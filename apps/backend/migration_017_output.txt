alembic : INFO  [alembic.runtime.migration] Context impl PostgresqlImpl.
At line:1 char:55
+ ... s\backend"; alembic upgrade 017_fix_foreign_key_relationships 2>&1 |  ...
+                 ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    + CategoryInfo          : NotSpecified: (INFO  [alembic....PostgresqlImpl.:String) [], RemoteException
    + FullyQualifiedErrorId : NativeCommandError
 
INFO  [alembic.runtime.migration] Will assume transactional DDL.
INFO  [alembic.runtime.migration] Running upgrade  -> 000_create_base_users, Create base users table for authentication
INFO  [alembic.runtime.migration] Running upgrade 000_create_base_users -> 001, Create CRM schemas and tables
INFO  [alembic.runtime.migration] Running upgrade 001 -> 002, Create read model projections
INFO  [alembic.runtime.migration] Running upgrade 002 -> 003_add_social_media_integration, Add social media integration schemas
INFO  [alembic.runtime.migration] Running upgrade 002 -> 003_add_lead_newsletter_schemas, Add Lead and Newsletter schemas for enterprise CRM
INFO  [alembic.runtime.migration] Running upgrade 003_add_lead_newsletter_schemas -> 004_station_rbac, Multi-tenant station architecture migration
INFO  [alembic.runtime.migration] Running upgrade  -> 001_initial_stripe_tables, Initial Stripe integration tables
INFO  [alembic.runtime.migration] Running upgrade 001_initial_stripe_tables, 003_add_social_media_integration -> 9fd62e8ed3b4, merge migrations
INFO  [alembic.runtime.migration] Running upgrade 9fd62e8ed3b4 -> ea9069521d16, update_indexes_and_constraints
INFO  [alembic.runtime.migration] Running upgrade ea9069521d16 -> 005_add_users_table, Add users table for Google OAuth authentication
INFO  [alembic.runtime.migration] Running upgrade 005_add_users_table -> 006_add_roles_permissions, Create roles and permissions tables
INFO  [alembic.runtime.migration] Running upgrade 9fd62e8ed3b4 -> 004_review_system, Add Customer Review System
INFO  [alembic.runtime.migration] Running upgrade 004_review_system -> 005_add_qr_code_tracking, add qr code tracking
INFO  [alembic.runtime.migration] Running upgrade 005_add_qr_code_tracking -> 006_create_audit_logs_system, create audit logs system
INFO  [alembic.runtime.migration] Running upgrade 006_create_audit_logs_system -> 007_add_soft_delete_support, add soft delete support
INFO  [alembic.runtime.migration] Running upgrade 007_add_soft_delete_support -> 008_add_user_roles, add user roles and station assignment
INFO  [alembic.runtime.migration] Running upgrade 006_add_roles_permissions, 008_add_user_roles -> cd22216ae9d3, merge roles and users branches
INFO  [alembic.runtime.migration] Running upgrade cd22216ae9d3 -> 009_payment_notifications, Add payment notification system tables
INFO  [alembic.runtime.migration] Running upgrade 009_payment_notifications -> f069ddb440f7, merge_payment_notifications
INFO  [alembic.runtime.migration] Running upgrade f069ddb440f7 -> 7ca3dac9d866, create_system_events_table
INFO  [alembic.runtime.migration] Running upgrade 009_payment_notifications -> 010_ai_hospitality_training, Add AI Hospitality Training System tables
INFO  [alembic.runtime.migration] Running upgrade f069ddb440f7 -> f5a8b9c2d3e4, Add SMS tracking fields and SMS delivery event table
INFO  [alembic.runtime.migration] Running upgrade f069ddb440f7 -> a1b2c3d4e5f6, create notification groups tables
INFO  [alembic.runtime.migration] Running upgrade a1b2c3d4e5f6 -> 3907a0a8e118, Add error_logs table
INFO  [alembic.runtime.migration] Running upgrade 3907a0a8e118 -> 198b329960a9, Add customer review blog posts and approval logs tables MANUAL
INFO  [alembic.runtime.migration] Running upgrade 198b329960a9 -> 8f571102b6b2, Add performance indexes for AI and reviews
INFO  [alembic.runtime.migration] Running upgrade 8f571102b6b2 -> e636a2d56d82, add_businesses_table_for_white_label
INFO  [alembic.runtime.migration] Running upgrade e636a2d56d82 -> 4ec9e57ea53e, add_escalation_performance_indexes
INFO  [alembic.runtime.migration] Running upgrade 4ec9e57ea53e -> 4a931353b079, add_pgvector_for_ai_semantic_search
INFO  [alembic.runtime.migration] Running upgrade 4a931353b079 -> 987eae60d297, add_ai_training_quality_index
INFO  [alembic.runtime.migration] Running upgrade 987eae60d297 -> 5f6cb2dfed84, Add monitoring alert tables
INFO  [alembic.runtime.migration] Running upgrade 5f6cb2dfed84 -> 573ac0543ebb, create_alert_rules_table
INFO  [alembic.runtime.migration] Running upgrade 010_ai_hospitality_training, 573ac0543ebb -> 9c41683cf436, merge_ai_training_and_alerts
INFO  [alembic.runtime.migration] Running upgrade 9c41683cf436 -> 6e2245429ea8, add_ringcentral_ai_transcript_fields
INFO  [alembic.runtime.migration] Running upgrade 6e2245429ea8 -> 5034d1bfa5f0, add_conversation_linking_indexes
INFO  [alembic.runtime.migration] Running upgrade 5034d1bfa5f0 -> 8ecb9a7d48f7, add_menu_items_table
INFO  [alembic.runtime.migration] Running upgrade 8ecb9a7d48f7 -> ba857522523f, add_consent_records_table
INFO  [alembic.runtime.migration] Running upgrade ba857522523f -> 90164363b9b9, add_referral_tables
INFO  [alembic.runtime.migration] Running upgrade 90164363b9b9 -> 25dc17ff6a26, add_message_log_table
INFO  [alembic.runtime.migration] Running upgrade 006_add_roles_permissions -> 007_fix_lead_enum_values, Fix lead and newsletter enum values to match Python 
models
INFO  [alembic.runtime.migration] Running upgrade 007_fix_lead_enum_values, 25dc17ff6a26, 7ca3dac9d866 -> e1814ce1d0e9, final_master_merge_all_12_heads
INFO  [alembic.runtime.migration] Running upgrade 010_ai_hospitality_training -> 012_add_2fa_ip_verification, Database migration: Add 2FA and IP verification 
fields
INFO  [alembic.runtime.migration] Running upgrade 012_add_2fa_ip_verification -> 013_add_deposit_deadline, Add deposit dual deadline system and manual 
confirmation
INFO  [alembic.runtime.migration] Running upgrade 013_add_deposit_deadline -> 014_add_sms_consent, Add SMS consent fields for TCPA compliance
INFO  [alembic.runtime.migration] Running upgrade 014_add_sms_consent -> 015_add_terms_acknowledgment, Add terms acknowledgment system
INFO  [alembic.runtime.migration] Running upgrade 015_add_terms_acknowledgment, e1814ce1d0e9, f5a8b9c2d3e4 -> 53bf4e839c3c, merge_terms_system_with_main
INFO  [alembic.runtime.migration] Running upgrade 53bf4e839c3c -> 0e81266c9503, create_booking_reminders_table
INFO  [alembic.runtime.migration] Running upgrade 0e81266c9503 -> 016_add_social_account_identity, Add social_accounts and social_identities tables
INFO  [alembic.runtime.migration] Running upgrade 016_add_social_account_identity -> 017_fix_foreign_key_relationships, Fix database foreign key relationships
Traceback (most recent call last):
  File "C:\Users\surya\scoop\apps\python\current\Lib\site-packages\sqlalchemy\engine\base.py", line 1961, in _exec_single_context
    self.dialect.do_execute(
    ~~~~~~~~~~~~~~~~~~~~~~~^
        cursor, str_statement, effective_parameters, context
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "C:\Users\surya\scoop\apps\python\current\Lib\site-packages\sqlalchemy\engine\default.py", line 944, in do_execute
    cursor.execute(statement, parameters)
    ~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^
psycopg2.errors.InFailedSqlTransaction: current transaction is aborted, commands ignored until end of transaction block


The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "<frozen runpy>", line 198, in _run_module_as_main
  File "<frozen runpy>", line 88, in _run_code
  File "C:\Users\surya\scoop\apps\python\current\Scripts\alembic.exe\__main__.py", line 7, in <module>
    sys.exit(main())
             ~~~~^^
  File "C:\Users\surya\scoop\apps\python\current\Lib\site-packages\alembic\config.py", line 1016, in main
    CommandLine(prog=prog).main(argv=argv)
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^
  File "C:\Users\surya\scoop\apps\python\current\Lib\site-packages\alembic\config.py", line 1006, in main
    self.run_cmd(cfg, options)
    ~~~~~~~~~~~~^^^^^^^^^^^^^^
  File "C:\Users\surya\scoop\apps\python\current\Lib\site-packages\alembic\config.py", line 940, in run_cmd
    fn(
    ~~^
        config,
        ^^^^^^^
        *[getattr(options, k, None) for k in positional],
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
        **{k: getattr(options, k, None) for k in kwarg},
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "C:\Users\surya\scoop\apps\python\current\Lib\site-packages\alembic\command.py", line 483, in upgrade
    script.run_env()
    ~~~~~~~~~~~~~~^^
  File "C:\Users\surya\scoop\apps\python\current\Lib\site-packages\alembic\script\base.py", line 549, in run_env
    util.load_python_file(self.dir, "env.py")
    ~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\surya\scoop\apps\python\current\Lib\site-packages\alembic\util\pyfiles.py", line 116, in load_python_file
    module = load_module_py(module_id, path)
  File "C:\Users\surya\scoop\apps\python\current\Lib\site-packages\alembic\util\pyfiles.py", line 136, in load_module_py
    spec.loader.exec_module(module)  # type: ignore
    ~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^
  File "<frozen importlib._bootstrap_external>", line 1026, in exec_module
  File "<frozen importlib._bootstrap>", line 488, in _call_with_frames_removed
  File "C:\Users\surya\projects\MH webapps\apps\backend\src\db\migrations\alembic\env.py", line 133, in <module>
    run_migrations_online()
    ~~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\surya\projects\MH webapps\apps\backend\src\db\migrations\alembic\env.py", line 127, in run_migrations_online
    context.run_migrations()
    ~~~~~~~~~~~~~~~~~~~~~~^^
  File "<string>", line 8, in run_migrations
  File "C:\Users\surya\scoop\apps\python\current\Lib\site-packages\alembic\runtime\environment.py", line 946, in run_migrations
    self.get_context().run_migrations(**kw)
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^
  File "C:\Users\surya\scoop\apps\python\current\Lib\site-packages\alembic\runtime\migration.py", line 627, in run_migrations
    step.migration_fn(**kw)
    ~~~~~~~~~~~~~~~~~^^^^^^
  File "C:\Users\surya\projects\MH webapps\apps\backend\src\db\migrations\alembic\versions\017_fix_foreign_key_relationships.py", line 62, in upgrade
    fk_exists = conn.execute(sa.text("""
                ~~~~~~~~~~~~^^^^^^^^^^^^
        SELECT EXISTS (
        ^^^^^^^^^^^^^^^
    ...<5 lines>...
        )
        ^
    """)).scalar()
    ^^^^^
  File "C:\Users\surya\scoop\apps\python\current\Lib\site-packages\sqlalchemy\engine\base.py", line 1413, in execute
    return meth(
        self,
        distilled_parameters,
        execution_options or NO_OPTIONS,
    )
  File "C:\Users\surya\scoop\apps\python\current\Lib\site-packages\sqlalchemy\sql\elements.py", line 526, in _execute_on_connection
    return connection._execute_clauseelement(
           ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        self, distilled_params, execution_options
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "C:\Users\surya\scoop\apps\python\current\Lib\site-packages\sqlalchemy\engine\base.py", line 1635, in _execute_clauseelement
    ret = self._execute_context(
        dialect,
    ...<8 lines>...
        cache_hit=cache_hit,
    )
  File "C:\Users\surya\scoop\apps\python\current\Lib\site-packages\sqlalchemy\engine\base.py", line 1840, in _execute_context
    return self._exec_single_context(
           ~~~~~~~~~~~~~~~~~~~~~~~~~^
        dialect, context, statement, parameters
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "C:\Users\surya\scoop\apps\python\current\Lib\site-packages\sqlalchemy\engine\base.py", line 1980, in _exec_single_context
    self._handle_dbapi_exception(
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        e, str_statement, effective_parameters, cursor, context
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "C:\Users\surya\scoop\apps\python\current\Lib\site-packages\sqlalchemy\engine\base.py", line 2349, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "C:\Users\surya\scoop\apps\python\current\Lib\site-packages\sqlalchemy\engine\base.py", line 1961, in _exec_single_context
    self.dialect.do_execute(
    ~~~~~~~~~~~~~~~~~~~~~~~^
        cursor, str_statement, effective_parameters, context
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "C:\Users\surya\scoop\apps\python\current\Lib\site-packages\sqlalchemy\engine\default.py", line 944, in do_execute
    cursor.execute(statement, parameters)
    ~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^
sqlalchemy.exc.InternalError: (psycopg2.errors.InFailedSqlTransaction) current transaction is aborted, commands ignored until end of transaction block

[SQL: 
            SELECT EXISTS (
                SELECT 1 FROM information_schema.table_constraints 
                WHERE constraint_schema = 'identity' 
                AND table_name = 'station_users'
                AND constraint_name = 'fk_station_users_user_id'
                AND constraint_type = 'FOREIGN KEY'
            )
        ]
(Background on this error at: https://sqlalche.me/e/20/2j85)
Γ£à Users table created successfully
   - Email + Google OAuth authentication supported
   - Pending approval workflow for new users
   - Super admin designation
   - MFA support
Γ£à Created roletype enum
Γ£à Created permissiontype enum
Γ£à Created permissions table
Γ£à Created roles table
Γ£à Created role_permissions table
Γ£à Created user_roles table
Γ£à Roles and permissions tables created successfully
[SUCCESS] Created audit_logs table with 8 indexes
[SUCCESS] Created audit_action enum (VIEW, CREATE, UPDATE, DELETE)
[SUCCESS] Created user_role enum (SUPER_ADMIN, ADMIN, CUSTOMER_SUPPORT, STATION_MANAGER)
[SUCCESS] Added delete_must_have_reason constraint
[SKIP] bookings - soft delete columns already exist
[SKIP] customers - soft delete columns already exist
[SKIP] leads - table does not exist in schema core
[SKIP] reviews - table does not exist in schema feedback

[SOFT DELETE SUMMARY]
   - Added 3 columns per table: deleted_at, deleted_by, delete_reason
   - Created 2 indexes per table for performance
   - Total: 4 tables updated

[USAGE]
   - Filter active records: WHERE deleted_at IS NULL
   - Filter deleted records: WHERE deleted_at IS NOT NULL
   - Restore: SET deleted_at = NULL, deleted_by = NULL, delete_reason = NULL
[SUCCESS] Added role column to identity.users table
[SUCCESS] Added assigned_station_id column to identity.users table

[MIGRATION] Migrating existing users to new role system...
[SKIP] No existing users to migrate (fresh database)

[SUCCESS] User role system configured!

[ROLE HIERARCHY]
   1. SUPER_ADMIN - Full system access
   2. ADMIN - Most operations, cannot manage admins
   3. CUSTOMER_SUPPORT - Customer-facing operations
   4. STATION_MANAGER - Station-specific operations

[NEXT STEPS]
   1. Update SUPER_ADMIN emails in migration if needed
   2. Assign stations to STATION_MANAGER users
   3. Review and adjust user roles as needed
Γ£à Created 11 tables for AI Hospitality Training System + Automated Customer Service
Γ£à Added business_id to identity.users
[SKIP] bookings.bookings does not exist
Γ£à Added business_id to lead.leads
[SKIP] feedback.reviews does not exist
[SKIP] newsletter.newsletter_subscribers does not exist
AI schema not found, skipping pgvector migration
AI schema or training_data table not found, skipping index creation
ΓÜá∩╕Å  call_recordings table not found in communications schema
    This migration will be applied after 010_escalation_call_recording.py runs
    Run 'alembic upgrade head' again to complete this migration

================================================================================
Adding Performance Indexes for Conversation Linking
================================================================================

≡ƒô₧ Optimizing customer phone lookups...
   ΓÜá∩╕Å  bookings schema not found, skipping

≡ƒôà Optimizing booking date range queries...

≡ƒÆ¼ Optimizing conversation history queries...
   ΓÜá∩╕Å  communications schema not found, skipping

================================================================================
Γ£à Performance indexes created successfully!
================================================================================

≡ƒôè Expected Performance Improvements:
   ΓÇó Customer phone lookup: 10x faster (50ms ΓåÆ 5ms)
   ΓÇó Booking correlation: 10x faster (100ms ΓåÆ 10ms)
   ΓÇó Conversation history: 10x faster (200ms ΓåÆ 20ms)
   ΓÇó Transcript search: 5x faster (500ms ΓåÆ 100ms)



================================================================================
≡ƒöº FIXING DATABASE FOREIGN KEY RELATIONSHIPS
================================================================================

≡ƒôï Issue #1: Fixing identity.station_users foreign keys...
  Γ£ô Dropped old fk_station_users_user_id constraint
  ΓÜá∩╕Å  Could not drop fk_station_users_assigned_by: (psycopg2.errors.UndefinedObject) constraint "fk_station_users_assigned_by" of relation "station_users" does not exist

[SQL: ALTER TABLE identity.station_users DROP CONSTRAINT fk_station_users_assigned_by]
(Background on this error at: https://sqlalche.me/e/20/f405)
