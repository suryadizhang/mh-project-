python : INFO:main:⚠️ Sentry DSN not configured - monitoring disabled
At line:1 char:55
+ ...  webapps\apps\backend"; python comprehensive_e2e_test.py 2>&1 | Out-F ...
+                             ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    + CategoryInfo          : NotSpecified: (INFO:main:⚠️ Se...toring disabled:String) [], RemoteExce 
   ption
    + FullyQualifiedErrorId : NativeCommandError
 
INFO:main:✅ SlowAPI rate limiter configured
INFO:main:✅ SlowAPI exception handler registered
INFO:main:✅ Custom exception handlers registered (with Sentry integration)
INFO:main:✅ Request ID middleware registered for distributed tracing
INFO:main:✅ Structured logging middleware registered
INFO:main:✅ Security headers middleware registered (HSTS, CSP, X-Frame-Options)
INFO:main:✅ Request size limiter registered (10 MB maximum)
INFO:main:✅ CORS middleware registered for origins: ['http://localhost:3000', 
'http://localhost:3001', 'http://localhost:5173']
INFO:main:✅ Google OAuth endpoints included
INFO:services.email_service:Email service initialized (enabled=False)
INFO:main:✅ User Management endpoints included
INFO:main:✅ Role Management endpoints included
INFO:main:✅ Payment Calculator endpoints included
INFO:main:✅ New architecture test endpoints included
INFO:main:✅ Stripe router included from NEW location
INFO:main:✅ Station Management and Auth endpoints included from NEW location (Multi-tenant RBAC)
INFO:main:✅ Enhanced Booking Admin API included from NEW location (KPIs, customer analytics)
INFO:main:✅ Payment Analytics endpoints included from NEW location
INFO:main:✅ QR Code Tracking System included from NEW location
WARNING:main:Admin Error Logs endpoints not available from NEW location, trying OLD: No module named 
'routers.v1.admin.error_logs'; 'routers.v1.admin' is not a package
ERROR:main:❌ Admin Error Logs endpoints not available: No module named 'api.app'
WARNING:main:Notification Groups endpoints not available from NEW location, trying OLD: No module 
named 'routers.v1.admin.notification_groups'; 'routers.v1.admin' is not a package
ERROR:main:❌ Notification Groups endpoints not available: No module named 'api.app'
INFO:main:✅ Admin Analytics endpoints included from NEW location
INFO:main:✅ Customer Review System included from NEW location (legacy comprehensive version)
INFO:main:✅ Additional CRM routers included from NEW location
WARNING:main:Public lead endpoints not available: No module named 'api.app'
WARNING:main:Public quote endpoints not available: No module named 'api.app'
INFO:api.ai.endpoints.services.knowledge_base_simple:KnowledgeBase: Initializing production knowledge 
base service
INFO:api.ai.endpoints.services.knowledge_base_simple:KnowledgeBase: Loaded 21 business knowledge 
chunks (business + admin system)
INFO:api.ai.endpoints.services.knowledge_base_simple:KnowledgeBase: Initializing production knowledge 
base service
INFO:api.ai.endpoints.services.knowledge_base_simple:KnowledgeBase: Loaded 21 business knowledge 
chunks (business + admin system)
INFO:api.ai.endpoints.services.ai_cache_service:AI Response Cache initialized
INFO:api.ai.endpoints.services.intelligent_model_router:Intelligent Model Router initialized
INFO:api.ai.endpoints.services.self_learning_ai:Self-Learning AI initialized
INFO:api.ai.endpoints.services.customer_booking_ai:Performance optimizations ENABLED (cache + 
intelligent routing + self-learning)
INFO:main:✅ AI Chat endpoints included
WARNING:main:Customer Review Blog endpoints not available: No module named 'api.app'
WARNING:main:Admin Review Moderation endpoints not available: No module named 'api.app'
WARNING:main:Unified Inbox endpoints not available: No module named 'api.app'
INFO:main:✅ Enhanced health check endpoints included (K8s ready)
INFO:main:✅ Comprehensive health monitoring endpoints included from NEW location
INFO:main:✅ Admin Analytics endpoints included (6 composite endpoints)
INFO:main:✅ Payment Email Notification endpoints included
INFO:main:🔄 Development role switching enabled (DEV_MODE=true)
WARNING:main:Multi-Channel AI Communication endpoints not available: No module named 'api.app'
INFO:main:✅ Admin Email Review Dashboard endpoints included (approve/edit/reject AI responses)
INFO:middleware.structured_logging:→ GET /health [9788321d-eacc-4ced-b269-c9dc23fcde4b] from 
testclient user=anonymous
INFO:core.middleware:GET /health
INFO:core.middleware:GET /health - 200
INFO:middleware.structured_logging:✅ GET /health [9788321d-eacc-4ced-b269-c9dc23fcde4b] → 200 in 0ms 
user=anonymous
INFO:httpx:HTTP Request: GET http://testserver/health "HTTP/1.1 200 OK"
INFO:middleware.structured_logging:→ GET /ready [c4f68c44-f06b-43b9-8ab1-221b4f56ee67] from 
testclient user=anonymous
INFO:core.middleware:GET /ready
INFO:core.middleware:GET /ready - 200
INFO:middleware.structured_logging:✅ GET /ready [c4f68c44-f06b-43b9-8ab1-221b4f56ee67] → 200 in 0ms 
user=anonymous
INFO:httpx:HTTP Request: GET http://testserver/ready "HTTP/1.1 200 OK"
INFO:middleware.structured_logging:→ GET /docs [ff261c64-4058-4727-a128-1734d514c504] from testclient 
user=anonymous
INFO:core.middleware:GET /docs
INFO:core.middleware:GET /docs - 200
INFO:middleware.structured_logging:✅ GET /docs [ff261c64-4058-4727-a128-1734d514c504] → 200 in 0ms 
user=anonymous
INFO:httpx:HTTP Request: GET http://testserver/docs "HTTP/1.1 200 OK"
INFO:middleware.structured_logging:→ GET /openapi.json [999526b3-c0e8-469d-80b1-e34bbf5e2f1f] from 
testclient user=anonymous
INFO:core.middleware:GET /openapi.json
C:\Users\surya\scoop\apps\python\current\Lib\site-packages\fastapi\openapi\utils.py:246: UserWarning: 
Duplicate Operation ID get_lead_analytics_api_admin_analytics_leads_get for function 
get_lead_analytics at C:\Users\surya\projects\MH 
webapps\apps\backend\src\api\v1\endpoints\analytics.py
  warnings.warn(message, stacklevel=1)
C:\Users\surya\scoop\apps\python\current\Lib\site-packages\fastapi\openapi\utils.py:246: UserWarning: 
Duplicate Operation ID get_newsletter_analytics_api_admin_analytics_newsletter_get for function 
get_newsletter_analytics at C:\Users\surya\projects\MH 
webapps\apps\backend\src\api\v1\endpoints\analytics.py
  warnings.warn(message, stacklevel=1)
C:\Users\surya\scoop\apps\python\current\Lib\site-packages\fastapi\openapi\utils.py:246: UserWarning: 
Duplicate Operation ID get_conversion_funnel_api_admin_analytics_funnel_get for function 
get_conversion_funnel at C:\Users\surya\projects\MH 
webapps\apps\backend\src\api\v1\endpoints\analytics.py
  warnings.warn(message, stacklevel=1)
C:\Users\surya\scoop\apps\python\current\Lib\site-packages\fastapi\openapi\utils.py:246: UserWarning: 
Duplicate Operation ID get_engagement_trends_api_admin_analytics_engagement_trends_get for function 
get_engagement_trends at C:\Users\surya\projects\MH 
webapps\apps\backend\src\api\v1\endpoints\analytics.py
  warnings.warn(message, stacklevel=1)
INFO:core.middleware:GET /openapi.json - 200
INFO:middleware.structured_logging:✅ GET /openapi.json [999526b3-c0e8-469d-80b1-e34bbf5e2f1f] → 200 
in 93ms user=anonymous
INFO:httpx:HTTP Request: GET http://testserver/openapi.json "HTTP/1.1 200 OK"
INFO:middleware.structured_logging:→ POST /api/auth/login [92401b1e-e126-488a-aed8-88daddf24514] from 
testclient user=anonymous
INFO:core.middleware:POST /api/auth/login
WARNING:core.exceptions:Client error: Request validation failed
INFO:core.middleware:POST /api/auth/login - 422
WARNING:middleware.structured_logging:⚠️ POST /api/auth/login [92401b1e-e126-488a-aed8-88daddf24514] 
→ 422 in 4ms user=anonymous

======================================================================
  1. CORE APPLICATION & CRITICAL IMPORTS
======================================================================
  ✅ Main application loads
  ✅ Settings configuration
  ✅ Database utilities import
  ✅ Authentication imports
  ✅ CQRS pattern imports
  ✅ Station authentication imports

======================================================================
  2. ENDPOINT FUNCTIONALITY TESTS
======================================================================
  ✅ GET /health returns 200
  ✅ GET /ready returns 200
  ✅ GET /docs (Swagger UI) accessible
  ✅ GET /openapi.json returns schema

======================================================================
  3. AUTHENTICATION ENDPOINTS
======================================================================
2025-11-05 13:55:19,392 INFO sqlalchemy.engine.Engine select pg_catalog.version()
2025-11-05 13:55:19,392 INFO sqlalchemy.engine.Engine [raw sql] ()
INFO:sqlalchemy.engine.Engine:select pg_catalog.version()
INFO:sqlalchemy.engine.Engine:[raw sql] ()
2025-11-05 13:55:19,740 INFO sqlalchemy.engine.Engine select current_schema()
INFO:sqlalchemy.engine.Engine:select current_schema()
2025-11-05 13:55:19,740 INFO sqlalchemy.engine.Engine [raw sql] ()
INFO:sqlalchemy.engine.Engine:[raw sql] ()
2025-11-05 13:55:20,103 INFO sqlalchemy.engine.Engine show standard_conforming_strings
INFO:sqlalchemy.engine.Engine:show standard_conforming_strings
2025-11-05 13:55:20,103 INFO sqlalchemy.engine.Engine [raw sql] ()
INFO:sqlalchemy.engine.Engine:[raw sql] ()
2025-11-05 13:55:20,366 INFO sqlalchemy.engine.Engine BEGIN (implicit)
INFO:sqlalchemy.engine.Engine:BEGIN (implicit)
2025-11-05 13:55:20,367 INFO sqlalchemy.engine.Engine INSERT INTO error_logs (correlation_id, timestamp, method, path, client_ip, user_id, user_role, error_type, error_message, error_traceback, status_code, request_body, request_headers, user_agent, response_time_ms, level, resolved, resolved_at, resolved_by, resolution_notes) VALUES ($1::VARCHAR, $2::TIMESTAMP WITHOUT TIME ZONE, $3::VARCHAR, $4::VARCHAR, $5::VARCHAR, $6::INTEGER, $7::VARCHAR, $8::VARCHAR, $9::VARCHAR, $10::VARCHAR, $11::INTEGER, $12::VARCHAR, $13::VARCHAR, $14::VARCHAR, $15::INTEGER, $16::VARCHAR, $17::INTEGER, $18::TIMESTAMP WITHOUT TIME ZONE, $19::INTEGER, $20::VARCHAR) RETURNING error_logs.id
INFO:sqlalchemy.engine.Engine:INSERT INTO error_logs (correlation_id, timestamp, method, path, 
client_ip, user_id, user_role, error_type, error_message, error_traceback, status_code, request_body, 
request_headers, user_agent, response_time_ms, level, resolved, resolved_at, resolved_by, 
resolution_notes) VALUES ($1::VARCHAR, $2::TIMESTAMP WITHOUT TIME ZONE, $3::VARCHAR, $4::VARCHAR, 
$5::VARCHAR, $6::INTEGER, $7::VARCHAR, $8::VARCHAR, $9::VARCHAR, $10::VARCHAR, $11::INTEGER, 
$12::VARCHAR, $13::VARCHAR, $14::VARCHAR, $15::INTEGER, $16::VARCHAR, $17::INTEGER, $18::TIMESTAMP 
WITHOUT TIME ZONE, $19::INTEGER, $20::VARCHAR) RETURNING error_logs.id
2025-11-05 13:55:20,367 INFO sqlalchemy.engine.Engine [generated in 0.00019s] ('92401b1e-e126-488a-aed8-88daddf24514', datetime.datetime(2025, 11, 5, 21, 55, 20, 367713), 'POST', '/api/auth/login', 'testclient', None, None, 'Exception', 'HTTP 422', 'NoneType: None\n', 422, '{"email": "test@example.com", "password": "test123"}', '{"host": "testserver", "accept": "*/*", "accept-encoding": "gzip, deflate", "connection": "keep-alive", "user-agent": "testclient", "content-length": "52", "content-type": "application/json"}', 'testclient', 4, 'WARNING', 0, None, None, None)
INFO:sqlalchemy.engine.Engine:[generated in 0.00019s] ('92401b1e-e126-488a-aed8-88daddf24514', 
datetime.datetime(2025, 11, 5, 21, 55, 20, 367713), 'POST', '/api/auth/login', 'testclient', None, 
None, 'Exception', 'HTTP 422', 'NoneType: None\n', 422, '{"email": "test@example.com", "password": 
"test123"}', '{"host": "testserver", "accept": "*/*", "accept-encoding": "gzip, deflate", 
"connection": "keep-alive", "user-agent": "testclient", "content-length": "52", "content-type": 
"application/json"}', 'testclient', 4, 'WARNING', 0, None, None, None)
2025-11-05 13:55:20,628 INFO sqlalchemy.engine.Engine COMMIT
INFO:sqlalchemy.engine.Engine:COMMIT
INFO:middleware.structured_logging:📝 Error logged to database with correlation ID: 
92401b1e-e126-488a-aed8-88daddf24514
INFO:httpx:HTTP Request: POST http://testserver/api/auth/login "HTTP/1.1 422 Unprocessable Entity"
INFO:middleware.structured_logging:→ POST /api/auth/register [dda5c3b1-c0d4-42b9-bbf2-3e1545368917] 
from testclient user=anonymous
INFO:core.middleware:POST /api/auth/register
INFO:core.middleware:POST /api/auth/register - 201
INFO:middleware.structured_logging:✅ POST /api/auth/register [dda5c3b1-c0d4-42b9-bbf2-3e1545368917] → 
201 in 2ms user=anonymous
INFO:httpx:HTTP Request: POST http://testserver/api/auth/register "HTTP/1.1 201 Created"
INFO:middleware.structured_logging:→ POST /api/station/station-login 
[1133b115-2337-467d-b213-f61cdc3cd06f] from testclient user=anonymous
INFO:core.middleware:POST /api/station/station-login
ERROR:sqlalchemy.pool.impl.AsyncAdaptedQueuePool:Exception terminating connection <AdaptedConnection 
<asyncpg.connection.Connection object at 0x000002793929F4D0>>
Traceback (most recent call last):
  File "C:\Users\surya\scoop\apps\python\current\Lib\site-packages\sqlalchemy\pool\base.py", line 
372, in _close_connection
    self._dialect.do_terminate(connection)
    ~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^
  File "C:\Users\surya\scoop\apps\python\current\Lib\site-packages\sqlalchemy\dialects\postgresql\asyn
cpg.py", line 1133, in do_terminate
    dbapi_connection.terminate()
    ~~~~~~~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\surya\scoop\apps\python\current\Lib\site-packages\sqlalchemy\dialects\postgresql\asyn
cpg.py", line 907, in terminate
    self.await_(asyncio.shield(self._connection.close(timeout=2)))
    ~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File 
"C:\Users\surya\scoop\apps\python\current\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", 
line 132, in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^
  File 
"C:\Users\surya\scoop\apps\python\current\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", 
line 196, in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
  File "C:\Users\surya\scoop\apps\python\current\Lib\site-packages\asyncpg\connection.py", line 1504, 
in close
    await self._protocol.close(timeout)
  File "asyncpg\\protocol\\protocol.pyx", line 627, in close
  File "asyncpg\\protocol\\protocol.pyx", line 660, in 
asyncpg.protocol.protocol.BaseProtocol._request_cancel
  File "C:\Users\surya\scoop\apps\python\current\Lib\site-packages\asyncpg\connection.py", line 1673, 
in _cancel_current_command
    self._cancellations.add(self._loop.create_task(self._cancel(waiter)))
                            ~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\surya\scoop\apps\python\current\Lib\asyncio\base_events.py", line 466, in create_task
    self._check_closed()
    ~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\surya\scoop\apps\python\current\Lib\asyncio\base_events.py", line 556, in 
_check_closed
    raise RuntimeError('Event loop is closed')
RuntimeError: Event loop is closed
WARNING:core.exceptions:Client error: Invalid credentials
INFO:core.middleware:POST /api/station/station-login - 401
WARNING:middleware.structured_logging:⚠️ POST /api/station/station-login 
[1133b115-2337-467d-b213-f61cdc3cd06f] → 401 in 8ms user=anonymous
  ✅ POST /api/auth/login endpoint exists
  ✅ POST /api/auth/register endpoint exists
2025-11-05 13:55:21,904 INFO sqlalchemy.engine.Engine BEGIN (implicit)
INFO:sqlalchemy.engine.Engine:BEGIN (implicit)
2025-11-05 13:55:21,904 INFO sqlalchemy.engine.Engine INSERT INTO error_logs (correlation_id, timestamp, method, path, client_ip, user_id, user_role, error_type, error_message, error_traceback, status_code, request_body, request_headers, user_agent, response_time_ms, level, resolved, resolved_at, resolved_by, resolution_notes) VALUES ($1::VARCHAR, $2::TIMESTAMP WITHOUT TIME ZONE, $3::VARCHAR, $4::VARCHAR, $5::VARCHAR, $6::INTEGER, $7::VARCHAR, $8::VARCHAR, $9::VARCHAR, $10::VARCHAR, $11::INTEGER, $12::VARCHAR, $13::VARCHAR, $14::VARCHAR, $15::INTEGER, $16::VARCHAR, $17::INTEGER, $18::TIMESTAMP WITHOUT TIME ZONE, $19::INTEGER, $20::VARCHAR) RETURNING error_logs.id
INFO:sqlalchemy.engine.Engine:INSERT INTO error_logs (correlation_id, timestamp, method, path, 
client_ip, user_id, user_role, error_type, error_message, error_traceback, status_code, request_body, 
request_headers, user_agent, response_time_ms, level, resolved, resolved_at, resolved_by, 
resolution_notes) VALUES ($1::VARCHAR, $2::TIMESTAMP WITHOUT TIME ZONE, $3::VARCHAR, $4::VARCHAR, 
$5::VARCHAR, $6::INTEGER, $7::VARCHAR, $8::VARCHAR, $9::VARCHAR, $10::VARCHAR, $11::INTEGER, 
$12::VARCHAR, $13::VARCHAR, $14::VARCHAR, $15::INTEGER, $16::VARCHAR, $17::INTEGER, $18::TIMESTAMP 
WITHOUT TIME ZONE, $19::INTEGER, $20::VARCHAR) RETURNING error_logs.id
2025-11-05 13:55:21,904 INFO sqlalchemy.engine.Engine [cached since 1.537s ago] ('1133b115-2337-467d-b213-f61cdc3cd06f', datetime.datetime(2025, 11, 5, 21, 55, 21, 904555), 'POST', '/api/station/station-login', 'testclient', None, None, 'Exception', 'HTTP 401', 'NoneType: None\n', 401, '{"email": "test@example.com", "password": "test123"}', '{"host": "testserver", "accept": "*/*", "accept-encoding": "gzip, deflate", "connection": "keep-alive", "user-agent": "testclient", "content-length": "52", "content-type": "application/json"}', 'testclient', 8, 'WARNING', 0, None, None, None)
INFO:sqlalchemy.engine.Engine:[cached since 1.537s ago] ('1133b115-2337-467d-b213-f61cdc3cd06f', 
datetime.datetime(2025, 11, 5, 21, 55, 21, 904555), 'POST', '/api/station/station-login', 
'testclient', None, None, 'Exception', 'HTTP 401', 'NoneType: None\n', 401, '{"email": 
"test@example.com", "password": "test123"}', '{"host": "testserver", "accept": "*/*", 
"accept-encoding": "gzip, deflate", "connection": "keep-alive", "user-agent": "testclient", 
"content-length": "52", "content-type": "application/json"}', 'testclient', 8, 'WARNING', 0, None, 
None, None)
2025-11-05 13:55:22,274 INFO sqlalchemy.engine.Engine COMMIT
INFO:sqlalchemy.engine.Engine:COMMIT
INFO:middleware.structured_logging:📝 Error logged to database with correlation ID: 
1133b115-2337-467d-b213-f61cdc3cd06f
INFO:httpx:HTTP Request: POST http://testserver/api/station/station-login "HTTP/1.1 401 Unauthorized"
INFO:middleware.structured_logging:→ GET /api/bookings/ [e69dc933-befe-4439-8d7b-2589a4fa9d60] from 
testclient user=anonymous
INFO:core.middleware:GET /api/bookings/
WARNING:core.exceptions:Client error: Not authenticated
INFO:core.middleware:GET /api/bookings/ - 403
WARNING:middleware.structured_logging:⚠️ GET /api/bookings/ [e69dc933-befe-4439-8d7b-2589a4fa9d60] → 
403 in 0ms user=anonymous
ERROR:sqlalchemy.pool.impl.AsyncAdaptedQueuePool:Exception terminating connection <AdaptedConnection 
<asyncpg.connection.Connection object at 0x00000279397725D0>>
Traceback (most recent call last):
  File "C:\Users\surya\scoop\apps\python\current\Lib\site-packages\sqlalchemy\pool\base.py", line 
372, in _close_connection
    self._dialect.do_terminate(connection)
    ~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^
  File "C:\Users\surya\scoop\apps\python\current\Lib\site-packages\sqlalchemy\dialects\postgresql\asyn
cpg.py", line 1133, in do_terminate
    dbapi_connection.terminate()
    ~~~~~~~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\surya\scoop\apps\python\current\Lib\site-packages\sqlalchemy\dialects\postgresql\asyn
cpg.py", line 907, in terminate
    self.await_(asyncio.shield(self._connection.close(timeout=2)))
    ~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File 
"C:\Users\surya\scoop\apps\python\current\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", 
line 132, in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^
  File 
"C:\Users\surya\scoop\apps\python\current\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", 
line 196, in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
  File "C:\Users\surya\scoop\apps\python\current\Lib\site-packages\asyncpg\connection.py", line 1504, 
in close
    await self._protocol.close(timeout)
  File "asyncpg\\protocol\\protocol.pyx", line 627, in close
  File "asyncpg\\protocol\\protocol.pyx", line 660, in 
asyncpg.protocol.protocol.BaseProtocol._request_cancel
  File "C:\Users\surya\scoop\apps\python\current\Lib\site-packages\asyncpg\connection.py", line 1673, 
in _cancel_current_command
    self._cancellations.add(self._loop.create_task(self._cancel(waiter)))
                            ~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\surya\scoop\apps\python\current\Lib\asyncio\base_events.py", line 466, in create_task
    self._check_closed()
    ~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\surya\scoop\apps\python\current\Lib\asyncio\base_events.py", line 556, in 
_check_closed
    raise RuntimeError('Event loop is closed')
RuntimeError: Event loop is closed
ERROR:middleware.structured_logging:❌ Failed to log error to database: Event loop is closed
Traceback (most recent call last):
  File "C:\Users\surya\scoop\apps\python\current\Lib\asyncio\base_events.py", line 833, in call_soon
    self._check_closed()
    ~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\surya\scoop\apps\python\current\Lib\asyncio\base_events.py", line 556, in 
_check_closed
    raise RuntimeError('Event loop is closed')
RuntimeError: Event loop is closed

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "C:\Users\surya\projects\MH webapps\apps\backend\src\middleware\structured_logging.py", line 
148, in _log_error_to_database
    await db.commit()
  File 
"C:\Users\surya\scoop\apps\python\current\Lib\site-packages\sqlalchemy\ext\asyncio\session.py", line 
1014, in commit
    await greenlet_spawn(self.sync_session.commit)
  File 
"C:\Users\surya\scoop\apps\python\current\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", 
line 201, in greenlet_spawn
    result = context.throw(*sys.exc_info())
  File "C:\Users\surya\scoop\apps\python\current\Lib\site-packages\sqlalchemy\orm\session.py", line 
2032, in commit
    trans.commit(_to_root=True)
    ~~~~~~~~~~~~^^^^^^^^^^^^^^^
  File "<string>", line 2, in commit
  File "C:\Users\surya\scoop\apps\python\current\Lib\site-packages\sqlalchemy\orm\state_changes.py", 
line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\surya\scoop\apps\python\current\Lib\site-packages\sqlalchemy\orm\session.py", line 
1313, in commit
    self._prepare_impl()
    ~~~~~~~~~~~~~~~~~~^^
  File "<string>", line 2, in _prepare_impl
  File "C:\Users\surya\scoop\apps\python\current\Lib\site-packages\sqlalchemy\orm\state_changes.py", 
line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\surya\scoop\apps\python\current\Lib\site-packages\sqlalchemy\orm\session.py", line 
1288, in _prepare_impl
    self.session.flush()
    ~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\surya\scoop\apps\python\current\Lib\site-packages\sqlalchemy\orm\session.py", line 
4345, in flush
    self._flush(objects)
    ~~~~~~~~~~~^^^^^^^^^
  File "C:\Users\surya\scoop\apps\python\current\Lib\site-packages\sqlalchemy\orm\session.py", line 
4480, in _flush
    with util.safe_reraise():
         ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\surya\scoop\apps\python\current\Lib\site-packages\sqlalchemy\util\langhelpers.py", 
line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "C:\Users\surya\scoop\apps\python\current\Lib\site-packages\sqlalchemy\orm\session.py", line 
4441, in _flush
    flush_context.execute()
    ~~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\surya\scoop\apps\python\current\Lib\site-packages\sqlalchemy\orm\unitofwork.py", 
line 466, in execute
    rec.execute(self)
    ~~~~~~~~~~~^^^^^^
  File "C:\Users\surya\scoop\apps\python\current\Lib\site-packages\sqlalchemy\orm\unitofwork.py", 
line 642, in execute
    util.preloaded.orm_persistence.save_obj(
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        self.mapper,
        ^^^^^^^^^^^^
        uow.states_for_mapper_hierarchy(self.mapper, False, False),
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
        uow,
        ^^^^
    )
    ^
  File "C:\Users\surya\scoop\apps\python\current\Lib\site-packages\sqlalchemy\orm\persistence.py", 
line 68, in save_obj
    ) in _organize_states_for_save(base_mapper, states, uowtransaction):
         ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\surya\scoop\apps\python\current\Lib\site-packages\sqlalchemy\orm\persistence.py", 
line 223, in _organize_states_for_save
    for state, dict_, mapper, connection in _connections_for_states(
                                            ~~~~~~~~~~~~~~~~~~~~~~~^
        base_mapper, uowtransaction, states
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    ):
    ^
  File "C:\Users\surya\scoop\apps\python\current\Lib\site-packages\sqlalchemy\orm\persistence.py", 
line 1753, in _connections_for_states
    connection = uowtransaction.transaction.connection(base_mapper)
  File "<string>", line 2, in connection
  File "C:\Users\surya\scoop\apps\python\current\Lib\site-packages\sqlalchemy\orm\state_changes.py", 
line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\surya\scoop\apps\python\current\Lib\site-packages\sqlalchemy\orm\session.py", line 
1039, in connection
    return self._connection_for_bind(bind, execution_options)
           ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^
  File "<string>", line 2, in _connection_for_bind
  File "C:\Users\surya\scoop\apps\python\current\Lib\site-packages\sqlalchemy\orm\state_changes.py", 
line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\surya\scoop\apps\python\current\Lib\site-packages\sqlalchemy\orm\session.py", line 
1175, in _connection_for_bind
    conn = self._parent._connection_for_bind(
        bind, execution_options
    )
  File "<string>", line 2, in _connection_for_bind
  File "C:\Users\surya\scoop\apps\python\current\Lib\site-packages\sqlalchemy\orm\state_changes.py", 
line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\surya\scoop\apps\python\current\Lib\site-packages\sqlalchemy\orm\session.py", line 
1189, in _connection_for_bind
    conn = bind.connect()
  File "C:\Users\surya\scoop\apps\python\current\Lib\site-packages\sqlalchemy\engine\base.py", line 
3271, in connect
    return self._connection_cls(self)
           ~~~~~~~~~~~~~~~~~~~~^^^^^^
  File "C:\Users\surya\scoop\apps\python\current\Lib\site-packages\sqlalchemy\engine\base.py", line 
143, in __init__
    self._dbapi_connection = engine.raw_connection()
                             ~~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\surya\scoop\apps\python\current\Lib\site-packages\sqlalchemy\engine\base.py", line 
3295, in raw_connection
    return self.pool.connect()
           ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\surya\scoop\apps\python\current\Lib\site-packages\sqlalchemy\pool\base.py", line 
447, in connect
    return _ConnectionFairy._checkout(self)
           ~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^
  File "C:\Users\surya\scoop\apps\python\current\Lib\site-packages\sqlalchemy\pool\base.py", line 
1363, in _checkout
    with util.safe_reraise():
         ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\surya\scoop\apps\python\current\Lib\site-packages\sqlalchemy\util\langhelpers.py", 
line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "C:\Users\surya\scoop\apps\python\current\Lib\site-packages\sqlalchemy\pool\base.py", line 
1301, in _checkout
    result = pool._dialect._do_ping_w_event(
        fairy.dbapi_connection
    )
  File "C:\Users\surya\scoop\apps\python\current\Lib\site-packages\sqlalchemy\engine\default.py", 
line 721, in _do_ping_w_event
    return self.do_ping(dbapi_connection)
           ~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^
  File "C:\Users\surya\scoop\apps\python\current\Lib\site-packages\sqlalchemy\dialects\postgresql\asyn
cpg.py", line 1166, in do_ping
    dbapi_connection.ping()
    ~~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\surya\scoop\apps\python\current\Lib\site-packages\sqlalchemy\dialects\postgresql\asyn
cpg.py", line 813, in ping
    self._handle_exception(error)
    ~~~~~~~~~~~~~~~~~~~~~~^^^^^^^
  File "C:\Users\surya\scoop\apps\python\current\Lib\site-packages\sqlalchemy\dialects\postgresql\asyn
cpg.py", line 794, in _handle_exception
    raise error
  File "C:\Users\surya\scoop\apps\python\current\Lib\site-packages\sqlalchemy\dialects\postgresql\asyn
cpg.py", line 811, in ping
    _ = self.await_(self._async_ping())
  File 
"C:\Users\surya\scoop\apps\python\current\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", 
line 132, in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^
  File 
"C:\Users\surya\scoop\apps\python\current\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", 
line 196, in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
  File "C:\Users\surya\scoop\apps\python\current\Lib\site-packages\sqlalchemy\dialects\postgresql\asyn
cpg.py", line 820, in _async_ping
    await tr.start()
  File "C:\Users\surya\scoop\apps\python\current\Lib\site-packages\asyncpg\transaction.py", line 146, 
in start
    await self._connection.execute(query)
  File "C:\Users\surya\scoop\apps\python\current\Lib\site-packages\asyncpg\connection.py", line 349, 
in execute
    result = await self._protocol.query(query, timeout)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "asyncpg\\protocol\\protocol.pyx", line 375, in query
  File "asyncpg\\protocol\\protocol.pyx", line 368, in asyncpg.protocol.protocol.BaseProtocol.query
  File "asyncpg\\protocol\\coreproto.pyx", line 1174, in 
asyncpg.protocol.protocol.CoreProtocol._simple_query
  File "asyncpg\\protocol\\protocol.pyx", line 967, in asyncpg.protocol.protocol.BaseProtocol._write
  File "C:\Users\surya\scoop\apps\python\current\Lib\asyncio\sslproto.py", line 222, in write
    self._ssl_protocol._write_appdata((data,))
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^
  File "C:\Users\surya\scoop\apps\python\current\Lib\asyncio\sslproto.py", line 700, in _write_appdata
    self._fatal_error(ex, 'Fatal error on SSL protocol')
    ~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\surya\scoop\apps\python\current\Lib\asyncio\sslproto.py", line 918, in _fatal_error
    self._transport._force_close(exc)
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^
  File "C:\Users\surya\scoop\apps\python\current\Lib\asyncio\proactor_events.py", line 152, in 
_force_close
    self._loop.call_soon(self._call_connection_lost, exc)
    ~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\surya\scoop\apps\python\current\Lib\asyncio\base_events.py", line 833, in call_soon
    self._check_closed()
    ~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\surya\scoop\apps\python\current\Lib\asyncio\base_events.py", line 556, in 
_check_closed
    raise RuntimeError('Event loop is closed')
RuntimeError: Event loop is closed
INFO:httpx:HTTP Request: GET http://testserver/api/bookings/ "HTTP/1.1 403 Forbidden"
INFO:middleware.structured_logging:→ POST /api/bookings/ [6eac5712-3046-4a23-9338-da5996f3e116] from 
testclient user=anonymous
INFO:core.middleware:POST /api/bookings/
WARNING:core.exceptions:Client error: Not authenticated
INFO:core.middleware:POST /api/bookings/ - 403
WARNING:middleware.structured_logging:⚠️ POST /api/bookings/ [6eac5712-3046-4a23-9338-da5996f3e116] → 
403 in 1ms user=anonymous
  ✅ POST /api/station/station-login works

======================================================================
  4. BOOKING SYSTEM
======================================================================
  ✅ GET /api/bookings/ requires auth
2025-11-05 13:55:23,536 INFO sqlalchemy.engine.Engine BEGIN (implicit)
INFO:sqlalchemy.engine.Engine:BEGIN (implicit)
2025-11-05 13:55:23,536 INFO sqlalchemy.engine.Engine INSERT INTO error_logs (correlation_id, timestamp, method, path, client_ip, user_id, user_role, error_type, error_message, error_traceback, status_code, request_body, request_headers, user_agent, response_time_ms, level, resolved, resolved_at, resolved_by, resolution_notes) VALUES ($1::VARCHAR, $2::TIMESTAMP WITHOUT TIME ZONE, $3::VARCHAR, $4::VARCHAR, $5::VARCHAR, $6::INTEGER, $7::VARCHAR, $8::VARCHAR, $9::VARCHAR, $10::VARCHAR, $11::INTEGER, $12::VARCHAR, $13::VARCHAR, $14::VARCHAR, $15::INTEGER, $16::VARCHAR, $17::INTEGER, $18::TIMESTAMP WITHOUT TIME ZONE, $19::INTEGER, $20::VARCHAR) RETURNING error_logs.id
INFO:sqlalchemy.engine.Engine:INSERT INTO error_logs (correlation_id, timestamp, method, path, 
client_ip, user_id, user_role, error_type, error_message, error_traceback, status_code, request_body, 
request_headers, user_agent, response_time_ms, level, resolved, resolved_at, resolved_by, 
resolution_notes) VALUES ($1::VARCHAR, $2::TIMESTAMP WITHOUT TIME ZONE, $3::VARCHAR, $4::VARCHAR, 
$5::VARCHAR, $6::INTEGER, $7::VARCHAR, $8::VARCHAR, $9::VARCHAR, $10::VARCHAR, $11::INTEGER, 
$12::VARCHAR, $13::VARCHAR, $14::VARCHAR, $15::INTEGER, $16::VARCHAR, $17::INTEGER, $18::TIMESTAMP 
WITHOUT TIME ZONE, $19::INTEGER, $20::VARCHAR) RETURNING error_logs.id
2025-11-05 13:55:23,536 INFO sqlalchemy.engine.Engine [cached since 3.169s ago] ('6eac5712-3046-4a23-9338-da5996f3e116', datetime.datetime(2025, 11, 5, 21, 55, 23, 536321), 'POST', '/api/bookings/', 'testclient', None, None, 'Exception', 'HTTP 403', 'NoneType: None\n', 403, '{"customer_name": "John Doe", "service_type": "test"}', '{"host": "testserver", "accept": "*/*", "accept-encoding": "gzip, deflate", "connection": "keep-alive", "user-agent": "testclient", "content-length": "53", "content-type": "application/json"}', 'testclient', 1, 'WARNING', 0, None, None, None)
INFO:sqlalchemy.engine.Engine:[cached since 3.169s ago] ('6eac5712-3046-4a23-9338-da5996f3e116', 
datetime.datetime(2025, 11, 5, 21, 55, 23, 536321), 'POST', '/api/bookings/', 'testclient', None, 
None, 'Exception', 'HTTP 403', 'NoneType: None\n', 403, '{"customer_name": "John Doe", 
"service_type": "test"}', '{"host": "testserver", "accept": "*/*", "accept-encoding": "gzip, 
deflate", "connection": "keep-alive", "user-agent": "testclient", "content-length": "53", 
"content-type": "application/json"}', 'testclient', 1, 'WARNING', 0, None, None, None)
2025-11-05 13:55:23,899 INFO sqlalchemy.engine.Engine COMMIT
INFO:sqlalchemy.engine.Engine:COMMIT
INFO:middleware.structured_logging:📝 Error logged to database with correlation ID: 
6eac5712-3046-4a23-9338-da5996f3e116
INFO:httpx:HTTP Request: POST http://testserver/api/bookings/ "HTTP/1.1 403 Forbidden"
INFO:middleware.structured_logging:→ GET /api/leads/ [cc46888f-9bf2-4b2d-8ae1-c7df58c3834d] from 
testclient user=anonymous
INFO:core.middleware:GET /api/leads/
ERROR:middleware.structured_logging:❌ Exception in GET /api/leads/ 
[cc46888f-9bf2-4b2d-8ae1-c7df58c3834d]: 'AsyncSession' object has no attribute 'query'
Traceback (most recent call last):
  File "C:\Users\surya\scoop\apps\python\current\Lib\site-packages\starlette\middleware\base.py", 
line 151, in call_next
    message = await recv_stream.receive()
              ^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\surya\scoop\apps\python\current\Lib\site-packages\anyio\streams\memory.py", line 
126, in receive
    raise EndOfStream from None
anyio.EndOfStream

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "C:\Users\surya\projects\MH webapps\apps\backend\src\middleware\structured_logging.py", line 
201, in dispatch
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\surya\scoop\apps\python\current\Lib\site-packages\starlette\middleware\base.py", 
line 159, in call_next
    raise app_exc
  File "C:\Users\surya\scoop\apps\python\current\Lib\site-packages\starlette\middleware\base.py", 
line 144, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "C:\Users\surya\scoop\apps\python\current\Lib\site-packages\starlette\middleware\base.py", 
line 182, in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\surya\scoop\apps\python\current\Lib\contextlib.py", line 162, in __exit__
    self.gen.throw(value)
    ~~~~~~~~~~~~~~^^^^^^^
  File "C:\Users\surya\scoop\apps\python\current\Lib\site-packages\starlette\_utils.py", line 83, in 
collapse_excgroups
    raise exc
  File "C:\Users\surya\scoop\apps\python\current\Lib\site-packages\starlette\middleware\base.py", 
line 184, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\surya\projects\MH webapps\apps\backend\src\core\middleware.py", line 68, in dispatch
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\surya\scoop\apps\python\current\Lib\site-packages\starlette\middleware\base.py", 
line 159, in call_next
    raise app_exc
  File "C:\Users\surya\scoop\apps\python\current\Lib\site-packages\starlette\middleware\base.py", 
line 144, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File 
"C:\Users\surya\scoop\apps\python\current\Lib\site-packages\starlette\middleware\exceptions.py", line 
63, in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
  File "C:\Users\surya\scoop\apps\python\current\Lib\site-packages\starlette\_exception_handler.py", 
line 53, in wrapped_app
    raise exc
  File "C:\Users\surya\scoop\apps\python\current\Lib\site-packages\starlette\_exception_handler.py", 
line 42, in wrapped_app
    await app(scope, receive, sender)
  File "C:\Users\surya\scoop\apps\python\current\Lib\site-packages\starlette\routing.py", line 716, 
in __call__
    await self.middleware_stack(scope, receive, send)
  File "C:\Users\surya\scoop\apps\python\current\Lib\site-packages\starlette\routing.py", line 736, 
in app
    await route.handle(scope, receive, send)
  File "C:\Users\surya\scoop\apps\python\current\Lib\site-packages\starlette\routing.py", line 290, 
in handle
    await self.app(scope, receive, send)
  File "C:\Users\surya\scoop\apps\python\current\Lib\site-packages\starlette\routing.py", line 78, in 
app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
  File "C:\Users\surya\scoop\apps\python\current\Lib\site-packages\starlette\_exception_handler.py", 
line 53, in wrapped_app
    raise exc
  File "C:\Users\surya\scoop\apps\python\current\Lib\site-packages\starlette\_exception_handler.py", 
line 42, in wrapped_app
    await app(scope, receive, sender)
  File "C:\Users\surya\scoop\apps\python\current\Lib\site-packages\starlette\routing.py", line 75, in 
app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
  File "C:\Users\surya\scoop\apps\python\current\Lib\site-packages\fastapi\routing.py", line 302, in 
app
    raw_response = await run_endpoint_function(
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    ...<3 lines>...
    )
    ^
  File "C:\Users\surya\scoop\apps\python\current\Lib\site-packages\fastapi\routing.py", line 213, in 
run_endpoint_function
    return await dependant.call(**values)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\surya\projects\MH webapps\apps\backend\src\routers\v1\leads.py", line 216, in 
list_leads
    query = db.query(Lead)
            ^^^^^^^^
AttributeError: 'AsyncSession' object has no attribute 'query'
ERROR:middleware.structured_logging:❌ GET /api/leads/ [cc46888f-9bf2-4b2d-8ae1-c7df58c3834d] → 500 in 
4ms user=anonymous
C:\Users\surya\scoop\apps\python\current\Lib\traceback.py:522: RuntimeWarning: coroutine 
'Connection._cancel' was never awaited
  def format_frame_summary(self, frame_summary, **kwargs):
RuntimeWarning: Enable tracemalloc to get the object allocation traceback
ERROR:sqlalchemy.pool.impl.AsyncAdaptedQueuePool:Exception terminating connection <AdaptedConnection 
<asyncpg.connection.Connection object at 0x00000279395018B0>>
Traceback (most recent call last):
  File "C:\Users\surya\scoop\apps\python\current\Lib\site-packages\sqlalchemy\pool\base.py", line 
372, in _close_connection
    self._dialect.do_terminate(connection)
    ~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^
  File "C:\Users\surya\scoop\apps\python\current\Lib\site-packages\sqlalchemy\dialects\postgresql\asyn
cpg.py", line 1133, in do_terminate
    dbapi_connection.terminate()
    ~~~~~~~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\surya\scoop\apps\python\current\Lib\site-packages\sqlalchemy\dialects\postgresql\asyn
cpg.py", line 907, in terminate
    self.await_(asyncio.shield(self._connection.close(timeout=2)))
    ~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File 
"C:\Users\surya\scoop\apps\python\current\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", 
line 132, in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^
  File 
"C:\Users\surya\scoop\apps\python\current\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", 
line 196, in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
  File "C:\Users\surya\scoop\apps\python\current\Lib\site-packages\asyncpg\connection.py", line 1504, 
in close
    await self._protocol.close(timeout)
  File "asyncpg\\protocol\\protocol.pyx", line 627, in close
  File "asyncpg\\protocol\\protocol.pyx", line 660, in 
asyncpg.protocol.protocol.BaseProtocol._request_cancel
  File "C:\Users\surya\scoop\apps\python\current\Lib\site-packages\asyncpg\connection.py", line 1673, 
in _cancel_current_command
    self._cancellations.add(self._loop.create_task(self._cancel(waiter)))
                            ~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\surya\scoop\apps\python\current\Lib\asyncio\base_events.py", line 466, in create_task
    self._check_closed()
    ~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\surya\scoop\apps\python\current\Lib\asyncio\base_events.py", line 556, in 
_check_closed
    raise RuntimeError('Event loop is closed')
RuntimeError: Event loop is closed
ERROR:middleware.structured_logging:❌ Failed to log error to database: Event loop is closed
Traceback (most recent call last):
  File "C:\Users\surya\scoop\apps\python\current\Lib\asyncio\base_events.py", line 833, in call_soon
    self._check_closed()
    ~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\surya\scoop\apps\python\current\Lib\asyncio\base_events.py", line 556, in 
_check_closed
    raise RuntimeError('Event loop is closed')
RuntimeError: Event loop is closed

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "C:\Users\surya\projects\MH webapps\apps\backend\src\middleware\structured_logging.py", line 
148, in _log_error_to_database
    await db.commit()
  File 
"C:\Users\surya\scoop\apps\python\current\Lib\site-packages\sqlalchemy\ext\asyncio\session.py", line 
1014, in commit
    await greenlet_spawn(self.sync_session.commit)
  File 
"C:\Users\surya\scoop\apps\python\current\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", 
line 201, in greenlet_spawn
    result = context.throw(*sys.exc_info())
  File "C:\Users\surya\scoop\apps\python\current\Lib\site-packages\sqlalchemy\orm\session.py", line 
2032, in commit
    trans.commit(_to_root=True)
    ~~~~~~~~~~~~^^^^^^^^^^^^^^^
  File "<string>", line 2, in commit
  File "C:\Users\surya\scoop\apps\python\current\Lib\site-packages\sqlalchemy\orm\state_changes.py", 
line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\surya\scoop\apps\python\current\Lib\site-packages\sqlalchemy\orm\session.py", line 
1313, in commit
    self._prepare_impl()
    ~~~~~~~~~~~~~~~~~~^^
  File "<string>", line 2, in _prepare_impl
  File "C:\Users\surya\scoop\apps\python\current\Lib\site-packages\sqlalchemy\orm\state_changes.py", 
line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\surya\scoop\apps\python\current\Lib\site-packages\sqlalchemy\orm\session.py", line 
1288, in _prepare_impl
    self.session.flush()
    ~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\surya\scoop\apps\python\current\Lib\site-packages\sqlalchemy\orm\session.py", line 
4345, in flush
    self._flush(objects)
    ~~~~~~~~~~~^^^^^^^^^
  File "C:\Users\surya\scoop\apps\python\current\Lib\site-packages\sqlalchemy\orm\session.py", line 
4480, in _flush
    with util.safe_reraise():
         ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\surya\scoop\apps\python\current\Lib\site-packages\sqlalchemy\util\langhelpers.py", 
line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "C:\Users\surya\scoop\apps\python\current\Lib\site-packages\sqlalchemy\orm\session.py", line 
4441, in _flush
    flush_context.execute()
    ~~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\surya\scoop\apps\python\current\Lib\site-packages\sqlalchemy\orm\unitofwork.py", 
line 466, in execute
    rec.execute(self)
    ~~~~~~~~~~~^^^^^^
  File "C:\Users\surya\scoop\apps\python\current\Lib\site-packages\sqlalchemy\orm\unitofwork.py", 
line 642, in execute
    util.preloaded.orm_persistence.save_obj(
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        self.mapper,
        ^^^^^^^^^^^^
        uow.states_for_mapper_hierarchy(self.mapper, False, False),
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
        uow,
        ^^^^
    )
    ^
  File "C:\Users\surya\scoop\apps\python\current\Lib\site-packages\sqlalchemy\orm\persistence.py", 
line 68, in save_obj
    ) in _organize_states_for_save(base_mapper, states, uowtransaction):
         ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\surya\scoop\apps\python\current\Lib\site-packages\sqlalchemy\orm\persistence.py", 
line 223, in _organize_states_for_save
    for state, dict_, mapper, connection in _connections_for_states(
                                            ~~~~~~~~~~~~~~~~~~~~~~~^
        base_mapper, uowtransaction, states
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    ):
    ^
  File "C:\Users\surya\scoop\apps\python\current\Lib\site-packages\sqlalchemy\orm\persistence.py", 
line 1753, in _connections_for_states
    connection = uowtransaction.transaction.connection(base_mapper)
  File "<string>", line 2, in connection
  File "C:\Users\surya\scoop\apps\python\current\Lib\site-packages\sqlalchemy\orm\state_changes.py", 
line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\surya\scoop\apps\python\current\Lib\site-packages\sqlalchemy\orm\session.py", line 
1039, in connection
    return self._connection_for_bind(bind, execution_options)
           ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^
  File "<string>", line 2, in _connection_for_bind
  File "C:\Users\surya\scoop\apps\python\current\Lib\site-packages\sqlalchemy\orm\state_changes.py", 
line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\surya\scoop\apps\python\current\Lib\site-packages\sqlalchemy\orm\session.py", line 
1175, in _connection_for_bind
    conn = self._parent._connection_for_bind(
        bind, execution_options
    )
  File "<string>", line 2, in _connection_for_bind
  File "C:\Users\surya\scoop\apps\python\current\Lib\site-packages\sqlalchemy\orm\state_changes.py", 
line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\surya\scoop\apps\python\current\Lib\site-packages\sqlalchemy\orm\session.py", line 
1189, in _connection_for_bind
    conn = bind.connect()
  File "C:\Users\surya\scoop\apps\python\current\Lib\site-packages\sqlalchemy\engine\base.py", line 
3271, in connect
    return self._connection_cls(self)
           ~~~~~~~~~~~~~~~~~~~~^^^^^^
  File "C:\Users\surya\scoop\apps\python\current\Lib\site-packages\sqlalchemy\engine\base.py", line 
143, in __init__
    self._dbapi_connection = engine.raw_connection()
                             ~~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\surya\scoop\apps\python\current\Lib\site-packages\sqlalchemy\engine\base.py", line 
3295, in raw_connection
    return self.pool.connect()
           ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\surya\scoop\apps\python\current\Lib\site-packages\sqlalchemy\pool\base.py", line 
447, in connect
    return _ConnectionFairy._checkout(self)
           ~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^
  File "C:\Users\surya\scoop\apps\python\current\Lib\site-packages\sqlalchemy\pool\base.py", line 
1363, in _checkout
    with util.safe_reraise():
         ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\surya\scoop\apps\python\current\Lib\site-packages\sqlalchemy\util\langhelpers.py", 
line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "C:\Users\surya\scoop\apps\python\current\Lib\site-packages\sqlalchemy\pool\base.py", line 
1301, in _checkout
    result = pool._dialect._do_ping_w_event(
        fairy.dbapi_connection
    )
  File "C:\Users\surya\scoop\apps\python\current\Lib\site-packages\sqlalchemy\engine\default.py", 
line 721, in _do_ping_w_event
    return self.do_ping(dbapi_connection)
           ~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^
  File "C:\Users\surya\scoop\apps\python\current\Lib\site-packages\sqlalchemy\dialects\postgresql\asyn
cpg.py", line 1166, in do_ping
    dbapi_connection.ping()
    ~~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\surya\scoop\apps\python\current\Lib\site-packages\sqlalchemy\dialects\postgresql\asyn
cpg.py", line 813, in ping
    self._handle_exception(error)
    ~~~~~~~~~~~~~~~~~~~~~~^^^^^^^
  File "C:\Users\surya\scoop\apps\python\current\Lib\site-packages\sqlalchemy\dialects\postgresql\asyn
cpg.py", line 794, in _handle_exception
    raise error
  File "C:\Users\surya\scoop\apps\python\current\Lib\site-packages\sqlalchemy\dialects\postgresql\asyn
cpg.py", line 811, in ping
    _ = self.await_(self._async_ping())
  File 
"C:\Users\surya\scoop\apps\python\current\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", 
line 132, in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^
  File 
"C:\Users\surya\scoop\apps\python\current\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", 
line 196, in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
  File "C:\Users\surya\scoop\apps\python\current\Lib\site-packages\sqlalchemy\dialects\postgresql\asyn
cpg.py", line 820, in _async_ping
    await tr.start()
  File "C:\Users\surya\scoop\apps\python\current\Lib\site-packages\asyncpg\transaction.py", line 146, 
in start
    await self._connection.execute(query)
  File "C:\Users\surya\scoop\apps\python\current\Lib\site-packages\asyncpg\connection.py", line 349, 
in execute
    result = await self._protocol.query(query, timeout)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "asyncpg\\protocol\\protocol.pyx", line 375, in query
  File "asyncpg\\protocol\\protocol.pyx", line 368, in asyncpg.protocol.protocol.BaseProtocol.query
  File "asyncpg\\protocol\\coreproto.pyx", line 1174, in 
asyncpg.protocol.protocol.CoreProtocol._simple_query
  File "asyncpg\\protocol\\protocol.pyx", line 967, in asyncpg.protocol.protocol.BaseProtocol._write
  File "C:\Users\surya\scoop\apps\python\current\Lib\asyncio\sslproto.py", line 222, in write
    self._ssl_protocol._write_appdata((data,))
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^
  File "C:\Users\surya\scoop\apps\python\current\Lib\asyncio\sslproto.py", line 700, in _write_appdata
    self._fatal_error(ex, 'Fatal error on SSL protocol')
    ~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\surya\scoop\apps\python\current\Lib\asyncio\sslproto.py", line 918, in _fatal_error
    self._transport._force_close(exc)
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^
  File "C:\Users\surya\scoop\apps\python\current\Lib\asyncio\proactor_events.py", line 152, in 
_force_close
    self._loop.call_soon(self._call_connection_lost, exc)
    ~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\surya\scoop\apps\python\current\Lib\asyncio\base_events.py", line 833, in call_soon
    self._check_closed()
    ~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\surya\scoop\apps\python\current\Lib\asyncio\base_events.py", line 556, in 
_check_closed
    raise RuntimeError('Event loop is closed')
RuntimeError: Event loop is closed
ERROR:main:Unhandled error on GET http://testserver/api/leads/: 'AsyncSession' object has no 
attribute 'query'
ERROR:core.exceptions:Unhandled exception [error_20251105_215524]: 'AsyncSession' object has no 
attribute 'query'
  + Exception Group Traceback (most recent call last):
  |   File "C:\Users\surya\scoop\apps\python\current\Lib\site-packages\starlette\_utils.py", line 77, 
in collapse_excgroups
  |     yield
  |   File "C:\Users\surya\scoop\apps\python\current\Lib\site-packages\starlette\middleware\base.py", 
line 183, in __call__
  |     async with anyio.create_task_group() as task_group:
  |                ~~~~~~~~~~~~~~~~~~~~~~~^^
  |   File "C:\Users\surya\scoop\apps\python\current\Lib\site-packages\anyio\_backends\_asyncio.py", 
line 772, in __aexit__
  |     raise BaseExceptionGroup(
  |         "unhandled errors in a TaskGroup", self._exceptions
  |     ) from None
  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)
  +-+---------------- 1 ----------------
    | Traceback (most recent call last):
    |   File 
"C:\Users\surya\scoop\apps\python\current\Lib\site-packages\starlette\middleware\errors.py", line 
164, in __call__
    |     await self.app(scope, receive, _send)
    |   File 
"C:\Users\surya\scoop\apps\python\current\Lib\site-packages\starlette\middleware\base.py", line 182, 
in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |                                    ~~~~~~~~~~~~~~~~~~^^
    |   File "C:\Users\surya\scoop\apps\python\current\Lib\contextlib.py", line 162, in __exit__
    |     self.gen.throw(value)
    |     ~~~~~~~~~~~~~~^^^^^^^
    |   File "C:\Users\surya\scoop\apps\python\current\Lib\site-packages\starlette\_utils.py", line 
83, in collapse_excgroups
    |     raise exc
    |   File 
"C:\Users\surya\scoop\apps\python\current\Lib\site-packages\starlette\middleware\base.py", line 184, 
in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "C:\Users\surya\projects\MH webapps\apps\backend\src\main.py", line 469, in 
rate_limiting_middleware
    |     return await call_next(request)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File 
"C:\Users\surya\scoop\apps\python\current\Lib\site-packages\starlette\middleware\base.py", line 159, 
in call_next
    |     raise app_exc
    |   File 
"C:\Users\surya\scoop\apps\python\current\Lib\site-packages\starlette\middleware\base.py", line 144, 
in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File 
"C:\Users\surya\scoop\apps\python\current\Lib\site-packages\starlette\middleware\cors.py", line 85, 
in __call__
    |     await self.app(scope, receive, send)
    |   File 
"C:\Users\surya\scoop\apps\python\current\Lib\site-packages\starlette\middleware\base.py", line 182, 
in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |                                    ~~~~~~~~~~~~~~~~~~^^
    |   File "C:\Users\surya\scoop\apps\python\current\Lib\contextlib.py", line 162, in __exit__
    |     self.gen.throw(value)
    |     ~~~~~~~~~~~~~~^^^^^^^
    |   File "C:\Users\surya\scoop\apps\python\current\Lib\site-packages\starlette\_utils.py", line 
83, in collapse_excgroups
    |     raise exc
    |   File 
"C:\Users\surya\scoop\apps\python\current\Lib\site-packages\starlette\middleware\base.py", line 184, 
in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "C:\Users\surya\projects\MH webapps\apps\backend\src\core\security_middleware.py", line 
118, in dispatch
    |     return await call_next(request)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File 
"C:\Users\surya\scoop\apps\python\current\Lib\site-packages\starlette\middleware\base.py", line 159, 
in call_next
    |     raise app_exc
    |   File 
"C:\Users\surya\scoop\apps\python\current\Lib\site-packages\starlette\middleware\base.py", line 144, 
in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File 
"C:\Users\surya\scoop\apps\python\current\Lib\site-packages\starlette\middleware\base.py", line 182, 
in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |                                    ~~~~~~~~~~~~~~~~~~^^
    |   File "C:\Users\surya\scoop\apps\python\current\Lib\contextlib.py", line 162, in __exit__
    |     self.gen.throw(value)
    |     ~~~~~~~~~~~~~~^^^^^^^
    |   File "C:\Users\surya\scoop\apps\python\current\Lib\site-packages\starlette\_utils.py", line 
83, in collapse_excgroups
    |     raise exc
    |   File 
"C:\Users\surya\scoop\apps\python\current\Lib\site-packages\starlette\middleware\base.py", line 184, 
in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "C:\Users\surya\projects\MH webapps\apps\backend\src\core\security_middleware.py", line 
28, in dispatch
    |     response = await call_next(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File 
"C:\Users\surya\scoop\apps\python\current\Lib\site-packages\starlette\middleware\base.py", line 159, 
in call_next
    |     raise app_exc
    |   File 
"C:\Users\surya\scoop\apps\python\current\Lib\site-packages\starlette\middleware\base.py", line 144, 
in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File 
"C:\Users\surya\scoop\apps\python\current\Lib\site-packages\starlette\middleware\base.py", line 182, 
in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |                                    ~~~~~~~~~~~~~~~~~~^^
    |   File "C:\Users\surya\scoop\apps\python\current\Lib\contextlib.py", line 162, in __exit__
    |     self.gen.throw(value)
    |     ~~~~~~~~~~~~~~^^^^^^^
    |   File "C:\Users\surya\scoop\apps\python\current\Lib\site-packages\starlette\_utils.py", line 
83, in collapse_excgroups
    |     raise exc
    |   File 
"C:\Users\surya\scoop\apps\python\current\Lib\site-packages\starlette\middleware\base.py", line 184, 
in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "C:\Users\surya\projects\MH webapps\apps\backend\src\middleware\structured_logging.py", 
line 201, in dispatch
    |     response = await call_next(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File 
"C:\Users\surya\scoop\apps\python\current\Lib\site-packages\starlette\middleware\base.py", line 159, 
in call_next
    |     raise app_exc
    |   File 
"C:\Users\surya\scoop\apps\python\current\Lib\site-packages\starlette\middleware\base.py", line 144, 
in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File 
"C:\Users\surya\scoop\apps\python\current\Lib\site-packages\starlette\middleware\base.py", line 182, 
in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |                                    ~~~~~~~~~~~~~~~~~~^^
    |   File "C:\Users\surya\scoop\apps\python\current\Lib\contextlib.py", line 162, in __exit__
    |     self.gen.throw(value)
    |     ~~~~~~~~~~~~~~^^^^^^^
    |   File "C:\Users\surya\scoop\apps\python\current\Lib\site-packages\starlette\_utils.py", line 
83, in collapse_excgroups
    |     raise exc
    |   File 
"C:\Users\surya\scoop\apps\python\current\Lib\site-packages\starlette\middleware\base.py", line 184, 
in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "C:\Users\surya\projects\MH webapps\apps\backend\src\core\middleware.py", line 68, in 
dispatch
    |     response = await call_next(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File 
"C:\Users\surya\scoop\apps\python\current\Lib\site-packages\starlette\middleware\base.py", line 159, 
in call_next
    |     raise app_exc
    |   File 
"C:\Users\surya\scoop\apps\python\current\Lib\site-packages\starlette\middleware\base.py", line 144, 
in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File 
"C:\Users\surya\scoop\apps\python\current\Lib\site-packages\starlette\middleware\exceptions.py", line 
63, in __call__
    |     await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
    |   File 
"C:\Users\surya\scoop\apps\python\current\Lib\site-packages\starlette\_exception_handler.py", line 
53, in wrapped_app
    |     raise exc
    |   File 
"C:\Users\surya\scoop\apps\python\current\Lib\site-packages\starlette\_exception_handler.py", line 
42, in wrapped_app
    |     await app(scope, receive, sender)
    |   File "C:\Users\surya\scoop\apps\python\current\Lib\site-packages\starlette\routing.py", line 
716, in __call__
    |     await self.middleware_stack(scope, receive, send)
    |   File "C:\Users\surya\scoop\apps\python\current\Lib\site-packages\starlette\routing.py", line 
736, in app
    |     await route.handle(scope, receive, send)
    |   File "C:\Users\surya\scoop\apps\python\current\Lib\site-packages\starlette\routing.py", line 
290, in handle
    |     await self.app(scope, receive, send)
    |   File "C:\Users\surya\scoop\apps\python\current\Lib\site-packages\starlette\routing.py", line 
78, in app
    |     await wrap_app_handling_exceptions(app, request)(scope, receive, send)
    |   File 
"C:\Users\surya\scoop\apps\python\current\Lib\site-packages\starlette\_exception_handler.py", line 
53, in wrapped_app
    |     raise exc
    |   File 
"C:\Users\surya\scoop\apps\python\current\Lib\site-packages\starlette\_exception_handler.py", line 
42, in wrapped_app
    |     await app(scope, receive, sender)
    |   File "C:\Users\surya\scoop\apps\python\current\Lib\site-packages\starlette\routing.py", line 
75, in app
    |     response = await f(request)
    |                ^^^^^^^^^^^^^^^^
    |   File "C:\Users\surya\scoop\apps\python\current\Lib\site-packages\fastapi\routing.py", line 
302, in app
    |     raw_response = await run_endpoint_function(
    |                    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |     ...<3 lines>...
    |     )
    |     ^
    |   File "C:\Users\surya\scoop\apps\python\current\Lib\site-packages\fastapi\routing.py", line 
213, in run_endpoint_function
    |     return await dependant.call(**values)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "C:\Users\surya\projects\MH webapps\apps\backend\src\routers\v1\leads.py", line 216, in 
list_leads
    |     query = db.query(Lead)
    |             ^^^^^^^^
    | AttributeError: 'AsyncSession' object has no attribute 'query'
    +------------------------------------

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "C:\Users\surya\scoop\apps\python\current\Lib\site-packages\starlette\middleware\errors.py", 
line 164, in __call__
    await self.app(scope, receive, _send)
  File "C:\Users\surya\scoop\apps\python\current\Lib\site-packages\starlette\middleware\base.py", 
line 182, in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\surya\scoop\apps\python\current\Lib\contextlib.py", line 162, in __exit__
    self.gen.throw(value)
    ~~~~~~~~~~~~~~^^^^^^^
  File "C:\Users\surya\scoop\apps\python\current\Lib\site-packages\starlette\_utils.py", line 83, in 
collapse_excgroups
    raise exc
  File "C:\Users\surya\scoop\apps\python\current\Lib\site-packages\starlette\middleware\base.py", 
line 184, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\surya\projects\MH webapps\apps\backend\src\main.py", line 469, in 
rate_limiting_middleware
    return await call_next(request)
           ^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\surya\scoop\apps\python\current\Lib\site-packages\starlette\middleware\base.py", 
line 159, in call_next
    raise app_exc
  File "C:\Users\surya\scoop\apps\python\current\Lib\site-packages\starlette\middleware\base.py", 
line 144, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "C:\Users\surya\scoop\apps\python\current\Lib\site-packages\starlette\middleware\cors.py", 
line 85, in __call__
    await self.app(scope, receive, send)
  File "C:\Users\surya\scoop\apps\python\current\Lib\site-packages\starlette\middleware\base.py", 
line 182, in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\surya\scoop\apps\python\current\Lib\contextlib.py", line 162, in __exit__
    self.gen.throw(value)
    ~~~~~~~~~~~~~~^^^^^^^
  File "C:\Users\surya\scoop\apps\python\current\Lib\site-packages\starlette\_utils.py", line 83, in 
collapse_excgroups
    raise exc
  File "C:\Users\surya\scoop\apps\python\current\Lib\site-packages\starlette\middleware\base.py", 
line 184, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\surya\projects\MH webapps\apps\backend\src\core\security_middleware.py", line 118, 
in dispatch
    return await call_next(request)
           ^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\surya\scoop\apps\python\current\Lib\site-packages\starlette\middleware\base.py", 
line 159, in call_next
    raise app_exc
  File "C:\Users\surya\scoop\apps\python\current\Lib\site-packages\starlette\middleware\base.py", 
line 144, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "C:\Users\surya\scoop\apps\python\current\Lib\site-packages\starlette\middleware\base.py", 
line 182, in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\surya\scoop\apps\python\current\Lib\contextlib.py", line 162, in __exit__
    self.gen.throw(value)
    ~~~~~~~~~~~~~~^^^^^^^
  File "C:\Users\surya\scoop\apps\python\current\Lib\site-packages\starlette\_utils.py", line 83, in 
collapse_excgroups
    raise exc
  File "C:\Users\surya\scoop\apps\python\current\Lib\site-packages\starlette\middleware\base.py", 
line 184, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\surya\projects\MH webapps\apps\backend\src\core\security_middleware.py", line 28, in 
dispatch
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\surya\scoop\apps\python\current\Lib\site-packages\starlette\middleware\base.py", 
line 159, in call_next
    raise app_exc
  File "C:\Users\surya\scoop\apps\python\current\Lib\site-packages\starlette\middleware\base.py", 
line 144, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "C:\Users\surya\scoop\apps\python\current\Lib\site-packages\starlette\middleware\base.py", 
line 182, in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\surya\scoop\apps\python\current\Lib\contextlib.py", line 162, in __exit__
    self.gen.throw(value)
    ~~~~~~~~~~~~~~^^^^^^^
  File "C:\Users\surya\scoop\apps\python\current\Lib\site-packages\starlette\_utils.py", line 83, in 
collapse_excgroups
    raise exc
  File "C:\Users\surya\scoop\apps\python\current\Lib\site-packages\starlette\middleware\base.py", 
line 184, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\surya\projects\MH webapps\apps\backend\src\middleware\structured_logging.py", line 
201, in dispatch
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\surya\scoop\apps\python\current\Lib\site-packages\starlette\middleware\base.py", 
line 159, in call_next
    raise app_exc
  File "C:\Users\surya\scoop\apps\python\current\Lib\site-packages\starlette\middleware\base.py", 
line 144, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "C:\Users\surya\scoop\apps\python\current\Lib\site-packages\starlette\middleware\base.py", 
line 182, in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\surya\scoop\apps\python\current\Lib\contextlib.py", line 162, in __exit__
    self.gen.throw(value)
    ~~~~~~~~~~~~~~^^^^^^^
  File "C:\Users\surya\scoop\apps\python\current\Lib\site-packages\starlette\_utils.py", line 83, in 
collapse_excgroups
    raise exc
  File "C:\Users\surya\scoop\apps\python\current\Lib\site-packages\starlette\middleware\base.py", 
line 184, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\surya\projects\MH webapps\apps\backend\src\core\middleware.py", line 68, in dispatch
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\surya\scoop\apps\python\current\Lib\site-packages\starlette\middleware\base.py", 
line 159, in call_next
    raise app_exc
  File "C:\Users\surya\scoop\apps\python\current\Lib\site-packages\starlette\middleware\base.py", 
line 144, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File 
"C:\Users\surya\scoop\apps\python\current\Lib\site-packages\starlette\middleware\exceptions.py", line 
63, in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
  File "C:\Users\surya\scoop\apps\python\current\Lib\site-packages\starlette\_exception_handler.py", 
line 53, in wrapped_app
    raise exc
  File "C:\Users\surya\scoop\apps\python\current\Lib\site-packages\starlette\_exception_handler.py", 
line 42, in wrapped_app
    await app(scope, receive, sender)
  File "C:\Users\surya\scoop\apps\python\current\Lib\site-packages\starlette\routing.py", line 716, 
in __call__
    await self.middleware_stack(scope, receive, send)
  File "C:\Users\surya\scoop\apps\python\current\Lib\site-packages\starlette\routing.py", line 736, 
in app
    await route.handle(scope, receive, send)
  File "C:\Users\surya\scoop\apps\python\current\Lib\site-packages\starlette\routing.py", line 290, 
in handle
    await self.app(scope, receive, send)
  File "C:\Users\surya\scoop\apps\python\current\Lib\site-packages\starlette\routing.py", line 78, in 
app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
  File "C:\Users\surya\scoop\apps\python\current\Lib\site-packages\starlette\_exception_handler.py", 
line 53, in wrapped_app
    raise exc
  File "C:\Users\surya\scoop\apps\python\current\Lib\site-packages\starlette\_exception_handler.py", 
line 42, in wrapped_app
    await app(scope, receive, sender)
  File "C:\Users\surya\scoop\apps\python\current\Lib\site-packages\starlette\routing.py", line 75, in 
app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
  File "C:\Users\surya\scoop\apps\python\current\Lib\site-packages\fastapi\routing.py", line 302, in 
app
    raw_response = await run_endpoint_function(
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    ...<3 lines>...
    )
    ^
  File "C:\Users\surya\scoop\apps\python\current\Lib\site-packages\fastapi\routing.py", line 213, in 
run_endpoint_function
    return await dependant.call(**values)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\surya\projects\MH webapps\apps\backend\src\routers\v1\leads.py", line 216, in 
list_leads
    query = db.query(Lead)
            ^^^^^^^^
AttributeError: 'AsyncSession' object has no attribute 'query'
ERROR:core.exceptions:Server error: An unexpected error occurred. Please try again later.
INFO:middleware.structured_logging:→ POST /api/leads/ [eba8c535-ca24-46bb-adae-1f451c6fbe04] from 
testclient user=anonymous
INFO:core.middleware:POST /api/leads/
WARNING:core.exceptions:Client error: Request validation failed
INFO:core.middleware:POST /api/leads/ - 422
WARNING:middleware.structured_logging:⚠️ POST /api/leads/ [eba8c535-ca24-46bb-adae-1f451c6fbe04] → 
422 in 2ms user=anonymous
  ✅ POST /api/bookings/ endpoint exists

======================================================================
  5. LEAD MANAGEMENT SYSTEM
======================================================================
  ❌ GET /api/leads/ requires auth: AttributeError: 'AsyncSession' object has no attribute 'query'
2025-11-05 13:55:25,223 INFO sqlalchemy.engine.Engine BEGIN (implicit)
INFO:sqlalchemy.engine.Engine:BEGIN (implicit)
2025-11-05 13:55:25,224 INFO sqlalchemy.engine.Engine INSERT INTO error_logs (correlation_id, timestamp, method, path, client_ip, user_id, user_role, error_type, error_message, error_traceback, status_code, request_body, request_headers, user_agent, response_time_ms, level, resolved, resolved_at, resolved_by, resolution_notes) VALUES ($1::VARCHAR, $2::TIMESTAMP WITHOUT TIME ZONE, $3::VARCHAR, $4::VARCHAR, $5::VARCHAR, $6::INTEGER, $7::VARCHAR, $8::VARCHAR, $9::VARCHAR, $10::VARCHAR, $11::INTEGER, $12::VARCHAR, $13::VARCHAR, $14::VARCHAR, $15::INTEGER, $16::VARCHAR, $17::INTEGER, $18::TIMESTAMP WITHOUT TIME ZONE, $19::INTEGER, $20::VARCHAR) RETURNING error_logs.id
INFO:sqlalchemy.engine.Engine:INSERT INTO error_logs (correlation_id, timestamp, method, path, 
client_ip, user_id, user_role, error_type, error_message, error_traceback, status_code, request_body, 
request_headers, user_agent, response_time_ms, level, resolved, resolved_at, resolved_by, 
resolution_notes) VALUES ($1::VARCHAR, $2::TIMESTAMP WITHOUT TIME ZONE, $3::VARCHAR, $4::VARCHAR, 
$5::VARCHAR, $6::INTEGER, $7::VARCHAR, $8::VARCHAR, $9::VARCHAR, $10::VARCHAR, $11::INTEGER, 
$12::VARCHAR, $13::VARCHAR, $14::VARCHAR, $15::INTEGER, $16::VARCHAR, $17::INTEGER, $18::TIMESTAMP 
WITHOUT TIME ZONE, $19::INTEGER, $20::VARCHAR) RETURNING error_logs.id
2025-11-05 13:55:25,224 INFO sqlalchemy.engine.Engine [cached since 4.856s ago] ('eba8c535-ca24-46bb-adae-1f451c6fbe04', datetime.datetime(2025, 11, 5, 21, 55, 25, 223979), 'POST', '/api/leads/', 'testclient', None, None, 'Exception', 'HTTP 422', 'NoneType: None\n', 422, '{"name": "Test Lead", "email": "lead@test.com"}', '{"host": "testserver", "accept": "*/*", "accept-encoding": "gzip, deflate", "connection": "keep-alive", "user-agent": "testclient", "content-length": "47", "content-type": "application/json"}', 'testclient', 2, 'WARNING', 0, None, None, None)
INFO:sqlalchemy.engine.Engine:[cached since 4.856s ago] ('eba8c535-ca24-46bb-adae-1f451c6fbe04', 
datetime.datetime(2025, 11, 5, 21, 55, 25, 223979), 'POST', '/api/leads/', 'testclient', None, None, 
'Exception', 'HTTP 422', 'NoneType: None\n', 422, '{"name": "Test Lead", "email": "lead@test.com"}', 
'{"host": "testserver", "accept": "*/*", "accept-encoding": "gzip, deflate", "connection": 
"keep-alive", "user-agent": "testclient", "content-length": "47", "content-type": 
"application/json"}', 'testclient', 2, 'WARNING', 0, None, None, None)
2025-11-05 13:55:25,587 INFO sqlalchemy.engine.Engine COMMIT
INFO:sqlalchemy.engine.Engine:COMMIT
INFO:middleware.structured_logging:📝 Error logged to database with correlation ID: 
eba8c535-ca24-46bb-adae-1f451c6fbe04
INFO:httpx:HTTP Request: POST http://testserver/api/leads/ "HTTP/1.1 422 Unprocessable Entity"
INFO:middleware.structured_logging:→ GET /api/reviews/ [cadc53ae-717e-42b0-808f-669516928926] from 
testclient user=anonymous
INFO:core.middleware:GET /api/reviews/
WARNING:core.exceptions:Client error: Method Not Allowed
INFO:core.middleware:GET /api/reviews/ - 405
WARNING:middleware.structured_logging:⚠️ GET /api/reviews/ [cadc53ae-717e-42b0-808f-669516928926] → 
405 in 0ms user=anonymous
ERROR:sqlalchemy.pool.impl.AsyncAdaptedQueuePool:Exception terminating connection <AdaptedConnection 
<asyncpg.connection.Connection object at 0x0000027939D106E0>>
Traceback (most recent call last):
  File "C:\Users\surya\scoop\apps\python\current\Lib\site-packages\sqlalchemy\pool\base.py", line 
372, in _close_connection
    self._dialect.do_terminate(connection)
    ~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^
  File "C:\Users\surya\scoop\apps\python\current\Lib\site-packages\sqlalchemy\dialects\postgresql\asyn
cpg.py", line 1133, in do_terminate
    dbapi_connection.terminate()
    ~~~~~~~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\surya\scoop\apps\python\current\Lib\site-packages\sqlalchemy\dialects\postgresql\asyn
cpg.py", line 907, in terminate
    self.await_(asyncio.shield(self._connection.close(timeout=2)))
    ~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File 
"C:\Users\surya\scoop\apps\python\current\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", 
line 132, in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^
  File 
"C:\Users\surya\scoop\apps\python\current\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", 
line 196, in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
  File "C:\Users\surya\scoop\apps\python\current\Lib\site-packages\asyncpg\connection.py", line 1504, 
in close
    await self._protocol.close(timeout)
  File "asyncpg\\protocol\\protocol.pyx", line 627, in close
  File "asyncpg\\protocol\\protocol.pyx", line 660, in 
asyncpg.protocol.protocol.BaseProtocol._request_cancel
  File "C:\Users\surya\scoop\apps\python\current\Lib\site-packages\asyncpg\connection.py", line 1673, 
in _cancel_current_command
    self._cancellations.add(self._loop.create_task(self._cancel(waiter)))
                            ~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\surya\scoop\apps\python\current\Lib\asyncio\base_events.py", line 466, in create_task
    self._check_closed()
    ~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\surya\scoop\apps\python\current\Lib\asyncio\base_events.py", line 556, in 
_check_closed
    raise RuntimeError('Event loop is closed')
RuntimeError: Event loop is closed
ERROR:middleware.structured_logging:❌ Failed to log error to database: Event loop is closed
Traceback (most recent call last):
  File "C:\Users\surya\scoop\apps\python\current\Lib\asyncio\base_events.py", line 833, in call_soon
    self._check_closed()
    ~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\surya\scoop\apps\python\current\Lib\asyncio\base_events.py", line 556, in 
_check_closed
    raise RuntimeError('Event loop is closed')
RuntimeError: Event loop is closed

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "C:\Users\surya\projects\MH webapps\apps\backend\src\middleware\structured_logging.py", line 
148, in _log_error_to_database
    await db.commit()
  File 
"C:\Users\surya\scoop\apps\python\current\Lib\site-packages\sqlalchemy\ext\asyncio\session.py", line 
1014, in commit
    await greenlet_spawn(self.sync_session.commit)
  File 
"C:\Users\surya\scoop\apps\python\current\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", 
line 201, in greenlet_spawn
    result = context.throw(*sys.exc_info())
  File "C:\Users\surya\scoop\apps\python\current\Lib\site-packages\sqlalchemy\orm\session.py", line 
2032, in commit
    trans.commit(_to_root=True)
    ~~~~~~~~~~~~^^^^^^^^^^^^^^^
  File "<string>", line 2, in commit
  File "C:\Users\surya\scoop\apps\python\current\Lib\site-packages\sqlalchemy\orm\state_changes.py", 
line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\surya\scoop\apps\python\current\Lib\site-packages\sqlalchemy\orm\session.py", line 
1313, in commit
    self._prepare_impl()
    ~~~~~~~~~~~~~~~~~~^^
  File "<string>", line 2, in _prepare_impl
  File "C:\Users\surya\scoop\apps\python\current\Lib\site-packages\sqlalchemy\orm\state_changes.py", 
line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\surya\scoop\apps\python\current\Lib\site-packages\sqlalchemy\orm\session.py", line 
1288, in _prepare_impl
    self.session.flush()
    ~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\surya\scoop\apps\python\current\Lib\site-packages\sqlalchemy\orm\session.py", line 
4345, in flush
    self._flush(objects)
    ~~~~~~~~~~~^^^^^^^^^
  File "C:\Users\surya\scoop\apps\python\current\Lib\site-packages\sqlalchemy\orm\session.py", line 
4480, in _flush
    with util.safe_reraise():
         ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\surya\scoop\apps\python\current\Lib\site-packages\sqlalchemy\util\langhelpers.py", 
line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "C:\Users\surya\scoop\apps\python\current\Lib\site-packages\sqlalchemy\orm\session.py", line 
4441, in _flush
    flush_context.execute()
    ~~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\surya\scoop\apps\python\current\Lib\site-packages\sqlalchemy\orm\unitofwork.py", 
line 466, in execute
    rec.execute(self)
    ~~~~~~~~~~~^^^^^^
  File "C:\Users\surya\scoop\apps\python\current\Lib\site-packages\sqlalchemy\orm\unitofwork.py", 
line 642, in execute
    util.preloaded.orm_persistence.save_obj(
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        self.mapper,
        ^^^^^^^^^^^^
        uow.states_for_mapper_hierarchy(self.mapper, False, False),
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
        uow,
        ^^^^
    )
    ^
  File "C:\Users\surya\scoop\apps\python\current\Lib\site-packages\sqlalchemy\orm\persistence.py", 
line 68, in save_obj
    ) in _organize_states_for_save(base_mapper, states, uowtransaction):
         ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\surya\scoop\apps\python\current\Lib\site-packages\sqlalchemy\orm\persistence.py", 
line 223, in _organize_states_for_save
    for state, dict_, mapper, connection in _connections_for_states(
                                            ~~~~~~~~~~~~~~~~~~~~~~~^
        base_mapper, uowtransaction, states
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    ):
    ^
  File "C:\Users\surya\scoop\apps\python\current\Lib\site-packages\sqlalchemy\orm\persistence.py", 
line 1753, in _connections_for_states
    connection = uowtransaction.transaction.connection(base_mapper)
  File "<string>", line 2, in connection
  File "C:\Users\surya\scoop\apps\python\current\Lib\site-packages\sqlalchemy\orm\state_changes.py", 
line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\surya\scoop\apps\python\current\Lib\site-packages\sqlalchemy\orm\session.py", line 
1039, in connection
    return self._connection_for_bind(bind, execution_options)
           ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^
  File "<string>", line 2, in _connection_for_bind
  File "C:\Users\surya\scoop\apps\python\current\Lib\site-packages\sqlalchemy\orm\state_changes.py", 
line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\surya\scoop\apps\python\current\Lib\site-packages\sqlalchemy\orm\session.py", line 
1175, in _connection_for_bind
    conn = self._parent._connection_for_bind(
        bind, execution_options
    )
  File "<string>", line 2, in _connection_for_bind
  File "C:\Users\surya\scoop\apps\python\current\Lib\site-packages\sqlalchemy\orm\state_changes.py", 
line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\surya\scoop\apps\python\current\Lib\site-packages\sqlalchemy\orm\session.py", line 
1189, in _connection_for_bind
    conn = bind.connect()
  File "C:\Users\surya\scoop\apps\python\current\Lib\site-packages\sqlalchemy\engine\base.py", line 
3271, in connect
    return self._connection_cls(self)
           ~~~~~~~~~~~~~~~~~~~~^^^^^^
  File "C:\Users\surya\scoop\apps\python\current\Lib\site-packages\sqlalchemy\engine\base.py", line 
143, in __init__
    self._dbapi_connection = engine.raw_connection()
                             ~~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\surya\scoop\apps\python\current\Lib\site-packages\sqlalchemy\engine\base.py", line 
3295, in raw_connection
    return self.pool.connect()
           ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\surya\scoop\apps\python\current\Lib\site-packages\sqlalchemy\pool\base.py", line 
447, in connect
    return _ConnectionFairy._checkout(self)
           ~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^
  File "C:\Users\surya\scoop\apps\python\current\Lib\site-packages\sqlalchemy\pool\base.py", line 
1363, in _checkout
    with util.safe_reraise():
         ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\surya\scoop\apps\python\current\Lib\site-packages\sqlalchemy\util\langhelpers.py", 
line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "C:\Users\surya\scoop\apps\python\current\Lib\site-packages\sqlalchemy\pool\base.py", line 
1301, in _checkout
    result = pool._dialect._do_ping_w_event(
        fairy.dbapi_connection
    )
  File "C:\Users\surya\scoop\apps\python\current\Lib\site-packages\sqlalchemy\engine\default.py", 
line 721, in _do_ping_w_event
    return self.do_ping(dbapi_connection)
           ~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^
  File "C:\Users\surya\scoop\apps\python\current\Lib\site-packages\sqlalchemy\dialects\postgresql\asyn
cpg.py", line 1166, in do_ping
    dbapi_connection.ping()
    ~~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\surya\scoop\apps\python\current\Lib\site-packages\sqlalchemy\dialects\postgresql\asyn
cpg.py", line 813, in ping
    self._handle_exception(error)
    ~~~~~~~~~~~~~~~~~~~~~~^^^^^^^
  File "C:\Users\surya\scoop\apps\python\current\Lib\site-packages\sqlalchemy\dialects\postgresql\asyn
cpg.py", line 794, in _handle_exception
    raise error
  File "C:\Users\surya\scoop\apps\python\current\Lib\site-packages\sqlalchemy\dialects\postgresql\asyn
cpg.py", line 811, in ping
    _ = self.await_(self._async_ping())
  File 
"C:\Users\surya\scoop\apps\python\current\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", 
line 132, in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^
  File 
"C:\Users\surya\scoop\apps\python\current\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", 
line 196, in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
  File "C:\Users\surya\scoop\apps\python\current\Lib\site-packages\sqlalchemy\dialects\postgresql\asyn
cpg.py", line 820, in _async_ping
    await tr.start()
  File "C:\Users\surya\scoop\apps\python\current\Lib\site-packages\asyncpg\transaction.py", line 146, 
in start
    await self._connection.execute(query)
  File "C:\Users\surya\scoop\apps\python\current\Lib\site-packages\asyncpg\connection.py", line 349, 
in execute
    result = await self._protocol.query(query, timeout)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "asyncpg\\protocol\\protocol.pyx", line 375, in query
  File "asyncpg\\protocol\\protocol.pyx", line 368, in asyncpg.protocol.protocol.BaseProtocol.query
  File "asyncpg\\protocol\\coreproto.pyx", line 1174, in 
asyncpg.protocol.protocol.CoreProtocol._simple_query
  File "asyncpg\\protocol\\protocol.pyx", line 967, in asyncpg.protocol.protocol.BaseProtocol._write
  File "C:\Users\surya\scoop\apps\python\current\Lib\asyncio\sslproto.py", line 222, in write
    self._ssl_protocol._write_appdata((data,))
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^
  File "C:\Users\surya\scoop\apps\python\current\Lib\asyncio\sslproto.py", line 700, in _write_appdata
    self._fatal_error(ex, 'Fatal error on SSL protocol')
    ~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\surya\scoop\apps\python\current\Lib\asyncio\sslproto.py", line 918, in _fatal_error
    self._transport._force_close(exc)
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^
  File "C:\Users\surya\scoop\apps\python\current\Lib\asyncio\proactor_events.py", line 152, in 
_force_close
    self._loop.call_soon(self._call_connection_lost, exc)
    ~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\surya\scoop\apps\python\current\Lib\asyncio\base_events.py", line 833, in call_soon
    self._check_closed()
    ~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\surya\scoop\apps\python\current\Lib\asyncio\base_events.py", line 556, in 
_check_closed
    raise RuntimeError('Event loop is closed')
RuntimeError: Event loop is closed
INFO:httpx:HTTP Request: GET http://testserver/api/reviews/ "HTTP/1.1 405 Method Not Allowed"
INFO:middleware.structured_logging:→ POST /api/reviews/ [73deaead-04cc-4b30-97df-340c506aa598] from 
testclient user=anonymous
INFO:core.middleware:POST /api/reviews/
INFO:core.middleware:POST /api/reviews/ - 201
INFO:middleware.structured_logging:✅ POST /api/reviews/ [73deaead-04cc-4b30-97df-340c506aa598] → 201 
in 1ms user=anonymous
INFO:httpx:HTTP Request: POST http://testserver/api/reviews/ "HTTP/1.1 201 Created"
INFO:middleware.structured_logging:→ GET /api/payments/analytics 
[0e075c05-85d2-4452-9d95-71aef6499f7e] from testclient user=anonymous
INFO:core.middleware:GET /api/payments/analytics
C:\Users\surya\scoop\apps\python\current\Lib\site-packages\starlette\_exception_handler.py:23: 
RuntimeWarning: coroutine 'Connection._cancel' was never awaited
  def wrap_app_handling_exceptions(app: ASGIApp, conn: Request | WebSocket) -> ASGIApp:
RuntimeWarning: Enable tracemalloc to get the object allocation traceback
WARNING:core.exceptions:Client error: Not authenticated
INFO:core.middleware:GET /api/payments/analytics - 401
WARNING:middleware.structured_logging:⚠️ GET /api/payments/analytics 
[0e075c05-85d2-4452-9d95-71aef6499f7e] → 401 in 1ms user=anonymous
  ✅ POST /api/leads/ endpoint exists

======================================================================
  6. CUSTOMER REVIEW SYSTEM
======================================================================
  ❌ GET /api/reviews/ responds: Status: 405
  ✅ POST /api/reviews/ endpoint exists

======================================================================
  7. PAYMENT SYSTEM
======================================================================
2025-11-05 13:55:26,850 INFO sqlalchemy.engine.Engine BEGIN (implicit)
INFO:sqlalchemy.engine.Engine:BEGIN (implicit)
2025-11-05 13:55:26,850 INFO sqlalchemy.engine.Engine INSERT INTO error_logs (correlation_id, timestamp, method, path, client_ip, user_id, user_role, error_type, error_message, error_traceback, status_code, request_body, request_headers, user_agent, response_time_ms, level, resolved, resolved_at, resolved_by, resolution_notes) VALUES ($1::VARCHAR, $2::TIMESTAMP WITHOUT TIME ZONE, $3::VARCHAR, $4::VARCHAR, $5::VARCHAR, $6::INTEGER, $7::VARCHAR, $8::VARCHAR, $9::VARCHAR, $10::VARCHAR, $11::INTEGER, $12::VARCHAR, $13::VARCHAR, $14::VARCHAR, $15::INTEGER, $16::VARCHAR, $17::INTEGER, $18::TIMESTAMP WITHOUT TIME ZONE, $19::INTEGER, $20::VARCHAR) RETURNING error_logs.id
INFO:sqlalchemy.engine.Engine:INSERT INTO error_logs (correlation_id, timestamp, method, path, 
client_ip, user_id, user_role, error_type, error_message, error_traceback, status_code, request_body, 
request_headers, user_agent, response_time_ms, level, resolved, resolved_at, resolved_by, 
resolution_notes) VALUES ($1::VARCHAR, $2::TIMESTAMP WITHOUT TIME ZONE, $3::VARCHAR, $4::VARCHAR, 
$5::VARCHAR, $6::INTEGER, $7::VARCHAR, $8::VARCHAR, $9::VARCHAR, $10::VARCHAR, $11::INTEGER, 
$12::VARCHAR, $13::VARCHAR, $14::VARCHAR, $15::INTEGER, $16::VARCHAR, $17::INTEGER, $18::TIMESTAMP 
WITHOUT TIME ZONE, $19::INTEGER, $20::VARCHAR) RETURNING error_logs.id
2025-11-05 13:55:26,850 INFO sqlalchemy.engine.Engine [cached since 6.483s ago] ('0e075c05-85d2-4452-9d95-71aef6499f7e', datetime.datetime(2025, 11, 5, 21, 55, 26, 850637), 'GET', '/api/payments/analytics', 'testclient', None, None, 'Exception', 'HTTP 401', 'NoneType: None\n', 401, None, '{"host": "testserver", "accept": "*/*", "accept-encoding": "gzip, deflate", "connection": "keep-alive", "user-agent": "testclient"}', 'testclient', 1, 'WARNING', 0, None, None, None)
INFO:sqlalchemy.engine.Engine:[cached since 6.483s ago] ('0e075c05-85d2-4452-9d95-71aef6499f7e', 
datetime.datetime(2025, 11, 5, 21, 55, 26, 850637), 'GET', '/api/payments/analytics', 'testclient', 
None, None, 'Exception', 'HTTP 401', 'NoneType: None\n', 401, None, '{"host": "testserver", "accept": 
"*/*", "accept-encoding": "gzip, deflate", "connection": "keep-alive", "user-agent": "testclient"}', 
'testclient', 1, 'WARNING', 0, None, None, None)
2025-11-05 13:55:27,222 INFO sqlalchemy.engine.Engine COMMIT
INFO:sqlalchemy.engine.Engine:COMMIT
INFO:middleware.structured_logging:📝 Error logged to database with correlation ID: 
0e075c05-85d2-4452-9d95-71aef6499f7e
INFO:httpx:HTTP Request: GET http://testserver/api/payments/analytics "HTTP/1.1 401 Unauthorized"
INFO:middleware.structured_logging:→ GET /api/admin/kpis [1cb6af7c-024a-45d8-82e9-d388dca27188] from 
testclient user=anonymous
INFO:core.middleware:GET /api/admin/kpis
WARNING:core.exceptions:Client error: Not authenticated
INFO:core.middleware:GET /api/admin/kpis - 401
WARNING:middleware.structured_logging:⚠️ GET /api/admin/kpis [1cb6af7c-024a-45d8-82e9-d388dca27188] → 
401 in 0ms user=anonymous
ERROR:sqlalchemy.pool.impl.AsyncAdaptedQueuePool:Exception terminating connection <AdaptedConnection 
<asyncpg.connection.Connection object at 0x0000027939D11F40>>
Traceback (most recent call last):
  File "C:\Users\surya\scoop\apps\python\current\Lib\site-packages\sqlalchemy\pool\base.py", line 
372, in _close_connection
    self._dialect.do_terminate(connection)
    ~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^
  File "C:\Users\surya\scoop\apps\python\current\Lib\site-packages\sqlalchemy\dialects\postgresql\asyn
cpg.py", line 1133, in do_terminate
    dbapi_connection.terminate()
    ~~~~~~~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\surya\scoop\apps\python\current\Lib\site-packages\sqlalchemy\dialects\postgresql\asyn
cpg.py", line 907, in terminate
    self.await_(asyncio.shield(self._connection.close(timeout=2)))
    ~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File 
"C:\Users\surya\scoop\apps\python\current\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", 
line 132, in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^
  File 
"C:\Users\surya\scoop\apps\python\current\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", 
line 196, in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
  File "C:\Users\surya\scoop\apps\python\current\Lib\site-packages\asyncpg\connection.py", line 1504, 
in close
    await self._protocol.close(timeout)
  File "asyncpg\\protocol\\protocol.pyx", line 627, in close
  File "asyncpg\\protocol\\protocol.pyx", line 660, in 
asyncpg.protocol.protocol.BaseProtocol._request_cancel
  File "C:\Users\surya\scoop\apps\python\current\Lib\site-packages\asyncpg\connection.py", line 1673, 
in _cancel_current_command
    self._cancellations.add(self._loop.create_task(self._cancel(waiter)))
                            ~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\surya\scoop\apps\python\current\Lib\asyncio\base_events.py", line 466, in create_task
    self._check_closed()
    ~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\surya\scoop\apps\python\current\Lib\asyncio\base_events.py", line 556, in 
_check_closed
    raise RuntimeError('Event loop is closed')
RuntimeError: Event loop is closed
ERROR:middleware.structured_logging:❌ Failed to log error to database: Event loop is closed
Traceback (most recent call last):
  File "C:\Users\surya\scoop\apps\python\current\Lib\asyncio\base_events.py", line 833, in call_soon
    self._check_closed()
    ~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\surya\scoop\apps\python\current\Lib\asyncio\base_events.py", line 556, in 
_check_closed
    raise RuntimeError('Event loop is closed')
RuntimeError: Event loop is closed

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "C:\Users\surya\projects\MH webapps\apps\backend\src\middleware\structured_logging.py", line 
148, in _log_error_to_database
    await db.commit()
  File 
"C:\Users\surya\scoop\apps\python\current\Lib\site-packages\sqlalchemy\ext\asyncio\session.py", line 
1014, in commit
    await greenlet_spawn(self.sync_session.commit)
  File 
"C:\Users\surya\scoop\apps\python\current\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", 
line 201, in greenlet_spawn
    result = context.throw(*sys.exc_info())
  File "C:\Users\surya\scoop\apps\python\current\Lib\site-packages\sqlalchemy\orm\session.py", line 
2032, in commit
    trans.commit(_to_root=True)
    ~~~~~~~~~~~~^^^^^^^^^^^^^^^
  File "<string>", line 2, in commit
  File "C:\Users\surya\scoop\apps\python\current\Lib\site-packages\sqlalchemy\orm\state_changes.py", 
line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\surya\scoop\apps\python\current\Lib\site-packages\sqlalchemy\orm\session.py", line 
1313, in commit
    self._prepare_impl()
    ~~~~~~~~~~~~~~~~~~^^
  File "<string>", line 2, in _prepare_impl
  File "C:\Users\surya\scoop\apps\python\current\Lib\site-packages\sqlalchemy\orm\state_changes.py", 
line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\surya\scoop\apps\python\current\Lib\site-packages\sqlalchemy\orm\session.py", line 
1288, in _prepare_impl
    self.session.flush()
    ~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\surya\scoop\apps\python\current\Lib\site-packages\sqlalchemy\orm\session.py", line 
4345, in flush
    self._flush(objects)
    ~~~~~~~~~~~^^^^^^^^^
  File "C:\Users\surya\scoop\apps\python\current\Lib\site-packages\sqlalchemy\orm\session.py", line 
4480, in _flush
    with util.safe_reraise():
         ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\surya\scoop\apps\python\current\Lib\site-packages\sqlalchemy\util\langhelpers.py", 
line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "C:\Users\surya\scoop\apps\python\current\Lib\site-packages\sqlalchemy\orm\session.py", line 
4441, in _flush
    flush_context.execute()
    ~~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\surya\scoop\apps\python\current\Lib\site-packages\sqlalchemy\orm\unitofwork.py", 
line 466, in execute
    rec.execute(self)
    ~~~~~~~~~~~^^^^^^
  File "C:\Users\surya\scoop\apps\python\current\Lib\site-packages\sqlalchemy\orm\unitofwork.py", 
line 642, in execute
    util.preloaded.orm_persistence.save_obj(
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        self.mapper,
        ^^^^^^^^^^^^
        uow.states_for_mapper_hierarchy(self.mapper, False, False),
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
        uow,
        ^^^^
    )
    ^
  File "C:\Users\surya\scoop\apps\python\current\Lib\site-packages\sqlalchemy\orm\persistence.py", 
line 68, in save_obj
    ) in _organize_states_for_save(base_mapper, states, uowtransaction):
         ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\surya\scoop\apps\python\current\Lib\site-packages\sqlalchemy\orm\persistence.py", 
line 223, in _organize_states_for_save
    for state, dict_, mapper, connection in _connections_for_states(
                                            ~~~~~~~~~~~~~~~~~~~~~~~^
        base_mapper, uowtransaction, states
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    ):
    ^
  File "C:\Users\surya\scoop\apps\python\current\Lib\site-packages\sqlalchemy\orm\persistence.py", 
line 1753, in _connections_for_states
    connection = uowtransaction.transaction.connection(base_mapper)
  File "<string>", line 2, in connection
  File "C:\Users\surya\scoop\apps\python\current\Lib\site-packages\sqlalchemy\orm\state_changes.py", 
line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\surya\scoop\apps\python\current\Lib\site-packages\sqlalchemy\orm\session.py", line 
1039, in connection
    return self._connection_for_bind(bind, execution_options)
           ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^
  File "<string>", line 2, in _connection_for_bind
  File "C:\Users\surya\scoop\apps\python\current\Lib\site-packages\sqlalchemy\orm\state_changes.py", 
line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\surya\scoop\apps\python\current\Lib\site-packages\sqlalchemy\orm\session.py", line 
1175, in _connection_for_bind
    conn = self._parent._connection_for_bind(
        bind, execution_options
    )
  File "<string>", line 2, in _connection_for_bind
  File "C:\Users\surya\scoop\apps\python\current\Lib\site-packages\sqlalchemy\orm\state_changes.py", 
line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\surya\scoop\apps\python\current\Lib\site-packages\sqlalchemy\orm\session.py", line 
1189, in _connection_for_bind
    conn = bind.connect()
  File "C:\Users\surya\scoop\apps\python\current\Lib\site-packages\sqlalchemy\engine\base.py", line 
3271, in connect
    return self._connection_cls(self)
           ~~~~~~~~~~~~~~~~~~~~^^^^^^
  File "C:\Users\surya\scoop\apps\python\current\Lib\site-packages\sqlalchemy\engine\base.py", line 
143, in __init__
    self._dbapi_connection = engine.raw_connection()
                             ~~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\surya\scoop\apps\python\current\Lib\site-packages\sqlalchemy\engine\base.py", line 
3295, in raw_connection
    return self.pool.connect()
           ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\surya\scoop\apps\python\current\Lib\site-packages\sqlalchemy\pool\base.py", line 
447, in connect
    return _ConnectionFairy._checkout(self)
           ~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^
  File "C:\Users\surya\scoop\apps\python\current\Lib\site-packages\sqlalchemy\pool\base.py", line 
1363, in _checkout
    with util.safe_reraise():
         ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\surya\scoop\apps\python\current\Lib\site-packages\sqlalchemy\util\langhelpers.py", 
line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "C:\Users\surya\scoop\apps\python\current\Lib\site-packages\sqlalchemy\pool\base.py", line 
1301, in _checkout
    result = pool._dialect._do_ping_w_event(
        fairy.dbapi_connection
    )
  File "C:\Users\surya\scoop\apps\python\current\Lib\site-packages\sqlalchemy\engine\default.py", 
line 721, in _do_ping_w_event
    return self.do_ping(dbapi_connection)
           ~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^
  File "C:\Users\surya\scoop\apps\python\current\Lib\site-packages\sqlalchemy\dialects\postgresql\asyn
cpg.py", line 1166, in do_ping
    dbapi_connection.ping()
    ~~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\surya\scoop\apps\python\current\Lib\site-packages\sqlalchemy\dialects\postgresql\asyn
cpg.py", line 813, in ping
    self._handle_exception(error)
    ~~~~~~~~~~~~~~~~~~~~~~^^^^^^^
  File "C:\Users\surya\scoop\apps\python\current\Lib\site-packages\sqlalchemy\dialects\postgresql\asyn
cpg.py", line 794, in _handle_exception
    raise error
  File "C:\Users\surya\scoop\apps\python\current\Lib\site-packages\sqlalchemy\dialects\postgresql\asyn
cpg.py", line 811, in ping
    _ = self.await_(self._async_ping())
  File 
"C:\Users\surya\scoop\apps\python\current\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", 
line 132, in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^
  File 
"C:\Users\surya\scoop\apps\python\current\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", 
line 196, in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
  File "C:\Users\surya\scoop\apps\python\current\Lib\site-packages\sqlalchemy\dialects\postgresql\asyn
cpg.py", line 820, in _async_ping
    await tr.start()
  File "C:\Users\surya\scoop\apps\python\current\Lib\site-packages\asyncpg\transaction.py", line 146, 
in start
    await self._connection.execute(query)
  File "C:\Users\surya\scoop\apps\python\current\Lib\site-packages\asyncpg\connection.py", line 349, 
in execute
    result = await self._protocol.query(query, timeout)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "asyncpg\\protocol\\protocol.pyx", line 375, in query
  File "asyncpg\\protocol\\protocol.pyx", line 368, in asyncpg.protocol.protocol.BaseProtocol.query
  File "asyncpg\\protocol\\coreproto.pyx", line 1174, in 
asyncpg.protocol.protocol.CoreProtocol._simple_query
  File "asyncpg\\protocol\\protocol.pyx", line 967, in asyncpg.protocol.protocol.BaseProtocol._write
  File "C:\Users\surya\scoop\apps\python\current\Lib\asyncio\sslproto.py", line 222, in write
    self._ssl_protocol._write_appdata((data,))
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^
  File "C:\Users\surya\scoop\apps\python\current\Lib\asyncio\sslproto.py", line 700, in _write_appdata
    self._fatal_error(ex, 'Fatal error on SSL protocol')
    ~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\surya\scoop\apps\python\current\Lib\asyncio\sslproto.py", line 918, in _fatal_error
    self._transport._force_close(exc)
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^
  File "C:\Users\surya\scoop\apps\python\current\Lib\asyncio\proactor_events.py", line 152, in 
_force_close
    self._loop.call_soon(self._call_connection_lost, exc)
    ~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\surya\scoop\apps\python\current\Lib\asyncio\base_events.py", line 833, in call_soon
    self._check_closed()
    ~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\surya\scoop\apps\python\current\Lib\asyncio\base_events.py", line 556, in 
_check_closed
    raise RuntimeError('Event loop is closed')
RuntimeError: Event loop is closed
INFO:httpx:HTTP Request: GET http://testserver/api/admin/kpis "HTTP/1.1 401 Unauthorized"
INFO:middleware.structured_logging:→ GET /api/admin/stations/ [c47cf9dd-14cc-490d-b311-2816e0532d23] 
from testclient user=anonymous
INFO:core.middleware:GET /api/admin/stations/
WARNING:core.exceptions:Client error: Authentication required
INFO:core.middleware:GET /api/admin/stations/ - 401
WARNING:middleware.structured_logging:⚠️ GET /api/admin/stations/ 
[c47cf9dd-14cc-490d-b311-2816e0532d23] → 401 in 0ms user=anonymous
  ✅ GET /api/payments/analytics requires auth

======================================================================
  8. ADMIN PANEL FEATURES
======================================================================
  ✅ GET /api/admin/kpis requires auth
2025-11-05 13:55:28,492 INFO sqlalchemy.engine.Engine BEGIN (implicit)
INFO:sqlalchemy.engine.Engine:BEGIN (implicit)
2025-11-05 13:55:28,493 INFO sqlalchemy.engine.Engine INSERT INTO error_logs (correlation_id, timestamp, method, path, client_ip, user_id, user_role, error_type, error_message, error_traceback, status_code, request_body, request_headers, user_agent, response_time_ms, level, resolved, resolved_at, resolved_by, resolution_notes) VALUES ($1::VARCHAR, $2::TIMESTAMP WITHOUT TIME ZONE, $3::VARCHAR, $4::VARCHAR, $5::VARCHAR, $6::INTEGER, $7::VARCHAR, $8::VARCHAR, $9::VARCHAR, $10::VARCHAR, $11::INTEGER, $12::VARCHAR, $13::VARCHAR, $14::VARCHAR, $15::INTEGER, $16::VARCHAR, $17::INTEGER, $18::TIMESTAMP WITHOUT TIME ZONE, $19::INTEGER, $20::VARCHAR) RETURNING error_logs.id
INFO:sqlalchemy.engine.Engine:INSERT INTO error_logs (correlation_id, timestamp, method, path, 
client_ip, user_id, user_role, error_type, error_message, error_traceback, status_code, request_body, 
request_headers, user_agent, response_time_ms, level, resolved, resolved_at, resolved_by, 
resolution_notes) VALUES ($1::VARCHAR, $2::TIMESTAMP WITHOUT TIME ZONE, $3::VARCHAR, $4::VARCHAR, 
$5::VARCHAR, $6::INTEGER, $7::VARCHAR, $8::VARCHAR, $9::VARCHAR, $10::VARCHAR, $11::INTEGER, 
$12::VARCHAR, $13::VARCHAR, $14::VARCHAR, $15::INTEGER, $16::VARCHAR, $17::INTEGER, $18::TIMESTAMP 
WITHOUT TIME ZONE, $19::INTEGER, $20::VARCHAR) RETURNING error_logs.id
2025-11-05 13:55:28,493 INFO sqlalchemy.engine.Engine [cached since 8.126s ago] ('c47cf9dd-14cc-490d-b311-2816e0532d23', datetime.datetime(2025, 11, 5, 21, 55, 28, 493070), 'GET', '/api/admin/stations/', 'testclient', None, None, 'Exception', 'HTTP 401', 'NoneType: None\n', 401, None, '{"host": "testserver", "accept": "*/*", "accept-encoding": "gzip, deflate", "connection": "keep-alive", "user-agent": "testclient"}', 'testclient', 0, 'WARNING', 0, None, None, None)
INFO:sqlalchemy.engine.Engine:[cached since 8.126s ago] ('c47cf9dd-14cc-490d-b311-2816e0532d23', 
datetime.datetime(2025, 11, 5, 21, 55, 28, 493070), 'GET', '/api/admin/stations/', 'testclient', 
None, None, 'Exception', 'HTTP 401', 'NoneType: None\n', 401, None, '{"host": "testserver", "accept": 
"*/*", "accept-encoding": "gzip, deflate", "connection": "keep-alive", "user-agent": "testclient"}', 
'testclient', 0, 'WARNING', 0, None, None, None)
2025-11-05 13:55:28,865 INFO sqlalchemy.engine.Engine COMMIT
INFO:sqlalchemy.engine.Engine:COMMIT
INFO:middleware.structured_logging:📝 Error logged to database with correlation ID: 
c47cf9dd-14cc-490d-b311-2816e0532d23
INFO:httpx:HTTP Request: GET http://testserver/api/admin/stations/ "HTTP/1.1 401 Unauthorized"
INFO:middleware.structured_logging:→ GET /api/v1/ai/health [28130bd8-11a0-4e96-84fe-974a762d8117] 
from testclient user=anonymous
INFO:core.middleware:GET /api/v1/ai/health
INFO:api.ai.endpoints.services.knowledge_base_simple:KnowledgeBase: Initializing production knowledge 
base service
INFO:api.ai.endpoints.services.knowledge_base_simple:KnowledgeBase: Loaded 21 business knowledge 
chunks (business + admin system)
INFO:core.middleware:GET /api/v1/ai/health - 200
INFO:middleware.structured_logging:✅ GET /api/v1/ai/health [28130bd8-11a0-4e96-84fe-974a762d8117] → 
200 in 0ms user=anonymous
INFO:httpx:HTTP Request: GET http://testserver/api/v1/ai/health "HTTP/1.1 200 OK"
INFO:middleware.structured_logging:→ POST /api/v1/ai/chat [4507ef8c-def1-4c1c-8673-eeb60c912a25] from 
testclient user=anonymous
INFO:core.middleware:POST /api/v1/ai/chat
INFO:api.ai.endpoints.services.customer_booking_ai:Customer AI processing message: 'Hello...' with 
context: {'user_id': None, 'user_role': <UserRole.CUSTOMER: 'customer'>, 'channel': 'web', 
'conversation_id': '76437ea2-8f00-422f-8962-5f720792b737'}
INFO:api.ai.endpoints.services.customer_booking_ai:OpenAI client available, attempting to generate 
response
INFO:api.ai.endpoints.services.intelligent_model_router:Model selected: gpt-3.5-turbo (score: 3.0, 
reason: simple_faq_query)
INFO:api.ai.endpoints.services.customer_booking_ai:🎯 Model selection: gpt-3.5-turbo (complexity: 
3.0, cost: low)
INFO:api.ai.endpoints.services.customer_booking_ai:OpenAI response received: ("I'm having trouble 
accessing my knowledge right now. Please contact our team directly for immediate assistance with your 
hibachi catering needs.", 0.2, 'error', 0, 0, 0.0)
INFO:api.ai.endpoints.services.customer_booking_ai:Using OpenAI response: I'm having trouble 
accessing my knowledge right now. Please contact our team directly for immediate ... (time: 0ms, 
model: error, cost: $0.000000)
INFO:api.ai.endpoints.routers.chat:AI Chat - Role: customer, Intent: customer_service, Channel: web
INFO:core.middleware:POST /api/v1/ai/chat - 200
INFO:middleware.structured_logging:✅ POST /api/v1/ai/chat [4507ef8c-def1-4c1c-8673-eeb60c912a25] → 
200 in 3ms user=anonymous
INFO:httpx:HTTP Request: POST http://testserver/api/v1/ai/chat "HTTP/1.1 200 OK"
INFO:middleware.structured_logging:→ GET /health [e390abd9-fe5e-41ef-8b58-30585f8fec33] from 
testclient user=anonymous
INFO:core.middleware:GET /health
INFO:core.middleware:GET /health - 200
INFO:middleware.structured_logging:✅ GET /health [e390abd9-fe5e-41ef-8b58-30585f8fec33] → 200 in 0ms 
user=anonymous
INFO:httpx:HTTP Request: GET http://testserver/health "HTTP/1.1 200 OK"
INFO:middleware.structured_logging:→ GET /api/nonexistent-route-xyz-123 
[db1e4187-dccf-46ac-a422-4dc801a396e5] from testclient user=anonymous
INFO:core.middleware:GET /api/nonexistent-route-xyz-123
C:\Users\surya\scoop\apps\python\current\Lib\contextlib.py:716: RuntimeWarning: coroutine 
'Connection._cancel' was never awaited
  async def __aexit__(self, *exc_details):
RuntimeWarning: Enable tracemalloc to get the object allocation traceback
WARNING:core.exceptions:Client error: Not authenticated
INFO:core.middleware:GET /api/nonexistent-route-xyz-123 - 403
WARNING:middleware.structured_logging:⚠️ GET /api/nonexistent-route-xyz-123 
[db1e4187-dccf-46ac-a422-4dc801a396e5] → 403 in 1ms user=anonymous
ERROR:sqlalchemy.pool.impl.AsyncAdaptedQueuePool:Exception terminating connection <AdaptedConnection 
<asyncpg.connection.Connection object at 0x0000027939501A90>>
Traceback (most recent call last):
  File "C:\Users\surya\scoop\apps\python\current\Lib\site-packages\sqlalchemy\pool\base.py", line 
372, in _close_connection
    self._dialect.do_terminate(connection)
    ~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^
  File "C:\Users\surya\scoop\apps\python\current\Lib\site-packages\sqlalchemy\dialects\postgresql\asyn
cpg.py", line 1133, in do_terminate
    dbapi_connection.terminate()
    ~~~~~~~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\surya\scoop\apps\python\current\Lib\site-packages\sqlalchemy\dialects\postgresql\asyn
cpg.py", line 907, in terminate
    self.await_(asyncio.shield(self._connection.close(timeout=2)))
    ~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File 
"C:\Users\surya\scoop\apps\python\current\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", 
line 132, in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^
  File 
"C:\Users\surya\scoop\apps\python\current\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", 
line 196, in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
  File "C:\Users\surya\scoop\apps\python\current\Lib\site-packages\asyncpg\connection.py", line 1504, 
in close
    await self._protocol.close(timeout)
  File "asyncpg\\protocol\\protocol.pyx", line 627, in close
  File "asyncpg\\protocol\\protocol.pyx", line 660, in 
asyncpg.protocol.protocol.BaseProtocol._request_cancel
  File "C:\Users\surya\scoop\apps\python\current\Lib\site-packages\asyncpg\connection.py", line 1673, 
in _cancel_current_command
    self._cancellations.add(self._loop.create_task(self._cancel(waiter)))
                            ~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\surya\scoop\apps\python\current\Lib\asyncio\base_events.py", line 466, in create_task
    self._check_closed()
    ~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\surya\scoop\apps\python\current\Lib\asyncio\base_events.py", line 556, in 
_check_closed
    raise RuntimeError('Event loop is closed')
RuntimeError: Event loop is closed
ERROR:middleware.structured_logging:❌ Failed to log error to database: Event loop is closed
Traceback (most recent call last):
  File "C:\Users\surya\scoop\apps\python\current\Lib\asyncio\base_events.py", line 833, in call_soon
    self._check_closed()
    ~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\surya\scoop\apps\python\current\Lib\asyncio\base_events.py", line 556, in 
_check_closed
    raise RuntimeError('Event loop is closed')
RuntimeError: Event loop is closed

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "C:\Users\surya\projects\MH webapps\apps\backend\src\middleware\structured_logging.py", line 
148, in _log_error_to_database
    await db.commit()
  File 
"C:\Users\surya\scoop\apps\python\current\Lib\site-packages\sqlalchemy\ext\asyncio\session.py", line 
1014, in commit
    await greenlet_spawn(self.sync_session.commit)
  File 
"C:\Users\surya\scoop\apps\python\current\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", 
line 201, in greenlet_spawn
    result = context.throw(*sys.exc_info())
  File "C:\Users\surya\scoop\apps\python\current\Lib\site-packages\sqlalchemy\orm\session.py", line 
2032, in commit
    trans.commit(_to_root=True)
    ~~~~~~~~~~~~^^^^^^^^^^^^^^^
  File "<string>", line 2, in commit
  File "C:\Users\surya\scoop\apps\python\current\Lib\site-packages\sqlalchemy\orm\state_changes.py", 
line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\surya\scoop\apps\python\current\Lib\site-packages\sqlalchemy\orm\session.py", line 
1313, in commit
    self._prepare_impl()
    ~~~~~~~~~~~~~~~~~~^^
  File "<string>", line 2, in _prepare_impl
  File "C:\Users\surya\scoop\apps\python\current\Lib\site-packages\sqlalchemy\orm\state_changes.py", 
line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\surya\scoop\apps\python\current\Lib\site-packages\sqlalchemy\orm\session.py", line 
1288, in _prepare_impl
    self.session.flush()
    ~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\surya\scoop\apps\python\current\Lib\site-packages\sqlalchemy\orm\session.py", line 
4345, in flush
    self._flush(objects)
    ~~~~~~~~~~~^^^^^^^^^
  File "C:\Users\surya\scoop\apps\python\current\Lib\site-packages\sqlalchemy\orm\session.py", line 
4480, in _flush
    with util.safe_reraise():
         ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\surya\scoop\apps\python\current\Lib\site-packages\sqlalchemy\util\langhelpers.py", 
line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "C:\Users\surya\scoop\apps\python\current\Lib\site-packages\sqlalchemy\orm\session.py", line 
4441, in _flush
    flush_context.execute()
    ~~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\surya\scoop\apps\python\current\Lib\site-packages\sqlalchemy\orm\unitofwork.py", 
line 466, in execute
    rec.execute(self)
    ~~~~~~~~~~~^^^^^^
  File "C:\Users\surya\scoop\apps\python\current\Lib\site-packages\sqlalchemy\orm\unitofwork.py", 
line 642, in execute
    util.preloaded.orm_persistence.save_obj(
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        self.mapper,
        ^^^^^^^^^^^^
        uow.states_for_mapper_hierarchy(self.mapper, False, False),
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
        uow,
        ^^^^
    )
    ^
  File "C:\Users\surya\scoop\apps\python\current\Lib\site-packages\sqlalchemy\orm\persistence.py", 
line 68, in save_obj
    ) in _organize_states_for_save(base_mapper, states, uowtransaction):
         ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\surya\scoop\apps\python\current\Lib\site-packages\sqlalchemy\orm\persistence.py", 
line 223, in _organize_states_for_save
    for state, dict_, mapper, connection in _connections_for_states(
                                            ~~~~~~~~~~~~~~~~~~~~~~~^
        base_mapper, uowtransaction, states
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    ):
    ^
  File "C:\Users\surya\scoop\apps\python\current\Lib\site-packages\sqlalchemy\orm\persistence.py", 
line 1753, in _connections_for_states
    connection = uowtransaction.transaction.connection(base_mapper)
  File "<string>", line 2, in connection
  File "C:\Users\surya\scoop\apps\python\current\Lib\site-packages\sqlalchemy\orm\state_changes.py", 
line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\surya\scoop\apps\python\current\Lib\site-packages\sqlalchemy\orm\session.py", line 
1039, in connection
    return self._connection_for_bind(bind, execution_options)
           ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^
  File "<string>", line 2, in _connection_for_bind
  File "C:\Users\surya\scoop\apps\python\current\Lib\site-packages\sqlalchemy\orm\state_changes.py", 
line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\surya\scoop\apps\python\current\Lib\site-packages\sqlalchemy\orm\session.py", line 
1175, in _connection_for_bind
    conn = self._parent._connection_for_bind(
        bind, execution_options
    )
  File "<string>", line 2, in _connection_for_bind
  File "C:\Users\surya\scoop\apps\python\current\Lib\site-packages\sqlalchemy\orm\state_changes.py", 
line 137, in _go
    ret_value = fn(self, *arg, **kw)
  File "C:\Users\surya\scoop\apps\python\current\Lib\site-packages\sqlalchemy\orm\session.py", line 
1189, in _connection_for_bind
    conn = bind.connect()
  File "C:\Users\surya\scoop\apps\python\current\Lib\site-packages\sqlalchemy\engine\base.py", line 
3271, in connect
    return self._connection_cls(self)
           ~~~~~~~~~~~~~~~~~~~~^^^^^^
  File "C:\Users\surya\scoop\apps\python\current\Lib\site-packages\sqlalchemy\engine\base.py", line 
143, in __init__
    self._dbapi_connection = engine.raw_connection()
                             ~~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\surya\scoop\apps\python\current\Lib\site-packages\sqlalchemy\engine\base.py", line 
3295, in raw_connection
    return self.pool.connect()
           ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\surya\scoop\apps\python\current\Lib\site-packages\sqlalchemy\pool\base.py", line 
447, in connect
    return _ConnectionFairy._checkout(self)
           ~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^
  File "C:\Users\surya\scoop\apps\python\current\Lib\site-packages\sqlalchemy\pool\base.py", line 
1363, in _checkout
    with util.safe_reraise():
         ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\surya\scoop\apps\python\current\Lib\site-packages\sqlalchemy\util\langhelpers.py", 
line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "C:\Users\surya\scoop\apps\python\current\Lib\site-packages\sqlalchemy\pool\base.py", line 
1301, in _checkout
    result = pool._dialect._do_ping_w_event(
        fairy.dbapi_connection
    )
  File "C:\Users\surya\scoop\apps\python\current\Lib\site-packages\sqlalchemy\engine\default.py", 
line 721, in _do_ping_w_event
    return self.do_ping(dbapi_connection)
           ~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^
  File "C:\Users\surya\scoop\apps\python\current\Lib\site-packages\sqlalchemy\dialects\postgresql\asyn
cpg.py", line 1166, in do_ping
    dbapi_connection.ping()
    ~~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\surya\scoop\apps\python\current\Lib\site-packages\sqlalchemy\dialects\postgresql\asyn
cpg.py", line 813, in ping
    self._handle_exception(error)
    ~~~~~~~~~~~~~~~~~~~~~~^^^^^^^
  File "C:\Users\surya\scoop\apps\python\current\Lib\site-packages\sqlalchemy\dialects\postgresql\asyn
cpg.py", line 794, in _handle_exception
    raise error
  File "C:\Users\surya\scoop\apps\python\current\Lib\site-packages\sqlalchemy\dialects\postgresql\asyn
cpg.py", line 811, in ping
    _ = self.await_(self._async_ping())
  File 
"C:\Users\surya\scoop\apps\python\current\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", 
line 132, in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^
  File 
"C:\Users\surya\scoop\apps\python\current\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", 
line 196, in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
  File "C:\Users\surya\scoop\apps\python\current\Lib\site-packages\sqlalchemy\dialects\postgresql\asyn
cpg.py", line 820, in _async_ping
    await tr.start()
  File "C:\Users\surya\scoop\apps\python\current\Lib\site-packages\asyncpg\transaction.py", line 146, 
in start
    await self._connection.execute(query)
  File "C:\Users\surya\scoop\apps\python\current\Lib\site-packages\asyncpg\connection.py", line 349, 
in execute
    result = await self._protocol.query(query, timeout)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "asyncpg\\protocol\\protocol.pyx", line 375, in query
  File "asyncpg\\protocol\\protocol.pyx", line 368, in asyncpg.protocol.protocol.BaseProtocol.query
  File "asyncpg\\protocol\\coreproto.pyx", line 1174, in 
asyncpg.protocol.protocol.CoreProtocol._simple_query
  File "asyncpg\\protocol\\protocol.pyx", line 967, in asyncpg.protocol.protocol.BaseProtocol._write
  File "C:\Users\surya\scoop\apps\python\current\Lib\asyncio\sslproto.py", line 222, in write
    self._ssl_protocol._write_appdata((data,))
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^
  File "C:\Users\surya\scoop\apps\python\current\Lib\asyncio\sslproto.py", line 700, in _write_appdata
    self._fatal_error(ex, 'Fatal error on SSL protocol')
    ~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\surya\scoop\apps\python\current\Lib\asyncio\sslproto.py", line 918, in _fatal_error
    self._transport._force_close(exc)
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^
  File "C:\Users\surya\scoop\apps\python\current\Lib\asyncio\proactor_events.py", line 152, in 
_force_close
    self._loop.call_soon(self._call_connection_lost, exc)
    ~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\surya\scoop\apps\python\current\Lib\asyncio\base_events.py", line 833, in call_soon
    self._check_closed()
    ~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\surya\scoop\apps\python\current\Lib\asyncio\base_events.py", line 556, in 
_check_closed
    raise RuntimeError('Event loop is closed')
RuntimeError: Event loop is closed
INFO:httpx:HTTP Request: GET http://testserver/api/nonexistent-route-xyz-123 "HTTP/1.1 403 Forbidden"
INFO:middleware.structured_logging:→ POST /api/auth/login [ab9d3fd5-1879-4275-b529-a734098756a7] from 
testclient user=anonymous
INFO:core.middleware:POST /api/auth/login
WARNING:core.exceptions:Client error: Request validation failed
INFO:core.middleware:POST /api/auth/login - 422
WARNING:middleware.structured_logging:⚠️ POST /api/auth/login [ab9d3fd5-1879-4275-b529-a734098756a7] 
→ 422 in 0ms user=anonymous
  ✅ GET /api/admin/stations/ requires auth

======================================================================
  9. AI CHAT SYSTEM
======================================================================
  ✅ GET /api/v1/ai/health returns 200
  ✅ POST /api/v1/ai/chat endpoint exists

======================================================================
  10. CQRS ARCHITECTURE VALIDATION
======================================================================
  ❌ Booking commands instantiate correctly: ValidationError: 1 validation error for UpdateBookingCommand
updated_by
  Input should be a valid string [type=string_type, input_value=UUID('e27eac06-9e89-4268-9230-70dfb5994295'), input_type=UUID]
    For further information visit https://errors.pydantic.dev/2.11/v/string_type
  ✅ Booking queries instantiate correctly
  ✅ Lead commands instantiate correctly

======================================================================
  11. MULTI-TENANT STATION SYSTEM
======================================================================
  ✅ StationAuthenticationService instantiates
  ✅ StationContext works correctly
  ✅ Station permissions configured correctly

======================================================================
  12. MIDDLEWARE STACK VALIDATION
======================================================================
  ✅ Middleware stack configured
  ✅ Structured logging available

======================================================================
  13. DATABASE MODELS
======================================================================
  ✅ User model defined
  ❌ Booking model defined: 
  ❌ Lead model defined: 
  ✅ Station models defined

======================================================================
  14. API RESPONSE CONSISTENCY
======================================================================
  ✅ ApiResponse format correct
  ✅ Health endpoint response structure

======================================================================
  15. ROUTE REGISTRATION
======================================================================
  ✅ All critical routes registered

======================================================================
  16. ERROR HANDLING
======================================================================
  ✅ 404 errors handled gracefully
2025-11-05 13:55:30,155 INFO sqlalchemy.engine.Engine BEGIN (implicit)
2025-11-05 13:55:30,155 INFO sqlalchemy.engine.Engine INSERT INTO error_logs (correlation_id, timestamp, method, path, client_ip, user_id, user_role, error_type, error_message, error_traceback, status_code, request_body, request_headers, user_agent, response_time_ms, level, resolved, resolved_at, resolved_by, resolution_notes) VALUES ($1::VARCHAR, $2::TIMESTAMP WITHOUT TIME ZONE, $3::VARCHAR, $4::VARCHAR, $5::VARCHAR, $6::INTEGER, $7::VARCHAR, $8::VARCHAR, $9::VARCHAR, $10::VARCHAR, $11::INTEGER, $12::VARCHAR, $13::VARCHAR, $14::VARCHAR, $15::INTEGER, $16::VARCHAR, $17::INTEGER, $18::TIMESTAMP WITHOUT TIME ZONE, $19::INTEGER, $20::VARCHAR) RETURNING error_logs.id
2025-11-05 13:55:30,155 INFO sqlalchemy.engine.Engine [cached since 9.788s ago] ('ab9d3fd5-1879-4275-b529-a734098756a7', datetime.datetime(2025, 11, 5, 21, 55, 30, 155359), 'POST', '/api/auth/login', 'testclient', None, None, 'Exception', 'HTTP 422', 'NoneType: None\n', 422, '{"invalid": "data"}', '{"host": "testserver", "accept": "*/*", "accept-encoding": "gzip, deflate", "connection": "keep-alive", "user-agent": "testclient", "content-length": "19", "content-type": "application/json"}', 'testclient', 0, 'WARNING', 0, None, None, None)
INFO:sqlalchemy.engine.Engine:BEGIN (implicit)
INFO:sqlalchemy.engine.Engine:INSERT INTO error_logs (correlation_id, timestamp, method, path, 
client_ip, user_id, user_role, error_type, error_message, error_traceback, status_code, request_body, 
request_headers, user_agent, response_time_ms, level, resolved, resolved_at, resolved_by, 
resolution_notes) VALUES ($1::VARCHAR, $2::TIMESTAMP WITHOUT TIME ZONE, $3::VARCHAR, $4::VARCHAR, 
$5::VARCHAR, $6::INTEGER, $7::VARCHAR, $8::VARCHAR, $9::VARCHAR, $10::VARCHAR, $11::INTEGER, 
$12::VARCHAR, $13::VARCHAR, $14::VARCHAR, $15::INTEGER, $16::VARCHAR, $17::INTEGER, $18::TIMESTAMP 
WITHOUT TIME ZONE, $19::INTEGER, $20::VARCHAR) RETURNING error_logs.id
INFO:sqlalchemy.engine.Engine:[cached since 9.788s ago] ('ab9d3fd5-1879-4275-b529-a734098756a7', 
datetime.datetime(2025, 11, 5, 21, 55, 30, 155359), 'POST', '/api/auth/login', 'testclient', None, 
None, 'Exception', 'HTTP 422', 'NoneType: None\n', 422, '{"invalid": "data"}', '{"host": 
"testserver", "accept": "*/*", "accept-encoding": "gzip, deflate", "connection": "keep-alive", 
"user-agent": "testclient", "content-length": "19", "content-type": "application/json"}', 
'testclient', 0, 'WARNING', 0, None, None, None)
2025-11-05 13:55:30,507 INFO sqlalchemy.engine.Engine COMMIT
INFO:sqlalchemy.engine.Engine:COMMIT
INFO:middleware.structured_logging:📝 Error logged to database with correlation ID: 
ab9d3fd5-1879-4275-b529-a734098756a7
INFO:httpx:HTTP Request: POST http://testserver/api/auth/login "HTTP/1.1 422 Unprocessable Entity"
WARNING:passlib.handlers.bcrypt:(trapped) error reading bcrypt version
Traceback (most recent call last):
  File "C:\Users\surya\scoop\apps\python\current\Lib\site-packages\passlib\handlers\bcrypt.py", line 
620, in _load_backend_mixin
    version = _bcrypt.__about__.__version__
              ^^^^^^^^^^^^^^^^^
AttributeError: module 'bcrypt' has no attribute '__about__'
  ❌ Validation errors formatted correctly: Missing error detail

======================================================================
  17. SECURITY FEATURES
======================================================================
  ✅ Field encryption works
  ✅ Password hashing works

======================================================================
  18. ENVIRONMENT CONFIGURATION
======================================================================
  ✅ Settings validation

======================================================================
  19. MIGRATION VALIDATION
======================================================================
  ✅ OLD api/app directory deleted
  ✅ No OLD imports in runtime code

======================================================================
  20. INTEGRATION VALIDATION
======================================================================
  ❌ Complete import chain works: ModuleNotFoundError: No module named 'api.app'
  ✅ No circular dependencies

======================================================================
  COMPREHENSIVE TEST SUMMARY
======================================================================
Total Tests: 48
Passed: 41 ✅
Failed: 7 ❌
Success Rate: 85.4%

======================================================================
  FAILURES:
======================================================================
  ❌ GET /api/leads/ requires auth: AttributeError: 'AsyncSession' object has no attribute 'query'
  ❌ GET /api/reviews/ responds: Status: 405
  ❌ Booking commands instantiate correctly: ValidationError: 1 validation error for UpdateBookingCommand
updated_by
  Input should be a valid string [type=string_type, input_value=UUID('e27eac06-9e89-4268-9230-70dfb5994295'), input_type=UUID]
    For further information visit https://errors.pydantic.dev/2.11/v/string_type
  ❌ Booking model defined: 
  ❌ Lead model defined: 
  ❌ Validation errors formatted correctly: Missing error detail
  ❌ Complete import chain works: ModuleNotFoundError: No module named 'api.app'
======================================================================

❌ TESTS FAILED - ISSUES FOUND
<sys>:0: RuntimeWarning: coroutine 'Connection._cancel' was never awaited
RuntimeWarning: Enable tracemalloc to get the object allocation traceback
