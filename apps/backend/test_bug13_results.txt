============================= test session starts =============================
platform win32 -- Python 3.13.5, pytest-8.4.2, pluggy-1.6.0 -- C:\Users\surya\scoop\apps\python\current\python.exe
cachedir: .pytest_cache
benchmark: 5.1.0 (defaults: timer=time.perf_counter disable_gc=False min_rounds=5 min_time=0.000005 max_time=1.0 calibration_precision=10 warmup=False warmup_iterations=100000)
rootdir: C:\Users\surya\projects\MH webapps\apps\backend
configfile: pyproject.toml
plugins: anyio-4.9.0, Faker-37.11.0, asyncio-1.2.0, benchmark-5.1.0, cov-6.2.1, httpx-0.35.0, typeguard-4.4.4
asyncio: mode=Mode.AUTO, debug=False, asyncio_default_fixture_loop_scope=function, asyncio_default_test_loop_scope=function
collecting ... collected 8 items

tests/test_race_condition_fix.py::TestRaceConditionFix::test_unique_constraint_prevents_double_booking ERROR [ 12%]
tests/test_race_condition_fix.py::TestRaceConditionFix::test_concurrent_booking_attempts_only_one_succeeds ERROR [ 25%]
tests/test_race_condition_fix.py::TestRaceConditionFix::test_select_for_update_row_locking ERROR [ 37%]
tests/test_race_condition_fix.py::TestRaceConditionFix::test_optimistic_locking_prevents_concurrent_updates ERROR [ 50%]
tests/test_race_condition_fix.py::TestRaceConditionFix::test_integrity_error_handling_and_user_message ERROR [ 62%]
tests/test_race_condition_fix.py::TestRaceConditionFix::test_cancelled_bookings_dont_block_new_bookings ERROR [ 75%]
tests/test_race_condition_fix.py::TestRaceConditionFix::test_high_concurrency_stress_test ERROR [ 87%]
tests/test_race_condition_fix.py::TestRaceConditionFix::test_race_condition_with_different_party_sizes ERROR [100%]

=================================== ERRORS ====================================
_ ERROR at setup of TestRaceConditionFix.test_unique_constraint_prevents_double_booking _
tests\test_race_condition_fix.py:54: in customer
    station = Station(
<string>:4: in __init__
    ???
..\..\..\..\scoop\apps\python\current\Lib\site-packages\sqlalchemy\orm\state.py:566: in _initialize_instance
    manager.dispatch.init(self, args, kwargs)
..\..\..\..\scoop\apps\python\current\Lib\site-packages\sqlalchemy\event\attr.py:497: in __call__
    fn(*args, **kw)
..\..\..\..\scoop\apps\python\current\Lib\site-packages\sqlalchemy\orm\mapper.py:4406: in _event_on_init
    instrumenting_mapper._check_configure()
..\..\..\..\scoop\apps\python\current\Lib\site-packages\sqlalchemy\orm\mapper.py:2401: in _check_configure
    _configure_registries({self.registry}, cascade=True)
..\..\..\..\scoop\apps\python\current\Lib\site-packages\sqlalchemy\orm\mapper.py:4214: in _configure_registries
    _do_configure_registries(registries, cascade)
..\..\..\..\scoop\apps\python\current\Lib\site-packages\sqlalchemy\orm\mapper.py:4255: in _do_configure_registries
    mapper._post_configure_properties()
..\..\..\..\scoop\apps\python\current\Lib\site-packages\sqlalchemy\orm\mapper.py:2418: in _post_configure_properties
    prop.init()
..\..\..\..\scoop\apps\python\current\Lib\site-packages\sqlalchemy\orm\interfaces.py:589: in init
    self.do_init()
..\..\..\..\scoop\apps\python\current\Lib\site-packages\sqlalchemy\orm\relationships.py:1661: in do_init
    self._generate_backref()
..\..\..\..\scoop\apps\python\current\Lib\site-packages\sqlalchemy\orm\relationships.py:2145: in _generate_backref
    self._add_reverse_property(self.back_populates)
..\..\..\..\scoop\apps\python\current\Lib\site-packages\sqlalchemy\orm\relationships.py:1613: in _add_reverse_property
    other._setup_entity()
..\..\..\..\scoop\apps\python\current\Lib\site-packages\sqlalchemy\orm\relationships.py:1866: in _setup_entity
    self._clsregistry_resolve_name(argument)(),
    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
..\..\..\..\scoop\apps\python\current\Lib\site-packages\sqlalchemy\orm\clsregistry.py:516: in _resolve_name
    rval = d[token]
           ^^^^^^^^
..\..\..\..\scoop\apps\python\current\Lib\site-packages\sqlalchemy\util\_collections.py:345: in __missing__
    self[key] = val = self.creator(key)
                      ^^^^^^^^^^^^^^^^^
..\..\..\..\scoop\apps\python\current\Lib\site-packages\sqlalchemy\orm\clsregistry.py:463: in _access_cls
    return _determine_container(key, decl_class_registry[key])
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
..\..\..\..\scoop\apps\python\current\Lib\site-packages\sqlalchemy\orm\clsregistry.py:409: in _determine_container
    value = value.attempt_get([], key)
            ^^^^^^^^^^^^^^^^^^^^^^^^^^
..\..\..\..\scoop\apps\python\current\Lib\site-packages\sqlalchemy\orm\clsregistry.py:219: in attempt_get
    raise exc.InvalidRequestError(
E   sqlalchemy.exc.InvalidRequestError: Multiple classes found for path "Booking" in the registry of this declarative base. Please use a fully module-qualified path.
---------------------------- Captured stdout setup ----------------------------
2025-11-27 14:03:44,531 INFO sqlalchemy.engine.Engine select pg_catalog.version()
2025-11-27 14:03:44,532 INFO sqlalchemy.engine.Engine [raw sql] ()
2025-11-27 14:03:44,896 INFO sqlalchemy.engine.Engine select current_schema()
2025-11-27 14:03:44,896 INFO sqlalchemy.engine.Engine [raw sql] ()
2025-11-27 14:03:45,271 INFO sqlalchemy.engine.Engine show standard_conforming_strings
2025-11-27 14:03:45,272 INFO sqlalchemy.engine.Engine [raw sql] ()
2025-11-27 14:03:45,550 INFO sqlalchemy.engine.Engine BEGIN (implicit)
2025-11-27 14:03:45,551 INFO sqlalchemy.engine.Engine SET search_path TO core, identity, public
2025-11-27 14:03:45,551 INFO sqlalchemy.engine.Engine [generated in 0.00012s] ()
---------------------------- Captured stderr setup ----------------------------
INFO:sqlalchemy.engine.Engine:select pg_catalog.version()
INFO:sqlalchemy.engine.Engine:[raw sql] ()
INFO:sqlalchemy.engine.Engine:select current_schema()
INFO:sqlalchemy.engine.Engine:[raw sql] ()
INFO:sqlalchemy.engine.Engine:show standard_conforming_strings
INFO:sqlalchemy.engine.Engine:[raw sql] ()
INFO:sqlalchemy.engine.Engine:BEGIN (implicit)
INFO:sqlalchemy.engine.Engine:SET search_path TO core, identity, public
INFO:sqlalchemy.engine.Engine:[generated in 0.00012s] ()
----------------------------- Captured log setup ------------------------------
INFO     sqlalchemy.engine.Engine:base.py:1842 select pg_catalog.version()
INFO     sqlalchemy.engine.Engine:base.py:1842 [raw sql] ()
INFO     sqlalchemy.engine.Engine:base.py:1842 select current_schema()
INFO     sqlalchemy.engine.Engine:base.py:1842 [raw sql] ()
INFO     sqlalchemy.engine.Engine:base.py:1842 show standard_conforming_strings
INFO     sqlalchemy.engine.Engine:base.py:1842 [raw sql] ()
INFO     sqlalchemy.engine.Engine:base.py:2698 BEGIN (implicit)
INFO     sqlalchemy.engine.Engine:base.py:1842 SET search_path TO core, identity, public
INFO     sqlalchemy.engine.Engine:base.py:1842 [generated in 0.00012s] ()
_ ERROR at setup of TestRaceConditionFix.test_concurrent_booking_attempts_only_one_succeeds _
..\..\..\..\scoop\apps\python\current\Lib\site-packages\pytest_asyncio\plugin.py:463: in setup
    return super().setup()
           ^^^^^^^^^^^^^^^
..\..\..\..\scoop\apps\python\current\Lib\site-packages\pytest_asyncio\plugin.py:748: in pytest_fixture_setup
    hook_result = yield
                  ^^^^^
..\..\..\..\scoop\apps\python\current\Lib\site-packages\pytest_asyncio\plugin.py:318: in _asyncgen_fixture_wrapper
    result = runner.run(setup(), context=context)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
..\..\..\..\scoop\apps\python\current\Lib\asyncio\runners.py:118: in run
    return self._loop.run_until_complete(task)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
..\..\..\..\scoop\apps\python\current\Lib\asyncio\base_events.py:725: in run_until_complete
    return future.result()
           ^^^^^^^^^^^^^^^
..\..\..\..\scoop\apps\python\current\Lib\site-packages\pytest_asyncio\plugin.py:314: in setup
    res = await gen_obj.__anext__()
          ^^^^^^^^^^^^^^^^^^^^^^^^^
tests\conftest.py:183: in db_session
    await session.execute(text("SET search_path TO core, identity, public"))
..\..\..\..\scoop\apps\python\current\Lib\site-packages\sqlalchemy\ext\asyncio\session.py:463: in execute
    result = await greenlet_spawn(
..\..\..\..\scoop\apps\python\current\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
..\..\..\..\scoop\apps\python\current\Lib\site-packages\sqlalchemy\orm\session.py:2365: in execute
    return self._execute_internal(
..\..\..\..\scoop\apps\python\current\Lib\site-packages\sqlalchemy\orm\session.py:2241: in _execute_internal
    conn = self._connection_for_bind(bind)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
..\..\..\..\scoop\apps\python\current\Lib\site-packages\sqlalchemy\orm\session.py:2110: in _connection_for_bind
    return trans._connection_for_bind(engine, execution_options)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
..\..\..\..\scoop\apps\python\current\Lib\site-packages\sqlalchemy\orm\state_changes.py:139: in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
..\..\..\..\scoop\apps\python\current\Lib\site-packages\sqlalchemy\orm\session.py:1189: in _connection_for_bind
    conn = bind.connect()
           ^^^^^^^^^^^^^^
..\..\..\..\scoop\apps\python\current\Lib\site-packages\sqlalchemy\engine\base.py:3273: in connect
    return self._connection_cls(self)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
..\..\..\..\scoop\apps\python\current\Lib\site-packages\sqlalchemy\engine\base.py:145: in __init__
    self._dbapi_connection = engine.raw_connection()
                             ^^^^^^^^^^^^^^^^^^^^^^^
..\..\..\..\scoop\apps\python\current\Lib\site-packages\sqlalchemy\engine\base.py:3297: in raw_connection
    return self.pool.connect()
           ^^^^^^^^^^^^^^^^^^^
..\..\..\..\scoop\apps\python\current\Lib\site-packages\sqlalchemy\pool\base.py:449: in connect
    return _ConnectionFairy._checkout(self)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
..\..\..\..\scoop\apps\python\current\Lib\site-packages\sqlalchemy\pool\base.py:1363: in _checkout
    with util.safe_reraise():
         ^^^^^^^^^^^^^^^^^^^
..\..\..\..\scoop\apps\python\current\Lib\site-packages\sqlalchemy\util\langhelpers.py:224: in __exit__
    raise exc_value.with_traceback(exc_tb)
..\..\..\..\scoop\apps\python\current\Lib\site-packages\sqlalchemy\pool\base.py:1301: in _checkout
    result = pool._dialect._do_ping_w_event(
..\..\..\..\scoop\apps\python\current\Lib\site-packages\sqlalchemy\engine\default.py:720: in _do_ping_w_event
    return self.do_ping(dbapi_connection)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
..\..\..\..\scoop\apps\python\current\Lib\site-packages\sqlalchemy\dialects\postgresql\asyncpg.py:1163: in do_ping
    dbapi_connection.ping()
..\..\..\..\scoop\apps\python\current\Lib\site-packages\sqlalchemy\dialects\postgresql\asyncpg.py:813: in ping
    self._handle_exception(error)
..\..\..\..\scoop\apps\python\current\Lib\site-packages\sqlalchemy\dialects\postgresql\asyncpg.py:794: in _handle_exception
    raise error
..\..\..\..\scoop\apps\python\current\Lib\site-packages\sqlalchemy\dialects\postgresql\asyncpg.py:811: in ping
    _ = self.await_(self._async_ping())
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
..\..\..\..\scoop\apps\python\current\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
..\..\..\..\scoop\apps\python\current\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
..\..\..\..\scoop\apps\python\current\Lib\site-packages\sqlalchemy\dialects\postgresql\asyncpg.py:820: in _async_ping
    await tr.start()
..\..\..\..\scoop\apps\python\current\Lib\site-packages\asyncpg\transaction.py:146: in start
    await self._connection.execute(query)
..\..\..\..\scoop\apps\python\current\Lib\site-packages\asyncpg\connection.py:349: in execute
    result = await self._protocol.query(query, timeout)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
asyncpg\\protocol\\protocol.pyx:375: in query
    ???
E   RuntimeError: Task <Task pending name='Task-7' coro=<_wrap_asyncgen_fixture.<locals>._asyncgen_fixture_wrapper.<locals>.setup() running at C:\Users\surya\scoop\apps\python\current\Lib\site-packages\pytest_asyncio\plugin.py:314> cb=[_run_until_complete_cb() at C:\Users\surya\scoop\apps\python\current\Lib\asyncio\base_events.py:181]> got Future <Future pending cb=[BaseProtocol._on_waiter_completed()]> attached to a different loop
---------------------------- Captured stderr setup ----------------------------
ERROR:sqlalchemy.pool.impl.AsyncAdaptedQueuePool:Exception terminating connection <AdaptedConnection <asyncpg.connection.Connection object at 0x0000022EC6A655E0>>
Traceback (most recent call last):
  File "C:\Users\surya\scoop\apps\python\current\Lib\site-packages\sqlalchemy\pool\base.py", line 374, in _close_connection
    self._dialect.do_terminate(connection)
    ~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^
  File "C:\Users\surya\scoop\apps\python\current\Lib\site-packages\sqlalchemy\dialects\postgresql\asyncpg.py", line 1130, in do_terminate
    dbapi_connection.terminate()
    ~~~~~~~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\surya\scoop\apps\python\current\Lib\site-packages\sqlalchemy\dialects\postgresql\asyncpg.py", line 907, in terminate
    self.await_(asyncio.shield(self._connection.close(timeout=2)))
    ~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\surya\scoop\apps\python\current\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 132, in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^
  File "C:\Users\surya\scoop\apps\python\current\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 196, in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
  File "C:\Users\surya\scoop\apps\python\current\Lib\site-packages\asyncpg\connection.py", line 1504, in close
    await self._protocol.close(timeout)
  File "asyncpg\\protocol\\protocol.pyx", line 627, in close
  File "asyncpg\\protocol\\protocol.pyx", line 660, in asyncpg.protocol.protocol.BaseProtocol._request_cancel
  File "C:\Users\surya\scoop\apps\python\current\Lib\site-packages\asyncpg\connection.py", line 1673, in _cancel_current_command
    self._cancellations.add(self._loop.create_task(self._cancel(waiter)))
                            ~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\surya\scoop\apps\python\current\Lib\asyncio\base_events.py", line 466, in create_task
    self._check_closed()
    ~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\surya\scoop\apps\python\current\Lib\asyncio\base_events.py", line 556, in _check_closed
    raise RuntimeError('Event loop is closed')
RuntimeError: Event loop is closed
----------------------------- Captured log setup ------------------------------
ERROR    sqlalchemy.pool.impl.AsyncAdaptedQueuePool:base.py:378 Exception terminating connection <AdaptedConnection <asyncpg.connection.Connection object at 0x0000022EC6A655E0>>
Traceback (most recent call last):
  File "C:\Users\surya\scoop\apps\python\current\Lib\site-packages\sqlalchemy\pool\base.py", line 374, in _close_connection
    self._dialect.do_terminate(connection)
    ~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^
  File "C:\Users\surya\scoop\apps\python\current\Lib\site-packages\sqlalchemy\dialects\postgresql\asyncpg.py", line 1130, in do_terminate
    dbapi_connection.terminate()
    ~~~~~~~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\surya\scoop\apps\python\current\Lib\site-packages\sqlalchemy\dialects\postgresql\asyncpg.py", line 907, in terminate
    self.await_(asyncio.shield(self._connection.close(timeout=2)))
    ~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\surya\scoop\apps\python\current\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 132, in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^
  File "C:\Users\surya\scoop\apps\python\current\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 196, in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
  File "C:\Users\surya\scoop\apps\python\current\Lib\site-packages\asyncpg\connection.py", line 1504, in close
    await self._protocol.close(timeout)
  File "asyncpg\\protocol\\protocol.pyx", line 627, in close
  File "asyncpg\\protocol\\protocol.pyx", line 660, in asyncpg.protocol.protocol.BaseProtocol._request_cancel
  File "C:\Users\surya\scoop\apps\python\current\Lib\site-packages\asyncpg\connection.py", line 1673, in _cancel_current_command
    self._cancellations.add(self._loop.create_task(self._cancel(waiter)))
                            ~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\surya\scoop\apps\python\current\Lib\asyncio\base_events.py", line 466, in create_task
    self._check_closed()
    ~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\surya\scoop\apps\python\current\Lib\asyncio\base_events.py", line 556, in _check_closed
    raise RuntimeError('Event loop is closed')
RuntimeError: Event loop is closed
__ ERROR at setup of TestRaceConditionFix.test_select_for_update_row_locking __
tests\test_race_condition_fix.py:54: in customer
    station = Station(
<string>:4: in __init__
    ???
..\..\..\..\scoop\apps\python\current\Lib\site-packages\sqlalchemy\orm\state.py:566: in _initialize_instance
    manager.dispatch.init(self, args, kwargs)
..\..\..\..\scoop\apps\python\current\Lib\site-packages\sqlalchemy\event\attr.py:497: in __call__
    fn(*args, **kw)
..\..\..\..\scoop\apps\python\current\Lib\site-packages\sqlalchemy\orm\mapper.py:4406: in _event_on_init
    instrumenting_mapper._check_configure()
..\..\..\..\scoop\apps\python\current\Lib\site-packages\sqlalchemy\orm\mapper.py:2401: in _check_configure
    _configure_registries({self.registry}, cascade=True)
..\..\..\..\scoop\apps\python\current\Lib\site-packages\sqlalchemy\orm\mapper.py:4214: in _configure_registries
    _do_configure_registries(registries, cascade)
..\..\..\..\scoop\apps\python\current\Lib\site-packages\sqlalchemy\orm\mapper.py:4251: in _do_configure_registries
    raise e
E   sqlalchemy.exc.InvalidRequestError: One or more mappers failed to initialize - can't proceed with initialization of other mappers. Triggering mapper: 'Mapper[Booking(bookings)]'. Original exception was: Multiple classes found for path "Booking" in the registry of this declarative base. Please use a fully module-qualified path.
---------------------------- Captured stdout setup ----------------------------
2025-11-27 14:03:47,752 INFO sqlalchemy.engine.Engine BEGIN (implicit)
2025-11-27 14:03:47,752 INFO sqlalchemy.engine.Engine SET search_path TO core, identity, public
2025-11-27 14:03:47,752 INFO sqlalchemy.engine.Engine [cached since 2.202s ago] ()
---------------------------- Captured stderr setup ----------------------------
INFO:sqlalchemy.engine.Engine:BEGIN (implicit)
INFO:sqlalchemy.engine.Engine:SET search_path TO core, identity, public
INFO:sqlalchemy.engine.Engine:[cached since 2.202s ago] ()
----------------------------- Captured log setup ------------------------------
INFO     sqlalchemy.engine.Engine:base.py:2698 BEGIN (implicit)
INFO     sqlalchemy.engine.Engine:base.py:1842 SET search_path TO core, identity, public
INFO     sqlalchemy.engine.Engine:base.py:1842 [cached since 2.202s ago] ()
_ ERROR at setup of TestRaceConditionFix.test_optimistic_locking_prevents_concurrent_updates _
..\..\..\..\scoop\apps\python\current\Lib\site-packages\pytest_asyncio\plugin.py:463: in setup
    return super().setup()
           ^^^^^^^^^^^^^^^
..\..\..\..\scoop\apps\python\current\Lib\site-packages\pytest_asyncio\plugin.py:748: in pytest_fixture_setup
    hook_result = yield
                  ^^^^^
..\..\..\..\scoop\apps\python\current\Lib\site-packages\pytest_asyncio\plugin.py:318: in _asyncgen_fixture_wrapper
    result = runner.run(setup(), context=context)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
..\..\..\..\scoop\apps\python\current\Lib\asyncio\runners.py:118: in run
    return self._loop.run_until_complete(task)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
..\..\..\..\scoop\apps\python\current\Lib\asyncio\base_events.py:725: in run_until_complete
    return future.result()
           ^^^^^^^^^^^^^^^
..\..\..\..\scoop\apps\python\current\Lib\site-packages\pytest_asyncio\plugin.py:314: in setup
    res = await gen_obj.__anext__()
          ^^^^^^^^^^^^^^^^^^^^^^^^^
tests\conftest.py:183: in db_session
    await session.execute(text("SET search_path TO core, identity, public"))
..\..\..\..\scoop\apps\python\current\Lib\site-packages\sqlalchemy\ext\asyncio\session.py:463: in execute
    result = await greenlet_spawn(
..\..\..\..\scoop\apps\python\current\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
..\..\..\..\scoop\apps\python\current\Lib\site-packages\sqlalchemy\orm\session.py:2365: in execute
    return self._execute_internal(
..\..\..\..\scoop\apps\python\current\Lib\site-packages\sqlalchemy\orm\session.py:2241: in _execute_internal
    conn = self._connection_for_bind(bind)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
..\..\..\..\scoop\apps\python\current\Lib\site-packages\sqlalchemy\orm\session.py:2110: in _connection_for_bind
    return trans._connection_for_bind(engine, execution_options)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
..\..\..\..\scoop\apps\python\current\Lib\site-packages\sqlalchemy\orm\state_changes.py:139: in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
..\..\..\..\scoop\apps\python\current\Lib\site-packages\sqlalchemy\orm\session.py:1189: in _connection_for_bind
    conn = bind.connect()
           ^^^^^^^^^^^^^^
..\..\..\..\scoop\apps\python\current\Lib\site-packages\sqlalchemy\engine\base.py:3273: in connect
    return self._connection_cls(self)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
..\..\..\..\scoop\apps\python\current\Lib\site-packages\sqlalchemy\engine\base.py:145: in __init__
    self._dbapi_connection = engine.raw_connection()
                             ^^^^^^^^^^^^^^^^^^^^^^^
..\..\..\..\scoop\apps\python\current\Lib\site-packages\sqlalchemy\engine\base.py:3297: in raw_connection
    return self.pool.connect()
           ^^^^^^^^^^^^^^^^^^^
..\..\..\..\scoop\apps\python\current\Lib\site-packages\sqlalchemy\pool\base.py:449: in connect
    return _ConnectionFairy._checkout(self)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
..\..\..\..\scoop\apps\python\current\Lib\site-packages\sqlalchemy\pool\base.py:1363: in _checkout
    with util.safe_reraise():
         ^^^^^^^^^^^^^^^^^^^
..\..\..\..\scoop\apps\python\current\Lib\site-packages\sqlalchemy\util\langhelpers.py:224: in __exit__
    raise exc_value.with_traceback(exc_tb)
..\..\..\..\scoop\apps\python\current\Lib\site-packages\sqlalchemy\pool\base.py:1301: in _checkout
    result = pool._dialect._do_ping_w_event(
..\..\..\..\scoop\apps\python\current\Lib\site-packages\sqlalchemy\engine\default.py:720: in _do_ping_w_event
    return self.do_ping(dbapi_connection)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
..\..\..\..\scoop\apps\python\current\Lib\site-packages\sqlalchemy\dialects\postgresql\asyncpg.py:1163: in do_ping
    dbapi_connection.ping()
..\..\..\..\scoop\apps\python\current\Lib\site-packages\sqlalchemy\dialects\postgresql\asyncpg.py:813: in ping
    self._handle_exception(error)
..\..\..\..\scoop\apps\python\current\Lib\site-packages\sqlalchemy\dialects\postgresql\asyncpg.py:794: in _handle_exception
    raise error
..\..\..\..\scoop\apps\python\current\Lib\site-packages\sqlalchemy\dialects\postgresql\asyncpg.py:811: in ping
    _ = self.await_(self._async_ping())
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
..\..\..\..\scoop\apps\python\current\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
..\..\..\..\scoop\apps\python\current\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
..\..\..\..\scoop\apps\python\current\Lib\site-packages\sqlalchemy\dialects\postgresql\asyncpg.py:820: in _async_ping
    await tr.start()
..\..\..\..\scoop\apps\python\current\Lib\site-packages\asyncpg\transaction.py:146: in start
    await self._connection.execute(query)
..\..\..\..\scoop\apps\python\current\Lib\site-packages\asyncpg\connection.py:349: in execute
    result = await self._protocol.query(query, timeout)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
asyncpg\\protocol\\protocol.pyx:375: in query
    ???
E   RuntimeError: Task <Task pending name='Task-19' coro=<_wrap_asyncgen_fixture.<locals>._asyncgen_fixture_wrapper.<locals>.setup() running at C:\Users\surya\scoop\apps\python\current\Lib\site-packages\pytest_asyncio\plugin.py:314> cb=[_run_until_complete_cb() at C:\Users\surya\scoop\apps\python\current\Lib\asyncio\base_events.py:181]> got Future <Future pending cb=[BaseProtocol._on_waiter_completed()]> attached to a different loop
---------------------------- Captured stderr setup ----------------------------
ERROR:sqlalchemy.pool.impl.AsyncAdaptedQueuePool:Exception terminating connection <AdaptedConnection <asyncpg.connection.Connection object at 0x0000022EC6D38230>>
Traceback (most recent call last):
  File "C:\Users\surya\scoop\apps\python\current\Lib\site-packages\sqlalchemy\pool\base.py", line 374, in _close_connection
    self._dialect.do_terminate(connection)
    ~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^
  File "C:\Users\surya\scoop\apps\python\current\Lib\site-packages\sqlalchemy\dialects\postgresql\asyncpg.py", line 1130, in do_terminate
    dbapi_connection.terminate()
    ~~~~~~~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\surya\scoop\apps\python\current\Lib\site-packages\sqlalchemy\dialects\postgresql\asyncpg.py", line 907, in terminate
    self.await_(asyncio.shield(self._connection.close(timeout=2)))
    ~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\surya\scoop\apps\python\current\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 132, in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^
  File "C:\Users\surya\scoop\apps\python\current\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 196, in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
  File "C:\Users\surya\scoop\apps\python\current\Lib\site-packages\asyncpg\connection.py", line 1504, in close
    await self._protocol.close(timeout)
  File "asyncpg\\protocol\\protocol.pyx", line 627, in close
  File "asyncpg\\protocol\\protocol.pyx", line 660, in asyncpg.protocol.protocol.BaseProtocol._request_cancel
  File "C:\Users\surya\scoop\apps\python\current\Lib\site-packages\asyncpg\connection.py", line 1673, in _cancel_current_command
    self._cancellations.add(self._loop.create_task(self._cancel(waiter)))
                            ~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\surya\scoop\apps\python\current\Lib\asyncio\base_events.py", line 466, in create_task
    self._check_closed()
    ~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\surya\scoop\apps\python\current\Lib\asyncio\base_events.py", line 556, in _check_closed
    raise RuntimeError('Event loop is closed')
RuntimeError: Event loop is closed
----------------------------- Captured log setup ------------------------------
ERROR    sqlalchemy.pool.impl.AsyncAdaptedQueuePool:base.py:378 Exception terminating connection <AdaptedConnection <asyncpg.connection.Connection object at 0x0000022EC6D38230>>
Traceback (most recent call last):
  File "C:\Users\surya\scoop\apps\python\current\Lib\site-packages\sqlalchemy\pool\base.py", line 374, in _close_connection
    self._dialect.do_terminate(connection)
    ~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^
  File "C:\Users\surya\scoop\apps\python\current\Lib\site-packages\sqlalchemy\dialects\postgresql\asyncpg.py", line 1130, in do_terminate
    dbapi_connection.terminate()
    ~~~~~~~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\surya\scoop\apps\python\current\Lib\site-packages\sqlalchemy\dialects\postgresql\asyncpg.py", line 907, in terminate
    self.await_(asyncio.shield(self._connection.close(timeout=2)))
    ~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\surya\scoop\apps\python\current\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 132, in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^
  File "C:\Users\surya\scoop\apps\python\current\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 196, in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
  File "C:\Users\surya\scoop\apps\python\current\Lib\site-packages\asyncpg\connection.py", line 1504, in close
    await self._protocol.close(timeout)
  File "asyncpg\\protocol\\protocol.pyx", line 627, in close
  File "asyncpg\\protocol\\protocol.pyx", line 660, in asyncpg.protocol.protocol.BaseProtocol._request_cancel
  File "C:\Users\surya\scoop\apps\python\current\Lib\site-packages\asyncpg\connection.py", line 1673, in _cancel_current_command
    self._cancellations.add(self._loop.create_task(self._cancel(waiter)))
                            ~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\surya\scoop\apps\python\current\Lib\asyncio\base_events.py", line 466, in create_task
    self._check_closed()
    ~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\surya\scoop\apps\python\current\Lib\asyncio\base_events.py", line 556, in _check_closed
    raise RuntimeError('Event loop is closed')
RuntimeError: Event loop is closed
_ ERROR at setup of TestRaceConditionFix.test_integrity_error_handling_and_user_message _
tests\test_race_condition_fix.py:54: in customer
    station = Station(
<string>:4: in __init__
    ???
..\..\..\..\scoop\apps\python\current\Lib\site-packages\sqlalchemy\orm\state.py:566: in _initialize_instance
    manager.dispatch.init(self, args, kwargs)
..\..\..\..\scoop\apps\python\current\Lib\site-packages\sqlalchemy\event\attr.py:497: in __call__
    fn(*args, **kw)
..\..\..\..\scoop\apps\python\current\Lib\site-packages\sqlalchemy\orm\mapper.py:4406: in _event_on_init
    instrumenting_mapper._check_configure()
..\..\..\..\scoop\apps\python\current\Lib\site-packages\sqlalchemy\orm\mapper.py:2401: in _check_configure
    _configure_registries({self.registry}, cascade=True)
..\..\..\..\scoop\apps\python\current\Lib\site-packages\sqlalchemy\orm\mapper.py:4214: in _configure_registries
    _do_configure_registries(registries, cascade)
..\..\..\..\scoop\apps\python\current\Lib\site-packages\sqlalchemy\orm\mapper.py:4251: in _do_configure_registries
    raise e
E   sqlalchemy.exc.InvalidRequestError: One or more mappers failed to initialize - can't proceed with initialization of other mappers. Triggering mapper: 'Mapper[Booking(bookings)]'. Original exception was: Multiple classes found for path "Booking" in the registry of this declarative base. Please use a fully module-qualified path.
---------------------------- Captured stdout setup ----------------------------
2025-11-27 14:03:49,808 INFO sqlalchemy.engine.Engine BEGIN (implicit)
2025-11-27 14:03:49,808 INFO sqlalchemy.engine.Engine SET search_path TO core, identity, public
2025-11-27 14:03:49,808 INFO sqlalchemy.engine.Engine [cached since 4.257s ago] ()
---------------------------- Captured stderr setup ----------------------------
INFO:sqlalchemy.engine.Engine:BEGIN (implicit)
INFO:sqlalchemy.engine.Engine:SET search_path TO core, identity, public
INFO:sqlalchemy.engine.Engine:[cached since 4.257s ago] ()
----------------------------- Captured log setup ------------------------------
INFO     sqlalchemy.engine.Engine:base.py:2698 BEGIN (implicit)
INFO     sqlalchemy.engine.Engine:base.py:1842 SET search_path TO core, identity, public
INFO     sqlalchemy.engine.Engine:base.py:1842 [cached since 4.257s ago] ()
_ ERROR at setup of TestRaceConditionFix.test_cancelled_bookings_dont_block_new_bookings _
..\..\..\..\scoop\apps\python\current\Lib\site-packages\pytest_asyncio\plugin.py:463: in setup
    return super().setup()
           ^^^^^^^^^^^^^^^
..\..\..\..\scoop\apps\python\current\Lib\site-packages\pytest_asyncio\plugin.py:748: in pytest_fixture_setup
    hook_result = yield
                  ^^^^^
..\..\..\..\scoop\apps\python\current\Lib\site-packages\pytest_asyncio\plugin.py:318: in _asyncgen_fixture_wrapper
    result = runner.run(setup(), context=context)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
..\..\..\..\scoop\apps\python\current\Lib\asyncio\runners.py:118: in run
    return self._loop.run_until_complete(task)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
..\..\..\..\scoop\apps\python\current\Lib\asyncio\base_events.py:725: in run_until_complete
    return future.result()
           ^^^^^^^^^^^^^^^
..\..\..\..\scoop\apps\python\current\Lib\site-packages\pytest_asyncio\plugin.py:314: in setup
    res = await gen_obj.__anext__()
          ^^^^^^^^^^^^^^^^^^^^^^^^^
tests\conftest.py:183: in db_session
    await session.execute(text("SET search_path TO core, identity, public"))
..\..\..\..\scoop\apps\python\current\Lib\site-packages\sqlalchemy\ext\asyncio\session.py:463: in execute
    result = await greenlet_spawn(
..\..\..\..\scoop\apps\python\current\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
..\..\..\..\scoop\apps\python\current\Lib\site-packages\sqlalchemy\orm\session.py:2365: in execute
    return self._execute_internal(
..\..\..\..\scoop\apps\python\current\Lib\site-packages\sqlalchemy\orm\session.py:2241: in _execute_internal
    conn = self._connection_for_bind(bind)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
..\..\..\..\scoop\apps\python\current\Lib\site-packages\sqlalchemy\orm\session.py:2110: in _connection_for_bind
    return trans._connection_for_bind(engine, execution_options)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
..\..\..\..\scoop\apps\python\current\Lib\site-packages\sqlalchemy\orm\state_changes.py:139: in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
..\..\..\..\scoop\apps\python\current\Lib\site-packages\sqlalchemy\orm\session.py:1189: in _connection_for_bind
    conn = bind.connect()
           ^^^^^^^^^^^^^^
..\..\..\..\scoop\apps\python\current\Lib\site-packages\sqlalchemy\engine\base.py:3273: in connect
    return self._connection_cls(self)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
..\..\..\..\scoop\apps\python\current\Lib\site-packages\sqlalchemy\engine\base.py:145: in __init__
    self._dbapi_connection = engine.raw_connection()
                             ^^^^^^^^^^^^^^^^^^^^^^^
..\..\..\..\scoop\apps\python\current\Lib\site-packages\sqlalchemy\engine\base.py:3297: in raw_connection
    return self.pool.connect()
           ^^^^^^^^^^^^^^^^^^^
..\..\..\..\scoop\apps\python\current\Lib\site-packages\sqlalchemy\pool\base.py:449: in connect
    return _ConnectionFairy._checkout(self)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
..\..\..\..\scoop\apps\python\current\Lib\site-packages\sqlalchemy\pool\base.py:1363: in _checkout
    with util.safe_reraise():
         ^^^^^^^^^^^^^^^^^^^
..\..\..\..\scoop\apps\python\current\Lib\site-packages\sqlalchemy\util\langhelpers.py:224: in __exit__
    raise exc_value.with_traceback(exc_tb)
..\..\..\..\scoop\apps\python\current\Lib\site-packages\sqlalchemy\pool\base.py:1301: in _checkout
    result = pool._dialect._do_ping_w_event(
..\..\..\..\scoop\apps\python\current\Lib\site-packages\sqlalchemy\engine\default.py:720: in _do_ping_w_event
    return self.do_ping(dbapi_connection)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
..\..\..\..\scoop\apps\python\current\Lib\site-packages\sqlalchemy\dialects\postgresql\asyncpg.py:1163: in do_ping
    dbapi_connection.ping()
..\..\..\..\scoop\apps\python\current\Lib\site-packages\sqlalchemy\dialects\postgresql\asyncpg.py:813: in ping
    self._handle_exception(error)
..\..\..\..\scoop\apps\python\current\Lib\site-packages\sqlalchemy\dialects\postgresql\asyncpg.py:794: in _handle_exception
    raise error
..\..\..\..\scoop\apps\python\current\Lib\site-packages\sqlalchemy\dialects\postgresql\asyncpg.py:811: in ping
    _ = self.await_(self._async_ping())
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
..\..\..\..\scoop\apps\python\current\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
..\..\..\..\scoop\apps\python\current\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
..\..\..\..\scoop\apps\python\current\Lib\site-packages\sqlalchemy\dialects\postgresql\asyncpg.py:820: in _async_ping
    await tr.start()
..\..\..\..\scoop\apps\python\current\Lib\site-packages\asyncpg\transaction.py:146: in start
    await self._connection.execute(query)
..\..\..\..\scoop\apps\python\current\Lib\site-packages\asyncpg\connection.py:349: in execute
    result = await self._protocol.query(query, timeout)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
asyncpg\\protocol\\protocol.pyx:375: in query
    ???
E   RuntimeError: Task <Task pending name='Task-31' coro=<_wrap_asyncgen_fixture.<locals>._asyncgen_fixture_wrapper.<locals>.setup() running at C:\Users\surya\scoop\apps\python\current\Lib\site-packages\pytest_asyncio\plugin.py:314> cb=[_run_until_complete_cb() at C:\Users\surya\scoop\apps\python\current\Lib\asyncio\base_events.py:181]> got Future <Future pending cb=[BaseProtocol._on_waiter_completed()]> attached to a different loop
---------------------------- Captured stderr setup ----------------------------
ERROR:sqlalchemy.pool.impl.AsyncAdaptedQueuePool:Exception terminating connection <AdaptedConnection <asyncpg.connection.Connection object at 0x0000022EC6D38410>>
Traceback (most recent call last):
  File "C:\Users\surya\scoop\apps\python\current\Lib\site-packages\sqlalchemy\pool\base.py", line 374, in _close_connection
    self._dialect.do_terminate(connection)
    ~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^
  File "C:\Users\surya\scoop\apps\python\current\Lib\site-packages\sqlalchemy\dialects\postgresql\asyncpg.py", line 1130, in do_terminate
    dbapi_connection.terminate()
    ~~~~~~~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\surya\scoop\apps\python\current\Lib\site-packages\sqlalchemy\dialects\postgresql\asyncpg.py", line 907, in terminate
    self.await_(asyncio.shield(self._connection.close(timeout=2)))
    ~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\surya\scoop\apps\python\current\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 132, in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^
  File "C:\Users\surya\scoop\apps\python\current\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 196, in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
  File "C:\Users\surya\scoop\apps\python\current\Lib\site-packages\asyncpg\connection.py", line 1504, in close
    await self._protocol.close(timeout)
  File "asyncpg\\protocol\\protocol.pyx", line 627, in close
  File "asyncpg\\protocol\\protocol.pyx", line 660, in asyncpg.protocol.protocol.BaseProtocol._request_cancel
  File "C:\Users\surya\scoop\apps\python\current\Lib\site-packages\asyncpg\connection.py", line 1673, in _cancel_current_command
    self._cancellations.add(self._loop.create_task(self._cancel(waiter)))
                            ~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\surya\scoop\apps\python\current\Lib\asyncio\base_events.py", line 466, in create_task
    self._check_closed()
    ~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\surya\scoop\apps\python\current\Lib\asyncio\base_events.py", line 556, in _check_closed
    raise RuntimeError('Event loop is closed')
RuntimeError: Event loop is closed
----------------------------- Captured log setup ------------------------------
ERROR    sqlalchemy.pool.impl.AsyncAdaptedQueuePool:base.py:378 Exception terminating connection <AdaptedConnection <asyncpg.connection.Connection object at 0x0000022EC6D38410>>
Traceback (most recent call last):
  File "C:\Users\surya\scoop\apps\python\current\Lib\site-packages\sqlalchemy\pool\base.py", line 374, in _close_connection
    self._dialect.do_terminate(connection)
    ~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^
  File "C:\Users\surya\scoop\apps\python\current\Lib\site-packages\sqlalchemy\dialects\postgresql\asyncpg.py", line 1130, in do_terminate
    dbapi_connection.terminate()
    ~~~~~~~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\surya\scoop\apps\python\current\Lib\site-packages\sqlalchemy\dialects\postgresql\asyncpg.py", line 907, in terminate
    self.await_(asyncio.shield(self._connection.close(timeout=2)))
    ~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\surya\scoop\apps\python\current\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 132, in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^
  File "C:\Users\surya\scoop\apps\python\current\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 196, in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
  File "C:\Users\surya\scoop\apps\python\current\Lib\site-packages\asyncpg\connection.py", line 1504, in close
    await self._protocol.close(timeout)
  File "asyncpg\\protocol\\protocol.pyx", line 627, in close
  File "asyncpg\\protocol\\protocol.pyx", line 660, in asyncpg.protocol.protocol.BaseProtocol._request_cancel
  File "C:\Users\surya\scoop\apps\python\current\Lib\site-packages\asyncpg\connection.py", line 1673, in _cancel_current_command
    self._cancellations.add(self._loop.create_task(self._cancel(waiter)))
                            ~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\surya\scoop\apps\python\current\Lib\asyncio\base_events.py", line 466, in create_task
    self._check_closed()
    ~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\surya\scoop\apps\python\current\Lib\asyncio\base_events.py", line 556, in _check_closed
    raise RuntimeError('Event loop is closed')
RuntimeError: Event loop is closed
__ ERROR at setup of TestRaceConditionFix.test_high_concurrency_stress_test ___
tests\test_race_condition_fix.py:54: in customer
    station = Station(
<string>:4: in __init__
    ???
..\..\..\..\scoop\apps\python\current\Lib\site-packages\sqlalchemy\orm\state.py:566: in _initialize_instance
    manager.dispatch.init(self, args, kwargs)
..\..\..\..\scoop\apps\python\current\Lib\site-packages\sqlalchemy\event\attr.py:497: in __call__
    fn(*args, **kw)
..\..\..\..\scoop\apps\python\current\Lib\site-packages\sqlalchemy\orm\mapper.py:4406: in _event_on_init
    instrumenting_mapper._check_configure()
..\..\..\..\scoop\apps\python\current\Lib\site-packages\sqlalchemy\orm\mapper.py:2401: in _check_configure
    _configure_registries({self.registry}, cascade=True)
..\..\..\..\scoop\apps\python\current\Lib\site-packages\sqlalchemy\orm\mapper.py:4214: in _configure_registries
    _do_configure_registries(registries, cascade)
..\..\..\..\scoop\apps\python\current\Lib\site-packages\sqlalchemy\orm\mapper.py:4251: in _do_configure_registries
    raise e
E   sqlalchemy.exc.InvalidRequestError: One or more mappers failed to initialize - can't proceed with initialization of other mappers. Triggering mapper: 'Mapper[Booking(bookings)]'. Original exception was: Multiple classes found for path "Booking" in the registry of this declarative base. Please use a fully module-qualified path.
---------------------------- Captured stdout setup ----------------------------
2025-11-27 14:03:51,784 INFO sqlalchemy.engine.Engine BEGIN (implicit)
2025-11-27 14:03:51,784 INFO sqlalchemy.engine.Engine SET search_path TO core, identity, public
2025-11-27 14:03:51,784 INFO sqlalchemy.engine.Engine [cached since 6.233s ago] ()
---------------------------- Captured stderr setup ----------------------------
INFO:sqlalchemy.engine.Engine:BEGIN (implicit)
INFO:sqlalchemy.engine.Engine:SET search_path TO core, identity, public
INFO:sqlalchemy.engine.Engine:[cached since 6.233s ago] ()
----------------------------- Captured log setup ------------------------------
INFO     sqlalchemy.engine.Engine:base.py:2698 BEGIN (implicit)
INFO     sqlalchemy.engine.Engine:base.py:1842 SET search_path TO core, identity, public
INFO     sqlalchemy.engine.Engine:base.py:1842 [cached since 6.233s ago] ()
_ ERROR at setup of TestRaceConditionFix.test_race_condition_with_different_party_sizes _
..\..\..\..\scoop\apps\python\current\Lib\site-packages\pytest_asyncio\plugin.py:463: in setup
    return super().setup()
           ^^^^^^^^^^^^^^^
..\..\..\..\scoop\apps\python\current\Lib\site-packages\pytest_asyncio\plugin.py:748: in pytest_fixture_setup
    hook_result = yield
                  ^^^^^
..\..\..\..\scoop\apps\python\current\Lib\site-packages\pytest_asyncio\plugin.py:318: in _asyncgen_fixture_wrapper
    result = runner.run(setup(), context=context)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
..\..\..\..\scoop\apps\python\current\Lib\asyncio\runners.py:118: in run
    return self._loop.run_until_complete(task)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
..\..\..\..\scoop\apps\python\current\Lib\asyncio\base_events.py:725: in run_until_complete
    return future.result()
           ^^^^^^^^^^^^^^^
..\..\..\..\scoop\apps\python\current\Lib\site-packages\pytest_asyncio\plugin.py:314: in setup
    res = await gen_obj.__anext__()
          ^^^^^^^^^^^^^^^^^^^^^^^^^
tests\conftest.py:183: in db_session
    await session.execute(text("SET search_path TO core, identity, public"))
..\..\..\..\scoop\apps\python\current\Lib\site-packages\sqlalchemy\ext\asyncio\session.py:463: in execute
    result = await greenlet_spawn(
..\..\..\..\scoop\apps\python\current\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
..\..\..\..\scoop\apps\python\current\Lib\site-packages\sqlalchemy\orm\session.py:2365: in execute
    return self._execute_internal(
..\..\..\..\scoop\apps\python\current\Lib\site-packages\sqlalchemy\orm\session.py:2241: in _execute_internal
    conn = self._connection_for_bind(bind)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
..\..\..\..\scoop\apps\python\current\Lib\site-packages\sqlalchemy\orm\session.py:2110: in _connection_for_bind
    return trans._connection_for_bind(engine, execution_options)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
..\..\..\..\scoop\apps\python\current\Lib\site-packages\sqlalchemy\orm\state_changes.py:139: in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
..\..\..\..\scoop\apps\python\current\Lib\site-packages\sqlalchemy\orm\session.py:1189: in _connection_for_bind
    conn = bind.connect()
           ^^^^^^^^^^^^^^
..\..\..\..\scoop\apps\python\current\Lib\site-packages\sqlalchemy\engine\base.py:3273: in connect
    return self._connection_cls(self)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
..\..\..\..\scoop\apps\python\current\Lib\site-packages\sqlalchemy\engine\base.py:145: in __init__
    self._dbapi_connection = engine.raw_connection()
                             ^^^^^^^^^^^^^^^^^^^^^^^
..\..\..\..\scoop\apps\python\current\Lib\site-packages\sqlalchemy\engine\base.py:3297: in raw_connection
    return self.pool.connect()
           ^^^^^^^^^^^^^^^^^^^
..\..\..\..\scoop\apps\python\current\Lib\site-packages\sqlalchemy\pool\base.py:449: in connect
    return _ConnectionFairy._checkout(self)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
..\..\..\..\scoop\apps\python\current\Lib\site-packages\sqlalchemy\pool\base.py:1363: in _checkout
    with util.safe_reraise():
         ^^^^^^^^^^^^^^^^^^^
..\..\..\..\scoop\apps\python\current\Lib\site-packages\sqlalchemy\util\langhelpers.py:224: in __exit__
    raise exc_value.with_traceback(exc_tb)
..\..\..\..\scoop\apps\python\current\Lib\site-packages\sqlalchemy\pool\base.py:1301: in _checkout
    result = pool._dialect._do_ping_w_event(
..\..\..\..\scoop\apps\python\current\Lib\site-packages\sqlalchemy\engine\default.py:720: in _do_ping_w_event
    return self.do_ping(dbapi_connection)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
..\..\..\..\scoop\apps\python\current\Lib\site-packages\sqlalchemy\dialects\postgresql\asyncpg.py:1163: in do_ping
    dbapi_connection.ping()
..\..\..\..\scoop\apps\python\current\Lib\site-packages\sqlalchemy\dialects\postgresql\asyncpg.py:813: in ping
    self._handle_exception(error)
..\..\..\..\scoop\apps\python\current\Lib\site-packages\sqlalchemy\dialects\postgresql\asyncpg.py:794: in _handle_exception
    raise error
..\..\..\..\scoop\apps\python\current\Lib\site-packages\sqlalchemy\dialects\postgresql\asyncpg.py:811: in ping
    _ = self.await_(self._async_ping())
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
..\..\..\..\scoop\apps\python\current\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
..\..\..\..\scoop\apps\python\current\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
..\..\..\..\scoop\apps\python\current\Lib\site-packages\sqlalchemy\dialects\postgresql\asyncpg.py:820: in _async_ping
    await tr.start()
..\..\..\..\scoop\apps\python\current\Lib\site-packages\asyncpg\transaction.py:146: in start
    await self._connection.execute(query)
..\..\..\..\scoop\apps\python\current\Lib\site-packages\asyncpg\connection.py:349: in execute
    result = await self._protocol.query(query, timeout)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
asyncpg\\protocol\\protocol.pyx:375: in query
    ???
E   RuntimeError: Task <Task pending name='Task-43' coro=<_wrap_asyncgen_fixture.<locals>._asyncgen_fixture_wrapper.<locals>.setup() running at C:\Users\surya\scoop\apps\python\current\Lib\site-packages\pytest_asyncio\plugin.py:314> cb=[_run_until_complete_cb() at C:\Users\surya\scoop\apps\python\current\Lib\asyncio\base_events.py:181]> got Future <Future pending cb=[BaseProtocol._on_waiter_completed()]> attached to a different loop
---------------------------- Captured stderr setup ----------------------------
ERROR:sqlalchemy.pool.impl.AsyncAdaptedQueuePool:Exception terminating connection <AdaptedConnection <asyncpg.connection.Connection object at 0x0000022EC6D3B110>>
Traceback (most recent call last):
  File "C:\Users\surya\scoop\apps\python\current\Lib\site-packages\sqlalchemy\pool\base.py", line 374, in _close_connection
    self._dialect.do_terminate(connection)
    ~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^
  File "C:\Users\surya\scoop\apps\python\current\Lib\site-packages\sqlalchemy\dialects\postgresql\asyncpg.py", line 1130, in do_terminate
    dbapi_connection.terminate()
    ~~~~~~~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\surya\scoop\apps\python\current\Lib\site-packages\sqlalchemy\dialects\postgresql\asyncpg.py", line 907, in terminate
    self.await_(asyncio.shield(self._connection.close(timeout=2)))
    ~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\surya\scoop\apps\python\current\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 132, in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^
  File "C:\Users\surya\scoop\apps\python\current\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 196, in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
  File "C:\Users\surya\scoop\apps\python\current\Lib\site-packages\asyncpg\connection.py", line 1504, in close
    await self._protocol.close(timeout)
  File "asyncpg\\protocol\\protocol.pyx", line 627, in close
  File "asyncpg\\protocol\\protocol.pyx", line 660, in asyncpg.protocol.protocol.BaseProtocol._request_cancel
  File "C:\Users\surya\scoop\apps\python\current\Lib\site-packages\asyncpg\connection.py", line 1673, in _cancel_current_command
    self._cancellations.add(self._loop.create_task(self._cancel(waiter)))
                            ~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\surya\scoop\apps\python\current\Lib\asyncio\base_events.py", line 466, in create_task
    self._check_closed()
    ~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\surya\scoop\apps\python\current\Lib\asyncio\base_events.py", line 556, in _check_closed
    raise RuntimeError('Event loop is closed')
RuntimeError: Event loop is closed
----------------------------- Captured log setup ------------------------------
ERROR    sqlalchemy.pool.impl.AsyncAdaptedQueuePool:base.py:378 Exception terminating connection <AdaptedConnection <asyncpg.connection.Connection object at 0x0000022EC6D3B110>>
Traceback (most recent call last):
  File "C:\Users\surya\scoop\apps\python\current\Lib\site-packages\sqlalchemy\pool\base.py", line 374, in _close_connection
    self._dialect.do_terminate(connection)
    ~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^
  File "C:\Users\surya\scoop\apps\python\current\Lib\site-packages\sqlalchemy\dialects\postgresql\asyncpg.py", line 1130, in do_terminate
    dbapi_connection.terminate()
    ~~~~~~~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\surya\scoop\apps\python\current\Lib\site-packages\sqlalchemy\dialects\postgresql\asyncpg.py", line 907, in terminate
    self.await_(asyncio.shield(self._connection.close(timeout=2)))
    ~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\surya\scoop\apps\python\current\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 132, in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^
  File "C:\Users\surya\scoop\apps\python\current\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py", line 196, in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
  File "C:\Users\surya\scoop\apps\python\current\Lib\site-packages\asyncpg\connection.py", line 1504, in close
    await self._protocol.close(timeout)
  File "asyncpg\\protocol\\protocol.pyx", line 627, in close
  File "asyncpg\\protocol\\protocol.pyx", line 660, in asyncpg.protocol.protocol.BaseProtocol._request_cancel
  File "C:\Users\surya\scoop\apps\python\current\Lib\site-packages\asyncpg\connection.py", line 1673, in _cancel_current_command
    self._cancellations.add(self._loop.create_task(self._cancel(waiter)))
                            ~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\surya\scoop\apps\python\current\Lib\asyncio\base_events.py", line 466, in create_task
    self._check_closed()
    ~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\surya\scoop\apps\python\current\Lib\asyncio\base_events.py", line 556, in _check_closed
    raise RuntimeError('Event loop is closed')
RuntimeError: Event loop is closed
============================== warnings summary ===============================
..\..\..\..\scoop\apps\python\current\Lib\site-packages\sentry_sdk\integrations\starlette.py:60
  C:\Users\surya\scoop\apps\python\current\Lib\site-packages\sentry_sdk\integrations\starlette.py:60: PendingDeprecationWarning: Please use `import python_multipart` instead.
    import multipart  # type: ignore

<frozen importlib._bootstrap>:488
  <frozen importlib._bootstrap>:488: DeprecationWarning: Type google._upb._message.MessageMapContainer uses PyType_Spec with a metaclass that has custom tp_new. This is deprecated and will no longer be allowed in Python 3.14.

<frozen importlib._bootstrap>:488
  <frozen importlib._bootstrap>:488: DeprecationWarning: Type google._upb._message.ScalarMapContainer uses PyType_Spec with a metaclass that has custom tp_new. This is deprecated and will no longer be allowed in Python 3.14.

..\..\..\..\scoop\apps\python\current\Lib\site-packages\pydantic\_internal\_config.py:323: 29 warnings
  C:\Users\surya\scoop\apps\python\current\Lib\site-packages\pydantic\_internal\_config.py:323: PydanticDeprecatedSince20: Support for class-based `config` is deprecated, use ConfigDict instead. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.11/migration/
    warnings.warn(DEPRECATION_MESSAGE, DeprecationWarning)

..\..\..\..\scoop\apps\python\current\Lib\site-packages\starlette\middleware\wsgi.py:15
  C:\Users\surya\scoop\apps\python\current\Lib\site-packages\starlette\middleware\wsgi.py:15: DeprecationWarning: starlette.middleware.wsgi is deprecated and will be removed in a future release. Please refer to https://github.com/abersheeran/a2wsgi as a replacement.
    warnings.warn(

src\api\ai\shadow\confidence_predictor.py:10
  C:\Users\surya\projects\MH webapps\apps\backend\src\api\ai\shadow\confidence_predictor.py:10: DeprecationWarning: api.ai.shadow.models is deprecated. Use db.models.ai instead. This module will be removed to prevent SQLAlchemy duplicate class errors.
    from api.ai.shadow.models import AITutorPair

src\core\auth\station_auth.py:26
  C:\Users\surya\projects\MH webapps\apps\backend\src\core\auth\station_auth.py:26: DeprecationWarning: core.auth.station_models is deprecated. Use db.models.identity instead. This module will be removed in Phase 3 of model consolidation.
    from core.auth.station_models import (

src\routers\v1\admin_analytics.py:405
  C:\Users\surya\projects\MH webapps\apps\backend\src\routers\v1\admin_analytics.py:405: DeprecationWarning: `regex` has been deprecated, please use `pattern` instead
    interval: str = Query("day", regex="^(day|week|month)$"),

src\routers\v1\conversations.py:222
  C:\Users\surya\projects\MH webapps\apps\backend\src\routers\v1\conversations.py:222: DeprecationWarning: `regex` has been deprecated, please use `pattern` instead
    sentiment: Optional[str] = Query(

src\api\v1\escalations\schemas.py:26
  C:\Users\surya\projects\MH webapps\apps\backend\src\api\v1\escalations\schemas.py:26: PydanticDeprecatedSince20: Pydantic V1 style `@validator` validators are deprecated. You should migrate to Pydantic V2 style `@field_validator` validators, see the migration guide for more details. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.11/migration/
    @validator("phone")

src\api\v1\escalations\schemas.py:39
  C:\Users\surya\projects\MH webapps\apps\backend\src\api\v1\escalations\schemas.py:39: PydanticDeprecatedSince20: Pydantic V1 style `@validator` validators are deprecated. You should migrate to Pydantic V2 style `@field_validator` validators, see the migration guide for more details. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.11/migration/
    @validator("preferred_method")

src\api\v1\escalations\schemas.py:47
  C:\Users\surya\projects\MH webapps\apps\backend\src\api\v1\escalations\schemas.py:47: PydanticDeprecatedSince20: Pydantic V1 style `@validator` validators are deprecated. You should migrate to Pydantic V2 style `@field_validator` validators, see the migration guide for more details. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.11/migration/
    @validator("priority")

..\..\..\..\scoop\apps\python\current\Lib\site-packages\websockets\legacy\__init__.py:6
  C:\Users\surya\scoop\apps\python\current\Lib\site-packages\websockets\legacy\__init__.py:6: DeprecationWarning: websockets.legacy is deprecated; see https://websockets.readthedocs.io/en/stable/howto/upgrade.html for upgrade instructions
    warnings.warn(  # deprecated in 14.0 - 2024-11-09

-- Docs: https://docs.pytest.org/en/stable/how-to/capture-warnings.html
=========================== short test summary info ===========================
ERROR tests/test_race_condition_fix.py::TestRaceConditionFix::test_unique_constraint_prevents_double_booking - sqlalchemy.exc.InvalidRequestError: Multiple classes found for path "Booking" in the registry of this declarative base. Please use a fully module-qualified path.
python : 
C:\Users\surya\AppData\Roaming\Python\Python313\site-packages\_pytest\unraisableexception.py:33: 
RuntimeWarning: coroutine 'Connection._cancel' was never awaited
At line:1 char:126
+ ... ckend\src"; python -m pytest tests/test_race_condition_fix.py -v --tb ...
+                 ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    + CategoryInfo          : NotSpecified: (C:\Users\surya\...s never awaited:String) [], Remot 
   eException
    + FullyQualifiedErrorId : NativeCommandError
 
  gc.collect()
RuntimeWarning: Enable tracemalloc to get the object allocation traceback
ERROR tests/test_race_condition_fix.py::TestRaceConditionFix::test_concurrent_booking_attempts_only_one_succeeds - RuntimeError: Task <Task pending name='Task-7' coro=<_wrap_asyncgen_fixture.<locals>._asyncgen_fixture_wrapper.<locals>.setup() running at C:\Users\surya\scoop\apps\python\current\Lib\site-packages\pytest_asyncio\plugin.py:314> cb=[_run_until_complete_cb() at C:\Users\surya\scoop\apps\python\current\Lib\asyncio\base_events.py:181]> got Future <Future pending cb=[BaseProtocol._on_waiter_completed()]> attached to a different loop
ERROR tests/test_race_condition_fix.py::TestRaceConditionFix::test_select_for_update_row_locking - sqlalchemy.exc.InvalidRequestError: One or more mappers failed to initialize - can't proceed with initialization of other mappers. Triggering mapper: 'Mapper[Booking(bookings)]'. Original exception was: Multiple classes found for path "Booking" in the registry of this declarative base. Please use a fully module-qualified path.
ERROR tests/test_race_condition_fix.py::TestRaceConditionFix::test_optimistic_locking_prevents_concurrent_updates - RuntimeError: Task <Task pending name='Task-19' coro=<_wrap_asyncgen_fixture.<locals>._asyncgen_fixture_wrapper.<locals>.setup() running at C:\Users\surya\scoop\apps\python\current\Lib\site-packages\pytest_asyncio\plugin.py:314> cb=[_run_until_complete_cb() at C:\Users\surya\scoop\apps\python\current\Lib\asyncio\base_events.py:181]> got Future <Future pending cb=[BaseProtocol._on_waiter_completed()]> attached to a different loop
ERROR tests/test_race_condition_fix.py::TestRaceConditionFix::test_integrity_error_handling_and_user_message - sqlalchemy.exc.InvalidRequestError: One or more mappers failed to initialize - can't proceed with initialization of other mappers. Triggering mapper: 'Mapper[Booking(bookings)]'. Original exception was: Multiple classes found for path "Booking" in the registry of this declarative base. Please use a fully module-qualified path.
ERROR tests/test_race_condition_fix.py::TestRaceConditionFix::test_cancelled_bookings_dont_block_new_bookings - RuntimeError: Task <Task pending name='Task-31' coro=<_wrap_asyncgen_fixture.<locals>._asyncgen_fixture_wrapper.<locals>.setup() running at C:\Users\surya\scoop\apps\python\current\Lib\site-packages\pytest_asyncio\plugin.py:314> cb=[_run_until_complete_cb() at C:\Users\surya\scoop\apps\python\current\Lib\asyncio\base_events.py:181]> got Future <Future pending cb=[BaseProtocol._on_waiter_completed()]> attached to a different loop
ERROR tests/test_race_condition_fix.py::TestRaceConditionFix::test_high_concurrency_stress_test - sqlalchemy.exc.InvalidRequestError: One or more mappers failed to initialize - can't proceed with initialization of other mappers. Triggering mapper: 'Mapper[Booking(bookings)]'. Original exception was: Multiple classes found for path "Booking" in the registry of this declarative base. Please use a fully module-qualified path.
ERROR tests/test_race_condition_fix.py::TestRaceConditionFix::test_race_condition_with_different_party_sizes - RuntimeError: Task <Task pending name='Task-43' coro=<_wrap_asyncgen_fixture.<locals>._asyncgen_fixture_wrapper.<locals>.setup() running at C:\Users\surya\scoop\apps\python\current\Lib\site-packages\pytest_asyncio\plugin.py:314> cb=[_run_until_complete_cb() at C:\Users\surya\scoop\apps\python\current\Lib\asyncio\base_events.py:181]> got Future <Future pending cb=[BaseProtocol._on_waiter_completed()]> attached to a different loop
======================= 41 warnings, 8 errors in 9.58s ========================
