"""add_phase2_models_travelzone_menuitem_pricingrule

Revision ID: 6fed0b9d2bdd
Revises: cfeccbfaa133
Create Date: 2025-11-26 00:04:24.252237

"""

from alembic import op
import sqlalchemy as sa
from sqlalchemy.dialects import postgresql

# revision identifiers, used by Alembic.
revision = "6fed0b9d2bdd"
down_revision = "cfeccbfaa133"
branch_labels = None
depends_on = None


def upgrade() -> None:
    # ### commands auto generated by Alembic - please adjust! ###
    op.create_table(
        "ai_export_jobs",
        sa.Column(
            "id",
            sa.Integer(),
            autoincrement=True,
            nullable=False,
            comment="Auto-incrementing ID (sequential)",
        ),
        sa.Column(
            "export_type",
            sa.String(length=50),
            nullable=False,
            comment="Export type (fine_tuning/evaluation/backup)",
        ),
        sa.Column(
            "status",
            sa.Enum("PENDING", "IN_PROGRESS", "COMPLETED", "FAILED", name="exportstatus"),
            nullable=False,
            comment="Job status (pending/in_progress/completed/failed)",
        ),
        sa.Column(
            "min_similarity_score",
            sa.Float(),
            nullable=False,
            comment="Minimum similarity score threshold (0.0-1.0)",
        ),
        sa.Column(
            "min_rlhf_score",
            sa.Float(),
            nullable=True,
            comment="Minimum RLHF score threshold (1.0-5.0) if available",
        ),
        sa.Column(
            "date_range_start",
            sa.DateTime(),
            nullable=True,
            comment="Export pairs created after this date (NULL = all)",
        ),
        sa.Column(
            "date_range_end",
            sa.DateTime(),
            nullable=True,
            comment="Export pairs created before this date (NULL = all)",
        ),
        sa.Column(
            "pairs_exported", sa.Integer(), nullable=False, comment="Number of tutor pairs exported"
        ),
        sa.Column(
            "output_file_path",
            sa.String(length=500),
            nullable=True,
            comment="Path to generated JSONL file",
        ),
        sa.Column(
            "output_file_size_mb", sa.Float(), nullable=True, comment="File size in megabytes"
        ),
        sa.Column("error_message", sa.Text(), nullable=True, comment="Error message if job failed"),
        sa.Column(
            "started_at",
            sa.DateTime(),
            nullable=True,
            comment="Job start timestamp (when worker began processing)",
        ),
        sa.Column(
            "completed_at",
            sa.DateTime(),
            nullable=True,
            comment="Job completion timestamp (success or failure)",
        ),
        sa.Column("created_at", sa.DateTime(), nullable=False, comment="Job creation timestamp"),
        sa.Column(
            "created_by", sa.Integer(), nullable=True, comment="Admin user ID who created this job"
        ),
        sa.PrimaryKeyConstraint("id", name=op.f("pk_ai_export_jobs")),
        schema="ai",
    )
    op.create_index(
        "idx_export_creator",
        "ai_export_jobs",
        ["created_by", "created_at"],
        unique=False,
        schema="ai",
    )
    op.create_index(
        "idx_export_status", "ai_export_jobs", ["status", "created_at"], unique=False, schema="ai"
    )
    op.create_index(
        "idx_export_type", "ai_export_jobs", ["export_type", "status"], unique=False, schema="ai"
    )
    op.create_index(
        op.f("ix_ai_ai_export_jobs_created_at"),
        "ai_export_jobs",
        ["created_at"],
        unique=False,
        schema="ai",
    )
    op.create_index(
        op.f("ix_ai_ai_export_jobs_id"), "ai_export_jobs", ["id"], unique=False, schema="ai"
    )
    op.create_index(
        op.f("ix_ai_ai_export_jobs_status"), "ai_export_jobs", ["status"], unique=False, schema="ai"
    )
    op.create_table(
        "ai_tutor_pairs",
        sa.Column(
            "id",
            sa.Integer(),
            autoincrement=True,
            nullable=False,
            comment="Auto-incrementing ID (sequential)",
        ),
        sa.Column(
            "prompt", sa.Text(), nullable=False, comment="User's original prompt (training input)"
        ),
        sa.Column(
            "context",
            sa.Text(),
            nullable=True,
            comment="\n        Conversation context/history (training context):\n        - Previous messages\n        - Customer preferences\n        - Booking details\n        - Session state\n        ",
        ),
        sa.Column(
            "agent_type",
            sa.String(length=50),
            nullable=True,
            comment="\n        Which AI agent type handled this request:\n        - booking_agent\n        - menu_agent\n        - support_agent\n        - general_agent\n        ",
        ),
        sa.Column(
            "teacher_model",
            sa.String(length=50),
            nullable=False,
            comment="Teacher model name (gpt-4-turbo, gpt-3.5-turbo)",
        ),
        sa.Column(
            "teacher_response",
            sa.Text(),
            nullable=False,
            comment="Teacher's response (gold standard)",
        ),
        sa.Column(
            "teacher_tokens",
            sa.Integer(),
            nullable=True,
            comment="Teacher tokens consumed (input + output)",
        ),
        sa.Column(
            "teacher_cost_usd",
            sa.Float(),
            nullable=True,
            comment="Teacher cost in USD (GPT-4: ~$0.02/1K tokens)",
        ),
        sa.Column(
            "teacher_response_time_ms",
            sa.Integer(),
            nullable=True,
            comment="Teacher response time in milliseconds",
        ),
        sa.Column(
            "student_model",
            sa.String(length=50),
            nullable=False,
            comment="Student model name (llama-3-8b-instruct)",
        ),
        sa.Column(
            "student_response",
            sa.Text(),
            nullable=False,
            comment="Student's response (training target)",
        ),
        sa.Column(
            "student_tokens",
            sa.Integer(),
            nullable=True,
            comment="Student tokens generated (output only, input is local)",
        ),
        sa.Column(
            "student_response_time_ms",
            sa.Integer(),
            nullable=True,
            comment="Student response time in milliseconds (should be faster)",
        ),
        sa.Column(
            "similarity_score",
            sa.Float(),
            nullable=True,
            comment="\n        Cosine similarity between teacher and student embeddings (0-1):\n        - 1.0: Identical responses\n        - 0.85+: Very similar (safe to use student)\n        - 0.7-0.84: Similar (review needed)\n        - <0.7: Different (use teacher)\n        ",
        ),
        sa.Column(
            "quality_score",
            sa.Float(),
            nullable=True,
            comment="\n        Overall quality assessment (0-1):\n        Combines:\n        - Similarity score\n        - RLHF scores (if available)\n        - Customer feedback\n        - Resolution success\n        ",
        ),
        sa.Column(
            "used_in_production",
            sa.Boolean(),
            nullable=False,
            comment="\n        Did we use student response in production?\n        True = Used student (cost savings!)\n        False = Used teacher (quality priority)\n        ",
        ),
        sa.Column(
            "customer_feedback",
            sa.String(length=20),
            nullable=True,
            comment="\n        Customer feedback on response:\n        - positive (thumbs up, 4-5 rating)\n        - neutral (3 rating, no feedback)\n        - negative (thumbs down, 1-2 rating)\n        ",
        ),
        sa.Column("created_at", sa.DateTime(), nullable=False, comment="Pair creation timestamp"),
        sa.Column(
            "updated_at",
            sa.DateTime(),
            nullable=False,
            comment="Last update timestamp (feedback, RLHF scores)",
        ),
        sa.PrimaryKeyConstraint("id", name=op.f("pk_ai_tutor_pairs")),
        schema="ai",
    )
    op.create_index(
        "idx_tutor_agent", "ai_tutor_pairs", ["agent_type", "created_at"], unique=False, schema="ai"
    )
    op.create_index(
        "idx_tutor_created", "ai_tutor_pairs", ["created_at"], unique=False, schema="ai"
    )
    op.create_index(
        "idx_tutor_feedback",
        "ai_tutor_pairs",
        ["customer_feedback", "created_at"],
        unique=False,
        schema="ai",
    )
    op.create_index(
        "idx_tutor_production",
        "ai_tutor_pairs",
        ["used_in_production", "created_at"],
        unique=False,
        schema="ai",
    )
    op.create_index(
        "idx_tutor_quality",
        "ai_tutor_pairs",
        ["quality_score", "created_at"],
        unique=False,
        schema="ai",
    )
    op.create_index(
        "idx_tutor_similarity",
        "ai_tutor_pairs",
        ["similarity_score", "created_at"],
        unique=False,
        schema="ai",
    )
    op.create_index(
        op.f("ix_ai_ai_tutor_pairs_created_at"),
        "ai_tutor_pairs",
        ["created_at"],
        unique=False,
        schema="ai",
    )
    op.create_index(
        op.f("ix_ai_ai_tutor_pairs_id"), "ai_tutor_pairs", ["id"], unique=False, schema="ai"
    )
    op.create_table(
        "customer_engagement_followups",
        sa.Column(
            "id",
            sa.String(length=255),
            nullable=False,
            comment="Unique follow-up identifier (UUID, max 255 for compatibility)",
        ),
        sa.Column(
            "conversation_id",
            sa.String(length=255),
            nullable=False,
            comment="Original conversation ID that triggered this follow-up",
        ),
        sa.Column(
            "user_id", sa.String(length=255), nullable=False, comment="User ID to send follow-up to"
        ),
        sa.Column(
            "trigger_type",
            sa.String(length=50),
            nullable=False,
            comment="Trigger type (post_event/reengagement/emotion_based/custom)",
        ),
        sa.Column(
            "trigger_data",
            postgresql.JSONB(astext_type=sa.Text()),
            nullable=False,
            comment="\n        Trigger-specific data (JSONB for flexibility):\n        - POST_EVENT: {booking_id, event_date, emotion_score, chef_name}\n        - RE_ENGAGEMENT: {last_active_date, booking_count, total_spent}\n        - EMOTION_BASED: {emotion_score, emotion_trend, message_id}\n        - CUSTOM: {admin_id, campaign_name, promo_code}\n        ",
        ),
        sa.Column(
            "scheduled_at",
            sa.DateTime(),
            nullable=False,
            comment="When to send this follow-up (scheduler queries this field)",
        ),
        sa.Column(
            "executed_at",
            sa.DateTime(),
            nullable=True,
            comment="When follow-up was actually sent (NULL if not executed yet)",
        ),
        sa.Column(
            "cancelled_at",
            sa.DateTime(),
            nullable=True,
            comment="When follow-up was cancelled (NULL if not cancelled)",
        ),
        sa.Column(
            "status",
            sa.String(length=20),
            nullable=False,
            comment="Execution status (pending/executed/cancelled/failed)",
        ),
        sa.Column(
            "template_id",
            sa.String(length=50),
            nullable=True,
            comment="\n        Template ID for message generation:\n        - post_event_high_emotion\n        - post_event_neutral_emotion\n        - post_event_low_emotion\n        - reengagement_general\n        - emotion_recovery\n        - custom_admin\n        ",
        ),
        sa.Column(
            "message_content",
            sa.Text(),
            nullable=True,
            comment="\n        Pre-rendered message content (template variables replaced).\n        NULL if not yet rendered. Rendered at scheduling time or execution time.\n        ",
        ),
        sa.Column(
            "created_at",
            sa.DateTime(),
            nullable=False,
            comment="When follow-up was created/scheduled",
        ),
        sa.Column(
            "error_message",
            sa.Text(),
            nullable=True,
            comment="Error message if execution failed (for debugging)",
        ),
        sa.Column(
            "retry_count",
            sa.Integer(),
            nullable=False,
            comment="Number of retry attempts (max 3, exponential backoff)",
        ),
        sa.PrimaryKeyConstraint("id", name=op.f("pk_customer_engagement_followups")),
        schema="ai",
    )
    op.create_index(
        "idx_followups_conversation",
        "customer_engagement_followups",
        ["conversation_id"],
        unique=False,
        schema="ai",
    )
    op.create_index(
        "idx_followups_created",
        "customer_engagement_followups",
        ["created_at"],
        unique=False,
        schema="ai",
    )
    op.create_index(
        "idx_followups_duplicate_check",
        "customer_engagement_followups",
        ["user_id", "trigger_type", "status", "scheduled_at"],
        unique=False,
        schema="ai",
    )
    op.create_index(
        "idx_followups_executed",
        "customer_engagement_followups",
        ["executed_at"],
        unique=False,
        schema="ai",
    )
    op.create_index(
        "idx_followups_status_scheduled",
        "customer_engagement_followups",
        ["status", "scheduled_at"],
        unique=False,
        schema="ai",
    )
    op.create_index(
        "idx_followups_trigger_type",
        "customer_engagement_followups",
        ["trigger_type", "status"],
        unique=False,
        schema="ai",
    )
    op.create_index(
        "idx_followups_user_status",
        "customer_engagement_followups",
        ["user_id", "status"],
        unique=False,
        schema="ai",
    )
    op.create_index(
        op.f("ix_ai_customer_engagement_followups_conversation_id"),
        "customer_engagement_followups",
        ["conversation_id"],
        unique=False,
        schema="ai",
    )
    op.create_index(
        op.f("ix_ai_customer_engagement_followups_scheduled_at"),
        "customer_engagement_followups",
        ["scheduled_at"],
        unique=False,
        schema="ai",
    )
    op.create_index(
        op.f("ix_ai_customer_engagement_followups_user_id"),
        "customer_engagement_followups",
        ["user_id"],
        unique=False,
        schema="ai",
    )
    op.create_table(
        "escalation_rules",
        sa.Column(
            "id", sa.String(length=36), nullable=False, comment="Unique rule identifier (UUID)"
        ),
        sa.Column(
            "rule_name",
            sa.String(length=100),
            nullable=False,
            comment="\n        Rule name (unique identifier):\n        - explicit_human_request\n        - low_confidence\n        - negative_sentiment\n        - complex_query\n        - payment_issue\n        ",
        ),
        sa.Column(
            "description",
            sa.Text(),
            nullable=True,
            comment="Human-readable description of what triggers this rule",
        ),
        sa.Column(
            "keywords",
            postgresql.JSONB(astext_type=sa.Text()),
            nullable=False,
            comment='\n        Keywords that trigger escalation (case-insensitive):\n        ["speak to human", "manager", "complaint", "angry", "frustrated"]\n        Empty array = no keyword trigger\n        ',
        ),
        sa.Column(
            "confidence_threshold",
            sa.Float(),
            nullable=True,
            comment="\n        Escalate if AI confidence below this threshold (0.0-1.0).\n        Example: 0.6 = escalate if confidence <60%\n        NULL = no confidence trigger\n        ",
        ),
        sa.Column(
            "sentiment_threshold",
            sa.Float(),
            nullable=True,
            comment="\n        Escalate if emotion score below this threshold (0.0-1.0).\n        Example: 0.3 = escalate if emotion <30% (negative)\n        NULL = no sentiment trigger\n        ",
        ),
        sa.Column(
            "is_active",
            sa.Boolean(),
            nullable=False,
            comment="Active/inactive toggle (no deletion needed)",
        ),
        sa.Column(
            "priority",
            sa.Integer(),
            nullable=False,
            comment="\n        Rule priority (higher number = higher priority).\n        Rules evaluated in descending priority order:\n        - 10: Critical (explicit human request)\n        - 8: High (severe negative sentiment)\n        - 5: Medium (low confidence)\n        - 1: Low (general fallbacks)\n        ",
        ),
        sa.Column("created_at", sa.DateTime(), nullable=False, comment="Rule creation timestamp"),
        sa.Column("updated_at", sa.DateTime(), nullable=False, comment="Last update timestamp"),
        sa.PrimaryKeyConstraint("id", name=op.f("pk_escalation_rules")),
        sa.UniqueConstraint("rule_name", name=op.f("uq_escalation_rules_rule_name")),
        schema="ai",
    )
    op.create_index(
        "idx_escalation_active_priority",
        "escalation_rules",
        ["is_active", "priority"],
        unique=False,
        schema="ai",
    )
    op.create_index(
        "idx_escalation_updated", "escalation_rules", ["updated_at"], unique=False, schema="ai"
    )
    op.create_table(
        "kb_chunks",
        sa.Column(
            "id", sa.String(length=36), nullable=False, comment="Unique chunk identifier (UUID)"
        ),
        sa.Column(
            "title",
            sa.String(length=500),
            nullable=False,
            comment="Chunk title (question, heading, topic)",
        ),
        sa.Column(
            "text",
            sa.Text(),
            nullable=False,
            comment="Chunk content (answer, documentation, procedure)",
        ),
        sa.Column(
            "vector",
            sa.JSON(),
            nullable=True,
            comment="\n        Vector embedding (384-dimensional for all-MiniLM-L6-v2).\n        TODO: Change to VECTOR(384) when pgvector extension is enabled.\n        Current: JSON array [0.1, 0.2, ..., 0.384]\n        Future: VECTOR(384) with IVFFlat or HNSW index\n        ",
        ),
        sa.Column(
            "tags",
            postgresql.JSONB(astext_type=sa.Text()),
            nullable=False,
            comment='\n        Tag array for flexible categorization:\n        ["booking", "pricing", "menu", "cancellation", "refund"]\n        GIN index for fast array searches.\n        ',
        ),
        sa.Column(
            "category",
            sa.String(length=100),
            nullable=True,
            comment="\n        Primary category for hierarchical organization:\n        - booking (booking flow, availability)\n        - menu (dishes, pricing, ingredients)\n        - policy (refunds, cancellations, guarantees)\n        - procedure (step-by-step guides)\n        - general (company info, contact)\n        ",
        ),
        sa.Column(
            "source_type",
            sa.String(length=50),
            nullable=True,
            comment="Source type (faq/policy/procedure/learned/menu/custom)",
        ),
        sa.Column(
            "usage_count",
            sa.Integer(),
            nullable=False,
            comment="Number of times this chunk was used in AI responses",
        ),
        sa.Column(
            "success_rate",
            sa.Float(),
            nullable=False,
            comment="\n        Success rate based on customer feedback (0.0-1.0).\n        Calculated from: positive_feedback / total_usage\n        Auto-deprecate chunks with low success rates (<0.5)\n        ",
        ),
        sa.Column("created_at", sa.DateTime(), nullable=False, comment="Chunk creation timestamp"),
        sa.Column("updated_at", sa.DateTime(), nullable=False, comment="Last update timestamp"),
        sa.Column(
            "source_message_id",
            sa.String(length=36),
            nullable=True,
            comment="\n        Source message ID for learned content.\n        If this chunk was learned from a high-quality AI response,\n        store the message_id here for traceability.\n        ",
        ),
        sa.Column(
            "created_by_agent_id",
            sa.String(length=255),
            nullable=True,
            comment="\n        Agent/admin ID who created this chunk.\n        - Admin ID: Manual creation\n        - 'ai_learning': Automatically learned from conversations\n        ",
        ),
        sa.PrimaryKeyConstraint("id", name=op.f("pk_kb_chunks")),
        schema="ai",
    )
    op.create_index("idx_kb_category", "kb_chunks", ["category"], unique=False, schema="ai")
    op.create_index(
        "idx_kb_source_message", "kb_chunks", ["source_message_id"], unique=False, schema="ai"
    )
    op.create_index("idx_kb_source_type", "kb_chunks", ["source_type"], unique=False, schema="ai")
    op.create_index(
        "idx_kb_tags", "kb_chunks", ["tags"], unique=False, schema="ai", postgresql_using="gin"
    )
    op.create_index("idx_kb_updated", "kb_chunks", ["updated_at"], unique=False, schema="ai")
    op.create_index(
        "idx_kb_usage_success",
        "kb_chunks",
        ["usage_count", "success_rate"],
        unique=False,
        schema="ai",
    )
    op.create_table(
        "call_recordings",
        sa.Column("id", sa.UUID(), nullable=False),
        sa.Column("rc_call_id", sa.String(length=100), nullable=False),
        sa.Column("rc_recording_id", sa.String(length=100), nullable=False),
        sa.Column("rc_recording_uri", sa.Text(), nullable=False),
        sa.Column("booking_id", sa.UUID(), nullable=True),
        sa.Column("customer_id", sa.UUID(), nullable=True),
        sa.Column("escalation_id", sa.UUID(), nullable=True),
        sa.Column(
            "call_type",
            sa.Enum("inbound", "outbound", "internal", name="recordingtype"),
            nullable=False,
        ),
        sa.Column("from_phone", sa.String(length=20), nullable=False),
        sa.Column("to_phone", sa.String(length=20), nullable=False),
        sa.Column("duration_seconds", sa.Integer(), nullable=False),
        sa.Column("call_started_at", sa.DateTime(timezone=True), nullable=False),
        sa.Column("call_ended_at", sa.DateTime(timezone=True), nullable=True),
        sa.Column(
            "status",
            sa.Enum(
                "pending",
                "downloading",
                "available",
                "archived",
                "deleted",
                "error",
                name="recordingstatus",
            ),
            nullable=False,
        ),
        sa.Column("s3_bucket", sa.String(length=255), nullable=True),
        sa.Column("s3_key", sa.String(length=500), nullable=True),
        sa.Column("s3_uri", sa.Text(), nullable=True),
        sa.Column("file_size_bytes", sa.Integer(), nullable=True),
        sa.Column("content_type", sa.String(length=100), nullable=True),
        sa.Column("rc_transcript", sa.Text(), nullable=True),
        sa.Column("rc_transcript_confidence", sa.Integer(), nullable=True),
        sa.Column("rc_transcript_fetched_at", sa.DateTime(timezone=True), nullable=True),
        sa.Column("rc_ai_insights", postgresql.JSONB(astext_type=sa.Text()), nullable=False),
        sa.Column("recording_metadata", postgresql.JSONB(astext_type=sa.Text()), nullable=False),
        sa.Column("tags", postgresql.JSONB(astext_type=sa.Text()), nullable=False),
        sa.Column("retention_days", sa.Integer(), nullable=False),
        sa.Column("delete_after", sa.DateTime(timezone=True), nullable=True),
        sa.Column("accessed_count", sa.Integer(), nullable=False),
        sa.Column("last_accessed_at", sa.DateTime(timezone=True), nullable=True),
        sa.Column("error_message", sa.Text(), nullable=True),
        sa.Column("download_attempts", sa.Integer(), nullable=False),
        sa.Column(
            "created_at",
            sa.DateTime(timezone=True),
            server_default=sa.text("now()"),
            nullable=False,
        ),
        sa.Column(
            "updated_at",
            sa.DateTime(timezone=True),
            server_default=sa.text("now()"),
            nullable=False,
        ),
        sa.Column("downloaded_at", sa.DateTime(timezone=True), nullable=True),
        sa.Column("archived_at", sa.DateTime(timezone=True), nullable=True),
        sa.Column("deleted_at", sa.DateTime(timezone=True), nullable=True),
        sa.PrimaryKeyConstraint("id", name=op.f("pk_call_recordings")),
    )
    op.create_index(
        op.f("ix_call_recordings_booking_id"), "call_recordings", ["booking_id"], unique=False
    )
    op.create_index(
        op.f("ix_call_recordings_call_started_at"),
        "call_recordings",
        ["call_started_at"],
        unique=False,
    )
    op.create_index(
        op.f("ix_call_recordings_call_type"), "call_recordings", ["call_type"], unique=False
    )
    op.create_index(
        op.f("ix_call_recordings_created_at"), "call_recordings", ["created_at"], unique=False
    )
    op.create_index(
        op.f("ix_call_recordings_customer_id"), "call_recordings", ["customer_id"], unique=False
    )
    op.create_index(
        op.f("ix_call_recordings_delete_after"), "call_recordings", ["delete_after"], unique=False
    )
    op.create_index(
        op.f("ix_call_recordings_escalation_id"), "call_recordings", ["escalation_id"], unique=False
    )
    op.create_index(
        op.f("ix_call_recordings_from_phone"), "call_recordings", ["from_phone"], unique=False
    )
    op.create_index(op.f("ix_call_recordings_id"), "call_recordings", ["id"], unique=False)
    op.create_index(
        op.f("ix_call_recordings_rc_call_id"), "call_recordings", ["rc_call_id"], unique=True
    )
    op.create_index(
        op.f("ix_call_recordings_rc_recording_id"),
        "call_recordings",
        ["rc_recording_id"],
        unique=True,
    )
    op.create_index(op.f("ix_call_recordings_status"), "call_recordings", ["status"], unique=False)
    op.create_index(
        op.f("ix_call_recordings_to_phone"), "call_recordings", ["to_phone"], unique=False
    )
    op.create_table(
        "catering_bookings",
        sa.Column("customer_name", sa.String(length=255), nullable=False),
        sa.Column("customer_email", sa.String(length=255), nullable=False),
        sa.Column("customer_phone", sa.String(length=20), nullable=False),
        sa.Column("alternative_payer_name", sa.String(length=255), nullable=True),
        sa.Column("alternative_payer_email", sa.String(length=255), nullable=True),
        sa.Column("alternative_payer_phone", sa.String(length=20), nullable=True),
        sa.Column("alternative_payer_venmo", sa.String(length=100), nullable=True),
        sa.Column("event_date", sa.DateTime(), nullable=False),
        sa.Column("event_location", sa.Text(), nullable=False),
        sa.Column("guest_count", sa.Integer(), nullable=False),
        sa.Column("service_type", sa.String(length=100), nullable=True),
        sa.Column("base_amount", sa.Numeric(precision=10, scale=2), nullable=False),
        sa.Column("tip_amount", sa.Numeric(precision=10, scale=2), nullable=True),
        sa.Column("tax_amount", sa.Numeric(precision=10, scale=2), nullable=True),
        sa.Column("total_amount", sa.Numeric(precision=10, scale=2), nullable=False),
        sa.Column("status", sa.String(length=50), nullable=True),
        sa.Column("special_requests", sa.Text(), nullable=True),
        sa.Column("dietary_restrictions", sa.Text(), nullable=True),
        sa.Column("internal_notes", sa.Text(), nullable=True),
        sa.Column("confirmed_at", sa.DateTime(), nullable=True),
        sa.Column("completed_at", sa.DateTime(), nullable=True),
        sa.Column("cancelled_at", sa.DateTime(), nullable=True),
        sa.Column("id", sa.Integer(), nullable=False),
        sa.Column("created_at", sa.DateTime(), nullable=True),
        sa.Column("updated_at", sa.DateTime(), nullable=True),
        sa.Column("is_deleted", sa.Boolean(), nullable=False),
        sa.PrimaryKeyConstraint("id", name=op.f("pk_catering_bookings")),
    )
    op.create_index(
        op.f("ix_catering_bookings_customer_email"),
        "catering_bookings",
        ["customer_email"],
        unique=False,
    )
    op.create_index(
        op.f("ix_catering_bookings_customer_name"),
        "catering_bookings",
        ["customer_name"],
        unique=False,
    )
    op.create_index(
        op.f("ix_catering_bookings_customer_phone"),
        "catering_bookings",
        ["customer_phone"],
        unique=False,
    )
    op.create_index(
        op.f("ix_catering_bookings_event_date"), "catering_bookings", ["event_date"], unique=False
    )
    op.create_index(op.f("ix_catering_bookings_id"), "catering_bookings", ["id"], unique=False)
    op.create_index(
        op.f("ix_catering_bookings_status"), "catering_bookings", ["status"], unique=False
    )
    op.create_table(
        "chefs",
        sa.Column("id", sa.UUID(), nullable=False),
        sa.Column("first_name", sa.String(length=100), nullable=False),
        sa.Column("last_name", sa.String(length=100), nullable=False),
        sa.Column("email", sa.String(length=255), nullable=False),
        sa.Column("phone", sa.String(length=20), nullable=False),
        sa.Column("bio", sa.Text(), nullable=True),
        sa.Column("specialties", sa.Text(), nullable=True),
        sa.Column("years_experience", sa.Integer(), nullable=True),
        sa.Column("is_active", sa.Boolean(), nullable=False),
        sa.Column("chef_metadata", postgresql.JSONB(astext_type=sa.Text()), nullable=False),
        sa.Column(
            "created_at",
            sa.DateTime(timezone=True),
            server_default=sa.text("now()"),
            nullable=False,
        ),
        sa.Column(
            "updated_at",
            sa.DateTime(timezone=True),
            server_default=sa.text("now()"),
            nullable=False,
        ),
        sa.PrimaryKeyConstraint("id", name=op.f("pk_chefs")),
        schema="core",
    )
    op.create_index("idx_chefs_active", "chefs", ["is_active"], unique=False, schema="core")
    op.create_index("idx_chefs_email", "chefs", ["email"], unique=False, schema="core")
    op.create_index("idx_chefs_phone", "chefs", ["phone"], unique=False, schema="core")
    op.create_index(op.f("ix_core_chefs_email"), "chefs", ["email"], unique=True, schema="core")
    op.create_index(
        op.f("ix_core_chefs_is_active"), "chefs", ["is_active"], unique=False, schema="core"
    )
    op.create_index(op.f("ix_core_chefs_phone"), "chefs", ["phone"], unique=False, schema="core")
    op.create_table(
        "pricing_tiers",
        sa.Column("id", sa.UUID(), nullable=False),
        sa.Column("name", sa.String(length=100), nullable=False),
        sa.Column(
            "level",
            sa.Enum(
                "STANDARD",
                "PREMIUM",
                "DELUXE",
                "CUSTOM",
                name="pricing_tier_level",
                schema="public",
            ),
            nullable=False,
        ),
        sa.Column("description", sa.Text(), nullable=True),
        sa.Column("base_price", sa.Integer(), nullable=False),
        sa.Column("price_per_guest", sa.Integer(), nullable=False),
        sa.Column("min_guests", sa.Integer(), nullable=False),
        sa.Column("max_guests", sa.Integer(), nullable=False),
        sa.Column("is_active", sa.Boolean(), nullable=False),
        sa.Column("tier_metadata", postgresql.JSONB(astext_type=sa.Text()), nullable=False),
        sa.Column(
            "created_at",
            sa.DateTime(timezone=True),
            server_default=sa.text("now()"),
            nullable=False,
        ),
        sa.Column(
            "updated_at",
            sa.DateTime(timezone=True),
            server_default=sa.text("now()"),
            nullable=False,
        ),
        sa.CheckConstraint(
            "base_price >= 0", name=op.f("ck_pricing_tiers_check_base_price_positive")
        ),
        sa.CheckConstraint(
            "max_guests >= min_guests", name=op.f("ck_pricing_tiers_check_max_guests_valid")
        ),
        sa.CheckConstraint(
            "min_guests > 0", name=op.f("ck_pricing_tiers_check_min_guests_positive")
        ),
        sa.PrimaryKeyConstraint("id", name=op.f("pk_pricing_tiers")),
        schema="core",
    )
    op.create_index(
        "idx_pricing_tiers_active", "pricing_tiers", ["is_active"], unique=False, schema="core"
    )
    op.create_index(
        "idx_pricing_tiers_level", "pricing_tiers", ["level"], unique=False, schema="core"
    )
    op.create_index(
        op.f("ix_core_pricing_tiers_is_active"),
        "pricing_tiers",
        ["is_active"],
        unique=False,
        schema="core",
    )
    op.create_index(
        op.f("ix_core_pricing_tiers_level"), "pricing_tiers", ["level"], unique=False, schema="core"
    )
    op.create_table(
        "social_threads",
        sa.Column("id", sa.UUID(), nullable=False),
        sa.Column(
            "platform",
            sa.Enum(
                "INSTAGRAM",
                "FACEBOOK",
                "TWITTER",
                "TIKTOK",
                "LINKEDIN",
                name="social_platform",
                schema="public",
            ),
            nullable=False,
        ),
        sa.Column("platform_thread_id", sa.String(length=255), nullable=False),
        sa.Column("customer_name", sa.String(length=255), nullable=True),
        sa.Column("customer_handle", sa.String(length=255), nullable=True),
        sa.Column(
            "status",
            sa.Enum(
                "OPEN", "PENDING", "REPLIED", "CLOSED", name="social_thread_status", schema="public"
            ),
            nullable=False,
        ),
        sa.Column("thread_metadata", postgresql.JSONB(astext_type=sa.Text()), nullable=False),
        sa.Column(
            "created_at",
            sa.DateTime(timezone=True),
            server_default=sa.text("now()"),
            nullable=False,
        ),
        sa.Column(
            "updated_at",
            sa.DateTime(timezone=True),
            server_default=sa.text("now()"),
            nullable=False,
        ),
        sa.Column("last_message_at", sa.DateTime(timezone=True), nullable=True),
        sa.PrimaryKeyConstraint("id", name=op.f("pk_social_threads")),
        sa.UniqueConstraint(
            "platform_thread_id", name=op.f("uq_social_threads_platform_thread_id")
        ),
        schema="core",
    )
    op.create_index(
        "idx_social_threads_created_at",
        "social_threads",
        ["created_at"],
        unique=False,
        schema="core",
    )
    op.create_index(
        "idx_social_threads_platform", "social_threads", ["platform"], unique=False, schema="core"
    )
    op.create_index(
        "idx_social_threads_status", "social_threads", ["status"], unique=False, schema="core"
    )
    op.create_index(
        op.f("ix_core_social_threads_platform"),
        "social_threads",
        ["platform"],
        unique=False,
        schema="core",
    )
    op.create_index(
        op.f("ix_core_social_threads_status"),
        "social_threads",
        ["status"],
        unique=False,
        schema="core",
    )
    op.create_table(
        "campaigns",
        sa.Column("id", sa.UUID(), server_default=sa.text("gen_random_uuid()"), nullable=False),
        sa.Column("name", sa.String(length=200), nullable=False),
        sa.Column(
            "channel",
            sa.Enum("EMAIL", "SMS", "BOTH", name="campaign_channel", schema="public"),
            nullable=False,
        ),
        sa.Column("subject", sa.Text(), nullable=True),
        sa.Column("content", postgresql.JSONB(astext_type=sa.Text()), nullable=False),
        sa.Column("segment_filter", postgresql.JSONB(astext_type=sa.Text()), nullable=True),
        sa.Column("scheduled_at", sa.DateTime(timezone=True), nullable=True),
        sa.Column("sent_at", sa.DateTime(timezone=True), nullable=True),
        sa.Column(
            "status",
            sa.Enum(
                "DRAFT",
                "SCHEDULED",
                "SENDING",
                "SENT",
                "CANCELLED",
                name="campaign_status",
                schema="public",
            ),
            nullable=False,
        ),
        sa.Column("total_recipients", sa.Integer(), nullable=False),
        sa.Column("created_by", sa.String(length=100), nullable=False),
        sa.Column(
            "created_at",
            sa.DateTime(timezone=True),
            server_default=sa.text("now()"),
            nullable=False,
        ),
        sa.PrimaryKeyConstraint("id", name=op.f("pk_campaigns")),
        schema="crm",
    )
    op.create_index(
        "idx_crm_campaigns_channel", "campaigns", ["channel"], unique=False, schema="crm"
    )
    op.create_index("idx_crm_campaigns_sent", "campaigns", ["sent_at"], unique=False, schema="crm")
    op.create_index("idx_crm_campaigns_status", "campaigns", ["status"], unique=False, schema="crm")
    op.create_table(
        "customer_segments",
        sa.Column("id", sa.UUID(), server_default=sa.text("gen_random_uuid()"), nullable=False),
        sa.Column("name", sa.String(length=200), nullable=False),
        sa.Column("description", sa.Text(), nullable=True),
        sa.Column("is_active", sa.Boolean(), nullable=False),
        sa.Column("estimated_size", sa.Integer(), nullable=True),
        sa.Column("last_calculated_at", sa.DateTime(timezone=True), nullable=True),
        sa.Column(
            "created_at",
            sa.DateTime(timezone=True),
            server_default=sa.text("now()"),
            nullable=False,
        ),
        sa.Column(
            "updated_at",
            sa.DateTime(timezone=True),
            server_default=sa.text("now()"),
            nullable=False,
        ),
        sa.PrimaryKeyConstraint("id", name=op.f("pk_customer_segments")),
        sa.UniqueConstraint("name", name=op.f("uq_customer_segments_name")),
        schema="crm",
    )
    op.create_index(
        "idx_crm_segments_active", "customer_segments", ["is_active"], unique=False, schema="crm"
    )
    op.create_table(
        "email_messages",
        sa.Column("message_id", sa.String(length=500), nullable=False),
        sa.Column("imap_uid", sa.Integer(), nullable=True),
        sa.Column("thread_id", sa.String(length=500), nullable=True),
        sa.Column("inbox", sa.String(length=100), nullable=False),
        sa.Column("folder", sa.String(length=200), nullable=False),
        sa.Column("subject", sa.String(length=1000), nullable=True),
        sa.Column("from_address", sa.String(length=500), nullable=False),
        sa.Column("from_name", sa.String(length=500), nullable=True),
        sa.Column("to_addresses", sa.JSON(), nullable=True),
        sa.Column("cc_addresses", sa.JSON(), nullable=True),
        sa.Column("bcc_addresses", sa.JSON(), nullable=True),
        sa.Column("reply_to", sa.String(length=500), nullable=True),
        sa.Column("text_body", sa.Text(), nullable=True),
        sa.Column("html_body", sa.Text(), nullable=True),
        sa.Column("received_at", sa.DateTime(), nullable=False),
        sa.Column("sent_at", sa.DateTime(), nullable=True),
        sa.Column("is_read", sa.Boolean(), nullable=False),
        sa.Column("is_starred", sa.Boolean(), nullable=False),
        sa.Column("is_archived", sa.Boolean(), nullable=False),
        sa.Column("is_spam", sa.Boolean(), nullable=False),
        sa.Column("is_draft", sa.Boolean(), nullable=False),
        sa.Column("is_sent", sa.Boolean(), nullable=False),
        sa.Column("has_attachments", sa.Boolean(), nullable=False),
        sa.Column("attachments", sa.JSON(), nullable=True),
        sa.Column("labels", sa.JSON(), nullable=True),
        sa.Column("raw_headers", sa.JSON(), nullable=True),
        sa.Column("last_synced_at", sa.DateTime(), nullable=True),
        sa.Column("sync_error", sa.Text(), nullable=True),
        sa.Column("id", sa.Integer(), nullable=False),
        sa.Column("created_at", sa.DateTime(), nullable=True),
        sa.Column("updated_at", sa.DateTime(), nullable=True),
        sa.Column("is_deleted", sa.Boolean(), nullable=False),
        sa.PrimaryKeyConstraint("id", name=op.f("pk_email_messages")),
    )
    op.create_index(
        "idx_from_address_received", "email_messages", ["from_address", "received_at"], unique=False
    )
    op.create_index(
        "idx_inbox_read_archived",
        "email_messages",
        ["inbox", "is_read", "is_archived"],
        unique=False,
    )
    op.create_index("idx_inbox_received", "email_messages", ["inbox", "received_at"], unique=False)
    op.create_index(
        "idx_thread_received", "email_messages", ["thread_id", "received_at"], unique=False
    )
    op.create_index(
        op.f("ix_email_messages_from_address"), "email_messages", ["from_address"], unique=False
    )
    op.create_index(op.f("ix_email_messages_id"), "email_messages", ["id"], unique=False)
    op.create_index(
        op.f("ix_email_messages_imap_uid"), "email_messages", ["imap_uid"], unique=False
    )
    op.create_index(op.f("ix_email_messages_inbox"), "email_messages", ["inbox"], unique=False)
    op.create_index(
        op.f("ix_email_messages_is_archived"), "email_messages", ["is_archived"], unique=False
    )
    op.create_index(op.f("ix_email_messages_is_read"), "email_messages", ["is_read"], unique=False)
    op.create_index(
        op.f("ix_email_messages_is_starred"), "email_messages", ["is_starred"], unique=False
    )
    op.create_index(
        op.f("ix_email_messages_message_id"), "email_messages", ["message_id"], unique=True
    )
    op.create_index(
        op.f("ix_email_messages_received_at"), "email_messages", ["received_at"], unique=False
    )
    op.create_index(op.f("ix_email_messages_subject"), "email_messages", ["subject"], unique=False)
    op.create_index(
        op.f("ix_email_messages_thread_id"), "email_messages", ["thread_id"], unique=False
    )
    op.create_table(
        "email_sync_status",
        sa.Column("inbox", sa.String(length=100), nullable=False),
        sa.Column("last_sync_at", sa.DateTime(), nullable=True),
        sa.Column("last_sync_uid", sa.Integer(), nullable=True),
        sa.Column("total_messages_synced", sa.Integer(), nullable=False),
        sa.Column("sync_errors", sa.Integer(), nullable=False),
        sa.Column("last_error", sa.Text(), nullable=True),
        sa.Column("last_error_at", sa.DateTime(), nullable=True),
        sa.Column("imap_host", sa.String(length=200), nullable=True),
        sa.Column("imap_folder", sa.String(length=200), nullable=False),
        sa.Column("is_syncing", sa.Boolean(), nullable=False),
        sa.Column("is_enabled", sa.Boolean(), nullable=False),
        sa.Column("id", sa.Integer(), nullable=False),
        sa.Column("created_at", sa.DateTime(), nullable=True),
        sa.Column("updated_at", sa.DateTime(), nullable=True),
        sa.Column("is_deleted", sa.Boolean(), nullable=False),
        sa.PrimaryKeyConstraint("id", name=op.f("pk_email_sync_status")),
    )
    op.create_index(op.f("ix_email_sync_status_id"), "email_sync_status", ["id"], unique=False)
    op.create_index(op.f("ix_email_sync_status_inbox"), "email_sync_status", ["inbox"], unique=True)
    op.create_table(
        "email_threads",
        sa.Column("thread_id", sa.String(length=500), nullable=False),
        sa.Column("inbox", sa.String(length=100), nullable=False),
        sa.Column("subject", sa.String(length=1000), nullable=True),
        sa.Column("participants", sa.JSON(), nullable=True),
        sa.Column("message_count", sa.Integer(), nullable=False),
        sa.Column("unread_count", sa.Integer(), nullable=False),
        sa.Column("first_message_at", sa.DateTime(), nullable=True),
        sa.Column("last_message_at", sa.DateTime(), nullable=True),
        sa.Column("is_read", sa.Boolean(), nullable=False),
        sa.Column("is_starred", sa.Boolean(), nullable=False),
        sa.Column("is_archived", sa.Boolean(), nullable=False),
        sa.Column("has_attachments", sa.Boolean(), nullable=False),
        sa.Column("labels", sa.JSON(), nullable=True),
        sa.Column("id", sa.Integer(), nullable=False),
        sa.Column("created_at", sa.DateTime(), nullable=True),
        sa.Column("updated_at", sa.DateTime(), nullable=True),
        sa.Column("is_deleted", sa.Boolean(), nullable=False),
        sa.PrimaryKeyConstraint("id", name=op.f("pk_email_threads")),
    )
    op.create_index(
        "idx_inbox_last_message", "email_threads", ["inbox", "last_message_at"], unique=False
    )
    op.create_index(
        "idx_inbox_read_archived",
        "email_threads",
        ["inbox", "is_read", "is_archived"],
        unique=False,
    )
    op.create_index(
        op.f("ix_email_threads_first_message_at"),
        "email_threads",
        ["first_message_at"],
        unique=False,
    )
    op.create_index(op.f("ix_email_threads_id"), "email_threads", ["id"], unique=False)
    op.create_index(op.f("ix_email_threads_inbox"), "email_threads", ["inbox"], unique=False)
    op.create_index(
        op.f("ix_email_threads_is_archived"), "email_threads", ["is_archived"], unique=False
    )
    op.create_index(op.f("ix_email_threads_is_read"), "email_threads", ["is_read"], unique=False)
    op.create_index(
        op.f("ix_email_threads_is_starred"), "email_threads", ["is_starred"], unique=False
    )
    op.create_index(
        op.f("ix_email_threads_last_message_at"), "email_threads", ["last_message_at"], unique=False
    )
    op.create_index(op.f("ix_email_threads_subject"), "email_threads", ["subject"], unique=False)
    op.create_index(op.f("ix_email_threads_thread_id"), "email_threads", ["thread_id"], unique=True)
    op.create_table(
        "domain_events",
        sa.Column("id", sa.UUID(), nullable=False),
        sa.Column("event_type", sa.String(length=100), nullable=False),
        sa.Column("event_version", sa.String(length=20), nullable=False),
        sa.Column("aggregate_type", sa.String(length=50), nullable=False),
        sa.Column("aggregate_id", sa.UUID(), nullable=False),
        sa.Column("aggregate_version", sa.Integer(), nullable=False),
        sa.Column("event_data", postgresql.JSONB(astext_type=sa.Text()), nullable=False),
        sa.Column("metadata", postgresql.JSONB(astext_type=sa.Text()), nullable=False),
        sa.Column("causation_id", sa.String(length=255), nullable=True),
        sa.Column("correlation_id", sa.String(length=255), nullable=True),
        sa.Column("user_id", sa.String(length=255), nullable=True),
        sa.Column("occurred_at", sa.DateTime(timezone=True), nullable=False),
        sa.Column("version", sa.Integer(), nullable=False),
        sa.Column("payload", sa.JSON(), nullable=False),
        sa.Column("created_at", sa.DateTime(timezone=True), nullable=False),
        sa.Column("hash_previous", sa.String(length=64), nullable=False),
        sa.Column("hash_current", sa.String(length=64), nullable=False),
        sa.Column("updated_at", sa.DateTime(), nullable=True),
        sa.Column("is_deleted", sa.Boolean(), nullable=False),
        sa.PrimaryKeyConstraint("id", name=op.f("pk_domain_events")),
        sa.UniqueConstraint("hash_current", name=op.f("uq_domain_events_hash_current")),
        schema="events",
    )
    op.create_index(
        "idx_domain_events_aggregate_id",
        "domain_events",
        ["aggregate_id"],
        unique=False,
        schema="events",
    )
    op.create_index(
        "idx_domain_events_aggregate_type_id",
        "domain_events",
        ["aggregate_type", "aggregate_id"],
        unique=False,
        schema="events",
    )
    op.create_index(
        "idx_domain_events_event_type",
        "domain_events",
        ["event_type"],
        unique=False,
        schema="events",
    )
    op.create_index(
        "idx_domain_events_occurred_at",
        "domain_events",
        ["occurred_at"],
        unique=False,
        schema="events",
    )
    op.create_index(
        op.f("ix_events_domain_events_aggregate_id"),
        "domain_events",
        ["aggregate_id"],
        unique=False,
        schema="events",
    )
    op.create_index(
        op.f("ix_events_domain_events_aggregate_type"),
        "domain_events",
        ["aggregate_type"],
        unique=False,
        schema="events",
    )
    op.create_index(
        op.f("ix_events_domain_events_event_type"),
        "domain_events",
        ["event_type"],
        unique=False,
        schema="events",
    )
    op.create_index(
        op.f("ix_events_domain_events_occurred_at"),
        "domain_events",
        ["occurred_at"],
        unique=False,
        schema="events",
    )
    op.create_table(
        "inbox",
        sa.Column("id", sa.UUID(), nullable=False),
        sa.Column("message_id", sa.String(length=255), nullable=False),
        sa.Column("source", sa.String(length=100), nullable=False),
        sa.Column("source_type", sa.String(length=100), nullable=False),
        sa.Column("message_type", sa.String(length=255), nullable=False),
        sa.Column("message_data", postgresql.JSONB(astext_type=sa.Text()), nullable=False),
        sa.Column("is_processed", sa.Boolean(), nullable=False),
        sa.Column("processed_at", sa.DateTime(timezone=True), nullable=True),
        sa.Column("error_message", sa.Text(), nullable=True),
        sa.Column("retry_count", sa.Integer(), nullable=False),
        sa.Column("headers", postgresql.JSONB(astext_type=sa.Text()), nullable=False),
        sa.Column("metadata", postgresql.JSONB(astext_type=sa.Text()), nullable=False),
        sa.Column(
            "received_at",
            sa.DateTime(timezone=True),
            server_default=sa.text("now()"),
            nullable=False,
        ),
        sa.PrimaryKeyConstraint("id", name=op.f("pk_inbox")),
        schema="events",
    )
    op.create_index("idx_inbox_message_id", "inbox", ["message_id"], unique=False, schema="events")
    op.create_index("idx_inbox_processed", "inbox", ["is_processed"], unique=False, schema="events")
    op.create_index(
        "idx_inbox_received_at", "inbox", ["received_at"], unique=False, schema="events"
    )
    op.create_index("idx_inbox_source", "inbox", ["source"], unique=False, schema="events")
    op.create_index(
        op.f("ix_events_inbox_is_processed"),
        "inbox",
        ["is_processed"],
        unique=False,
        schema="events",
    )
    op.create_index(
        op.f("ix_events_inbox_message_id"), "inbox", ["message_id"], unique=True, schema="events"
    )
    op.create_index(
        op.f("ix_events_inbox_received_at"), "inbox", ["received_at"], unique=False, schema="events"
    )
    op.create_index(
        op.f("ix_events_inbox_source"), "inbox", ["source"], unique=False, schema="events"
    )
    op.create_table(
        "outbox",
        sa.Column("id", sa.UUID(), nullable=False),
        sa.Column("event_id", sa.String(length=255), nullable=True),
        sa.Column("aggregate_id", sa.String(length=255), nullable=False),
        sa.Column("event_type", sa.String(length=255), nullable=False),
        sa.Column("destination", sa.String(length=100), nullable=False),
        sa.Column("destination_url", sa.String(length=1000), nullable=True),
        sa.Column("payload", postgresql.JSONB(astext_type=sa.Text()), nullable=False),
        sa.Column("headers", postgresql.JSONB(astext_type=sa.Text()), nullable=False),
        sa.Column(
            "status",
            sa.Enum(
                "PENDING",
                "PROCESSING",
                "SENT",
                "FAILED",
                "RETRY",
                name="outbox_status",
                schema="public",
            ),
            server_default="pending",
            nullable=False,
        ),
        sa.Column("retry_count", sa.Integer(), nullable=False),
        sa.Column("max_retries", sa.Integer(), nullable=False),
        sa.Column("next_retry_at", sa.DateTime(timezone=True), nullable=True),
        sa.Column(
            "scheduled_at",
            sa.DateTime(timezone=True),
            server_default=sa.text("now()"),
            nullable=False,
        ),
        sa.Column("processed_at", sa.DateTime(timezone=True), nullable=True),
        sa.Column("error_message", sa.Text(), nullable=True),
        sa.Column("response_status_code", sa.Integer(), nullable=True),
        sa.Column("response_body", sa.Text(), nullable=True),
        sa.Column(
            "created_at",
            sa.DateTime(timezone=True),
            server_default=sa.text("now()"),
            nullable=False,
        ),
        sa.Column(
            "updated_at",
            sa.DateTime(timezone=True),
            server_default=sa.text("now()"),
            nullable=False,
        ),
        sa.PrimaryKeyConstraint("id", name=op.f("pk_outbox")),
        schema="events",
    )
    op.create_index(
        "idx_outbox_aggregate_id", "outbox", ["aggregate_id"], unique=False, schema="events"
    )
    op.create_index(
        "idx_outbox_created_at", "outbox", ["created_at"], unique=False, schema="events"
    )
    op.create_index(
        "idx_outbox_destination", "outbox", ["destination"], unique=False, schema="events"
    )
    op.create_index(
        "idx_outbox_scheduled_at", "outbox", ["scheduled_at"], unique=False, schema="events"
    )
    op.create_index("idx_outbox_status", "outbox", ["status"], unique=False, schema="events")
    op.create_index(
        op.f("ix_events_outbox_aggregate_id"),
        "outbox",
        ["aggregate_id"],
        unique=False,
        schema="events",
    )
    op.create_index(
        op.f("ix_events_outbox_created_at"), "outbox", ["created_at"], unique=False, schema="events"
    )
    op.create_index(
        op.f("ix_events_outbox_destination"),
        "outbox",
        ["destination"],
        unique=False,
        schema="events",
    )
    op.create_index(
        op.f("ix_events_outbox_scheduled_at"),
        "outbox",
        ["scheduled_at"],
        unique=False,
        schema="events",
    )
    op.create_index(
        op.f("ix_events_outbox_status"), "outbox", ["status"], unique=False, schema="events"
    )
    op.create_table(
        "discount_coupons",
        sa.Column("id", sa.UUID(), nullable=False),
        sa.Column("code", sa.String(length=50), nullable=False),
        sa.Column("description", sa.Text(), nullable=True),
        sa.Column("discount_percentage", sa.Integer(), nullable=True),
        sa.Column("discount_amount", sa.Integer(), nullable=True),
        sa.Column("valid_from", sa.DateTime(timezone=True), nullable=False),
        sa.Column("valid_until", sa.DateTime(timezone=True), nullable=False),
        sa.Column("max_uses", sa.Integer(), nullable=False),
        sa.Column("current_uses", sa.Integer(), nullable=False),
        sa.Column("min_booking_amount", sa.Integer(), nullable=True),
        sa.Column("max_discount_amount", sa.Integer(), nullable=True),
        sa.Column(
            "status",
            sa.Enum(
                "ACTIVE", "USED", "EXPIRED", "REVOKED", name="coupon_status", schema="feedback"
            ),
            server_default="active",
            nullable=False,
        ),
        sa.Column("coupon_metadata", postgresql.JSONB(astext_type=sa.Text()), nullable=False),
        sa.Column(
            "created_at",
            sa.DateTime(timezone=True),
            server_default=sa.text("now()"),
            nullable=False,
        ),
        sa.Column(
            "updated_at",
            sa.DateTime(timezone=True),
            server_default=sa.text("now()"),
            nullable=False,
        ),
        sa.CheckConstraint(
            "discount_amount >= 0", name=op.f("ck_discount_coupons_check_discount_amount")
        ),
        sa.CheckConstraint(
            "discount_percentage >= 0 AND discount_percentage <= 100",
            name=op.f("ck_discount_coupons_check_discount_percentage"),
        ),
        sa.CheckConstraint(
            "max_uses > 0", name=op.f("ck_discount_coupons_check_max_uses_positive")
        ),
        sa.PrimaryKeyConstraint("id", name=op.f("pk_discount_coupons")),
        schema="feedback",
    )
    op.create_index(
        "idx_discount_coupons_code", "discount_coupons", ["code"], unique=False, schema="feedback"
    )
    op.create_index(
        "idx_discount_coupons_status",
        "discount_coupons",
        ["status"],
        unique=False,
        schema="feedback",
    )
    op.create_index(
        "idx_discount_coupons_valid_from",
        "discount_coupons",
        ["valid_from"],
        unique=False,
        schema="feedback",
    )
    op.create_index(
        "idx_discount_coupons_valid_until",
        "discount_coupons",
        ["valid_until"],
        unique=False,
        schema="feedback",
    )
    op.create_index(
        op.f("ix_feedback_discount_coupons_code"),
        "discount_coupons",
        ["code"],
        unique=True,
        schema="feedback",
    )
    op.create_index(
        op.f("ix_feedback_discount_coupons_status"),
        "discount_coupons",
        ["status"],
        unique=False,
        schema="feedback",
    )
    op.create_index(
        op.f("ix_feedback_discount_coupons_valid_from"),
        "discount_coupons",
        ["valid_from"],
        unique=False,
        schema="feedback",
    )
    op.create_index(
        op.f("ix_feedback_discount_coupons_valid_until"),
        "discount_coupons",
        ["valid_until"],
        unique=False,
        schema="feedback",
    )
    op.create_table(
        "permissions",
        sa.Column("id", sa.UUID(), nullable=False),
        sa.Column("resource", sa.String(length=100), nullable=False),
        sa.Column(
            "action",
            sa.Enum(
                "READ",
                "WRITE",
                "DELETE",
                "EXECUTE",
                "ADMIN",
                name="permissiontype",
                schema="public",
            ),
            nullable=False,
        ),
        sa.Column("description", sa.Text(), nullable=True),
        sa.Column(
            "created_at",
            sa.DateTime(timezone=True),
            server_default=sa.text("now()"),
            nullable=False,
        ),
        sa.PrimaryKeyConstraint("id", name=op.f("pk_permissions")),
        sa.UniqueConstraint("resource", "action", name="uq_permissions_resource_action"),
        schema="identity",
    )
    op.create_index(
        "idx_permissions_resource_action",
        "permissions",
        ["resource", "action"],
        unique=False,
        schema="identity",
    )
    op.create_table(
        "roles",
        sa.Column("id", sa.UUID(), nullable=False),
        sa.Column("name", sa.String(length=100), nullable=False),
        sa.Column("description", sa.Text(), nullable=True),
        sa.Column(
            "role_type",
            sa.Enum(
                "SUPER_ADMIN",
                "ADMIN",
                "MANAGER",
                "STAFF",
                "CHEF",
                "CUSTOMER",
                name="roletype",
                schema="public",
            ),
            nullable=False,
        ),
        sa.Column("is_active", sa.Boolean(), nullable=False),
        sa.Column("is_system_role", sa.Boolean(), nullable=False),
        sa.Column(
            "created_at",
            sa.DateTime(timezone=True),
            server_default=sa.text("now()"),
            nullable=False,
        ),
        sa.Column(
            "updated_at",
            sa.DateTime(timezone=True),
            server_default=sa.text("now()"),
            nullable=False,
        ),
        sa.PrimaryKeyConstraint("id", name=op.f("pk_roles")),
        schema="identity",
    )
    op.create_index("idx_roles_active", "roles", ["is_active"], unique=False, schema="identity")
    op.create_index("idx_roles_name", "roles", ["name"], unique=False, schema="identity")
    op.create_index("idx_roles_role_type", "roles", ["role_type"], unique=False, schema="identity")
    op.create_index(
        op.f("ix_identity_roles_is_active"), "roles", ["is_active"], unique=False, schema="identity"
    )
    op.create_index(
        op.f("ix_identity_roles_name"), "roles", ["name"], unique=True, schema="identity"
    )
    op.create_index(
        op.f("ix_identity_roles_role_type"), "roles", ["role_type"], unique=False, schema="identity"
    )
    op.create_table(
        "stations",
        sa.Column("id", sa.UUID(), server_default=sa.text("gen_random_uuid()"), nullable=False),
        sa.Column("name", sa.String(length=100), nullable=False),
        sa.Column("code", sa.String(length=20), nullable=False),
        sa.Column("display_name", sa.String(length=200), nullable=False),
        sa.Column("country", sa.String(length=100), server_default="US", nullable=False),
        sa.Column(
            "timezone", sa.String(length=50), server_default="America/New_York", nullable=False
        ),
        sa.Column("status", sa.String(length=20), server_default="active", nullable=False),
        sa.Column(
            "settings", postgresql.JSON(astext_type=sa.Text()), server_default="{}", nullable=False
        ),
        sa.Column("max_concurrent_bookings", sa.Integer(), server_default="10", nullable=False),
        sa.Column("booking_lead_time_hours", sa.Integer(), server_default="24", nullable=False),
        sa.Column("email", sa.String(length=255), nullable=True),
        sa.Column("phone", sa.String(length=50), nullable=True),
        sa.Column("address", sa.Text(), nullable=True),
        sa.Column("city", sa.String(length=100), nullable=True),
        sa.Column("state", sa.String(length=50), nullable=True),
        sa.Column("postal_code", sa.String(length=20), nullable=True),
        sa.Column("business_hours", postgresql.JSON(astext_type=sa.Text()), nullable=True),
        sa.Column("service_area_radius", sa.Integer(), nullable=True),
        sa.Column("branding_config", postgresql.JSON(astext_type=sa.Text()), nullable=True),
        sa.Column(
            "created_at",
            sa.DateTime(timezone=True),
            server_default=sa.text("now()"),
            nullable=False,
        ),
        sa.Column(
            "updated_at",
            sa.DateTime(timezone=True),
            server_default=sa.text("now()"),
            nullable=False,
        ),
        sa.CheckConstraint(
            "status IN ('active', 'inactive', 'suspended', 'maintenance')",
            name=op.f("ck_stations_station_status_valid"),
        ),
        sa.CheckConstraint(
            "booking_lead_time_hours >= 0", name=op.f("ck_stations_station_lead_time_non_negative")
        ),
        sa.CheckConstraint(
            "max_concurrent_bookings > 0", name=op.f("ck_stations_station_max_bookings_positive")
        ),
        sa.PrimaryKeyConstraint("id", name=op.f("pk_stations")),
        sa.UniqueConstraint("code", name="unique_station_code"),
        schema="identity",
    )
    op.create_index("idx_station_code", "stations", ["code"], unique=False, schema="identity")
    op.create_index("idx_station_status", "stations", ["status"], unique=False, schema="identity")
    op.create_table(
        "users",
        sa.Column("id", sa.UUID(), nullable=False),
        sa.Column("email", sa.String(length=255), nullable=False),
        sa.Column("password_hash", sa.String(length=255), nullable=True),
        sa.Column("first_name", sa.String(length=100), nullable=True),
        sa.Column("last_name", sa.String(length=100), nullable=True),
        sa.Column("phone", sa.String(length=20), nullable=True),
        sa.Column("avatar_url", sa.String(length=500), nullable=True),
        sa.Column(
            "status",
            sa.Enum(
                "ACTIVE", "INACTIVE", "SUSPENDED", "PENDING", name="userstatus", schema="public"
            ),
            nullable=False,
        ),
        sa.Column("is_verified", sa.Boolean(), nullable=False),
        sa.Column("user_metadata", postgresql.JSONB(astext_type=sa.Text()), nullable=False),
        sa.Column("last_login_at", sa.DateTime(timezone=True), nullable=True),
        sa.Column(
            "created_at",
            sa.DateTime(timezone=True),
            server_default=sa.text("now()"),
            nullable=False,
        ),
        sa.Column(
            "updated_at",
            sa.DateTime(timezone=True),
            server_default=sa.text("now()"),
            nullable=False,
        ),
        sa.PrimaryKeyConstraint("id", name=op.f("pk_users")),
        schema="identity",
    )
    op.create_index(
        "idx_users_created_at", "users", ["created_at"], unique=False, schema="identity"
    )
    op.create_index("idx_users_email", "users", ["email"], unique=False, schema="identity")
    op.create_index("idx_users_status", "users", ["status"], unique=False, schema="identity")
    op.create_index(
        op.f("ix_identity_users_email"), "users", ["email"], unique=True, schema="identity"
    )
    op.create_index(
        op.f("ix_identity_users_status"), "users", ["status"], unique=False, schema="identity"
    )
    op.create_table(
        "payment_events",
        sa.Column(
            "id",
            sa.UUID(),
            server_default=sa.text("gen_random_uuid()"),
            nullable=False,
            comment="UUID primary key",
        ),
        sa.Column(
            "provider",
            sa.Enum("STRIPE", "PLAID", "MANUAL", name="paymentprovider", schema="integra"),
            nullable=False,
            comment="Payment provider (stripe, plaid, manual)",
        ),
        sa.Column(
            "provider_id",
            sa.String(length=255),
            nullable=False,
            comment="Provider's unique ID (e.g., Stripe charge ID, Plaid transaction ID)",
        ),
        sa.Column(
            "method",
            sa.Enum(
                "CARD",
                "ACH",
                "VENMO",
                "ZELLE",
                "CASH",
                "CHECK",
                name="paymentmethod",
                schema="integra",
            ),
            nullable=False,
            comment="Payment method (card, ach, venmo, zelle, cash, check)",
        ),
        sa.Column(
            "amount_cents",
            sa.Integer(),
            nullable=False,
            comment="Payment amount in cents (e.g., 5000 = $50.00)",
        ),
        sa.Column(
            "currency", sa.String(length=3), nullable=False, comment="Currency code (ISO 4217)"
        ),
        sa.Column(
            "occurred_at",
            sa.TIMESTAMP(timezone=True),
            nullable=False,
            comment="When the payment occurred (provider timestamp)",
        ),
        sa.Column(
            "memo",
            sa.Text(),
            nullable=True,
            comment="Optional notes (e.g., check number, Venmo reference)",
        ),
        sa.Column(
            "raw_data",
            postgresql.JSONB(astext_type=sa.Text()),
            nullable=False,
            comment="Complete webhook payload from provider (JSON)",
        ),
        sa.Column(
            "created_at",
            sa.TIMESTAMP(timezone=True),
            server_default="NOW()",
            nullable=False,
            comment="When this record was created in our system",
        ),
        sa.CheckConstraint(
            "amount_cents > 0", name=op.f("ck_payment_events_check_payment_amount_positive")
        ),
        sa.PrimaryKeyConstraint("id", name=op.f("pk_payment_events")),
        schema="integra",
    )
    op.create_index(
        "ix_integra_payment_events_occurred",
        "payment_events",
        ["occurred_at"],
        unique=False,
        schema="integra",
    )
    op.create_index(
        "ix_integra_payment_events_provider_id",
        "payment_events",
        ["provider", "provider_id"],
        unique=True,
        schema="integra",
    )
    op.create_table(
        "social_inbox",
        sa.Column(
            "signature",
            sa.String(length=255),
            nullable=False,
            comment="Webhook signature for idempotency (e.g., X-Hub-Signature, X-Webhook-Signature)",
        ),
        sa.Column(
            "platform",
            sa.Enum(
                "INSTAGRAM",
                "FACEBOOK",
                "GOOGLE_BUSINESS",
                "YELP",
                "TIKTOK",
                "TWITTER",
                name="socialplatform",
                schema="integra",
            ),
            nullable=False,
            comment="Social media platform (instagram, facebook, google_business, yelp, tiktok, twitter)",
        ),
        sa.Column(
            "webhook_type",
            sa.String(length=100),
            nullable=False,
            comment="Type of webhook event (e.g., 'messages', 'comments', 'mentions', 'reviews')",
        ),
        sa.Column(
            "account_id",
            sa.UUID(),
            nullable=True,
            comment="Reference to core.social_accounts (which business page)",
        ),
        sa.Column(
            "payload_hash",
            sa.String(length=64),
            nullable=False,
            comment="SHA256 hash of payload (for detecting duplicate webhooks)",
        ),
        sa.Column(
            "processed",
            sa.Boolean(),
            nullable=False,
            comment="Whether webhook has been successfully processed",
        ),
        sa.Column(
            "processing_attempts",
            sa.Integer(),
            nullable=False,
            comment="Number of processing attempts (max 3)",
        ),
        sa.Column(
            "last_error",
            sa.Text(),
            nullable=True,
            comment="Last error message (if processing failed)",
        ),
        sa.Column(
            "received_at",
            sa.TIMESTAMP(timezone=True),
            server_default="NOW()",
            nullable=False,
            comment="When webhook was received",
        ),
        sa.Column(
            "processed_at",
            sa.TIMESTAMP(timezone=True),
            nullable=True,
            comment="When webhook was successfully processed",
        ),
        sa.PrimaryKeyConstraint("signature", name=op.f("pk_social_inbox")),
        schema="integra",
    )
    op.create_index(
        "ix_social_inbox_platform_received",
        "social_inbox",
        ["platform", "received_at"],
        unique=False,
        schema="integra",
    )
    op.create_table(
        "campaigns",
        sa.Column("id", sa.UUID(), nullable=False),
        sa.Column("name", sa.String(length=200), nullable=False),
        sa.Column(
            "channel",
            sa.Enum("EMAIL", "SMS", "PUSH", "WHATSAPP", name="campaign_channel"),
            nullable=False,
        ),
        sa.Column(
            "status",
            sa.Enum(
                "DRAFT",
                "SCHEDULED",
                "SENDING",
                "SENT",
                "PAUSED",
                "CANCELLED",
                "FAILED",
                name="campaign_status",
            ),
            nullable=False,
        ),
        sa.Column("subject", sa.String(length=500), nullable=True),
        sa.Column("content", sa.Text(), nullable=False),
        sa.Column("sender_name", sa.String(length=100), nullable=True),
        sa.Column("reply_to", sa.String(length=200), nullable=True),
        sa.Column("scheduled_at", sa.DateTime(timezone=True), nullable=True),
        sa.Column("sent_at", sa.DateTime(timezone=True), nullable=True),
        sa.Column("completed_at", sa.DateTime(timezone=True), nullable=True),
        sa.Column("target_segment", sa.String(length=100), nullable=True),
        sa.Column(
            "extra_data",
            postgresql.JSONB(astext_type=sa.Text()),
            nullable=True,
            comment="Campaign metadata and custom fields",
        ),
        sa.Column("created_at", sa.DateTime(), nullable=True),
        sa.Column("updated_at", sa.DateTime(), nullable=True),
        sa.Column("is_deleted", sa.Boolean(), nullable=False),
        sa.PrimaryKeyConstraint("id", name=op.f("pk_campaigns")),
        schema="lead",
    )
    op.create_table(
        "social_accounts",
        sa.Column("id", sa.UUID(), nullable=False),
        sa.Column(
            "platform",
            sa.Enum(
                "INSTAGRAM",
                "FACEBOOK",
                "GOOGLE",
                "GOOGLE_BUSINESS",
                "YELP",
                "SMS",
                "PHONE",
                "STRIPE",
                "PLAID",
                name="social_platform",
            ),
            nullable=False,
            comment="Social media platform (instagram, facebook, etc.)",
        ),
        sa.Column(
            "page_id",
            sa.String(length=255),
            nullable=False,
            comment="Platform-specific page/business ID",
        ),
        sa.Column(
            "page_name",
            sa.String(length=255),
            nullable=False,
            comment="Display name of the business page",
        ),
        sa.Column(
            "handle",
            sa.String(length=100),
            nullable=True,
            comment="@username or handle if applicable",
        ),
        sa.Column("profile_url", sa.Text(), nullable=True),
        sa.Column("avatar_url", sa.Text(), nullable=True),
        sa.Column(
            "connected_by", sa.UUID(), nullable=False, comment="User ID who connected this account"
        ),
        sa.Column("connected_at", sa.DateTime(timezone=True), nullable=False),
        sa.Column(
            "token_ref",
            sa.Text(),
            nullable=True,
            comment="Encrypted reference to access tokens (do not store plaintext tokens)",
        ),
        sa.Column(
            "webhook_verified",
            sa.Boolean(),
            nullable=False,
            comment="Whether webhook subscription is verified",
        ),
        sa.Column(
            "last_sync_at",
            sa.DateTime(timezone=True),
            nullable=True,
            comment="Last successful sync with platform API",
        ),
        sa.Column(
            "is_active", sa.Boolean(), nullable=False, comment="Whether account is currently active"
        ),
        sa.Column(
            "platform_metadata",
            postgresql.JSONB(astext_type=sa.Text()),
            nullable=True,
            comment="Platform-specific settings, capabilities, and metadata",
        ),
        sa.Column("created_at", sa.DateTime(timezone=True), nullable=False),
        sa.Column("updated_at", sa.DateTime(timezone=True), nullable=False),
        sa.Column(
            "deleted_at", sa.DateTime(timezone=True), nullable=True, comment="Soft delete timestamp"
        ),
        sa.Column("is_deleted", sa.Boolean(), nullable=False),
        sa.PrimaryKeyConstraint("id", name=op.f("pk_social_accounts")),
        schema="lead",
    )
    op.create_index(
        op.f("ix_lead_social_accounts_is_active"),
        "social_accounts",
        ["is_active"],
        unique=False,
        schema="lead",
    )
    op.create_index(
        op.f("ix_lead_social_accounts_platform"),
        "social_accounts",
        ["platform"],
        unique=False,
        schema="lead",
    )
    op.create_index(
        "ix_social_accounts_is_active",
        "social_accounts",
        ["is_active"],
        unique=False,
        schema="lead",
    )
    op.create_index(
        "ix_social_accounts_platform", "social_accounts", ["platform"], unique=False, schema="lead"
    )
    op.create_index(
        "ix_social_accounts_platform_page_id",
        "social_accounts",
        ["platform", "page_id"],
        unique=True,
        schema="lead",
    )
    op.create_table(
        "social_identities",
        sa.Column("id", sa.UUID(), nullable=False),
        sa.Column(
            "platform",
            sa.Enum(
                "INSTAGRAM",
                "FACEBOOK",
                "GOOGLE",
                "GOOGLE_BUSINESS",
                "YELP",
                "SMS",
                "PHONE",
                "STRIPE",
                "PLAID",
                name="social_platform",
            ),
            nullable=False,
        ),
        sa.Column(
            "handle",
            sa.String(length=100),
            nullable=False,
            comment="Social handle without @ prefix",
        ),
        sa.Column("display_name", sa.String(length=255), nullable=True),
        sa.Column("profile_url", sa.Text(), nullable=True),
        sa.Column("avatar_url", sa.Text(), nullable=True),
        sa.Column(
            "customer_id",
            sa.UUID(),
            nullable=True,
            comment="Link to known customer (soft reference)",
        ),
        sa.Column(
            "confidence_score",
            sa.Float(),
            nullable=False,
            comment="Confidence in customer mapping (0.0 to 1.0)",
        ),
        sa.Column(
            "verification_status",
            sa.String(length=50),
            nullable=False,
            comment="Verification status: unverified, pending, verified, rejected",
        ),
        sa.Column(
            "first_seen_at",
            sa.DateTime(timezone=True),
            nullable=False,
            comment="When this identity was first detected",
        ),
        sa.Column(
            "last_active_at",
            sa.DateTime(timezone=True),
            nullable=True,
            comment="Last interaction timestamp",
        ),
        sa.Column(
            "platform_metadata",
            postgresql.JSONB(astext_type=sa.Text()),
            nullable=True,
            comment="Platform-specific profile data",
        ),
        sa.Column("created_at", sa.DateTime(timezone=True), nullable=False),
        sa.Column("updated_at", sa.DateTime(timezone=True), nullable=False),
        sa.Column("is_deleted", sa.Boolean(), nullable=False),
        sa.PrimaryKeyConstraint("id", name=op.f("pk_social_identities")),
        schema="lead",
    )
    op.create_index(
        op.f("ix_lead_social_identities_customer_id"),
        "social_identities",
        ["customer_id"],
        unique=False,
        schema="lead",
    )
    op.create_index(
        op.f("ix_lead_social_identities_platform"),
        "social_identities",
        ["platform"],
        unique=False,
        schema="lead",
    )
    op.create_index(
        "ix_social_identities_customer_id",
        "social_identities",
        ["customer_id"],
        unique=False,
        schema="lead",
    )
    op.create_index(
        "ix_social_identities_platform",
        "social_identities",
        ["platform"],
        unique=False,
        schema="lead",
    )
    op.create_index(
        "ix_social_identities_platform_handle",
        "social_identities",
        ["platform", "handle"],
        unique=True,
        schema="lead",
    )
    op.create_table(
        "subscribers",
        sa.Column("id", sa.UUID(), nullable=False),
        sa.Column("email", sa.String(length=255), nullable=True),
        sa.Column("phone", sa.String(length=20), nullable=True),
        sa.Column("first_name", sa.String(length=100), nullable=True),
        sa.Column("last_name", sa.String(length=100), nullable=True),
        sa.Column("email_subscribed", sa.Boolean(), nullable=False),
        sa.Column("sms_subscribed", sa.Boolean(), nullable=False),
        sa.Column("push_subscribed", sa.Boolean(), nullable=False),
        sa.Column("whatsapp_subscribed", sa.Boolean(), nullable=False),
        sa.Column("subscribed_at", sa.DateTime(timezone=True), nullable=False),
        sa.Column("email_unsubscribed_at", sa.DateTime(timezone=True), nullable=True),
        sa.Column("sms_unsubscribed_at", sa.DateTime(timezone=True), nullable=True),
        sa.Column("language", sa.String(length=10), nullable=False),
        sa.Column("timezone", sa.String(length=50), nullable=True),
        sa.Column(
            "tags",
            postgresql.JSONB(astext_type=sa.Text()),
            nullable=True,
            comment="Subscriber tags for segmentation",
        ),
        sa.Column(
            "customer_id",
            sa.UUID(),
            nullable=True,
            comment="Soft reference to customer (validated at application level)",
        ),
        sa.Column(
            "lead_id",
            sa.UUID(),
            nullable=True,
            comment="Soft reference to lead (validated at application level)",
        ),
        sa.Column("source", sa.String(length=100), nullable=True),
        sa.Column("utm_source", sa.String(length=100), nullable=True),
        sa.Column("utm_medium", sa.String(length=100), nullable=True),
        sa.Column("utm_campaign", sa.String(length=100), nullable=True),
        sa.Column("last_email_sent_at", sa.DateTime(timezone=True), nullable=True),
        sa.Column("last_email_opened_at", sa.DateTime(timezone=True), nullable=True),
        sa.Column("last_email_clicked_at", sa.DateTime(timezone=True), nullable=True),
        sa.Column("last_sms_sent_at", sa.DateTime(timezone=True), nullable=True),
        sa.Column("email_open_count", sa.Integer(), nullable=False),
        sa.Column("email_click_count", sa.Integer(), nullable=False),
        sa.Column("sms_response_count", sa.Integer(), nullable=False),
        sa.Column(
            "extra_data",
            postgresql.JSONB(astext_type=sa.Text()),
            nullable=True,
            comment="Subscriber metadata and custom fields",
        ),
        sa.Column("created_at", sa.DateTime(), nullable=True),
        sa.Column("updated_at", sa.DateTime(), nullable=True),
        sa.Column("is_deleted", sa.Boolean(), nullable=False),
        sa.PrimaryKeyConstraint("id", name=op.f("pk_subscribers")),
        schema="lead",
    )
    op.create_index(
        op.f("ix_lead_subscribers_customer_id"),
        "subscribers",
        ["customer_id"],
        unique=False,
        schema="lead",
    )
    op.create_index(
        op.f("ix_lead_subscribers_email"), "subscribers", ["email"], unique=False, schema="lead"
    )
    op.create_index(
        op.f("ix_lead_subscribers_lead_id"), "subscribers", ["lead_id"], unique=False, schema="lead"
    )
    op.create_index(
        op.f("ix_lead_subscribers_phone"), "subscribers", ["phone"], unique=False, schema="lead"
    )
    op.create_table(
        "qr_codes",
        sa.Column("id", sa.UUID(), nullable=False),
        sa.Column("code", sa.String(length=100), nullable=False),
        sa.Column(
            "type",
            sa.Enum(
                "MENU",
                "BOOKING",
                "REVIEW",
                "PROMOTION",
                "EVENT",
                name="qr_code_type",
                schema="marketing",
            ),
            nullable=False,
        ),
        sa.Column("name", sa.String(length=255), nullable=False),
        sa.Column("description", sa.Text(), nullable=True),
        sa.Column("target_url", sa.String(length=1000), nullable=False),
        sa.Column("scan_count", sa.Integer(), nullable=False),
        sa.Column("last_scanned_at", sa.DateTime(timezone=True), nullable=True),
        sa.Column("is_active", sa.Boolean(), nullable=False),
        sa.Column("qr_metadata", postgresql.JSONB(astext_type=sa.Text()), nullable=False),
        sa.Column(
            "created_at",
            sa.DateTime(timezone=True),
            server_default=sa.text("now()"),
            nullable=False,
        ),
        sa.Column(
            "updated_at",
            sa.DateTime(timezone=True),
            server_default=sa.text("now()"),
            nullable=False,
        ),
        sa.PrimaryKeyConstraint("id", name=op.f("pk_qr_codes")),
        schema="marketing",
    )
    op.create_index(
        "idx_qr_codes_active", "qr_codes", ["is_active"], unique=False, schema="marketing"
    )
    op.create_index("idx_qr_codes_code", "qr_codes", ["code"], unique=False, schema="marketing")
    op.create_index("idx_qr_codes_type", "qr_codes", ["type"], unique=False, schema="marketing")
    op.create_index(
        op.f("ix_marketing_qr_codes_code"), "qr_codes", ["code"], unique=True, schema="marketing"
    )
    op.create_index(
        op.f("ix_marketing_qr_codes_is_active"),
        "qr_codes",
        ["is_active"],
        unique=False,
        schema="marketing",
    )
    op.create_index(
        op.f("ix_marketing_qr_codes_type"), "qr_codes", ["type"], unique=False, schema="marketing"
    )
    op.create_table(
        "campaigns",
        sa.Column("id", sa.UUID(), server_default=sa.text("gen_random_uuid()"), nullable=False),
        sa.Column("name", sa.String(length=200), nullable=False),
        sa.Column(
            "channel",
            sa.Enum("EMAIL", "SMS", "BOTH", name="campaign_channel", schema="public"),
            nullable=False,
        ),
        sa.Column("subject", sa.Text(), nullable=True),
        sa.Column("content", postgresql.JSONB(astext_type=sa.Text()), nullable=False),
        sa.Column("segment_filter", postgresql.JSONB(astext_type=sa.Text()), nullable=True),
        sa.Column("scheduled_at", sa.DateTime(timezone=True), nullable=True),
        sa.Column("sent_at", sa.DateTime(timezone=True), nullable=True),
        sa.Column(
            "status",
            sa.Enum(
                "DRAFT",
                "SCHEDULED",
                "SENDING",
                "SENT",
                "CANCELLED",
                name="campaign_status",
                schema="public",
            ),
            nullable=False,
        ),
        sa.Column("total_recipients", sa.Integer(), nullable=False),
        sa.Column("created_by", sa.String(length=100), nullable=False),
        sa.Column(
            "created_at",
            sa.DateTime(timezone=True),
            server_default=sa.text("now()"),
            nullable=False,
        ),
        sa.PrimaryKeyConstraint("id", name=op.f("pk_campaigns")),
        schema="newsletter",
    )
    op.create_index(
        "ix_newsletter_campaigns_sent", "campaigns", ["sent_at"], unique=False, schema="newsletter"
    )
    op.create_index(
        "ix_newsletter_campaigns_status", "campaigns", ["status"], unique=False, schema="newsletter"
    )
    op.create_table(
        "chefs",
        sa.Column("id", sa.UUID(), server_default=sa.text("gen_random_uuid()"), nullable=False),
        sa.Column("first_name", sa.String(length=100), nullable=False),
        sa.Column("last_name", sa.String(length=100), nullable=False),
        sa.Column("email", sa.String(length=255), nullable=False),
        sa.Column("phone", sa.String(length=20), nullable=False),
        sa.Column(
            "specialty",
            sa.Enum(
                "TEPPANYAKI",
                "SUSHI",
                "FUSION",
                "HIBACHI",
                "ASIAN_FUSION",
                name="chef_specialty",
                schema="public",
            ),
            nullable=False,
        ),
        sa.Column("years_experience", sa.Integer(), nullable=True),
        sa.Column("certifications", sa.ARRAY(sa.String()), nullable=True),
        sa.Column(
            "status",
            sa.Enum(
                "ACTIVE", "INACTIVE", "ON_LEAVE", "TERMINATED", name="chef_status", schema="public"
            ),
            nullable=False,
        ),
        sa.Column("is_active", sa.Boolean(), nullable=False),
        sa.Column("rating", sa.Numeric(precision=3, scale=2), nullable=True),
        sa.Column("total_bookings", sa.Integer(), nullable=False),
        sa.Column("completed_bookings", sa.Integer(), nullable=False),
        sa.Column("hired_date", sa.Date(), nullable=True),
        sa.Column(
            "created_at",
            sa.DateTime(timezone=True),
            server_default=sa.text("now()"),
            nullable=False,
        ),
        sa.Column(
            "updated_at",
            sa.DateTime(timezone=True),
            server_default=sa.text("now()"),
            nullable=False,
        ),
        sa.CheckConstraint(
            "rating >= 0 AND rating <= 5", name=op.f("ck_chefs_check_chef_rating_range")
        ),
        sa.PrimaryKeyConstraint("id", name=op.f("pk_chefs")),
        sa.UniqueConstraint("email", name=op.f("uq_chefs_email")),
        schema="ops",
    )
    op.create_index("idx_ops_chefs_active", "chefs", ["is_active"], unique=False, schema="ops")
    op.create_index("idx_ops_chefs_rating", "chefs", ["rating"], unique=False, schema="ops")
    op.create_index("idx_ops_chefs_specialty", "chefs", ["specialty"], unique=False, schema="ops")
    op.create_table(
        "equipment",
        sa.Column("id", sa.UUID(), server_default=sa.text("gen_random_uuid()"), nullable=False),
        sa.Column("name", sa.String(length=200), nullable=False),
        sa.Column(
            "type",
            sa.Enum(
                "GRILL",
                "UTENSILS",
                "VEHICLE",
                "COOLER",
                "STORAGE",
                "COOKWARE",
                name="equipment_type",
                schema="public",
            ),
            nullable=False,
        ),
        sa.Column("description", sa.Text(), nullable=True),
        sa.Column(
            "status",
            sa.Enum(
                "AVAILABLE",
                "IN_USE",
                "MAINTENANCE",
                "RETIRED",
                name="equipment_status",
                schema="public",
            ),
            nullable=False,
        ),
        sa.Column("last_maintenance_date", sa.Date(), nullable=True),
        sa.Column("next_maintenance_date", sa.Date(), nullable=True),
        sa.Column("purchase_cost", sa.Numeric(precision=10, scale=2), nullable=True),
        sa.Column("purchase_date", sa.Date(), nullable=True),
        sa.Column(
            "created_at",
            sa.DateTime(timezone=True),
            server_default=sa.text("now()"),
            nullable=False,
        ),
        sa.Column(
            "updated_at",
            sa.DateTime(timezone=True),
            server_default=sa.text("now()"),
            nullable=False,
        ),
        sa.PrimaryKeyConstraint("id", name=op.f("pk_equipment")),
        schema="ops",
    )
    op.create_index("idx_ops_equipment_status", "equipment", ["status"], unique=False, schema="ops")
    op.create_index("idx_ops_equipment_type", "equipment", ["type"], unique=False, schema="ops")
    op.create_table(
        "inventory",
        sa.Column("id", sa.UUID(), server_default=sa.text("gen_random_uuid()"), nullable=False),
        sa.Column("name", sa.String(length=200), nullable=False),
        sa.Column(
            "category",
            sa.Enum(
                "FOOD",
                "BEVERAGE",
                "SUPPLIES",
                "EQUIPMENT",
                "PACKAGING",
                name="inventory_category",
                schema="public",
            ),
            nullable=False,
        ),
        sa.Column("description", sa.Text(), nullable=True),
        sa.Column("current_quantity", sa.Numeric(precision=10, scale=2), nullable=False),
        sa.Column("unit_of_measure", sa.String(length=20), nullable=False),
        sa.Column("reorder_point", sa.Numeric(precision=10, scale=2), nullable=True),
        sa.Column("unit_cost", sa.Numeric(precision=10, scale=2), nullable=True),
        sa.Column(
            "created_at",
            sa.DateTime(timezone=True),
            server_default=sa.text("now()"),
            nullable=False,
        ),
        sa.Column(
            "updated_at",
            sa.DateTime(timezone=True),
            server_default=sa.text("now()"),
            nullable=False,
        ),
        sa.PrimaryKeyConstraint("id", name=op.f("pk_inventory")),
        schema="ops",
    )
    op.create_index(
        "idx_ops_inventory_category", "inventory", ["category"], unique=False, schema="ops"
    )
    op.create_index(
        "idx_ops_inventory_reorder", "inventory", ["current_quantity"], unique=False, schema="ops"
    )
    op.create_table(
        "menu_items",
        sa.Column("id", sa.UUID(), server_default=sa.text("gen_random_uuid()"), nullable=False),
        sa.Column("name", sa.String(length=200), nullable=False),
        sa.Column("description", sa.Text(), nullable=False),
        sa.Column("category", sa.String(length=50), nullable=False),
        sa.Column("base_price_per_person", sa.Numeric(precision=10, scale=2), nullable=False),
        sa.Column("dietary_tags", postgresql.JSONB(astext_type=sa.Text()), nullable=False),
        sa.Column("ingredients", postgresql.JSONB(astext_type=sa.Text()), nullable=False),
        sa.Column("is_available", sa.Boolean(), nullable=False),
        sa.Column("seasonal", sa.Boolean(), nullable=False),
        sa.Column(
            "created_at",
            sa.DateTime(timezone=True),
            server_default=sa.text("now()"),
            nullable=False,
        ),
        sa.Column(
            "updated_at",
            sa.DateTime(timezone=True),
            server_default=sa.text("now()"),
            nullable=False,
        ),
        sa.PrimaryKeyConstraint("id", name=op.f("pk_menu_items")),
        schema="ops",
    )
    op.create_index(
        "idx_ops_menu_items_available", "menu_items", ["is_available"], unique=False, schema="ops"
    )
    op.create_index(
        "idx_ops_menu_items_category", "menu_items", ["category"], unique=False, schema="ops"
    )
    op.create_table(
        "pricing_rules",
        sa.Column("id", sa.UUID(), server_default=sa.text("gen_random_uuid()"), nullable=False),
        sa.Column("rule_name", sa.String(length=200), nullable=False),
        sa.Column("rule_type", sa.String(length=50), nullable=False),
        sa.Column("conditions", postgresql.JSONB(astext_type=sa.Text()), nullable=False),
        sa.Column("pricing_formula", postgresql.JSONB(astext_type=sa.Text()), nullable=False),
        sa.Column("effective_start_date", sa.Date(), nullable=False),
        sa.Column("effective_end_date", sa.Date(), nullable=True),
        sa.Column("priority", sa.Integer(), nullable=False),
        sa.Column("is_active", sa.Boolean(), nullable=False),
        sa.Column(
            "created_at",
            sa.DateTime(timezone=True),
            server_default=sa.text("now()"),
            nullable=False,
        ),
        sa.Column(
            "updated_at",
            sa.DateTime(timezone=True),
            server_default=sa.text("now()"),
            nullable=False,
        ),
        sa.PrimaryKeyConstraint("id", name=op.f("pk_pricing_rules")),
        schema="ops",
    )
    op.create_index(
        "idx_ops_pricing_rules_active", "pricing_rules", ["is_active"], unique=False, schema="ops"
    )
    op.create_index(
        "idx_ops_pricing_rules_priority", "pricing_rules", ["priority"], unique=False, schema="ops"
    )
    op.create_index(
        "idx_ops_pricing_rules_type", "pricing_rules", ["rule_type"], unique=False, schema="ops"
    )
    op.create_table(
        "travel_zones",
        sa.Column("id", sa.UUID(), server_default=sa.text("gen_random_uuid()"), nullable=False),
        sa.Column("name", sa.String(length=100), nullable=False),
        sa.Column("description", sa.Text(), nullable=True),
        sa.Column("zip_codes", postgresql.JSONB(astext_type=sa.Text()), nullable=False),
        sa.Column("base_fee", sa.Numeric(precision=10, scale=2), nullable=False),
        sa.Column("per_mile_fee", sa.Numeric(precision=10, scale=2), nullable=False),
        sa.Column("max_distance_miles", sa.Integer(), nullable=False),
        sa.Column("is_active", sa.Boolean(), nullable=False),
        sa.Column(
            "created_at",
            sa.DateTime(timezone=True),
            server_default=sa.text("now()"),
            nullable=False,
        ),
        sa.Column(
            "updated_at",
            sa.DateTime(timezone=True),
            server_default=sa.text("now()"),
            nullable=False,
        ),
        sa.PrimaryKeyConstraint("id", name=op.f("pk_travel_zones")),
        schema="ops",
    )
    op.create_index(
        "idx_ops_travel_zones_active", "travel_zones", ["is_active"], unique=False, schema="ops"
    )
    op.create_table(
        "permissions",
        sa.Column("id", sa.UUID(), nullable=False),
        sa.Column(
            "name",
            sa.Enum(
                "user:create",
                "user:read",
                "user:update",
                "user:delete",
                "user:approve",
                "station:create",
                "station:read",
                "station:update",
                "station:delete",
                "station:assign",
                "booking:create",
                "booking:read",
                "booking:update",
                "booking:delete",
                "booking:cancel",
                "customer:create",
                "customer:read",
                "customer:update",
                "customer:delete",
                "payment:create",
                "payment:read",
                "payment:refund",
                "payment:void",
                "review:read",
                "review:moderate",
                "review:respond",
                "analytics:view",
                "analytics:export",
                "analytics:forecast",
                "settings:read",
                "settings:update",
                "settings:system",
                "newsletter:create",
                "newsletter:read",
                "newsletter:update",
                "newsletter:delete",
                "newsletter:send",
                "campaign:create",
                "campaign:read",
                "campaign:update",
                "campaign:delete",
                "sms:send",
                "sms:read",
                "sms:campaign:create",
                "sms:campaign:send",
                "ai:config:read",
                "ai:config:update",
                "ai:faq:manage",
                "ai:learning:view",
                "ai:learning:train",
                "inbox:read",
                "inbox:reply",
                "inbox:assign",
                "escalation:create",
                "escalation:read",
                "escalation:handle",
                "escalation:resolve",
                "recording:read",
                "recording:download",
                "recording:delete",
                name="permissiontype",
            ),
            nullable=False,
        ),
        sa.Column("display_name", sa.String(length=100), nullable=False),
        sa.Column("description", sa.Text(), nullable=True),
        sa.Column("resource", sa.String(length=50), nullable=False),
        sa.Column("action", sa.String(length=50), nullable=False),
        sa.Column("created_at", sa.DateTime(timezone=True), nullable=False),
        sa.PrimaryKeyConstraint("id", name=op.f("pk_permissions")),
    )
    op.create_index(op.f("ix_permissions_action"), "permissions", ["action"], unique=False)
    op.create_index(op.f("ix_permissions_name"), "permissions", ["name"], unique=True)
    op.create_index(op.f("ix_permissions_resource"), "permissions", ["resource"], unique=False)
    op.create_table(
        "customer_reviews",
        sa.Column("id", sa.UUID(), nullable=False),
        sa.Column(
            "customer_id",
            sa.UUID(),
            nullable=True,
            comment="Soft reference to customer (validated at application level)",
        ),
        sa.Column(
            "booking_id",
            sa.UUID(),
            nullable=True,
            comment="Soft reference to booking (validated at application level)",
        ),
        sa.Column("rating", sa.Integer(), nullable=False),
        sa.Column("review_text", sa.Text(), nullable=False),
        sa.Column("reviewer_name", sa.String(length=200), nullable=True),
        sa.Column("approved", sa.Boolean(), nullable=False),
        sa.Column("featured", sa.Boolean(), nullable=False),
        sa.Column("review_date", sa.DateTime(timezone=True), nullable=False),
        sa.Column("created_at", sa.DateTime(), nullable=True),
        sa.Column("updated_at", sa.DateTime(), nullable=True),
        sa.Column("is_deleted", sa.Boolean(), nullable=False),
        sa.PrimaryKeyConstraint("id", name=op.f("pk_customer_reviews")),
        schema="public",
    )
    op.create_index(
        op.f("ix_public_customer_reviews_booking_id"),
        "customer_reviews",
        ["booking_id"],
        unique=False,
        schema="public",
    )
    op.create_index(
        op.f("ix_public_customer_reviews_customer_id"),
        "customer_reviews",
        ["customer_id"],
        unique=False,
        schema="public",
    )
    op.create_table(
        "discount_coupons",
        sa.Column("id", sa.UUID(), nullable=False),
        sa.Column("code", sa.String(length=50), nullable=False),
        sa.Column("description", sa.Text(), nullable=True),
        sa.Column("discount_type", sa.String(length=20), nullable=False),
        sa.Column("discount_value", sa.Numeric(precision=10, scale=2), nullable=False),
        sa.Column("min_order_amount", sa.Numeric(precision=10, scale=2), nullable=True),
        sa.Column("max_discount_amount", sa.Numeric(precision=10, scale=2), nullable=True),
        sa.Column("valid_from", sa.DateTime(timezone=True), nullable=False),
        sa.Column("valid_until", sa.DateTime(timezone=True), nullable=True),
        sa.Column("usage_limit", sa.Integer(), nullable=True),
        sa.Column("usage_count", sa.Integer(), nullable=False),
        sa.Column("active", sa.Boolean(), nullable=False),
        sa.Column(
            "extra_data",
            postgresql.JSONB(astext_type=sa.Text()),
            nullable=True,
            comment="Coupon metadata and campaign tracking",
        ),
        sa.Column("created_at", sa.DateTime(), nullable=True),
        sa.Column("updated_at", sa.DateTime(), nullable=True),
        sa.Column("is_deleted", sa.Boolean(), nullable=False),
        sa.PrimaryKeyConstraint("id", name=op.f("pk_discount_coupons")),
        schema="public",
    )
    op.create_index(
        op.f("ix_public_discount_coupons_code"),
        "discount_coupons",
        ["code"],
        unique=True,
        schema="public",
    )
    op.create_table(
        "sync_history",
        sa.Column("id", sa.Integer(), autoincrement=True, nullable=False),
        sa.Column(
            "source_type",
            postgresql.ENUM("MENU", "FAQS", "TERMS", name="sync_source_type"),
            nullable=False,
        ),
        sa.Column("source_file_path", sa.Text(), nullable=False),
        sa.Column("file_hash", sa.String(length=64), nullable=False),
        sa.Column("last_sync_time", sa.DateTime(timezone=True), nullable=False),
        sa.Column("changes_applied", sa.Integer(), nullable=True),
        sa.Column("items_added", sa.Integer(), nullable=True),
        sa.Column("items_modified", sa.Integer(), nullable=True),
        sa.Column("items_deleted", sa.Integer(), nullable=True),
        sa.Column("conflicts_detected", sa.Integer(), nullable=True),
        sa.Column("synced_by", sa.String(length=100), nullable=True),
        sa.Column(
            "sync_type", postgresql.ENUM("AUTO", "MANUAL", "FORCE", name="sync_type"), nullable=True
        ),
        sa.Column(
            "sync_status",
            postgresql.ENUM("SUCCESS", "PARTIAL", "FAILED", name="sync_status"),
            nullable=True,
        ),
        sa.Column("error_message", sa.Text(), nullable=True),
        sa.Column("created_at", sa.DateTime(timezone=True), nullable=False),
        sa.Column("updated_at", sa.DateTime(timezone=True), nullable=False),
        sa.PrimaryKeyConstraint("id", name=op.f("pk_sync_history")),
        schema="public",
    )
    op.create_index(
        "idx_sync_history_created", "sync_history", ["created_at"], unique=False, schema="public"
    )
    op.create_index(
        "idx_sync_history_source",
        "sync_history",
        ["source_type", "last_sync_time"],
        unique=False,
        schema="public",
    )
    op.create_index(
        "idx_sync_history_status",
        "sync_history",
        ["sync_status", "created_at"],
        unique=False,
        schema="public",
    )
    op.create_index(
        "idx_sync_history_user",
        "sync_history",
        ["synced_by", "created_at"],
        unique=False,
        schema="public",
    )
    op.create_table(
        "roles",
        sa.Column("id", sa.UUID(), nullable=False),
        sa.Column(
            "name",
            sa.Enum("super_admin", "admin", "manager", "staff", "viewer", name="roletype"),
            nullable=False,
        ),
        sa.Column("display_name", sa.String(length=100), nullable=False),
        sa.Column("description", sa.Text(), nullable=True),
        sa.Column("is_system_role", sa.Boolean(), nullable=False),
        sa.Column("is_active", sa.Boolean(), nullable=False),
        sa.Column("created_at", sa.DateTime(timezone=True), nullable=False),
        sa.Column("updated_at", sa.DateTime(timezone=True), nullable=False),
        sa.Column("settings", postgresql.JSONB(astext_type=sa.Text()), nullable=False),
        sa.PrimaryKeyConstraint("id", name=op.f("pk_roles")),
    )
    op.create_index(op.f("ix_roles_created_at"), "roles", ["created_at"], unique=False)
    op.create_index(op.f("ix_roles_name"), "roles", ["name"], unique=True)
    op.create_table(
        "ai_rlhf_scores",
        sa.Column(
            "id",
            sa.Integer(),
            autoincrement=True,
            nullable=False,
            comment="Auto-incrementing ID (sequential)",
        ),
        sa.Column(
            "tutor_pair_id",
            sa.Integer(),
            nullable=False,
            comment="Parent tutor pair ID (CASCADE delete)",
        ),
        sa.Column(
            "reviewer_id",
            sa.Integer(),
            nullable=True,
            comment="Admin user ID who reviewed this pair",
        ),
        sa.Column(
            "accuracy_score",
            sa.Integer(),
            nullable=False,
            comment="\n        How accurate is the student response? (1-5):\n        5 = Fully accurate, no errors\n        4 = Mostly accurate, minor issues\n        3 = Somewhat accurate, some errors\n        2 = Inaccurate, major errors\n        1 = Completely wrong\n        ",
        ),
        sa.Column(
            "helpfulness_score",
            sa.Integer(),
            nullable=False,
            comment="\n        How helpful is the student response? (1-5):\n        5 = Very helpful, solves problem\n        4 = Helpful, good guidance\n        3 = Somewhat helpful\n        2 = Not very helpful\n        1 = Not helpful at all\n        ",
        ),
        sa.Column(
            "tone_score",
            sa.Integer(),
            nullable=False,
            comment="\n        Appropriate tone for My Hibachi brand? (1-5):\n        5 = Perfect brand voice\n        4 = Good tone, minor adjustments\n        3 = Acceptable tone\n        2 = Off-brand tone\n        1 = Wrong tone entirely\n        ",
        ),
        sa.Column(
            "completeness_score",
            sa.Integer(),
            nullable=False,
            comment="\n        Addresses all aspects of customer query? (1-5):\n        5 = Fully complete answer\n        4 = Mostly complete, minor gaps\n        3 = Somewhat complete\n        2 = Missing key information\n        1 = Incomplete answer\n        ",
        ),
        sa.Column(
            "overall_score",
            sa.Float(),
            nullable=False,
            comment="Average of all scoring dimensions (1-5)",
        ),
        sa.Column(
            "would_use_in_production",
            sa.Boolean(),
            nullable=False,
            comment="\n        Would you use this student response with a real customer?\n        True = Production-ready\n        False = Needs improvement\n        ",
        ),
        sa.Column(
            "feedback_notes",
            sa.Text(),
            nullable=True,
            comment="\n        Reviewer comments and suggestions:\n        - What was good?\n        - What needs improvement?\n        - Specific examples\n        ",
        ),
        sa.Column("created_at", sa.DateTime(), nullable=False, comment="Review timestamp"),
        sa.ForeignKeyConstraint(
            ["tutor_pair_id"],
            ["ai.ai_tutor_pairs.id"],
            name=op.f("fk_ai_rlhf_scores_tutor_pair_id_ai_tutor_pairs"),
            ondelete="CASCADE",
        ),
        sa.PrimaryKeyConstraint("id", name=op.f("pk_ai_rlhf_scores")),
        schema="ai",
    )
    op.create_index(
        "idx_rlhf_overall",
        "ai_rlhf_scores",
        ["overall_score", "created_at"],
        unique=False,
        schema="ai",
    )
    op.create_index(
        "idx_rlhf_production",
        "ai_rlhf_scores",
        ["would_use_in_production", "created_at"],
        unique=False,
        schema="ai",
    )
    op.create_index(
        "idx_rlhf_reviewer",
        "ai_rlhf_scores",
        ["reviewer_id", "created_at"],
        unique=False,
        schema="ai",
    )
    op.create_index(
        "idx_rlhf_tutor", "ai_rlhf_scores", ["tutor_pair_id"], unique=False, schema="ai"
    )
    op.create_index(
        op.f("ix_ai_ai_rlhf_scores_created_at"),
        "ai_rlhf_scores",
        ["created_at"],
        unique=False,
        schema="ai",
    )
    op.create_index(
        op.f("ix_ai_ai_rlhf_scores_id"), "ai_rlhf_scores", ["id"], unique=False, schema="ai"
    )
    op.create_index(
        op.f("ix_ai_ai_rlhf_scores_tutor_pair_id"),
        "ai_rlhf_scores",
        ["tutor_pair_id"],
        unique=False,
        schema="ai",
    )
    op.create_table(
        "customers",
        sa.Column("id", sa.UUID(), nullable=False),
        sa.Column("station_id", sa.UUID(), nullable=False),
        sa.Column("first_name", sa.String(length=100), nullable=False),
        sa.Column("last_name", sa.String(length=100), nullable=False),
        sa.Column("email_encrypted", sa.Text(), nullable=False),
        sa.Column("phone_encrypted", sa.Text(), nullable=False),
        sa.Column("consent_sms", sa.Boolean(), nullable=False),
        sa.Column("consent_email", sa.Boolean(), nullable=False),
        sa.Column("consent_updated_at", sa.DateTime(timezone=True), nullable=True),
        sa.Column("timezone", sa.String(length=50), nullable=False),
        sa.Column("tags", postgresql.ARRAY(sa.String(length=50)), nullable=True),
        sa.Column("notes", sa.Text(), nullable=True),
        sa.Column("deleted_at", sa.DateTime(timezone=True), nullable=True),
        sa.Column(
            "created_at",
            sa.DateTime(timezone=True),
            server_default=sa.text("now()"),
            nullable=False,
        ),
        sa.Column(
            "updated_at",
            sa.DateTime(timezone=True),
            server_default=sa.text("now()"),
            nullable=False,
        ),
        sa.ForeignKeyConstraint(
            ["station_id"],
            ["identity.stations.id"],
            name="fk_customers_station",
            ondelete="RESTRICT",
        ),
        sa.PrimaryKeyConstraint("id", name=op.f("pk_customers")),
        schema="core",
    )
    op.create_index(
        "idx_customer_station_created",
        "customers",
        ["station_id", "created_at"],
        unique=False,
        schema="core",
    )
    op.create_index(
        "idx_customer_station_email",
        "customers",
        ["station_id", "email_encrypted"],
        unique=True,
        schema="core",
    )
    op.create_index(
        "ix_core_customers_email_active",
        "customers",
        ["email_encrypted"],
        unique=True,
        schema="core",
    )
    op.create_table(
        "reviews",
        sa.Column("id", sa.UUID(), nullable=False),
        sa.Column("thread_id", sa.UUID(), nullable=False),
        sa.Column("rating", sa.Integer(), nullable=False),
        sa.Column("review_text", sa.Text(), nullable=True),
        sa.Column(
            "status",
            sa.Enum(
                "PENDING", "APPROVED", "REJECTED", "FLAGGED", name="review_status", schema="public"
            ),
            nullable=False,
        ),
        sa.Column("moderation_notes", sa.Text(), nullable=True),
        sa.Column(
            "created_at",
            sa.DateTime(timezone=True),
            server_default=sa.text("now()"),
            nullable=False,
        ),
        sa.Column("moderated_at", sa.DateTime(timezone=True), nullable=True),
        sa.CheckConstraint(
            "rating >= 1 AND rating <= 5", name=op.f("ck_reviews_check_rating_range")
        ),
        sa.ForeignKeyConstraint(
            ["thread_id"],
            ["core.social_threads.id"],
            name=op.f("fk_reviews_thread_id_social_threads"),
        ),
        sa.PrimaryKeyConstraint("id", name=op.f("pk_reviews")),
        schema="core",
    )
    op.create_index("idx_reviews_rating", "reviews", ["rating"], unique=False, schema="core")
    op.create_index("idx_reviews_status", "reviews", ["status"], unique=False, schema="core")
    op.create_index("idx_reviews_thread_id", "reviews", ["thread_id"], unique=False, schema="core")
    op.create_index(
        op.f("ix_core_reviews_status"), "reviews", ["status"], unique=False, schema="core"
    )
    op.create_table(
        "segment_rules",
        sa.Column("id", sa.UUID(), server_default=sa.text("gen_random_uuid()"), nullable=False),
        sa.Column("segment_id", sa.UUID(), nullable=False),
        sa.Column("field_name", sa.String(length=100), nullable=False),
        sa.Column(
            "operator",
            sa.Enum(
                "EQUALS",
                "NOT_EQUALS",
                "GREATER_THAN",
                "LESS_THAN",
                "CONTAINS",
                "IN",
                "NOT_IN",
                name="segment_rule_operator",
                schema="public",
            ),
            nullable=False,
        ),
        sa.Column("field_value", postgresql.JSONB(astext_type=sa.Text()), nullable=False),
        sa.Column("rule_order", sa.Integer(), nullable=False),
        sa.Column(
            "created_at",
            sa.DateTime(timezone=True),
            server_default=sa.text("now()"),
            nullable=False,
        ),
        sa.ForeignKeyConstraint(
            ["segment_id"],
            ["crm.customer_segments.id"],
            name=op.f("fk_segment_rules_segment_id_customer_segments"),
            ondelete="CASCADE",
        ),
        sa.PrimaryKeyConstraint("id", name=op.f("pk_segment_rules")),
        schema="crm",
    )
    op.create_index(
        "idx_crm_segment_rules_segment", "segment_rules", ["segment_id"], unique=False, schema="crm"
    )
    op.create_table(
        "outbox_entries",
        sa.Column("id", sa.UUID(), nullable=False),
        sa.Column("event_id", sa.UUID(), nullable=False),
        sa.Column("target", sa.String(length=50), nullable=False),
        sa.Column("payload", sa.JSON(), nullable=False),
        sa.Column("status", sa.String(length=20), nullable=False),
        sa.Column("attempts", sa.Integer(), nullable=False),
        sa.Column("max_attempts", sa.Integer(), nullable=False),
        sa.Column("last_error", sa.Text(), nullable=True),
        sa.Column("created_at", sa.DateTime(timezone=True), nullable=False),
        sa.Column("updated_at", sa.DateTime(timezone=True), nullable=False),
        sa.Column("next_attempt_at", sa.DateTime(timezone=True), nullable=False),
        sa.Column("completed_at", sa.DateTime(timezone=True), nullable=True),
        sa.Column("is_deleted", sa.Boolean(), nullable=False),
        sa.CheckConstraint(
            "status IN ('pending', 'processing', 'completed', 'failed')",
            name=op.f("ck_outbox_entries_outbox_status_check"),
        ),
        sa.CheckConstraint(
            "attempts >= 0", name=op.f("ck_outbox_entries_outbox_attempts_positive")
        ),
        sa.CheckConstraint(
            "max_attempts > 0", name=op.f("ck_outbox_entries_outbox_max_attempts_positive")
        ),
        sa.ForeignKeyConstraint(
            ["event_id"],
            ["events.domain_events.id"],
            name=op.f("fk_outbox_entries_event_id_domain_events"),
        ),
        sa.PrimaryKeyConstraint("id", name=op.f("pk_outbox_entries")),
        schema="events",
    )
    op.create_index(
        op.f("ix_events_outbox_entries_event_id"),
        "outbox_entries",
        ["event_id"],
        unique=False,
        schema="events",
    )
    op.create_index(
        op.f("ix_events_outbox_entries_status"),
        "outbox_entries",
        ["status"],
        unique=False,
        schema="events",
    )
    op.create_index(
        op.f("ix_events_outbox_entries_target"),
        "outbox_entries",
        ["target"],
        unique=False,
        schema="events",
    )
    op.create_table(
        "admin_invitations",
        sa.Column("id", sa.UUID(), nullable=False),
        sa.Column("email", sa.String(length=255), nullable=False),
        sa.Column("invitation_code", sa.String(length=100), nullable=False),
        sa.Column("role", sa.String(length=30), nullable=False),
        sa.Column("station_id", sa.UUID(), nullable=True),
        sa.Column("status", sa.String(length=20), nullable=False),
        sa.Column("invited_by", sa.UUID(), nullable=False),
        sa.Column(
            "invited_at",
            sa.DateTime(timezone=True),
            server_default=sa.text("now()"),
            nullable=False,
        ),
        sa.Column("expires_at", sa.DateTime(timezone=True), nullable=False),
        sa.Column("accepted_at", sa.DateTime(timezone=True), nullable=True),
        sa.Column("accepted_by_user_id", sa.UUID(), nullable=True),
        sa.Column("revoked_at", sa.DateTime(timezone=True), nullable=True),
        sa.Column("revoked_by", sa.UUID(), nullable=True),
        sa.Column("revoked_reason", sa.Text(), nullable=True),
        sa.Column("notes", sa.Text(), nullable=True),
        sa.ForeignKeyConstraint(
            ["accepted_by_user_id"],
            ["identity.users.id"],
            name=op.f("fk_admin_invitations_accepted_by_user_id_users"),
        ),
        sa.ForeignKeyConstraint(
            ["invited_by"],
            ["identity.users.id"],
            name=op.f("fk_admin_invitations_invited_by_users"),
        ),
        sa.ForeignKeyConstraint(
            ["revoked_by"],
            ["identity.users.id"],
            name=op.f("fk_admin_invitations_revoked_by_users"),
        ),
        sa.ForeignKeyConstraint(
            ["station_id"],
            ["identity.stations.id"],
            name=op.f("fk_admin_invitations_station_id_stations"),
        ),
        sa.PrimaryKeyConstraint("id", name=op.f("pk_admin_invitations")),
        sa.UniqueConstraint("invitation_code", name=op.f("uq_admin_invitations_invitation_code")),
        schema="identity",
    )
    op.create_index(
        "idx_admin_invitations_code",
        "admin_invitations",
        ["invitation_code"],
        unique=False,
        schema="identity",
    )
    op.create_index(
        "idx_admin_invitations_email",
        "admin_invitations",
        ["email"],
        unique=False,
        schema="identity",
    )
    op.create_index(
        "idx_admin_invitations_station",
        "admin_invitations",
        ["station_id"],
        unique=False,
        schema="identity",
    )
    op.create_index(
        "idx_admin_invitations_status",
        "admin_invitations",
        ["status"],
        unique=False,
        schema="identity",
    )
    op.create_table(
        "oauth_accounts",
        sa.Column("id", sa.UUID(), nullable=False),
        sa.Column("user_id", sa.UUID(), nullable=False),
        sa.Column("provider", sa.String(length=20), nullable=False),
        sa.Column("provider_account_id", sa.String(length=255), nullable=False),
        sa.Column("provider_account_email", sa.String(length=255), nullable=False),
        sa.Column("access_token", sa.Text(), nullable=True),
        sa.Column("refresh_token", sa.Text(), nullable=True),
        sa.Column("token_expires_at", sa.DateTime(timezone=True), nullable=True),
        sa.Column("provider_profile", sa.Text(), nullable=True),
        sa.Column("profile_picture_url", sa.String(length=500), nullable=True),
        sa.Column("is_active", sa.Boolean(), nullable=False),
        sa.Column("is_verified", sa.Boolean(), nullable=False),
        sa.Column("is_approved", sa.Boolean(), nullable=False),
        sa.Column("approved_by", sa.UUID(), nullable=True),
        sa.Column("approved_at", sa.DateTime(timezone=True), nullable=True),
        sa.Column("revoked_at", sa.DateTime(timezone=True), nullable=True),
        sa.Column("revoked_by", sa.UUID(), nullable=True),
        sa.Column("revoked_reason", sa.Text(), nullable=True),
        sa.Column(
            "linked_at", sa.DateTime(timezone=True), server_default=sa.text("now()"), nullable=False
        ),
        sa.Column("last_login_at", sa.DateTime(timezone=True), nullable=True),
        sa.Column(
            "updated_at",
            sa.DateTime(timezone=True),
            server_default=sa.text("now()"),
            nullable=False,
        ),
        sa.ForeignKeyConstraint(
            ["approved_by"], ["identity.users.id"], name=op.f("fk_oauth_accounts_approved_by_users")
        ),
        sa.ForeignKeyConstraint(
            ["revoked_by"], ["identity.users.id"], name=op.f("fk_oauth_accounts_revoked_by_users")
        ),
        sa.ForeignKeyConstraint(
            ["user_id"], ["identity.users.id"], name=op.f("fk_oauth_accounts_user_id_users")
        ),
        sa.PrimaryKeyConstraint("id", name=op.f("pk_oauth_accounts")),
        schema="identity",
    )
    op.create_index(
        "idx_google_oauth_email",
        "oauth_accounts",
        ["provider_account_email"],
        unique=False,
        schema="identity",
    )
    op.create_index(
        "idx_google_oauth_provider",
        "oauth_accounts",
        ["provider", "provider_account_id"],
        unique=False,
        schema="identity",
    )
    op.create_index(
        "idx_google_oauth_user", "oauth_accounts", ["user_id"], unique=False, schema="identity"
    )
    op.create_table(
        "role_permissions",
        sa.Column("id", sa.UUID(), nullable=False),
        sa.Column("role_id", sa.UUID(), nullable=False),
        sa.Column("permission_id", sa.UUID(), nullable=False),
        sa.Column(
            "created_at",
            sa.DateTime(timezone=True),
            server_default=sa.text("now()"),
            nullable=False,
        ),
        sa.ForeignKeyConstraint(
            ["permission_id"],
            ["identity.permissions.id"],
            name=op.f("fk_role_permissions_permission_id_permissions"),
        ),
        sa.ForeignKeyConstraint(
            ["role_id"], ["identity.roles.id"], name=op.f("fk_role_permissions_role_id_roles")
        ),
        sa.PrimaryKeyConstraint("id", name=op.f("pk_role_permissions")),
        sa.UniqueConstraint("role_id", "permission_id", name="uq_role_permissions"),
        schema="identity",
    )
    op.create_index(
        "idx_role_permissions_permission_id",
        "role_permissions",
        ["permission_id"],
        unique=False,
        schema="identity",
    )
    op.create_index(
        "idx_role_permissions_role_id",
        "role_permissions",
        ["role_id"],
        unique=False,
        schema="identity",
    )
    op.create_table(
        "social_accounts",
        sa.Column("id", sa.UUID(), nullable=False),
        sa.Column("user_id", sa.UUID(), nullable=False),
        sa.Column("provider", sa.String(length=50), nullable=False),
        sa.Column("provider_account_id", sa.String(length=255), nullable=False),
        sa.Column("access_token", sa.Text(), nullable=True),
        sa.Column("refresh_token", sa.Text(), nullable=True),
        sa.Column("expires_at", sa.DateTime(timezone=True), nullable=True),
        sa.Column("profile_data", postgresql.JSONB(astext_type=sa.Text()), nullable=False),
        sa.Column(
            "created_at",
            sa.DateTime(timezone=True),
            server_default=sa.text("now()"),
            nullable=False,
        ),
        sa.Column(
            "updated_at",
            sa.DateTime(timezone=True),
            server_default=sa.text("now()"),
            nullable=False,
        ),
        sa.ForeignKeyConstraint(
            ["user_id"], ["identity.users.id"], name=op.f("fk_social_accounts_user_id_users")
        ),
        sa.PrimaryKeyConstraint("id", name=op.f("pk_social_accounts")),
        sa.UniqueConstraint("provider", "provider_account_id", name="uq_social_accounts_provider"),
        schema="identity",
    )
    op.create_index(
        "idx_social_accounts_provider",
        "social_accounts",
        ["provider"],
        unique=False,
        schema="identity",
    )
    op.create_index(
        "idx_social_accounts_user_id",
        "social_accounts",
        ["user_id"],
        unique=False,
        schema="identity",
    )
    op.create_index(
        op.f("ix_identity_social_accounts_provider"),
        "social_accounts",
        ["provider"],
        unique=False,
        schema="identity",
    )
    op.create_table(
        "station_access_tokens",
        sa.Column("id", sa.UUID(), nullable=False),
        sa.Column("station_id", sa.UUID(), nullable=False),
        sa.Column("token", sa.String(length=255), nullable=False),
        sa.Column("name", sa.String(length=100), nullable=True),
        sa.Column("description", sa.Text(), nullable=True),
        sa.Column("expires_at", sa.DateTime(timezone=True), nullable=True),
        sa.Column("is_active", sa.Boolean(), nullable=False),
        sa.Column("last_used_at", sa.DateTime(timezone=True), nullable=True),
        sa.Column("use_count", sa.Integer(), nullable=False),
        sa.Column(
            "created_at",
            sa.DateTime(timezone=True),
            server_default=sa.text("now()"),
            nullable=False,
        ),
        sa.Column(
            "updated_at",
            sa.DateTime(timezone=True),
            server_default=sa.text("now()"),
            nullable=False,
        ),
        sa.ForeignKeyConstraint(
            ["station_id"],
            ["identity.stations.id"],
            name=op.f("fk_station_access_tokens_station_id_stations"),
        ),
        sa.PrimaryKeyConstraint("id", name=op.f("pk_station_access_tokens")),
        schema="identity",
    )
    op.create_index(
        "idx_station_access_tokens_active",
        "station_access_tokens",
        ["is_active"],
        unique=False,
        schema="identity",
    )
    op.create_index(
        "idx_station_access_tokens_station_id",
        "station_access_tokens",
        ["station_id"],
        unique=False,
        schema="identity",
    )
    op.create_index(
        "idx_station_access_tokens_token",
        "station_access_tokens",
        ["token"],
        unique=False,
        schema="identity",
    )
    op.create_index(
        op.f("ix_identity_station_access_tokens_is_active"),
        "station_access_tokens",
        ["is_active"],
        unique=False,
        schema="identity",
    )
    op.create_index(
        op.f("ix_identity_station_access_tokens_token"),
        "station_access_tokens",
        ["token"],
        unique=True,
        schema="identity",
    )
    op.create_table(
        "station_audit_logs",
        sa.Column("id", sa.UUID(), nullable=False),
        sa.Column("station_id", sa.UUID(), nullable=False),
        sa.Column("user_id", sa.UUID(), nullable=True),
        sa.Column(
            "action",
            sa.Enum(
                "LOGIN",
                "LOGOUT",
                "CREATE",
                "UPDATE",
                "DELETE",
                "VIEW",
                "EXPORT",
                "IMPORT",
                "PERMISSION_CHANGE",
                "ROLE_CHANGE",
                name="audit_action",
                schema="public",
            ),
            nullable=False,
        ),
        sa.Column("resource_type", sa.String(length=100), nullable=False),
        sa.Column("resource_id", sa.String(length=255), nullable=True),
        sa.Column("description", sa.Text(), nullable=True),
        sa.Column("ip_address", sa.String(length=50), nullable=True),
        sa.Column("user_agent", sa.String(length=500), nullable=True),
        sa.Column("audit_metadata", postgresql.JSONB(astext_type=sa.Text()), nullable=False),
        sa.Column(
            "created_at",
            sa.DateTime(timezone=True),
            server_default=sa.text("now()"),
            nullable=False,
        ),
        sa.ForeignKeyConstraint(
            ["station_id"],
            ["identity.stations.id"],
            name=op.f("fk_station_audit_logs_station_id_stations"),
        ),
        sa.ForeignKeyConstraint(
            ["user_id"], ["identity.users.id"], name=op.f("fk_station_audit_logs_user_id_users")
        ),
        sa.PrimaryKeyConstraint("id", name=op.f("pk_station_audit_logs")),
        schema="identity",
    )
    op.create_index(
        "idx_station_audit_logs_action",
        "station_audit_logs",
        ["action"],
        unique=False,
        schema="identity",
    )
    op.create_index(
        "idx_station_audit_logs_created_at",
        "station_audit_logs",
        ["created_at"],
        unique=False,
        schema="identity",
    )
    op.create_index(
        "idx_station_audit_logs_station_id",
        "station_audit_logs",
        ["station_id"],
        unique=False,
        schema="identity",
    )
    op.create_index(
        "idx_station_audit_logs_user_id",
        "station_audit_logs",
        ["user_id"],
        unique=False,
        schema="identity",
    )
    op.create_index(
        op.f("ix_identity_station_audit_logs_action"),
        "station_audit_logs",
        ["action"],
        unique=False,
        schema="identity",
    )
    op.create_index(
        op.f("ix_identity_station_audit_logs_created_at"),
        "station_audit_logs",
        ["created_at"],
        unique=False,
        schema="identity",
    )
    op.create_table(
        "station_users",
        sa.Column("id", sa.UUID(), nullable=False),
        sa.Column("station_id", sa.UUID(), nullable=False),
        sa.Column("user_id", sa.UUID(), nullable=False),
        sa.Column("is_active", sa.Boolean(), nullable=False),
        sa.Column(
            "created_at",
            sa.DateTime(timezone=True),
            server_default=sa.text("now()"),
            nullable=False,
        ),
        sa.Column(
            "updated_at",
            sa.DateTime(timezone=True),
            server_default=sa.text("now()"),
            nullable=False,
        ),
        sa.ForeignKeyConstraint(
            ["station_id"],
            ["identity.stations.id"],
            name=op.f("fk_station_users_station_id_stations"),
        ),
        sa.ForeignKeyConstraint(
            ["user_id"], ["identity.users.id"], name=op.f("fk_station_users_user_id_users")
        ),
        sa.PrimaryKeyConstraint("id", name=op.f("pk_station_users")),
        sa.UniqueConstraint("station_id", "user_id", name="uq_station_users"),
        schema="identity",
    )
    op.create_index(
        "idx_station_users_station_id",
        "station_users",
        ["station_id"],
        unique=False,
        schema="identity",
    )
    op.create_index(
        "idx_station_users_user_id", "station_users", ["user_id"], unique=False, schema="identity"
    )
    op.create_table(
        "user_roles",
        sa.Column("user_id", sa.UUID(), nullable=False, comment="User ID"),
        sa.Column("role_id", sa.UUID(), nullable=False, comment="Role ID"),
        sa.Column(
            "assigned_at",
            sa.DateTime(timezone=True),
            server_default=sa.text("now()"),
            nullable=False,
            comment="When role was assigned",
        ),
        sa.Column("assigned_by", sa.UUID(), nullable=True, comment="Who assigned this role"),
        sa.ForeignKeyConstraint(
            ["assigned_by"],
            ["identity.users.id"],
            name=op.f("fk_user_roles_assigned_by_users"),
            ondelete="SET NULL",
        ),
        sa.ForeignKeyConstraint(
            ["role_id"],
            ["identity.roles.id"],
            name=op.f("fk_user_roles_role_id_roles"),
            ondelete="CASCADE",
        ),
        sa.ForeignKeyConstraint(
            ["user_id"],
            ["identity.users.id"],
            name=op.f("fk_user_roles_user_id_users"),
            ondelete="CASCADE",
        ),
        sa.PrimaryKeyConstraint("user_id", "role_id", name=op.f("pk_user_roles")),
        schema="identity",
    )
    op.create_table(
        "campaign_events",
        sa.Column("id", sa.UUID(), nullable=False),
        sa.Column("campaign_id", sa.UUID(), nullable=False),
        sa.Column("subscriber_id", sa.UUID(), nullable=True),
        sa.Column(
            "event_type",
            sa.Enum(
                "SENT",
                "DELIVERED",
                "OPENED",
                "CLICKED",
                "BOUNCED",
                "UNSUBSCRIBED",
                "COMPLAINED",
                name="campaign_event_type",
            ),
            nullable=False,
        ),
        sa.Column("occurred_at", sa.DateTime(timezone=True), nullable=False),
        sa.Column(
            "extra_data",
            postgresql.JSONB(astext_type=sa.Text()),
            nullable=True,
            comment="Event metadata and tracking info",
        ),
        sa.Column("created_at", sa.DateTime(), nullable=True),
        sa.Column("updated_at", sa.DateTime(), nullable=True),
        sa.Column("is_deleted", sa.Boolean(), nullable=False),
        sa.ForeignKeyConstraint(
            ["campaign_id"],
            ["lead.campaigns.id"],
            name=op.f("fk_campaign_events_campaign_id_campaigns"),
            ondelete="CASCADE",
        ),
        sa.ForeignKeyConstraint(
            ["subscriber_id"],
            ["lead.subscribers.id"],
            name=op.f("fk_campaign_events_subscriber_id_subscribers"),
            ondelete="SET NULL",
        ),
        sa.PrimaryKeyConstraint("id", name=op.f("pk_campaign_events")),
        schema="lead",
    )
    op.create_index(
        op.f("ix_lead_campaign_events_campaign_id"),
        "campaign_events",
        ["campaign_id"],
        unique=False,
        schema="lead",
    )
    op.create_index(
        op.f("ix_lead_campaign_events_event_type"),
        "campaign_events",
        ["event_type"],
        unique=False,
        schema="lead",
    )
    op.create_index(
        op.f("ix_lead_campaign_events_subscriber_id"),
        "campaign_events",
        ["subscriber_id"],
        unique=False,
        schema="lead",
    )
    op.create_table(
        "sms_delivery_events",
        sa.Column("id", sa.UUID(), nullable=False),
        sa.Column("campaign_id", sa.UUID(), nullable=True),
        sa.Column("subscriber_id", sa.UUID(), nullable=True),
        sa.Column("phone_number", sa.String(length=20), nullable=False),
        sa.Column("message_sid", sa.String(length=100), nullable=True),
        sa.Column(
            "status",
            sa.Enum(
                "QUEUED", "SENT", "DELIVERED", "FAILED", "UNDELIVERED", name="sms_delivery_status"
            ),
            nullable=False,
        ),
        sa.Column("sent_at", sa.DateTime(timezone=True), nullable=True),
        sa.Column("delivered_at", sa.DateTime(timezone=True), nullable=True),
        sa.Column("failed_at", sa.DateTime(timezone=True), nullable=True),
        sa.Column("error_code", sa.String(length=50), nullable=True),
        sa.Column("error_message", sa.Text(), nullable=True),
        sa.Column("cost", sa.Integer(), nullable=True, comment="Cost in cents"),
        sa.Column(
            "extra_data",
            postgresql.JSONB(astext_type=sa.Text()),
            nullable=True,
            comment="SMS delivery metadata and carrier info",
        ),
        sa.Column("created_at", sa.DateTime(), nullable=True),
        sa.Column("updated_at", sa.DateTime(), nullable=True),
        sa.Column("is_deleted", sa.Boolean(), nullable=False),
        sa.ForeignKeyConstraint(
            ["campaign_id"],
            ["lead.campaigns.id"],
            name=op.f("fk_sms_delivery_events_campaign_id_campaigns"),
            ondelete="CASCADE",
        ),
        sa.ForeignKeyConstraint(
            ["subscriber_id"],
            ["lead.subscribers.id"],
            name=op.f("fk_sms_delivery_events_subscriber_id_subscribers"),
            ondelete="SET NULL",
        ),
        sa.PrimaryKeyConstraint("id", name=op.f("pk_sms_delivery_events")),
        sa.UniqueConstraint("message_sid", name=op.f("uq_sms_delivery_events_message_sid")),
        schema="lead",
    )
    op.create_index(
        op.f("ix_lead_sms_delivery_events_campaign_id"),
        "sms_delivery_events",
        ["campaign_id"],
        unique=False,
        schema="lead",
    )
    op.create_index(
        op.f("ix_lead_sms_delivery_events_status"),
        "sms_delivery_events",
        ["status"],
        unique=False,
        schema="lead",
    )
    op.create_index(
        op.f("ix_lead_sms_delivery_events_subscriber_id"),
        "sms_delivery_events",
        ["subscriber_id"],
        unique=False,
        schema="lead",
    )
    op.create_table(
        "social_threads",
        sa.Column("id", sa.UUID(), nullable=False),
        sa.Column(
            "platform",
            sa.Enum(
                "INSTAGRAM",
                "FACEBOOK",
                "GOOGLE",
                "GOOGLE_BUSINESS",
                "YELP",
                "SMS",
                "PHONE",
                "STRIPE",
                "PLAID",
                name="social_platform",
            ),
            nullable=False,
        ),
        sa.Column("account_id", sa.UUID(), nullable=False, comment="Connected social account"),
        sa.Column("thread_ref", sa.String(length=255), nullable=True),
        sa.Column(
            "lead_id",
            sa.UUID(),
            nullable=True,
            comment="Soft reference to lead (validated at application level)",
        ),
        sa.Column(
            "customer_id",
            sa.UUID(),
            nullable=True,
            comment="Soft reference to customer (validated at application level)",
        ),
        sa.Column(
            "status",
            sa.Enum(
                "OPEN",
                "WAITING_CUSTOMER",
                "WAITING_AGENT",
                "RESOLVED",
                "CLOSED",
                name="thread_status",
            ),
            nullable=False,
        ),
        sa.Column("last_message_at", sa.DateTime(timezone=True), nullable=True),
        sa.Column("created_at", sa.DateTime(timezone=True), nullable=False),
        sa.Column("thread_external_id", sa.String(length=255), nullable=False),
        sa.Column(
            "social_identity_id",
            sa.UUID(),
            nullable=True,
            comment="Social identity of the person messaging us",
        ),
        sa.Column(
            "assigned_to",
            sa.UUID(),
            nullable=True,
            comment="Assigned team member (soft reference to user)",
        ),
        sa.Column("priority", sa.Integer(), nullable=False, comment="1=urgent, 5=low"),
        sa.Column(
            "subject",
            sa.String(length=255),
            nullable=True,
            comment="Thread subject or first message preview",
        ),
        sa.Column("context_url", sa.Text(), nullable=True, comment="Link to original post/content"),
        sa.Column("customer_handle", sa.String(length=255), nullable=True),
        sa.Column("message_count", sa.Integer(), nullable=False),
        sa.Column("unread_count", sa.Integer(), nullable=False),
        sa.Column(
            "last_response_at",
            sa.DateTime(timezone=True),
            nullable=True,
            comment="Last time we responded",
        ),
        sa.Column("closed_at", sa.DateTime(timezone=True), nullable=True),
        sa.Column("resolved_at", sa.DateTime(timezone=True), nullable=True),
        sa.Column(
            "tags",
            postgresql.ARRAY(sa.String(length=50)),
            nullable=True,
            comment="Categorization tags",
        ),
        sa.Column("platform_metadata", postgresql.JSONB(astext_type=sa.Text()), nullable=True),
        sa.Column("updated_at", sa.DateTime(timezone=True), nullable=False),
        sa.Column("is_deleted", sa.Boolean(), nullable=False),
        sa.ForeignKeyConstraint(
            ["account_id"],
            ["lead.social_accounts.id"],
            name=op.f("fk_social_threads_account_id_social_accounts"),
            ondelete="CASCADE",
        ),
        sa.ForeignKeyConstraint(
            ["social_identity_id"],
            ["lead.social_identities.id"],
            name=op.f("fk_social_threads_social_identity_id_social_identities"),
            ondelete="SET NULL",
        ),
        sa.PrimaryKeyConstraint("id", name=op.f("pk_social_threads")),
        schema="lead",
    )
    op.create_index(
        op.f("ix_lead_social_threads_account_id"),
        "social_threads",
        ["account_id"],
        unique=False,
        schema="lead",
    )
    op.create_index(
        op.f("ix_lead_social_threads_assigned_to"),
        "social_threads",
        ["assigned_to"],
        unique=False,
        schema="lead",
    )
    op.create_index(
        op.f("ix_lead_social_threads_customer_id"),
        "social_threads",
        ["customer_id"],
        unique=False,
        schema="lead",
    )
    op.create_index(
        op.f("ix_lead_social_threads_lead_id"),
        "social_threads",
        ["lead_id"],
        unique=False,
        schema="lead",
    )
    op.create_index(
        op.f("ix_lead_social_threads_platform"),
        "social_threads",
        ["platform"],
        unique=False,
        schema="lead",
    )
    op.create_index(
        op.f("ix_lead_social_threads_social_identity_id"),
        "social_threads",
        ["social_identity_id"],
        unique=False,
        schema="lead",
    )
    op.create_index(
        op.f("ix_lead_social_threads_status"),
        "social_threads",
        ["status"],
        unique=False,
        schema="lead",
    )
    op.create_index(
        "ix_social_threads_account_id",
        "social_threads",
        ["account_id"],
        unique=False,
        schema="lead",
    )
    op.create_index(
        "ix_social_threads_assigned_to",
        "social_threads",
        ["assigned_to"],
        unique=False,
        schema="lead",
    )
    op.create_index(
        "ix_social_threads_customer", "social_threads", ["customer_id"], unique=False, schema="lead"
    )
    op.create_index(
        "ix_social_threads_lead", "social_threads", ["lead_id"], unique=False, schema="lead"
    )
    op.create_index(
        "ix_social_threads_platform",
        "social_threads",
        ["platform", "thread_external_id"],
        unique=True,
        schema="lead",
    )
    op.create_index(
        "ix_social_threads_status", "social_threads", ["status"], unique=False, schema="lead"
    )
    op.create_table(
        "qr_scans",
        sa.Column("id", sa.UUID(), nullable=False),
        sa.Column("qr_code_id", sa.UUID(), nullable=False),
        sa.Column("ip_address", sa.String(length=50), nullable=True),
        sa.Column("user_agent", sa.String(length=500), nullable=True),
        sa.Column("referrer", sa.String(length=1000), nullable=True),
        sa.Column("latitude", sa.Numeric(precision=10, scale=8), nullable=True),
        sa.Column("longitude", sa.Numeric(precision=11, scale=8), nullable=True),
        sa.Column("city", sa.String(length=100), nullable=True),
        sa.Column("country", sa.String(length=100), nullable=True),
        sa.Column("scan_metadata", postgresql.JSONB(astext_type=sa.Text()), nullable=False),
        sa.Column(
            "scanned_at",
            sa.DateTime(timezone=True),
            server_default=sa.text("now()"),
            nullable=False,
        ),
        sa.ForeignKeyConstraint(
            ["qr_code_id"],
            ["marketing.qr_codes.id"],
            name=op.f("fk_qr_scans_qr_code_id_qr_codes"),
            ondelete="CASCADE",
        ),
        sa.PrimaryKeyConstraint("id", name=op.f("pk_qr_scans")),
        schema="marketing",
    )
    op.create_index(
        "idx_qr_scans_qr_code_id", "qr_scans", ["qr_code_id"], unique=False, schema="marketing"
    )
    op.create_index(
        "idx_qr_scans_scanned_at", "qr_scans", ["scanned_at"], unique=False, schema="marketing"
    )
    op.create_index(
        op.f("ix_marketing_qr_scans_qr_code_id"),
        "qr_scans",
        ["qr_code_id"],
        unique=False,
        schema="marketing",
    )
    op.create_index(
        op.f("ix_marketing_qr_scans_scanned_at"),
        "qr_scans",
        ["scanned_at"],
        unique=False,
        schema="marketing",
    )
    op.create_table(
        "campaign_sms_limits",
        sa.Column("campaign_id", sa.UUID(), nullable=False),
        sa.Column(
            "monthly_sms_limit",
            sa.Integer(),
            server_default="1000",
            nullable=False,
            comment="RingCentral plan monthly limit",
        ),
        sa.Column("monthly_sms_used", sa.Integer(), server_default="0", nullable=False),
        sa.Column("current_month", sa.String(length=7), nullable=False, comment="YYYY-MM"),
        sa.Column(
            "campaign_sms_limit",
            sa.Integer(),
            nullable=True,
            comment="Max SMS for this campaign (optional)",
        ),
        sa.Column("campaign_sms_sent", sa.Integer(), server_default="0", nullable=False),
        sa.Column("campaign_sms_queued", sa.Integer(), server_default="0", nullable=False),
        sa.Column("campaign_sms_failed", sa.Integer(), server_default="0", nullable=False),
        sa.Column(
            "cost_per_sms_cents",
            sa.Integer(),
            server_default="75",
            nullable=False,
            comment="Cost in cents (e.g., $0.0075)",
        ),
        sa.Column("total_cost_cents", sa.Integer(), server_default="0", nullable=False),
        sa.Column("monthly_limit_exceeded_at", sa.DateTime(timezone=True), nullable=True),
        sa.Column("campaign_limit_exceeded_at", sa.DateTime(timezone=True), nullable=True),
        sa.Column(
            "limit_exceeded_action",
            sa.String(length=50),
            server_default="pause",
            nullable=False,
            comment="pause, notify, continue",
        ),
        sa.Column(
            "alert_at_percentage",
            sa.Integer(),
            server_default="80",
            nullable=False,
            comment="Alert when 80% of limit used",
        ),
        sa.Column("alert_sent_at", sa.DateTime(timezone=True), nullable=True),
        sa.Column(
            "created_at",
            sa.DateTime(timezone=True),
            server_default=sa.text("now()"),
            nullable=False,
        ),
        sa.Column(
            "updated_at",
            sa.DateTime(timezone=True),
            server_default=sa.text("now()"),
            nullable=False,
        ),
        sa.ForeignKeyConstraint(
            ["campaign_id"],
            ["newsletter.campaigns.id"],
            name=op.f("fk_campaign_sms_limits_campaign_id_campaigns"),
            ondelete="CASCADE",
        ),
        sa.PrimaryKeyConstraint("campaign_id", name=op.f("pk_campaign_sms_limits")),
        schema="newsletter",
    )
    op.create_index(
        "idx_campaign_sms_limits_exceeded",
        "campaign_sms_limits",
        ["monthly_limit_exceeded_at"],
        unique=False,
        schema="newsletter",
    )
    op.create_index(
        "idx_campaign_sms_limits_month",
        "campaign_sms_limits",
        ["current_month"],
        unique=False,
        schema="newsletter",
    )
    op.create_table(
        "sms_templates",
        sa.Column("id", sa.UUID(), server_default=sa.text("gen_random_uuid()"), nullable=False),
        sa.Column("name", sa.String(length=100), nullable=False),
        sa.Column("content", sa.Text(), nullable=False, comment="Template with {{variables}}"),
        sa.Column(
            "category",
            sa.String(length=50),
            nullable=False,
            comment="reminder, promotion, transactional, newsletter",
        ),
        sa.Column(
            "source",
            sa.Enum("ADMIN", "AI_SUGGESTED", "SYSTEM", name="template_source", schema="newsletter"),
            server_default="admin",
            nullable=False,
        ),
        sa.Column(
            "status",
            sa.Enum(
                "DRAFT",
                "PENDING_APPROVAL",
                "APPROVED",
                "REJECTED",
                "ARCHIVED",
                name="template_status",
                schema="newsletter",
            ),
            server_default="draft",
            nullable=False,
        ),
        sa.Column(
            "variables",
            postgresql.JSONB(astext_type=sa.Text()),
            server_default="[]",
            nullable=False,
            comment='["first_name", "booking_date", "amount"]',
        ),
        sa.Column(
            "example_data",
            postgresql.JSONB(astext_type=sa.Text()),
            server_default="{}",
            nullable=False,
            comment='{"first_name": "John", "booking_date": "Dec 25"}',
        ),
        sa.Column(
            "ai_prompt", sa.Text(), nullable=True, comment="Original AI prompt if AI-generated"
        ),
        sa.Column(
            "ai_confidence", sa.Float(), nullable=True, comment="AI confidence score 0.0-1.0"
        ),
        sa.Column("ai_model", sa.String(length=50), nullable=True, comment="GPT-4, Claude, etc."),
        sa.Column("created_by", sa.UUID(), nullable=True),
        sa.Column("approved_by", sa.UUID(), nullable=True),
        sa.Column("approved_at", sa.DateTime(timezone=True), nullable=True),
        sa.Column("rejection_reason", sa.Text(), nullable=True),
        sa.Column(
            "usage_count",
            sa.Integer(),
            server_default="0",
            nullable=False,
            comment="How many times used",
        ),
        sa.Column("last_used_at", sa.DateTime(timezone=True), nullable=True),
        sa.Column("is_active", sa.Boolean(), server_default="true", nullable=False),
        sa.Column(
            "created_at",
            sa.DateTime(timezone=True),
            server_default=sa.text("now()"),
            nullable=False,
        ),
        sa.Column(
            "updated_at",
            sa.DateTime(timezone=True),
            server_default=sa.text("now()"),
            nullable=False,
        ),
        sa.ForeignKeyConstraint(
            ["approved_by"],
            ["identity.users.id"],
            name=op.f("fk_sms_templates_approved_by_users"),
            ondelete="SET NULL",
        ),
        sa.ForeignKeyConstraint(
            ["created_by"],
            ["identity.users.id"],
            name=op.f("fk_sms_templates_created_by_users"),
            ondelete="SET NULL",
        ),
        sa.PrimaryKeyConstraint("id", name=op.f("pk_sms_templates")),
        schema="newsletter",
    )
    op.create_index(
        "idx_sms_templates_active",
        "sms_templates",
        ["is_active"],
        unique=False,
        schema="newsletter",
    )
    op.create_index(
        "idx_sms_templates_category",
        "sms_templates",
        ["category"],
        unique=False,
        schema="newsletter",
    )
    op.create_index(
        "idx_sms_templates_source", "sms_templates", ["source"], unique=False, schema="newsletter"
    )
    op.create_index(
        "idx_sms_templates_status", "sms_templates", ["status"], unique=False, schema="newsletter"
    )
    op.create_table(
        "chef_availability",
        sa.Column("id", sa.UUID(), server_default=sa.text("gen_random_uuid()"), nullable=False),
        sa.Column("chef_id", sa.UUID(), nullable=False),
        sa.Column(
            "day_of_week",
            sa.Enum(
                "MONDAY",
                "TUESDAY",
                "WEDNESDAY",
                "THURSDAY",
                "FRIDAY",
                "SATURDAY",
                "SUNDAY",
                name="day_of_week",
                schema="public",
            ),
            nullable=False,
        ),
        sa.Column("start_time", sa.Time(), nullable=False),
        sa.Column("end_time", sa.Time(), nullable=False),
        sa.Column("is_available", sa.Boolean(), nullable=False),
        sa.Column(
            "created_at",
            sa.DateTime(timezone=True),
            server_default=sa.text("now()"),
            nullable=False,
        ),
        sa.ForeignKeyConstraint(
            ["chef_id"],
            ["ops.chefs.id"],
            name=op.f("fk_chef_availability_chef_id_chefs"),
            ondelete="CASCADE",
        ),
        sa.PrimaryKeyConstraint("id", name=op.f("pk_chef_availability")),
        sa.UniqueConstraint("chef_id", "day_of_week", "start_time", name="uq_chef_day_time"),
        schema="ops",
    )
    op.create_index(
        "idx_ops_chef_availability_chef",
        "chef_availability",
        ["chef_id", "day_of_week"],
        unique=False,
        schema="ops",
    )
    op.create_table(
        "chef_timeoff",
        sa.Column("id", sa.UUID(), server_default=sa.text("gen_random_uuid()"), nullable=False),
        sa.Column("chef_id", sa.UUID(), nullable=False),
        sa.Column("start_date", sa.Date(), nullable=False),
        sa.Column("end_date", sa.Date(), nullable=False),
        sa.Column(
            "type",
            sa.Enum("VACATION", "SICK", "PERSONAL", "UNPAID", name="timeoff_type", schema="public"),
            nullable=False,
        ),
        sa.Column(
            "status",
            sa.Enum(
                "PENDING", "APPROVED", "DENIED", "CANCELLED", name="timeoff_status", schema="public"
            ),
            nullable=False,
        ),
        sa.Column("reason", sa.Text(), nullable=True),
        sa.Column("approved_by", sa.String(length=100), nullable=True),
        sa.Column(
            "requested_at",
            sa.DateTime(timezone=True),
            server_default=sa.text("now()"),
            nullable=False,
        ),
        sa.Column("processed_at", sa.DateTime(timezone=True), nullable=True),
        sa.ForeignKeyConstraint(
            ["chef_id"],
            ["ops.chefs.id"],
            name=op.f("fk_chef_timeoff_chef_id_chefs"),
            ondelete="CASCADE",
        ),
        sa.PrimaryKeyConstraint("id", name=op.f("pk_chef_timeoff")),
        schema="ops",
    )
    op.create_index(
        "idx_ops_chef_timeoff_chef",
        "chef_timeoff",
        ["chef_id", "start_date"],
        unique=False,
        schema="ops",
    )
    op.create_index(
        "idx_ops_chef_timeoff_status", "chef_timeoff", ["status"], unique=False, schema="ops"
    )
    op.create_table(
        "equipment_maintenance",
        sa.Column("id", sa.UUID(), server_default=sa.text("gen_random_uuid()"), nullable=False),
        sa.Column("equipment_id", sa.UUID(), nullable=False),
        sa.Column(
            "type",
            sa.Enum(
                "PREVENTIVE",
                "REPAIR",
                "INSPECTION",
                "CLEANING",
                name="maintenance_type",
                schema="public",
            ),
            nullable=False,
        ),
        sa.Column("description", sa.Text(), nullable=False),
        sa.Column("maintenance_date", sa.Date(), nullable=False),
        sa.Column("cost", sa.Numeric(precision=10, scale=2), nullable=True),
        sa.Column("performed_by", sa.String(length=100), nullable=True),
        sa.Column(
            "created_at",
            sa.DateTime(timezone=True),
            server_default=sa.text("now()"),
            nullable=False,
        ),
        sa.ForeignKeyConstraint(
            ["equipment_id"],
            ["ops.equipment.id"],
            name=op.f("fk_equipment_maintenance_equipment_id_equipment"),
            ondelete="CASCADE",
        ),
        sa.PrimaryKeyConstraint("id", name=op.f("pk_equipment_maintenance")),
        schema="ops",
    )
    op.create_index(
        "idx_ops_maintenance_equipment",
        "equipment_maintenance",
        ["equipment_id", "maintenance_date"],
        unique=False,
        schema="ops",
    )
    op.create_index(
        "idx_ops_maintenance_type", "equipment_maintenance", ["type"], unique=False, schema="ops"
    )
    op.create_table(
        "inventory_transactions",
        sa.Column("id", sa.UUID(), server_default=sa.text("gen_random_uuid()"), nullable=False),
        sa.Column("inventory_id", sa.UUID(), nullable=False),
        sa.Column(
            "type",
            sa.Enum(
                "PURCHASE",
                "USE",
                "ADJUSTMENT",
                "TRANSFER",
                "WASTE",
                name="transaction_type",
                schema="public",
            ),
            nullable=False,
        ),
        sa.Column("quantity", sa.Numeric(precision=10, scale=2), nullable=False),
        sa.Column(
            "transaction_date",
            sa.DateTime(timezone=True),
            server_default=sa.text("now()"),
            nullable=False,
        ),
        sa.Column("notes", sa.Text(), nullable=True),
        sa.Column("reference_id", sa.String(length=100), nullable=True),
        sa.Column(
            "created_at",
            sa.DateTime(timezone=True),
            server_default=sa.text("now()"),
            nullable=False,
        ),
        sa.ForeignKeyConstraint(
            ["inventory_id"],
            ["ops.inventory.id"],
            name=op.f("fk_inventory_transactions_inventory_id_inventory"),
            ondelete="CASCADE",
        ),
        sa.PrimaryKeyConstraint("id", name=op.f("pk_inventory_transactions")),
        schema="ops",
    )
    op.create_index(
        "idx_ops_inventory_trans_item",
        "inventory_transactions",
        ["inventory_id", "transaction_date"],
        unique=False,
        schema="ops",
    )
    op.create_index(
        "idx_ops_inventory_trans_type",
        "inventory_transactions",
        ["type"],
        unique=False,
        schema="ops",
    )
    op.create_table(
        "shift_schedules",
        sa.Column("id", sa.UUID(), server_default=sa.text("gen_random_uuid()"), nullable=False),
        sa.Column("chef_id", sa.UUID(), nullable=False),
        sa.Column("shift_date", sa.Date(), nullable=False),
        sa.Column("start_time", sa.Time(), nullable=False),
        sa.Column("end_time", sa.Time(), nullable=False),
        sa.Column("booking_id", sa.UUID(), nullable=True),
        sa.Column("is_completed", sa.Boolean(), nullable=False),
        sa.Column("notes", sa.Text(), nullable=True),
        sa.Column(
            "created_at",
            sa.DateTime(timezone=True),
            server_default=sa.text("now()"),
            nullable=False,
        ),
        sa.ForeignKeyConstraint(
            ["chef_id"],
            ["ops.chefs.id"],
            name=op.f("fk_shift_schedules_chef_id_chefs"),
            ondelete="CASCADE",
        ),
        sa.PrimaryKeyConstraint("id", name=op.f("pk_shift_schedules")),
        schema="ops",
    )
    op.create_index(
        "idx_ops_shifts_chef",
        "shift_schedules",
        ["chef_id", "shift_date"],
        unique=False,
        schema="ops",
    )
    op.create_index(
        "idx_ops_shifts_date", "shift_schedules", ["shift_date"], unique=False, schema="ops"
    )
    op.create_table(
        "reviews",
        sa.Column("id", sa.UUID(), nullable=False),
        sa.Column(
            "account_id",
            sa.UUID(),
            nullable=True,
            comment="Social account where review was posted (if applicable)",
        ),
        sa.Column(
            "customer_id",
            sa.UUID(),
            nullable=True,
            comment="Soft reference to customer (validated at application level)",
        ),
        sa.Column(
            "booking_id",
            sa.UUID(),
            nullable=True,
            comment="Soft reference to booking (validated at application level)",
        ),
        sa.Column(
            "source",
            sa.Enum("GOOGLE", "YELP", "FACEBOOK", "INSTAGRAM", "DIRECT", name="review_source"),
            nullable=False,
        ),
        sa.Column(
            "status",
            sa.Enum(
                "NEW", "ACKNOWLEDGED", "RESPONDED", "ESCALATED", "CLOSED", name="review_status"
            ),
            nullable=False,
        ),
        sa.Column("rating", sa.Integer(), nullable=False),
        sa.Column("title", sa.String(length=200), nullable=True),
        sa.Column("content", sa.Text(), nullable=False),
        sa.Column("reviewer_name", sa.String(length=200), nullable=True),
        sa.Column("reviewer_email", sa.String(length=255), nullable=True),
        sa.Column("verified", sa.Boolean(), nullable=False),
        sa.Column("published", sa.Boolean(), nullable=False),
        sa.Column("featured", sa.Boolean(), nullable=False),
        sa.Column("review_date", sa.DateTime(timezone=True), nullable=False),
        sa.Column("published_at", sa.DateTime(timezone=True), nullable=True),
        sa.Column("acknowledged_at", sa.DateTime(timezone=True), nullable=True),
        sa.Column("responded_at", sa.DateTime(timezone=True), nullable=True),
        sa.Column(
            "platform_metadata",
            postgresql.JSONB(astext_type=sa.Text()),
            nullable=True,
            comment="Platform-specific review data",
        ),
        sa.Column("response_text", sa.Text(), nullable=True),
        sa.Column("external_id", sa.String(length=255), nullable=True),
        sa.Column("external_url", sa.String(length=500), nullable=True),
        sa.Column(
            "extra_data",
            postgresql.JSONB(astext_type=sa.Text()),
            nullable=True,
            comment="Review metadata and platform-specific data",
        ),
        sa.Column("created_at", sa.DateTime(), nullable=True),
        sa.Column("updated_at", sa.DateTime(), nullable=True),
        sa.Column("is_deleted", sa.Boolean(), nullable=False),
        sa.ForeignKeyConstraint(
            ["account_id"],
            ["lead.social_accounts.id"],
            name=op.f("fk_reviews_account_id_social_accounts"),
            ondelete="SET NULL",
        ),
        sa.PrimaryKeyConstraint("id", name=op.f("pk_reviews")),
        sa.UniqueConstraint("external_id", name=op.f("uq_reviews_external_id")),
        schema="public",
    )
    op.create_index(
        op.f("ix_public_reviews_account_id"),
        "reviews",
        ["account_id"],
        unique=False,
        schema="public",
    )
    op.create_index(
        op.f("ix_public_reviews_booking_id"),
        "reviews",
        ["booking_id"],
        unique=False,
        schema="public",
    )
    op.create_index(
        op.f("ix_public_reviews_customer_id"),
        "reviews",
        ["customer_id"],
        unique=False,
        schema="public",
    )
    op.create_index(
        op.f("ix_public_reviews_source"), "reviews", ["source"], unique=False, schema="public"
    )
    op.create_index(
        op.f("ix_public_reviews_status"), "reviews", ["status"], unique=False, schema="public"
    )
    op.create_index(
        "ix_reviews_customer_id", "reviews", ["customer_id"], unique=False, schema="public"
    )
    op.create_index("ix_reviews_rating", "reviews", ["rating"], unique=False, schema="public")
    op.create_index("ix_reviews_source", "reviews", ["source"], unique=False, schema="public")
    op.create_table(
        "role_permissions",
        sa.Column("role_id", sa.UUID(), nullable=False),
        sa.Column("permission_id", sa.UUID(), nullable=False),
        sa.Column("created_at", sa.DateTime(timezone=True), nullable=True),
        sa.ForeignKeyConstraint(
            ["permission_id"],
            ["permissions.id"],
            name=op.f("fk_role_permissions_permission_id_permissions"),
            ondelete="CASCADE",
        ),
        sa.ForeignKeyConstraint(
            ["role_id"],
            ["roles.id"],
            name=op.f("fk_role_permissions_role_id_roles"),
            ondelete="CASCADE",
        ),
        sa.PrimaryKeyConstraint("role_id", "permission_id", name=op.f("pk_role_permissions")),
    )
    op.create_table(
        "escalations",
        sa.Column("id", sa.UUID(), nullable=False),
        sa.Column("assigned_to_id", sa.UUID(), nullable=True),
        sa.Column("conversation_id", sa.String(length=255), nullable=False),
        sa.Column("customer_name", sa.String(length=255), nullable=False),
        sa.Column("customer_phone", sa.String(length=20), nullable=False),
        sa.Column("customer_email", sa.String(length=255), nullable=True),
        sa.Column("reason", sa.Text(), nullable=False),
        sa.Column(
            "priority",
            sa.Enum(
                "LOW", "MEDIUM", "HIGH", "URGENT", name="escalation_priority", schema="support"
            ),
            server_default="medium",
            nullable=False,
        ),
        sa.Column(
            "method",
            sa.Enum(
                "PHONE", "EMAIL", "PREFERRED_METHOD", name="escalation_method", schema="support"
            ),
            server_default="phone",
            nullable=False,
        ),
        sa.Column(
            "status",
            sa.Enum(
                "PENDING",
                "ASSIGNED",
                "IN_PROGRESS",
                "WAITING_CUSTOMER",
                "RESOLVED",
                "CLOSED",
                "ERROR",
                name="escalation_status",
                schema="support",
            ),
            server_default="pending",
            nullable=False,
        ),
        sa.Column("assigned_at", sa.DateTime(timezone=True), nullable=True),
        sa.Column("escalated_at", sa.DateTime(timezone=True), nullable=True),
        sa.Column("resolved_at", sa.DateTime(timezone=True), nullable=True),
        sa.Column("resolution_notes", sa.Text(), nullable=True),
        sa.Column("resume_ai_chat", sa.Boolean(), server_default="false", nullable=False),
        sa.Column("last_customer_response_at", sa.DateTime(timezone=True), nullable=True),
        sa.Column("sms_sent", sa.Boolean(), server_default="false", nullable=False),
        sa.Column("sms_sent_at", sa.DateTime(timezone=True), nullable=True),
        sa.Column("call_initiated", sa.Boolean(), server_default="false", nullable=False),
        sa.Column("call_initiated_at", sa.DateTime(timezone=True), nullable=True),
        sa.Column("error_message", sa.Text(), nullable=True),
        sa.Column("retry_count", sa.Integer(), server_default="0", nullable=False),
        sa.Column(
            "escalation_metadata",
            postgresql.JSONB(astext_type=sa.Text()),
            server_default="{}",
            nullable=False,
        ),
        sa.Column(
            "created_at",
            sa.DateTime(timezone=True),
            server_default=sa.text("now()"),
            nullable=False,
        ),
        sa.Column(
            "updated_at",
            sa.DateTime(timezone=True),
            server_default=sa.text("now()"),
            nullable=False,
        ),
        sa.ForeignKeyConstraint(
            ["assigned_to_id"],
            ["identity.users.id"],
            name=op.f("fk_escalations_assigned_to_id_users"),
            ondelete="SET NULL",
        ),
        sa.PrimaryKeyConstraint("id", name=op.f("pk_escalations")),
        schema="support",
    )
    op.create_index(
        "idx_escalations_assigned_status",
        "escalations",
        ["assigned_to_id", "status"],
        unique=False,
        schema="support",
    )
    op.create_index(
        "idx_escalations_assigned_to_id",
        "escalations",
        ["assigned_to_id"],
        unique=False,
        schema="support",
    )
    op.create_index(
        "idx_escalations_conversation_id",
        "escalations",
        ["conversation_id"],
        unique=False,
        schema="support",
    )
    op.create_index(
        "idx_escalations_created_at", "escalations", ["created_at"], unique=False, schema="support"
    )
    op.create_index(
        "idx_escalations_customer_phone",
        "escalations",
        ["customer_phone"],
        unique=False,
        schema="support",
    )
    op.create_index(
        "idx_escalations_status", "escalations", ["status"], unique=False, schema="support"
    )
    op.create_index(
        "idx_escalations_status_priority",
        "escalations",
        ["status", "priority"],
        unique=False,
        schema="support",
    )
    op.create_index(
        op.f("ix_support_escalations_assigned_to_id"),
        "escalations",
        ["assigned_to_id"],
        unique=False,
        schema="support",
    )
    op.create_index(
        op.f("ix_support_escalations_conversation_id"),
        "escalations",
        ["conversation_id"],
        unique=False,
        schema="support",
    )
    op.create_index(
        op.f("ix_support_escalations_customer_phone"),
        "escalations",
        ["customer_phone"],
        unique=False,
        schema="support",
    )
    op.create_index(
        op.f("ix_support_escalations_status"),
        "escalations",
        ["status"],
        unique=False,
        schema="support",
    )
    op.create_table(
        "conversations",
        sa.Column(
            "id",
            sa.String(length=100),
            nullable=False,
            comment="Unique conversation identifier (UUID)",
        ),
        sa.Column(
            "user_id",
            sa.String(length=255),
            nullable=True,
            comment="User identifier (from auth system or anonymous session)",
        ),
        sa.Column(
            "customer_id",
            sa.String(length=36),
            nullable=True,
            comment="Link to customer record (if identified)",
        ),
        sa.Column(
            "channel",
            sa.String(length=20),
            nullable=False,
            comment="Communication channel (web/sms/voice/facebook/instagram/email)",
        ),
        sa.Column(
            "thread_id",
            sa.String(length=255),
            nullable=True,
            comment="Channel-specific thread ID (SMS phone number, FB thread, etc.)",
        ),
        sa.Column(
            "channel_metadata",
            postgresql.JSONB(astext_type=sa.Text()),
            nullable=False,
            comment="Channel-specific metadata (phone numbers, FB page IDs, email addresses)",
        ),
        sa.Column(
            "status",
            sa.String(length=20),
            nullable=False,
            comment="Conversation status (active/escalated/closed/archived)",
        ),
        sa.Column(
            "is_active",
            sa.Boolean(),
            nullable=False,
            comment="Quick active/inactive flag (optimized queries)",
        ),
        sa.Column(
            "created_at", sa.DateTime(), nullable=False, comment="Conversation start timestamp"
        ),
        sa.Column(
            "updated_at",
            sa.DateTime(),
            nullable=False,
            comment="Last update timestamp (any change)",
        ),
        sa.Column(
            "last_message_at",
            sa.DateTime(),
            nullable=False,
            comment="Last message timestamp (for inactive detection)",
        ),
        sa.Column(
            "closed_at", sa.DateTime(), nullable=True, comment="Conversation closure timestamp"
        ),
        sa.Column(
            "closed_reason",
            sa.String(length=100),
            nullable=True,
            comment="Closure reason (resolved/timeout/customer_ended/escalated)",
        ),
        sa.Column(
            "message_count",
            sa.Integer(),
            nullable=False,
            comment="Total messages in conversation (performance optimization)",
        ),
        sa.Column(
            "context",
            postgresql.JSONB(astext_type=sa.Text()),
            nullable=False,
            comment="Conversation context (booking details, customer preferences, session data)",
        ),
        sa.Column(
            "average_emotion_score",
            sa.Float(),
            nullable=True,
            comment="Average emotion score across all messages (0.0=negative, 1.0=positive)",
        ),
        sa.Column(
            "emotion_trend",
            sa.String(length=20),
            nullable=True,
            comment="Emotion trend (improving/stable/declining)",
        ),
        sa.Column(
            "escalated", sa.Boolean(), nullable=False, comment="Escalated to human agent flag"
        ),
        sa.Column("escalated_at", sa.DateTime(), nullable=True, comment="Escalation timestamp"),
        sa.Column(
            "assigned_agent_id",
            sa.String(length=255),
            nullable=True,
            comment="Human agent ID (after escalation)",
        ),
        sa.Column(
            "escalation_reason",
            sa.Text(),
            nullable=True,
            comment="Why conversation was escalated (emotion/complexity/customer_request)",
        ),
        sa.Column(
            "confidence_score",
            sa.Float(),
            nullable=True,
            comment="AI confidence score (for routing decisions)",
        ),
        sa.Column(
            "route_decision",
            sa.String(length=50),
            nullable=True,
            comment="Routing decision (student/teacher/human) for shadow learning",
        ),
        sa.Column(
            "student_response",
            sa.Text(),
            nullable=True,
            comment="Student model response (local Llama-3) for comparison",
        ),
        sa.Column(
            "teacher_response",
            sa.Text(),
            nullable=True,
            comment="Teacher model response (OpenAI GPT-4) for training",
        ),
        sa.Column(
            "reward_score",
            sa.Float(),
            nullable=True,
            comment="RLHF reward score (human feedback on conversation quality)",
        ),
        sa.ForeignKeyConstraint(
            ["customer_id"],
            ["core.customers.id"],
            name=op.f("fk_conversations_customer_id_customers"),
            ondelete="SET NULL",
        ),
        sa.PrimaryKeyConstraint("id", name=op.f("pk_conversations")),
        schema="ai",
    )
    op.create_index(
        "idx_conversations_assigned_agent",
        "conversations",
        ["assigned_agent_id", "status"],
        unique=False,
        schema="ai",
    )
    op.create_index(
        "idx_conversations_channel_metadata",
        "conversations",
        ["channel_metadata"],
        unique=False,
        schema="ai",
        postgresql_using="gin",
    )
    op.create_index(
        "idx_conversations_channel_status",
        "conversations",
        ["channel", "status"],
        unique=False,
        schema="ai",
    )
    op.create_index(
        "idx_conversations_closed", "conversations", ["closed_at"], unique=False, schema="ai"
    )
    op.create_index(
        "idx_conversations_context",
        "conversations",
        ["context"],
        unique=False,
        schema="ai",
        postgresql_using="gin",
    )
    op.create_index(
        "idx_conversations_created", "conversations", ["created_at"], unique=False, schema="ai"
    )
    op.create_index(
        "idx_conversations_customer_id", "conversations", ["customer_id"], unique=False, schema="ai"
    )
    op.create_index(
        "idx_conversations_emotion_active",
        "conversations",
        ["average_emotion_score", "is_active"],
        unique=False,
        schema="ai",
    )
    op.create_index(
        "idx_conversations_emotion_trend",
        "conversations",
        ["average_emotion_score", "emotion_trend"],
        unique=False,
        schema="ai",
    )
    op.create_index(
        "idx_conversations_escalated",
        "conversations",
        ["escalated", "escalated_at"],
        unique=False,
        schema="ai",
    )
    op.create_index(
        "idx_conversations_last_message",
        "conversations",
        ["last_message_at"],
        unique=False,
        schema="ai",
    )
    op.create_index(
        "idx_conversations_route_decision",
        "conversations",
        ["route_decision", "confidence_score"],
        unique=False,
        schema="ai",
    )
    op.create_index(
        "idx_conversations_status_updated",
        "conversations",
        ["status", "updated_at"],
        unique=False,
        schema="ai",
    )
    op.create_index(
        "idx_conversations_user_active",
        "conversations",
        ["user_id", "is_active"],
        unique=False,
        schema="ai",
    )
    op.create_index(
        "idx_conversations_user_channel",
        "conversations",
        ["user_id", "channel"],
        unique=False,
        schema="ai",
    )
    op.create_index(
        op.f("ix_ai_conversations_customer_id"),
        "conversations",
        ["customer_id"],
        unique=False,
        schema="ai",
    )
    op.create_index(
        op.f("ix_ai_conversations_is_active"),
        "conversations",
        ["is_active"],
        unique=False,
        schema="ai",
    )
    op.create_index(
        op.f("ix_ai_conversations_user_id"), "conversations", ["user_id"], unique=False, schema="ai"
    )
    op.create_table(
        "call_recordings",
        sa.Column("id", sa.UUID(), nullable=False),
        sa.Column("escalation_id", sa.UUID(), nullable=True),
        sa.Column("last_accessed_by_id", sa.UUID(), nullable=True),
        sa.Column("rc_call_id", sa.String(length=255), nullable=False),
        sa.Column("rc_recording_id", sa.String(length=255), nullable=False),
        sa.Column("rc_recording_uri", sa.String(length=500), nullable=True),
        sa.Column(
            "recording_type",
            sa.Enum(
                "INBOUND", "OUTBOUND", "INTERNAL", name="recording_type", schema="communications"
            ),
            server_default="inbound",
            nullable=False,
        ),
        sa.Column(
            "status",
            sa.Enum(
                "PENDING",
                "DOWNLOADING",
                "AVAILABLE",
                "ARCHIVED",
                "DELETED",
                "ERROR",
                name="recording_status",
                schema="communications",
            ),
            server_default="pending",
            nullable=False,
        ),
        sa.Column("call_started_at", sa.DateTime(timezone=True), nullable=False),
        sa.Column("duration_seconds", sa.Integer(), nullable=True),
        sa.Column("file_size_bytes", sa.BigInteger(), nullable=True),
        sa.Column("content_type", sa.String(length=50), nullable=True),
        sa.Column("s3_bucket", sa.String(length=255), nullable=True),
        sa.Column("s3_key", sa.String(length=500), nullable=True),
        sa.Column("s3_uri", sa.String(length=1000), nullable=True),
        sa.Column("retention_days", sa.Integer(), server_default="90", nullable=False),
        sa.Column("delete_after", sa.DateTime(timezone=True), nullable=True),
        sa.Column("downloaded_at", sa.DateTime(timezone=True), nullable=True),
        sa.Column("archived_at", sa.DateTime(timezone=True), nullable=True),
        sa.Column("deleted_at", sa.DateTime(timezone=True), nullable=True),
        sa.Column("download_attempts", sa.Integer(), server_default="0", nullable=False),
        sa.Column("error_message", sa.Text(), nullable=True),
        sa.Column("accessed_count", sa.Integer(), server_default="0", nullable=False),
        sa.Column("last_accessed_at", sa.DateTime(timezone=True), nullable=True),
        sa.Column(
            "recording_metadata",
            postgresql.JSONB(astext_type=sa.Text()),
            server_default="{}",
            nullable=False,
        ),
        sa.Column(
            "created_at",
            sa.DateTime(timezone=True),
            server_default=sa.text("now()"),
            nullable=False,
        ),
        sa.Column(
            "updated_at",
            sa.DateTime(timezone=True),
            server_default=sa.text("now()"),
            nullable=False,
        ),
        sa.ForeignKeyConstraint(
            ["escalation_id"],
            ["support.escalations.id"],
            name=op.f("fk_call_recordings_escalation_id_escalations"),
            ondelete="SET NULL",
        ),
        sa.ForeignKeyConstraint(
            ["last_accessed_by_id"],
            ["identity.users.id"],
            name=op.f("fk_call_recordings_last_accessed_by_id_users"),
            ondelete="SET NULL",
        ),
        sa.PrimaryKeyConstraint("id", name=op.f("pk_call_recordings")),
        sa.UniqueConstraint("rc_recording_id", name=op.f("uq_call_recordings_rc_recording_id")),
        schema="communications",
    )
    op.create_index(
        "idx_call_recordings_call_started_at",
        "call_recordings",
        ["call_started_at"],
        unique=False,
        schema="communications",
    )
    op.create_index(
        "idx_call_recordings_date_status",
        "call_recordings",
        ["call_started_at", "status"],
        unique=False,
        schema="communications",
    )
    op.create_index(
        "idx_call_recordings_delete_after",
        "call_recordings",
        ["delete_after"],
        unique=False,
        schema="communications",
    )
    op.create_index(
        "idx_call_recordings_escalation_id",
        "call_recordings",
        ["escalation_id"],
        unique=False,
        schema="communications",
    )
    op.create_index(
        "idx_call_recordings_rc_call_id",
        "call_recordings",
        ["rc_call_id"],
        unique=False,
        schema="communications",
    )
    op.create_index(
        "idx_call_recordings_status",
        "call_recordings",
        ["status"],
        unique=False,
        schema="communications",
    )
    op.create_index(
        op.f("ix_communications_call_recordings_call_started_at"),
        "call_recordings",
        ["call_started_at"],
        unique=False,
        schema="communications",
    )
    op.create_index(
        op.f("ix_communications_call_recordings_delete_after"),
        "call_recordings",
        ["delete_after"],
        unique=False,
        schema="communications",
    )
    op.create_index(
        op.f("ix_communications_call_recordings_escalation_id"),
        "call_recordings",
        ["escalation_id"],
        unique=False,
        schema="communications",
    )
    op.create_index(
        op.f("ix_communications_call_recordings_rc_call_id"),
        "call_recordings",
        ["rc_call_id"],
        unique=True,
        schema="communications",
    )
    op.create_index(
        op.f("ix_communications_call_recordings_status"),
        "call_recordings",
        ["status"],
        unique=False,
        schema="communications",
    )
    op.create_table(
        "bookings",
        sa.Column("id", sa.UUID(), server_default=sa.text("gen_random_uuid()"), nullable=False),
        sa.Column("customer_id", sa.UUID(), nullable=False),
        sa.Column("chef_id", sa.UUID(), nullable=True),
        sa.Column("station_id", sa.UUID(), nullable=False),
        sa.Column("date", sa.Date(), nullable=False),
        sa.Column("slot", sa.Time(), nullable=False),
        sa.Column("address_encrypted", sa.Text(), nullable=False),
        sa.Column("zone", sa.String(), nullable=False),
        sa.Column("party_adults", sa.Integer(), nullable=False),
        sa.Column("party_kids", sa.Integer(), nullable=False),
        sa.Column("deposit_due_cents", sa.Integer(), nullable=False),
        sa.Column("total_due_cents", sa.Integer(), nullable=False),
        sa.Column(
            "status",
            sa.Enum(
                "new",
                "deposit_pending",
                "confirmed",
                "completed",
                "cancelled",
                "no_show",
                name="booking_status",
                create_constraint=True,
            ),
            nullable=False,
        ),
        sa.Column("source", sa.String(), nullable=False),
        sa.Column("sms_consent", sa.Boolean(), nullable=False),
        sa.Column("sms_consent_timestamp", sa.DateTime(timezone=True), nullable=True),
        sa.Column("version", sa.Integer(), nullable=False),
        sa.Column("customer_deposit_deadline", sa.DateTime(), nullable=True),
        sa.Column("internal_deadline", sa.DateTime(), nullable=True),
        sa.Column("deposit_deadline", sa.DateTime(), nullable=True),
        sa.Column("deposit_confirmed_at", sa.DateTime(), nullable=True),
        sa.Column("deposit_confirmed_by", sa.String(length=255), nullable=True),
        sa.Column("hold_on_request", sa.Boolean(), nullable=False),
        sa.Column("held_by", sa.String(length=255), nullable=True),
        sa.Column("held_at", sa.DateTime(), nullable=True),
        sa.Column("hold_reason", sa.Text(), nullable=True),
        sa.Column("menu_items", sa.JSON(), nullable=True),
        sa.Column("special_requests", sa.Text(), nullable=True),
        sa.Column("notes", sa.Text(), nullable=True),
        sa.Column("metadata", sa.JSON(), nullable=True),
        sa.Column("deleted_at", sa.DateTime(timezone=True), nullable=True),
        sa.Column("created_at", sa.DateTime(timezone=True), nullable=False),
        sa.Column("updated_at", sa.DateTime(timezone=True), nullable=False),
        sa.CheckConstraint(
            "deposit_due_cents >= 0", name=op.f("ck_bookings_check_deposit_non_negative")
        ),
        sa.CheckConstraint(
            "party_adults > 0", name=op.f("ck_bookings_check_party_adults_positive")
        ),
        sa.CheckConstraint(
            "party_kids >= 0", name=op.f("ck_bookings_check_party_kids_non_negative")
        ),
        sa.CheckConstraint(
            "total_due_cents >= deposit_due_cents", name=op.f("ck_bookings_check_total_gte_deposit")
        ),
        sa.ForeignKeyConstraint(
            ["customer_id"], ["core.customers.id"], name=op.f("fk_bookings_customer_id_customers")
        ),
        sa.PrimaryKeyConstraint("id", name=op.f("pk_bookings")),
        schema="core",
    )
    op.create_index(
        "idx_booking_date_slot_active",
        "bookings",
        ["date", "slot", "status"],
        unique=True,
        schema="core",
    )
    op.create_index(
        "idx_booking_station_customer",
        "bookings",
        ["station_id", "customer_id"],
        unique=False,
        schema="core",
    )
    op.create_index(
        "idx_booking_station_date",
        "bookings",
        ["station_id", "date", "slot"],
        unique=False,
        schema="core",
    )
    op.create_index(
        "ix_bookings_customer_deposit_deadline",
        "bookings",
        ["customer_deposit_deadline", "status"],
        unique=False,
        schema="core",
    )
    op.create_index(
        "ix_bookings_internal_deadline",
        "bookings",
        ["internal_deadline", "status", "hold_on_request", "deposit_confirmed_at"],
        unique=False,
        schema="core",
    )
    op.create_index(
        "ix_bookings_sms_consent", "bookings", ["sms_consent"], unique=False, schema="core"
    )
    op.create_index(
        "ix_core_bookings_chef_slot_unique",
        "bookings",
        ["chef_id", "date", "slot"],
        unique=True,
        schema="core",
    )
    op.create_index(
        op.f("ix_core_bookings_customer_deposit_deadline"),
        "bookings",
        ["customer_deposit_deadline"],
        unique=False,
        schema="core",
    )
    op.create_index(
        op.f("ix_core_bookings_customer_id"),
        "bookings",
        ["customer_id"],
        unique=False,
        schema="core",
    )
    op.create_index(
        op.f("ix_core_bookings_date"), "bookings", ["date"], unique=False, schema="core"
    )
    op.create_index(
        "ix_core_bookings_date_slot", "bookings", ["date", "slot"], unique=False, schema="core"
    )
    op.create_index(op.f("ix_core_bookings_id"), "bookings", ["id"], unique=False, schema="core")
    op.create_index(
        op.f("ix_core_bookings_internal_deadline"),
        "bookings",
        ["internal_deadline"],
        unique=False,
        schema="core",
    )
    op.create_index(
        op.f("ix_core_bookings_slot"), "bookings", ["slot"], unique=False, schema="core"
    )
    op.create_index(
        op.f("ix_core_bookings_status"), "bookings", ["status"], unique=False, schema="core"
    )
    op.create_table(
        "message_threads",
        sa.Column("id", sa.UUID(), nullable=False),
        sa.Column("customer_id", sa.UUID(), nullable=False),
        sa.Column("station_id", sa.UUID(), nullable=True),
        sa.Column("subject", sa.String(length=255), nullable=True),
        sa.Column(
            "channel",
            sa.Enum(
                "SMS",
                "EMAIL",
                "PHONE",
                "WEB_CHAT",
                "SOCIAL_MEDIA",
                name="message_channel",
                schema="public",
            ),
            nullable=False,
        ),
        sa.Column(
            "status",
            sa.Enum("ACTIVE", "ARCHIVED", "CLOSED", "SPAM", name="thread_status", schema="public"),
            nullable=False,
        ),
        sa.Column("thread_metadata", postgresql.JSONB(astext_type=sa.Text()), nullable=False),
        sa.Column(
            "created_at",
            sa.DateTime(timezone=True),
            server_default=sa.text("now()"),
            nullable=False,
        ),
        sa.Column(
            "updated_at",
            sa.DateTime(timezone=True),
            server_default=sa.text("now()"),
            nullable=False,
        ),
        sa.Column("last_message_at", sa.DateTime(timezone=True), nullable=True),
        sa.ForeignKeyConstraint(
            ["customer_id"],
            ["core.customers.id"],
            name=op.f("fk_message_threads_customer_id_customers"),
        ),
        sa.ForeignKeyConstraint(
            ["station_id"],
            ["identity.stations.id"],
            name=op.f("fk_message_threads_station_id_stations"),
        ),
        sa.PrimaryKeyConstraint("id", name=op.f("pk_message_threads")),
        schema="core",
    )
    op.create_index(
        "idx_message_threads_created_at",
        "message_threads",
        ["created_at"],
        unique=False,
        schema="core",
    )
    op.create_index(
        "idx_message_threads_customer_id",
        "message_threads",
        ["customer_id"],
        unique=False,
        schema="core",
    )
    op.create_index(
        "idx_message_threads_station_id",
        "message_threads",
        ["station_id"],
        unique=False,
        schema="core",
    )
    op.create_index(
        "idx_message_threads_status", "message_threads", ["status"], unique=False, schema="core"
    )
    op.create_index(
        op.f("ix_core_message_threads_status"),
        "message_threads",
        ["status"],
        unique=False,
        schema="core",
    )
    op.create_table(
        "leads",
        sa.Column("id", sa.UUID(), server_default=sa.text("gen_random_uuid()"), nullable=False),
        sa.Column(
            "source",
            sa.Enum(
                "WEB_QUOTE",
                "CHAT",
                "INSTAGRAM",
                "FACEBOOK",
                "GOOGLE",
                "YELP",
                "SMS",
                "PHONE",
                "REFERRAL",
                "EVENT",
                name="lead_source",
                schema="public",
            ),
            nullable=False,
        ),
        sa.Column("utm_source", sa.String(length=100), nullable=True),
        sa.Column("utm_medium", sa.String(length=100), nullable=True),
        sa.Column("utm_campaign", sa.String(length=100), nullable=True),
        sa.Column(
            "status",
            sa.Enum(
                "NEW",
                "WORKING",
                "QUALIFIED",
                "DISQUALIFIED",
                "CONVERTED",
                "NURTURING",
                name="lead_status",
                schema="public",
            ),
            nullable=False,
        ),
        sa.Column(
            "quality",
            sa.Enum("HOT", "WARM", "COLD", name="lead_quality", schema="public"),
            nullable=True,
        ),
        sa.Column("score", sa.Numeric(precision=5, scale=2), nullable=False),
        sa.Column("assigned_to", sa.String(length=100), nullable=True),
        sa.Column("customer_id", sa.UUID(), nullable=True),
        sa.Column("last_contact_date", sa.DateTime(timezone=True), nullable=True),
        sa.Column("follow_up_date", sa.DateTime(timezone=True), nullable=True),
        sa.Column("conversion_date", sa.DateTime(timezone=True), nullable=True),
        sa.Column("lost_reason", sa.Text(), nullable=True),
        sa.Column(
            "created_at",
            sa.DateTime(timezone=True),
            server_default=sa.text("now()"),
            nullable=False,
        ),
        sa.Column(
            "updated_at",
            sa.DateTime(timezone=True),
            server_default=sa.text("now()"),
            nullable=False,
        ),
        sa.Column("deleted_at", sa.DateTime(timezone=True), nullable=True),
        sa.CheckConstraint(
            "score >= 0 AND score <= 100", name=op.f("ck_leads_check_lead_score_range")
        ),
        sa.ForeignKeyConstraint(
            ["customer_id"],
            ["core.customers.id"],
            name=op.f("fk_leads_customer_id_customers"),
            ondelete="SET NULL",
        ),
        sa.PrimaryKeyConstraint("id", name=op.f("pk_leads")),
        schema="crm",
    )
    op.create_index("idx_crm_leads_customer", "leads", ["customer_id"], unique=False, schema="crm")
    op.create_index(
        "idx_crm_leads_followup", "leads", ["follow_up_date"], unique=False, schema="crm"
    )
    op.create_index("idx_crm_leads_score", "leads", ["score"], unique=False, schema="crm")
    op.create_index("idx_crm_leads_source", "leads", ["source"], unique=False, schema="crm")
    op.create_index("idx_crm_leads_status", "leads", ["status"], unique=False, schema="crm")
    op.create_table(
        "admin_access_logs",
        sa.Column("id", sa.UUID(), nullable=False),
        sa.Column("user_id", sa.UUID(), nullable=True),
        sa.Column("oauth_account_id", sa.UUID(), nullable=True),
        sa.Column("email", sa.String(length=255), nullable=False),
        sa.Column("action", sa.String(length=50), nullable=False),
        sa.Column("result", sa.String(length=20), nullable=False),
        sa.Column("details", sa.Text(), nullable=True),
        sa.Column("error_message", sa.Text(), nullable=True),
        sa.Column("ip_address", sa.String(length=45), nullable=True),
        sa.Column("user_agent", sa.Text(), nullable=True),
        sa.Column(
            "created_at",
            sa.DateTime(timezone=True),
            server_default=sa.text("now()"),
            nullable=False,
        ),
        sa.ForeignKeyConstraint(
            ["oauth_account_id"],
            ["identity.oauth_accounts.id"],
            name=op.f("fk_admin_access_logs_oauth_account_id_oauth_accounts"),
        ),
        sa.ForeignKeyConstraint(
            ["user_id"], ["identity.users.id"], name=op.f("fk_admin_access_logs_user_id_users")
        ),
        sa.PrimaryKeyConstraint("id", name=op.f("pk_admin_access_logs")),
        schema="identity",
    )
    op.create_index(
        "idx_admin_access_action", "admin_access_logs", ["action"], unique=False, schema="identity"
    )
    op.create_index(
        "idx_admin_access_created",
        "admin_access_logs",
        ["created_at"],
        unique=False,
        schema="identity",
    )
    op.create_index(
        "idx_admin_access_email", "admin_access_logs", ["email"], unique=False, schema="identity"
    )
    op.create_index(
        "idx_admin_access_user", "admin_access_logs", ["user_id"], unique=False, schema="identity"
    )
    op.create_table(
        "leads",
        sa.Column("id", sa.UUID(), server_default=sa.text("gen_random_uuid()"), nullable=False),
        sa.Column(
            "source",
            sa.Enum(
                "WEB_QUOTE",
                "CHAT",
                "INSTAGRAM",
                "FACEBOOK",
                "GOOGLE",
                "YELP",
                "SMS",
                "PHONE",
                "REFERRAL",
                "EVENT",
                name="lead_source",
                schema="public",
            ),
            nullable=False,
        ),
        sa.Column("utm_source", sa.String(length=100), nullable=True),
        sa.Column("utm_medium", sa.String(length=100), nullable=True),
        sa.Column("utm_campaign", sa.String(length=100), nullable=True),
        sa.Column(
            "status",
            sa.Enum(
                "NEW",
                "WORKING",
                "QUALIFIED",
                "DISQUALIFIED",
                "CONVERTED",
                "NURTURING",
                name="lead_status",
                schema="public",
            ),
            nullable=False,
        ),
        sa.Column(
            "quality",
            sa.Enum("HOT", "WARM", "COLD", name="lead_quality", schema="public"),
            nullable=True,
        ),
        sa.Column("score", sa.Numeric(precision=5, scale=2), nullable=False),
        sa.Column("assigned_to", sa.String(length=100), nullable=True),
        sa.Column("customer_id", sa.UUID(), nullable=True),
        sa.Column("last_contact_date", sa.DateTime(timezone=True), nullable=True),
        sa.Column("follow_up_date", sa.DateTime(timezone=True), nullable=True),
        sa.Column("conversion_date", sa.DateTime(timezone=True), nullable=True),
        sa.Column("lost_reason", sa.Text(), nullable=True),
        sa.Column(
            "created_at",
            sa.DateTime(timezone=True),
            server_default=sa.text("now()"),
            nullable=False,
        ),
        sa.Column(
            "updated_at",
            sa.DateTime(timezone=True),
            server_default=sa.text("now()"),
            nullable=False,
        ),
        sa.Column("deleted_at", sa.DateTime(timezone=True), nullable=True),
        sa.CheckConstraint(
            "score >= 0 AND score <= 100", name=op.f("ck_leads_check_lead_score_range")
        ),
        sa.ForeignKeyConstraint(
            ["customer_id"],
            ["core.customers.id"],
            name=op.f("fk_leads_customer_id_customers"),
            ondelete="SET NULL",
        ),
        sa.PrimaryKeyConstraint("id", name=op.f("pk_leads")),
        schema="lead",
    )
    op.create_index("ix_lead_leads_customer", "leads", ["customer_id"], unique=False, schema="lead")
    op.create_index(
        "ix_lead_leads_followup", "leads", ["follow_up_date"], unique=False, schema="lead"
    )
    op.create_index("ix_lead_leads_score", "leads", ["score"], unique=False, schema="lead")
    op.create_index("ix_lead_leads_source", "leads", ["source"], unique=False, schema="lead")
    op.create_index("ix_lead_leads_status", "leads", ["status"], unique=False, schema="lead")
    op.create_table(
        "social_messages",
        sa.Column("id", sa.UUID(), nullable=False),
        sa.Column("thread_id", sa.UUID(), nullable=False),
        sa.Column(
            "message_external_id",
            sa.String(length=255),
            nullable=True,
            comment="Platform-specific message ID",
        ),
        sa.Column(
            "message_ref",
            sa.String(length=255),
            nullable=True,
            comment="Alternative message reference",
        ),
        sa.Column(
            "direction",
            sa.Enum("IN", "OUT", name="message_direction"),
            nullable=False,
            comment="IN (from customer) or OUT (from business)",
        ),
        sa.Column(
            "kind",
            sa.Enum(
                "DM", "COMMENT", "REVIEW", "REPLY", "MENTION", "STORY_REPLY", name="message_kind"
            ),
            nullable=False,
            comment="Type of message: DM, comment, review, etc.",
        ),
        sa.Column("content", sa.Text(), nullable=False),
        sa.Column("sender_handle", sa.String(length=255), nullable=False),
        sa.Column(
            "author_handle",
            sa.String(length=100),
            nullable=True,
            comment="Alternative author field",
        ),
        sa.Column("author_name", sa.String(length=255), nullable=True),
        sa.Column("is_from_customer", sa.Boolean(), nullable=False),
        sa.Column(
            "media",
            postgresql.JSONB(astext_type=sa.Text()),
            nullable=True,
            comment="Attachments, images, videos",
        ),
        sa.Column(
            "sentiment_score",
            sa.Float(),
            nullable=True,
            comment="AI sentiment analysis -1 (negative) to 1 (positive)",
        ),
        sa.Column(
            "intent_tags",
            postgresql.ARRAY(sa.String(length=50)),
            nullable=True,
            comment="Detected intents: booking, complaint, question, etc.",
        ),
        sa.Column("sent_at", sa.DateTime(timezone=True), nullable=False),
        sa.Column("read_at", sa.DateTime(timezone=True), nullable=True),
        sa.Column("created_at", sa.DateTime(timezone=True), nullable=False),
        sa.Column(
            "extra_data",
            postgresql.JSONB(astext_type=sa.Text()),
            nullable=True,
            comment="Message metadata and platform-specific data",
        ),
        sa.Column("updated_at", sa.DateTime(), nullable=True),
        sa.Column("is_deleted", sa.Boolean(), nullable=False),
        sa.ForeignKeyConstraint(
            ["thread_id"],
            ["lead.social_threads.id"],
            name=op.f("fk_social_messages_thread_id_social_threads"),
            ondelete="CASCADE",
        ),
        sa.PrimaryKeyConstraint("id", name=op.f("pk_social_messages")),
        sa.UniqueConstraint(
            "message_external_id", name=op.f("uq_social_messages_message_external_id")
        ),
        schema="lead",
    )
    op.create_index(
        op.f("ix_lead_social_messages_thread_id"),
        "social_messages",
        ["thread_id"],
        unique=False,
        schema="lead",
    )
    op.create_index(
        "ix_social_messages_sent_at", "social_messages", ["sent_at"], unique=False, schema="lead"
    )
    op.create_index(
        "ix_social_messages_thread_id",
        "social_messages",
        ["thread_id"],
        unique=False,
        schema="lead",
    )
    op.create_table(
        "subscribers",
        sa.Column("id", sa.UUID(), server_default=sa.text("gen_random_uuid()"), nullable=False),
        sa.Column("customer_id", sa.UUID(), nullable=True),
        sa.Column("email_enc", sa.LargeBinary(), nullable=False),
        sa.Column("phone_enc", sa.LargeBinary(), nullable=True),
        sa.Column("subscribed", sa.Boolean(), nullable=False),
        sa.Column("source", sa.String(length=50), nullable=True),
        sa.Column("sms_consent", sa.Boolean(), nullable=False),
        sa.Column("email_consent", sa.Boolean(), nullable=False),
        sa.Column("consent_updated_at", sa.DateTime(timezone=True), nullable=True),
        sa.Column("consent_ip_address", sa.String(length=45), nullable=True),
        sa.Column("tags", sa.ARRAY(sa.String(length=50)), nullable=True),
        sa.Column("engagement_score", sa.Integer(), nullable=False),
        sa.Column("total_emails_sent", sa.Integer(), nullable=False),
        sa.Column("total_emails_opened", sa.Integer(), nullable=False),
        sa.Column("total_clicks", sa.Integer(), nullable=False),
        sa.Column("last_email_sent_date", sa.DateTime(timezone=True), nullable=True),
        sa.Column("last_opened_date", sa.DateTime(timezone=True), nullable=True),
        sa.Column(
            "created_at",
            sa.DateTime(timezone=True),
            server_default=sa.text("now()"),
            nullable=False,
        ),
        sa.Column("unsubscribed_at", sa.DateTime(timezone=True), nullable=True),
        sa.CheckConstraint(
            "engagement_score >= 0 AND engagement_score <= 100",
            name=op.f("ck_subscribers_check_engagement_score_range"),
        ),
        sa.ForeignKeyConstraint(
            ["customer_id"],
            ["core.customers.id"],
            name=op.f("fk_subscribers_customer_id_customers"),
            ondelete="SET NULL",
        ),
        sa.PrimaryKeyConstraint("id", name=op.f("pk_subscribers")),
        schema="newsletter",
    )
    op.create_index(
        "ix_newsletter_subscribers_customer",
        "subscribers",
        ["customer_id"],
        unique=False,
        schema="newsletter",
    )
    op.create_index(
        "ix_newsletter_subscribers_engagement",
        "subscribers",
        ["engagement_score"],
        unique=False,
        schema="newsletter",
    )
    op.create_index(
        "ix_newsletter_subscribers_subscribed",
        "subscribers",
        ["subscribed"],
        unique=False,
        schema="newsletter",
    )
    op.create_table(
        "ai_usage",
        sa.Column(
            "id",
            sa.String(length=36),
            nullable=False,
            comment="Unique usage record identifier (UUID)",
        ),
        sa.Column(
            "conversation_id",
            sa.String(length=100),
            nullable=False,
            comment="Parent conversation ID (CASCADE delete)",
        ),
        sa.Column(
            "model_name",
            sa.String(length=50),
            nullable=False,
            comment="\n        AI model used:\n        - gpt-4-turbo-preview\n        - gpt-3.5-turbo\n        - llama-3-8b-instruct\n        - claude-3-sonnet\n        ",
        ),
        sa.Column(
            "input_tokens", sa.Integer(), nullable=False, comment="Input tokens (prompt + context)"
        ),
        sa.Column(
            "output_tokens",
            sa.Integer(),
            nullable=False,
            comment="Output tokens (generated response)",
        ),
        sa.Column(
            "total_tokens", sa.Integer(), nullable=False, comment="Total tokens (input + output)"
        ),
        sa.Column(
            "cost_usd",
            sa.Float(),
            nullable=False,
            comment="\n        Cost in USD (calculated from tokens):\n        GPT-4 Turbo: $0.01/1K input, $0.03/1K output\n        GPT-3.5 Turbo: $0.0005/1K input, $0.0015/1K output\n        Llama-3: Free (local model)\n        ",
        ),
        sa.Column(
            "response_time_ms",
            sa.Integer(),
            nullable=True,
            comment="API response time in milliseconds",
        ),
        sa.Column(
            "created_at", sa.DateTime(), nullable=False, comment="Usage record creation timestamp"
        ),
        sa.ForeignKeyConstraint(
            ["conversation_id"],
            ["ai.conversations.id"],
            name=op.f("fk_ai_usage_conversation_id_conversations"),
            ondelete="CASCADE",
        ),
        sa.PrimaryKeyConstraint("id", name=op.f("pk_ai_usage")),
        schema="ai",
    )
    op.create_index(
        "idx_usage_conversation",
        "ai_usage",
        ["conversation_id", "created_at"],
        unique=False,
        schema="ai",
    )
    op.create_index(
        "idx_usage_cost", "ai_usage", ["cost_usd", "created_at"], unique=False, schema="ai"
    )
    op.create_index(
        "idx_usage_model", "ai_usage", ["model_name", "created_at"], unique=False, schema="ai"
    )
    op.create_index(
        "idx_usage_performance", "ai_usage", ["response_time_ms"], unique=False, schema="ai"
    )
    op.create_table(
        "conversation_analytics",
        sa.Column(
            "id",
            sa.String(length=36),
            nullable=False,
            comment="Unique analytics record identifier (UUID)",
        ),
        sa.Column(
            "conversation_id",
            sa.String(length=100),
            nullable=False,
            comment="Parent conversation ID (CASCADE delete)",
        ),
        sa.Column(
            "total_messages", sa.Integer(), nullable=False, comment="Total messages in conversation"
        ),
        sa.Column(
            "ai_messages",
            sa.Integer(),
            nullable=False,
            comment="AI-generated messages (assistant role)",
        ),
        sa.Column(
            "human_messages",
            sa.Integer(),
            nullable=False,
            comment="Human agent messages (after escalation)",
        ),
        sa.Column(
            "avg_confidence",
            sa.Float(),
            nullable=True,
            comment="Average AI confidence across all messages (0.0-1.0)",
        ),
        sa.Column(
            "resolution_status",
            sa.String(length=20),
            nullable=True,
            comment="Resolution status (resolved/unresolved/escalated/abandoned)",
        ),
        sa.Column(
            "customer_satisfaction",
            sa.Integer(),
            nullable=True,
            comment="\n        Customer satisfaction rating (1-5):\n        5 = Very satisfied\n        4 = Satisfied\n        3 = Neutral\n        2 = Dissatisfied\n        1 = Very dissatisfied\n        NULL = No rating provided\n        ",
        ),
        sa.Column(
            "first_response_time_seconds",
            sa.Integer(),
            nullable=True,
            comment="Time from first user message to first AI response (seconds)",
        ),
        sa.Column(
            "resolution_time_seconds",
            sa.Integer(),
            nullable=True,
            comment="Time from conversation start to resolution/closure (seconds)",
        ),
        sa.Column(
            "total_tokens",
            sa.Integer(),
            nullable=False,
            comment="Total tokens consumed (input + output)",
        ),
        sa.Column(
            "total_cost_usd",
            sa.Float(),
            nullable=False,
            comment="Total cost in USD (calculated from token usage)",
        ),
        sa.Column(
            "created_at",
            sa.DateTime(),
            nullable=False,
            comment="Analytics record creation timestamp",
        ),
        sa.Column(
            "updated_at",
            sa.DateTime(),
            nullable=False,
            comment="Last update timestamp (recalculated metrics)",
        ),
        sa.ForeignKeyConstraint(
            ["conversation_id"],
            ["ai.conversations.id"],
            name=op.f("fk_conversation_analytics_conversation_id_conversations"),
            ondelete="CASCADE",
        ),
        sa.PrimaryKeyConstraint("id", name=op.f("pk_conversation_analytics")),
        sa.UniqueConstraint(
            "conversation_id", name=op.f("uq_conversation_analytics_conversation_id")
        ),
        schema="ai",
    )
    op.create_index(
        "idx_analytics_confidence",
        "conversation_analytics",
        ["avg_confidence"],
        unique=False,
        schema="ai",
    )
    op.create_index(
        "idx_analytics_conversation",
        "conversation_analytics",
        ["conversation_id"],
        unique=False,
        schema="ai",
    )
    op.create_index(
        "idx_analytics_cost",
        "conversation_analytics",
        ["total_cost_usd", "created_at"],
        unique=False,
        schema="ai",
    )
    op.create_index(
        "idx_analytics_resolution",
        "conversation_analytics",
        ["resolution_status", "created_at"],
        unique=False,
        schema="ai",
    )
    op.create_index(
        "idx_analytics_resolution_time",
        "conversation_analytics",
        ["resolution_time_seconds"],
        unique=False,
        schema="ai",
    )
    op.create_index(
        "idx_analytics_response_time",
        "conversation_analytics",
        ["first_response_time_seconds"],
        unique=False,
        schema="ai",
    )
    op.create_index(
        "idx_analytics_satisfaction",
        "conversation_analytics",
        ["customer_satisfaction", "created_at"],
        unique=False,
        schema="ai",
    )
    op.create_table(
        "messages",
        sa.Column(
            "id", sa.String(length=100), nullable=False, comment="Unique message identifier (UUID)"
        ),
        sa.Column(
            "conversation_id",
            sa.String(length=100),
            nullable=False,
            comment="Parent conversation ID (CASCADE delete)",
        ),
        sa.Column(
            "role",
            sa.String(length=20),
            nullable=False,
            comment="Message role (user/assistant/system/human/tool)",
        ),
        sa.Column(
            "content",
            sa.Text(),
            nullable=False,
            comment="Message content (primary field for AI processing)",
        ),
        sa.Column(
            "text",
            sa.Text(),
            nullable=True,
            comment="Display text (may differ from content for tool calls)",
        ),
        sa.Column(
            "channel",
            sa.String(length=20),
            nullable=False,
            comment="Message channel (inherited from conversation)",
        ),
        sa.Column("timestamp", sa.DateTime(), nullable=False, comment="Message creation timestamp"),
        sa.Column(
            "edited_at",
            sa.DateTime(),
            nullable=True,
            comment="Message edit timestamp (if edited by human)",
        ),
        sa.Column(
            "message_metadata",
            postgresql.JSONB(astext_type=sa.Text()),
            nullable=False,
            comment="Message-specific metadata (attachments, formatting, channel-specific data)",
        ),
        sa.Column(
            "emotion_score",
            sa.Float(),
            nullable=True,
            comment="Emotion score for this message (0.0=negative, 1.0=positive)",
        ),
        sa.Column(
            "emotion_label",
            sa.String(length=20),
            nullable=True,
            comment="Simplified emotion label (positive/neutral/negative)",
        ),
        sa.Column(
            "detected_emotions",
            postgresql.JSONB(astext_type=sa.Text()),
            nullable=True,
            comment="Detailed emotion detection (joy, anger, sadness, fear, etc.)",
        ),
        sa.Column(
            "model_used",
            sa.String(length=50),
            nullable=True,
            comment="AI model used (gpt-4-turbo, gpt-3.5-turbo, llama-3-8b, etc.)",
        ),
        sa.Column("confidence", sa.Float(), nullable=True, comment="AI confidence score (0.0-1.0)"),
        sa.Column(
            "input_tokens",
            sa.Integer(),
            nullable=True,
            comment="Input tokens consumed (for cost tracking)",
        ),
        sa.Column(
            "output_tokens",
            sa.Integer(),
            nullable=True,
            comment="Output tokens generated (for cost tracking)",
        ),
        sa.Column(
            "cost_usd",
            sa.Float(),
            nullable=True,
            comment="Message cost in USD (calculated from tokens)",
        ),
        sa.Column(
            "processing_time_ms",
            sa.Integer(),
            nullable=True,
            comment="Processing time in milliseconds (performance monitoring)",
        ),
        sa.Column(
            "intent_classification",
            sa.String(length=50),
            nullable=True,
            comment="Detected intent (booking/menu/pricing/complaint/etc.)",
        ),
        sa.Column(
            "kb_sources_used",
            postgresql.JSONB(astext_type=sa.Text()),
            nullable=True,
            comment="Knowledge base chunk IDs used (for transparency and training)",
        ),
        sa.Column(
            "tool_calls",
            postgresql.JSONB(astext_type=sa.Text()),
            nullable=True,
            comment="Tool/function calls made by AI (structured data)",
        ),
        sa.Column(
            "tool_results",
            postgresql.JSONB(astext_type=sa.Text()),
            nullable=True,
            comment="Tool call results (structured data)",
        ),
        sa.Column(
            "human_feedback",
            sa.String(length=20),
            nullable=True,
            comment="Human feedback (thumbs_up/thumbs_down/neutral)",
        ),
        sa.Column(
            "human_correction",
            sa.Text(),
            nullable=True,
            comment="Human correction of AI response (for training)",
        ),
        sa.Column(
            "is_training_data",
            sa.Boolean(),
            nullable=False,
            comment="Flag for high-quality training data",
        ),
        sa.ForeignKeyConstraint(
            ["conversation_id"],
            ["ai.conversations.id"],
            name=op.f("fk_messages_conversation_id_conversations"),
            ondelete="CASCADE",
        ),
        sa.PrimaryKeyConstraint("id", name=op.f("pk_messages")),
        schema="ai",
    )
    op.create_index("idx_messages_channel", "messages", ["channel"], unique=False, schema="ai")
    op.create_index(
        "idx_messages_conversation_role",
        "messages",
        ["conversation_id", "role"],
        unique=False,
        schema="ai",
    )
    op.create_index(
        "idx_messages_conversation_timestamp",
        "messages",
        ["conversation_id", "timestamp"],
        unique=False,
        schema="ai",
    )
    op.create_index(
        "idx_messages_detected_emotions",
        "messages",
        ["detected_emotions"],
        unique=False,
        schema="ai",
        postgresql_using="gin",
    )
    op.create_index(
        "idx_messages_emotion_history",
        "messages",
        ["conversation_id", "emotion_score", "timestamp"],
        unique=False,
        schema="ai",
    )
    op.create_index(
        "idx_messages_emotion_label", "messages", ["emotion_label"], unique=False, schema="ai"
    )
    op.create_index(
        "idx_messages_human_feedback",
        "messages",
        ["human_feedback", "timestamp"],
        unique=False,
        schema="ai",
    )
    op.create_index(
        "idx_messages_kb_sources",
        "messages",
        ["kb_sources_used"],
        unique=False,
        schema="ai",
        postgresql_using="gin",
    )
    op.create_index(
        "idx_messages_metadata",
        "messages",
        ["message_metadata"],
        unique=False,
        schema="ai",
        postgresql_using="gin",
    )
    op.create_index(
        "idx_messages_model_used",
        "messages",
        ["model_used", "timestamp"],
        unique=False,
        schema="ai",
    )
    op.create_index(
        "idx_messages_role_created", "messages", ["role", "timestamp"], unique=False, schema="ai"
    )
    op.create_index(
        "idx_messages_tool_calls",
        "messages",
        ["tool_calls"],
        unique=False,
        schema="ai",
        postgresql_using="gin",
    )
    op.create_index(
        "idx_messages_training_data",
        "messages",
        ["is_training_data", "timestamp"],
        unique=False,
        schema="ai",
    )
    op.create_index(
        op.f("ix_ai_messages_conversation_id"),
        "messages",
        ["conversation_id"],
        unique=False,
        schema="ai",
    )
    op.create_index(
        op.f("ix_ai_messages_timestamp"), "messages", ["timestamp"], unique=False, schema="ai"
    )
    op.create_table(
        "booking_reminders",
        sa.Column("id", sa.UUID(), nullable=False),
        sa.Column("booking_id", sa.Integer(), nullable=False),
        sa.Column("reminder_type", sa.String(length=50), nullable=False),
        sa.Column("scheduled_for", sa.DateTime(timezone=True), nullable=False),
        sa.Column("sent_at", sa.DateTime(timezone=True), nullable=True),
        sa.Column("status", sa.String(length=50), nullable=False),
        sa.Column("message", sa.Text(), nullable=True),
        sa.Column("error_message", sa.Text(), nullable=True),
        sa.Column("created_at", sa.DateTime(timezone=True), nullable=False),
        sa.Column("updated_at", sa.DateTime(timezone=True), nullable=False),
        sa.ForeignKeyConstraint(
            ["booking_id"],
            ["core.bookings.id"],
            name=op.f("fk_booking_reminders_booking_id_bookings"),
            ondelete="CASCADE",
        ),
        sa.PrimaryKeyConstraint("id", name=op.f("pk_booking_reminders")),
        schema="core",
    )
    op.create_index(
        op.f("ix_core_booking_reminders_booking_id"),
        "booking_reminders",
        ["booking_id"],
        unique=False,
        schema="core",
    )
    op.create_index(
        op.f("ix_core_booking_reminders_scheduled_for"),
        "booking_reminders",
        ["scheduled_for"],
        unique=False,
        schema="core",
    )
    op.create_index(
        op.f("ix_core_booking_reminders_status"),
        "booking_reminders",
        ["status"],
        unique=False,
        schema="core",
    )
    op.create_table(
        "messages",
        sa.Column("id", sa.UUID(), nullable=False),
        sa.Column("thread_id", sa.UUID(), nullable=False),
        sa.Column("sender_type", sa.String(length=50), nullable=False),
        sa.Column("sender_id", sa.String(length=255), nullable=True),
        sa.Column("content", sa.Text(), nullable=False),
        sa.Column("is_read", sa.Boolean(), nullable=False),
        sa.Column("message_metadata", postgresql.JSONB(astext_type=sa.Text()), nullable=False),
        sa.Column(
            "created_at",
            sa.DateTime(timezone=True),
            server_default=sa.text("now()"),
            nullable=False,
        ),
        sa.ForeignKeyConstraint(
            ["thread_id"],
            ["core.message_threads.id"],
            name=op.f("fk_messages_thread_id_message_threads"),
        ),
        sa.PrimaryKeyConstraint("id", name=op.f("pk_messages")),
        schema="core",
    )
    op.create_index(
        "idx_messages_created_at", "messages", ["created_at"], unique=False, schema="core"
    )
    op.create_index(
        "idx_messages_thread_id", "messages", ["thread_id"], unique=False, schema="core"
    )
    op.create_table(
        "payments",
        sa.Column("booking_id", sa.Integer(), nullable=False),
        sa.Column("amount", sa.Numeric(precision=10, scale=2), nullable=False),
        sa.Column("payment_method", sa.String(length=50), nullable=False),
        sa.Column("payment_reference", sa.String(length=255), nullable=True),
        sa.Column(
            "status",
            sa.Enum(
                "PENDING", "COMPLETED", "FAILED", "REFUNDED", "CANCELLED", name="paymentstatus"
            ),
            nullable=False,
        ),
        sa.Column("sender_name", sa.String(length=255), nullable=True),
        sa.Column("sender_phone", sa.String(length=20), nullable=True),
        sa.Column("sender_email", sa.String(length=255), nullable=True),
        sa.Column("received_at", sa.DateTime(), nullable=True),
        sa.Column("notification_email_id", sa.String(length=255), nullable=True),
        sa.Column("processed_by", sa.String(length=100), nullable=True),
        sa.Column("processed_at", sa.DateTime(), nullable=True),
        sa.Column("confirmation_sent_at", sa.DateTime(), nullable=True),
        sa.Column("notes", sa.Text(), nullable=True),
        sa.Column("internal_notes", sa.Text(), nullable=True),
        sa.Column("id", sa.Integer(), nullable=False),
        sa.Column("created_at", sa.DateTime(), nullable=True),
        sa.Column("updated_at", sa.DateTime(), nullable=True),
        sa.Column("is_deleted", sa.Boolean(), nullable=False),
        sa.ForeignKeyConstraint(
            ["booking_id"], ["core.bookings.id"], name=op.f("fk_payments_booking_id_bookings")
        ),
        sa.PrimaryKeyConstraint("id", name=op.f("pk_payments")),
        schema="core",
    )
    op.create_index(
        op.f("ix_core_payments_booking_id"), "payments", ["booking_id"], unique=False, schema="core"
    )
    op.create_index(op.f("ix_core_payments_id"), "payments", ["id"], unique=False, schema="core")
    op.create_index(
        op.f("ix_core_payments_received_at"),
        "payments",
        ["received_at"],
        unique=False,
        schema="core",
    )
    op.create_index(
        op.f("ix_core_payments_status"), "payments", ["status"], unique=False, schema="core"
    )
    op.create_table(
        "customer_reviews",
        sa.Column("id", sa.UUID(), nullable=False),
        sa.Column("booking_id", sa.UUID(), nullable=True),
        sa.Column("customer_id", sa.UUID(), nullable=True),
        sa.Column("rating", sa.Integer(), nullable=False),
        sa.Column("review_text", sa.Text(), nullable=True),
        sa.Column("sentiment_score", sa.Numeric(precision=3, scale=2), nullable=True),
        sa.Column("sentiment_label", sa.String(length=50), nullable=True),
        sa.Column(
            "status",
            sa.Enum(
                "PENDING",
                "APPROVED",
                "REJECTED",
                "FLAGGED",
                name="review_status",
                schema="feedback",
            ),
            server_default="pending",
            nullable=False,
        ),
        sa.Column("moderation_notes", sa.Text(), nullable=True),
        sa.Column("moderated_by_id", sa.UUID(), nullable=True),
        sa.Column("moderated_at", sa.DateTime(timezone=True), nullable=True),
        sa.Column("is_featured", sa.Boolean(), nullable=False),
        sa.Column("display_on_website", sa.Boolean(), nullable=False),
        sa.Column(
            "created_at",
            sa.DateTime(timezone=True),
            server_default=sa.text("now()"),
            nullable=False,
        ),
        sa.Column(
            "updated_at",
            sa.DateTime(timezone=True),
            server_default=sa.text("now()"),
            nullable=False,
        ),
        sa.CheckConstraint(
            "rating >= 1 AND rating <= 5", name=op.f("ck_customer_reviews_check_rating_range")
        ),
        sa.ForeignKeyConstraint(
            ["booking_id"],
            ["core.bookings.id"],
            name=op.f("fk_customer_reviews_booking_id_bookings"),
            ondelete="SET NULL",
        ),
        sa.ForeignKeyConstraint(
            ["customer_id"],
            ["core.customers.id"],
            name=op.f("fk_customer_reviews_customer_id_customers"),
            ondelete="SET NULL",
        ),
        sa.ForeignKeyConstraint(
            ["moderated_by_id"],
            ["identity.users.id"],
            name=op.f("fk_customer_reviews_moderated_by_id_users"),
            ondelete="SET NULL",
        ),
        sa.PrimaryKeyConstraint("id", name=op.f("pk_customer_reviews")),
        schema="feedback",
    )
    op.create_index(
        "idx_customer_reviews_booking_id",
        "customer_reviews",
        ["booking_id"],
        unique=False,
        schema="feedback",
    )
    op.create_index(
        "idx_customer_reviews_created_at",
        "customer_reviews",
        ["created_at"],
        unique=False,
        schema="feedback",
    )
    op.create_index(
        "idx_customer_reviews_customer_id",
        "customer_reviews",
        ["customer_id"],
        unique=False,
        schema="feedback",
    )
    op.create_index(
        "idx_customer_reviews_rating",
        "customer_reviews",
        ["rating"],
        unique=False,
        schema="feedback",
    )
    op.create_index(
        "idx_customer_reviews_status",
        "customer_reviews",
        ["status"],
        unique=False,
        schema="feedback",
    )
    op.create_index(
        op.f("ix_feedback_customer_reviews_booking_id"),
        "customer_reviews",
        ["booking_id"],
        unique=False,
        schema="feedback",
    )
    op.create_index(
        op.f("ix_feedback_customer_reviews_customer_id"),
        "customer_reviews",
        ["customer_id"],
        unique=False,
        schema="feedback",
    )
    op.create_index(
        op.f("ix_feedback_customer_reviews_rating"),
        "customer_reviews",
        ["rating"],
        unique=False,
        schema="feedback",
    )
    op.create_index(
        op.f("ix_feedback_customer_reviews_status"),
        "customer_reviews",
        ["status"],
        unique=False,
        schema="feedback",
    )
    op.create_table(
        "call_sessions",
        sa.Column(
            "id",
            sa.UUID(),
            server_default=sa.text("gen_random_uuid()"),
            nullable=False,
            comment="UUID primary key",
        ),
        sa.Column(
            "booking_id",
            sa.UUID(),
            nullable=True,
            comment="Reference to core.bookings (if call related to a booking)",
        ),
        sa.Column(
            "customer_id",
            sa.UUID(),
            nullable=True,
            comment="Reference to core.customers (if we identified the caller)",
        ),
        sa.Column(
            "direction",
            sa.String(length=10),
            nullable=False,
            comment="Call direction (inbound or outbound)",
        ),
        sa.Column(
            "phone_number",
            sa.String(length=20),
            nullable=False,
            comment="Customer's phone number (E.164 format, e.g., +14155551234)",
        ),
        sa.Column(
            "duration_seconds",
            sa.Integer(),
            nullable=True,
            comment="Call duration in seconds (null if not answered)",
        ),
        sa.Column(
            "transcript",
            sa.Text(),
            nullable=True,
            comment="AI-generated transcript from recording (optional)",
        ),
        sa.Column(
            "outcome",
            sa.String(length=50),
            nullable=True,
            comment="Call outcome (e.g., 'booked', 'rescheduled', 'no_answer', 'voicemail')",
        ),
        sa.Column(
            "recording_url",
            sa.String(length=500),
            nullable=True,
            comment="URL to call recording (S3 or RingCentral)",
        ),
        sa.Column(
            "ringcentral_call_id",
            sa.String(length=255),
            nullable=True,
            comment="RingCentral's unique call ID",
        ),
        sa.Column(
            "created_at",
            sa.TIMESTAMP(timezone=True),
            server_default="NOW()",
            nullable=False,
            comment="When the call started",
        ),
        sa.Column(
            "ended_at", sa.TIMESTAMP(timezone=True), nullable=True, comment="When the call ended"
        ),
        sa.CheckConstraint(
            "direction IN ('inbound', 'outbound')",
            name=op.f("ck_call_sessions_check_call_direction"),
        ),
        sa.ForeignKeyConstraint(
            ["booking_id"],
            ["core.bookings.id"],
            name=op.f("fk_call_sessions_booking_id_bookings"),
            ondelete="SET NULL",
        ),
        sa.ForeignKeyConstraint(
            ["customer_id"],
            ["core.customers.id"],
            name=op.f("fk_call_sessions_customer_id_customers"),
            ondelete="SET NULL",
        ),
        sa.PrimaryKeyConstraint("id", name=op.f("pk_call_sessions")),
        schema="integra",
    )
    op.create_table(
        "payment_matches",
        sa.Column(
            "id",
            sa.UUID(),
            server_default=sa.text("gen_random_uuid()"),
            nullable=False,
            comment="UUID primary key",
        ),
        sa.Column(
            "payment_event_id",
            sa.UUID(),
            nullable=False,
            comment="Reference to payment_events table",
        ),
        sa.Column(
            "booking_id", sa.UUID(), nullable=False, comment="Reference to core.bookings table"
        ),
        sa.Column(
            "confidence",
            sa.Numeric(precision=3, scale=2),
            nullable=False,
            comment="Match confidence (0.00 to 1.00, e.g., 0.95 = 95% confident)",
        ),
        sa.Column(
            "match_method",
            sa.String(length=50),
            nullable=False,
            comment="How the match was found (e.g., 'amount+email', 'amount+phone', 'memo_reference')",
        ),
        sa.Column(
            "status",
            sa.String(length=20),
            nullable=False,
            comment="Match status (auto, manual, ignored)",
        ),
        sa.Column(
            "reviewed_by",
            sa.UUID(),
            nullable=True,
            comment="User ID who reviewed this match (if status=manual)",
        ),
        sa.Column("notes", sa.Text(), nullable=True, comment="Admin notes about this match"),
        sa.Column(
            "created_at",
            sa.TIMESTAMP(timezone=True),
            server_default="NOW()",
            nullable=False,
            comment="When this match was created",
        ),
        sa.CheckConstraint(
            "status IN ('auto', 'manual', 'ignored')",
            name=op.f("ck_payment_matches_check_match_status"),
        ),
        sa.CheckConstraint(
            "confidence >= 0 AND confidence <= 1",
            name=op.f("ck_payment_matches_check_confidence_range"),
        ),
        sa.ForeignKeyConstraint(
            ["booking_id"],
            ["core.bookings.id"],
            name=op.f("fk_payment_matches_booking_id_bookings"),
            ondelete="CASCADE",
        ),
        sa.ForeignKeyConstraint(
            ["payment_event_id"],
            ["integra.payment_events.id"],
            name=op.f("fk_payment_matches_payment_event_id_payment_events"),
            ondelete="CASCADE",
        ),
        sa.PrimaryKeyConstraint("id", name=op.f("pk_payment_matches")),
        schema="integra",
    )
    op.create_table(
        "lead_contacts",
        sa.Column("id", sa.UUID(), server_default=sa.text("gen_random_uuid()"), nullable=False),
        sa.Column("lead_id", sa.UUID(), nullable=False),
        sa.Column(
            "channel",
            sa.Enum(
                "EMAIL",
                "SMS",
                "INSTAGRAM",
                "FACEBOOK",
                "GOOGLE",
                "YELP",
                "WEB",
                name="contact_channel",
                schema="public",
            ),
            nullable=False,
        ),
        sa.Column("handle_or_address", sa.Text(), nullable=False),
        sa.Column("verified", sa.Boolean(), nullable=False),
        sa.Column(
            "created_at",
            sa.DateTime(timezone=True),
            server_default=sa.text("now()"),
            nullable=False,
        ),
        sa.ForeignKeyConstraint(
            ["lead_id"],
            ["lead.leads.id"],
            name=op.f("fk_lead_contacts_lead_id_leads"),
            ondelete="CASCADE",
        ),
        sa.PrimaryKeyConstraint("id", name=op.f("pk_lead_contacts")),
        schema="lead",
    )
    op.create_index(
        "ix_lead_contacts_channel",
        "lead_contacts",
        ["channel", "handle_or_address"],
        unique=False,
        schema="lead",
    )
    op.create_index(
        "ix_lead_contacts_lead", "lead_contacts", ["lead_id"], unique=False, schema="lead"
    )
    op.create_table(
        "lead_context",
        sa.Column("lead_id", sa.UUID(), nullable=False),
        sa.Column("party_size_adults", sa.Integer(), nullable=True),
        sa.Column("party_size_kids", sa.Integer(), nullable=True),
        sa.Column("estimated_budget_cents", sa.Integer(), nullable=True),
        sa.Column("event_date_pref", sa.Date(), nullable=True),
        sa.Column("event_date_range_start", sa.Date(), nullable=True),
        sa.Column("event_date_range_end", sa.Date(), nullable=True),
        sa.Column("zip_code", sa.String(length=10), nullable=True),
        sa.Column("service_type", sa.String(length=50), nullable=True),
        sa.Column("notes", sa.Text(), nullable=True),
        sa.Column(
            "updated_at",
            sa.DateTime(timezone=True),
            server_default=sa.text("now()"),
            nullable=False,
        ),
        sa.ForeignKeyConstraint(
            ["lead_id"],
            ["lead.leads.id"],
            name=op.f("fk_lead_context_lead_id_leads"),
            ondelete="CASCADE",
        ),
        sa.PrimaryKeyConstraint("lead_id", name=op.f("pk_lead_context")),
        schema="lead",
    )
    op.create_table(
        "lead_events",
        sa.Column("id", sa.UUID(), server_default=sa.text("gen_random_uuid()"), nullable=False),
        sa.Column("lead_id", sa.UUID(), nullable=False),
        sa.Column("type", sa.String(length=50), nullable=False),
        sa.Column("payload", postgresql.JSONB(astext_type=sa.Text()), nullable=True),
        sa.Column(
            "occurred_at",
            sa.DateTime(timezone=True),
            server_default=sa.text("now()"),
            nullable=False,
        ),
        sa.ForeignKeyConstraint(
            ["lead_id"],
            ["lead.leads.id"],
            name=op.f("fk_lead_events_lead_id_leads"),
            ondelete="CASCADE",
        ),
        sa.PrimaryKeyConstraint("id", name=op.f("pk_lead_events")),
        schema="lead",
    )
    op.create_index(
        "ix_lead_events_lead",
        "lead_events",
        ["lead_id", "occurred_at"],
        unique=False,
        schema="lead",
    )
    op.create_table(
        "campaign_events",
        sa.Column("id", sa.UUID(), server_default=sa.text("gen_random_uuid()"), nullable=False),
        sa.Column("campaign_id", sa.UUID(), nullable=False),
        sa.Column("subscriber_id", sa.UUID(), nullable=False),
        sa.Column(
            "type",
            sa.Enum(
                "SENT",
                "DELIVERED",
                "OPENED",
                "CLICKED",
                "REPLIED",
                "BOUNCED",
                "UNSUBSCRIBED",
                "COMPLAINED",
                name="campaign_event_type",
                schema="public",
            ),
            nullable=False,
        ),
        sa.Column("payload", postgresql.JSONB(astext_type=sa.Text()), nullable=True),
        sa.Column(
            "occurred_at",
            sa.DateTime(timezone=True),
            server_default=sa.text("now()"),
            nullable=False,
        ),
        sa.ForeignKeyConstraint(
            ["campaign_id"],
            ["newsletter.campaigns.id"],
            name=op.f("fk_campaign_events_campaign_id_campaigns"),
            ondelete="CASCADE",
        ),
        sa.ForeignKeyConstraint(
            ["subscriber_id"],
            ["newsletter.subscribers.id"],
            name=op.f("fk_campaign_events_subscriber_id_subscribers"),
            ondelete="CASCADE",
        ),
        sa.PrimaryKeyConstraint("id", name=op.f("pk_campaign_events")),
        schema="newsletter",
    )
    op.create_index(
        "ix_newsletter_events_campaign",
        "campaign_events",
        ["campaign_id", "type"],
        unique=False,
        schema="newsletter",
    )
    op.create_index(
        "ix_newsletter_events_subscriber",
        "campaign_events",
        ["subscriber_id", "occurred_at"],
        unique=False,
        schema="newsletter",
    )
    op.create_table(
        "sms_send_queue",
        sa.Column("id", sa.UUID(), server_default=sa.text("gen_random_uuid()"), nullable=False),
        sa.Column("campaign_id", sa.UUID(), nullable=False),
        sa.Column("subscriber_id", sa.UUID(), nullable=False),
        sa.Column("template_id", sa.UUID(), nullable=True),
        sa.Column("phone_number", sa.String(length=20), nullable=False),
        sa.Column("message_content", sa.Text(), nullable=False),
        sa.Column(
            "personalized_variables",
            postgresql.JSONB(astext_type=sa.Text()),
            server_default="{}",
            nullable=False,
            comment="Rendered template variables",
        ),
        sa.Column(
            "status",
            sa.Enum(
                "PENDING",
                "SENDING",
                "SENT",
                "FAILED",
                "CANCELLED",
                name="sms_queue_status",
                schema="newsletter",
            ),
            server_default="pending",
            nullable=False,
        ),
        sa.Column(
            "priority",
            sa.Integer(),
            server_default="0",
            nullable=False,
            comment="Higher = sent first",
        ),
        sa.Column(
            "scheduled_at",
            sa.DateTime(timezone=True),
            server_default=sa.text("now()"),
            nullable=False,
        ),
        sa.Column("sent_at", sa.DateTime(timezone=True), nullable=True),
        sa.Column("failed_at", sa.DateTime(timezone=True), nullable=True),
        sa.Column("attempts", sa.Integer(), server_default="0", nullable=False),
        sa.Column("max_attempts", sa.Integer(), server_default="3", nullable=False),
        sa.Column("next_retry_at", sa.DateTime(timezone=True), nullable=True),
        sa.Column("last_error", sa.Text(), nullable=True),
        sa.Column("error_code", sa.String(length=50), nullable=True),
        sa.Column(
            "message_sid", sa.String(length=100), nullable=True, comment="RingCentral message ID"
        ),
        sa.Column("ringcentral_status", sa.String(length=50), nullable=True),
        sa.Column(
            "created_at",
            sa.DateTime(timezone=True),
            server_default=sa.text("now()"),
            nullable=False,
        ),
        sa.Column(
            "updated_at",
            sa.DateTime(timezone=True),
            server_default=sa.text("now()"),
            nullable=False,
        ),
        sa.ForeignKeyConstraint(
            ["campaign_id"],
            ["newsletter.campaigns.id"],
            name=op.f("fk_sms_send_queue_campaign_id_campaigns"),
            ondelete="CASCADE",
        ),
        sa.ForeignKeyConstraint(
            ["subscriber_id"],
            ["newsletter.subscribers.id"],
            name=op.f("fk_sms_send_queue_subscriber_id_subscribers"),
            ondelete="CASCADE",
        ),
        sa.ForeignKeyConstraint(
            ["template_id"],
            ["newsletter.sms_templates.id"],
            name=op.f("fk_sms_send_queue_template_id_sms_templates"),
            ondelete="SET NULL",
        ),
        sa.PrimaryKeyConstraint("id", name=op.f("pk_sms_send_queue")),
        sa.UniqueConstraint("message_sid", name=op.f("uq_sms_send_queue_message_sid")),
        schema="newsletter",
    )
    op.create_index(
        "idx_sms_queue_pending",
        "sms_send_queue",
        ["status", "scheduled_at"],
        unique=False,
        schema="newsletter",
    )
    op.create_index(
        "idx_sms_queue_priority",
        "sms_send_queue",
        ["priority", "scheduled_at"],
        unique=False,
        schema="newsletter",
    )
    op.create_index(
        "idx_sms_queue_retry",
        "sms_send_queue",
        ["status", "next_retry_at"],
        unique=False,
        schema="newsletter",
    )
    op.create_index(
        op.f("ix_newsletter_sms_send_queue_campaign_id"),
        "sms_send_queue",
        ["campaign_id"],
        unique=False,
        schema="newsletter",
    )
    op.create_index(
        op.f("ix_newsletter_sms_send_queue_phone_number"),
        "sms_send_queue",
        ["phone_number"],
        unique=False,
        schema="newsletter",
    )
    op.create_index(
        op.f("ix_newsletter_sms_send_queue_scheduled_at"),
        "sms_send_queue",
        ["scheduled_at"],
        unique=False,
        schema="newsletter",
    )
    op.create_index(
        op.f("ix_newsletter_sms_send_queue_status"),
        "sms_send_queue",
        ["status"],
        unique=False,
        schema="newsletter",
    )
    op.create_index(
        op.f("ix_newsletter_sms_send_queue_subscriber_id"),
        "sms_send_queue",
        ["subscriber_id"],
        unique=False,
        schema="newsletter",
    )
    op.create_table(
        "training_data",
        sa.Column(
            "id",
            sa.String(length=36),
            nullable=False,
            comment="Unique training data identifier (UUID)",
        ),
        sa.Column(
            "conversation_id",
            sa.String(length=100),
            nullable=True,
            comment="Source conversation ID (SET NULL on delete)",
        ),
        sa.Column(
            "message_id",
            sa.String(length=100),
            nullable=True,
            comment="Source message ID (SET NULL on delete)",
        ),
        sa.Column(
            "prompt", sa.Text(), nullable=False, comment="User prompt/question (training input)"
        ),
        sa.Column(
            "response",
            sa.Text(),
            nullable=False,
            comment="AI response (training output - original or corrected)",
        ),
        sa.Column(
            "human_correction",
            sa.Text(),
            nullable=True,
            comment="\n        Human-corrected response (if original was wrong).\n        NULL = original response was good\n        Non-NULL = use this instead of 'response' field\n        ",
        ),
        sa.Column(
            "quality_score",
            sa.Float(),
            nullable=False,
            comment="\n        Overall quality score (0.0-1.0):\n        Calculated from:\n        - AI confidence\n        - Customer satisfaction\n        - Human feedback\n        - Resolution status\n        ",
        ),
        sa.Column(
            "category",
            sa.String(length=100),
            nullable=True,
            comment="\n        Training data category:\n        - booking (booking flow, availability)\n        - menu (dishes, pricing)\n        - support (general questions)\n        - policy (refunds, cancellations)\n        ",
        ),
        sa.Column(
            "is_approved",
            sa.Boolean(),
            nullable=False,
            comment="\n        Human approval flag:\n        True = Ready for training/export\n        False = Needs review\n        ",
        ),
        sa.Column(
            "training_metadata",
            postgresql.JSONB(astext_type=sa.Text()),
            nullable=False,
            comment='\n        Additional metadata (JSONB):\n        {\n            "customer_satisfaction": 5,\n            "ai_confidence": 0.92,\n            "human_feedback": "thumbs_up",\n            "model_used": "gpt-4-turbo",\n            "tokens": 150\n        }\n        ',
        ),
        sa.Column(
            "created_at",
            sa.DateTime(),
            nullable=False,
            comment="Training data collection timestamp",
        ),
        sa.Column("approved_at", sa.DateTime(), nullable=True, comment="Human approval timestamp"),
        sa.Column(
            "approved_by",
            sa.String(length=255),
            nullable=True,
            comment="Admin ID who approved this training data",
        ),
        sa.ForeignKeyConstraint(
            ["conversation_id"],
            ["ai.conversations.id"],
            name=op.f("fk_training_data_conversation_id_conversations"),
            ondelete="SET NULL",
        ),
        sa.ForeignKeyConstraint(
            ["message_id"],
            ["ai.messages.id"],
            name=op.f("fk_training_data_message_id_messages"),
            ondelete="SET NULL",
        ),
        sa.PrimaryKeyConstraint("id", name=op.f("pk_training_data")),
        schema="ai",
    )
    op.create_index(
        "idx_training_approved",
        "training_data",
        ["is_approved", "created_at"],
        unique=False,
        schema="ai",
    )
    op.create_index(
        "idx_training_category",
        "training_data",
        ["category", "is_approved"],
        unique=False,
        schema="ai",
    )
    op.create_index(
        "idx_training_conversation", "training_data", ["conversation_id"], unique=False, schema="ai"
    )
    op.create_index(
        "idx_training_message", "training_data", ["message_id"], unique=False, schema="ai"
    )
    op.create_index(
        "idx_training_quality",
        "training_data",
        ["quality_score", "is_approved"],
        unique=False,
        schema="ai",
    )
    op.create_table(
        "review_escalations",
        sa.Column("id", sa.UUID(), nullable=False),
        sa.Column("review_id", sa.UUID(), nullable=False),
        sa.Column("assigned_to_id", sa.UUID(), nullable=True),
        sa.Column("reason", sa.Text(), nullable=False),
        sa.Column("priority", sa.String(length=50), nullable=False),
        sa.Column("is_resolved", sa.Boolean(), nullable=False),
        sa.Column("resolution_notes", sa.Text(), nullable=True),
        sa.Column("resolved_at", sa.DateTime(timezone=True), nullable=True),
        sa.Column(
            "created_at",
            sa.DateTime(timezone=True),
            server_default=sa.text("now()"),
            nullable=False,
        ),
        sa.Column(
            "updated_at",
            sa.DateTime(timezone=True),
            server_default=sa.text("now()"),
            nullable=False,
        ),
        sa.ForeignKeyConstraint(
            ["assigned_to_id"],
            ["identity.users.id"],
            name=op.f("fk_review_escalations_assigned_to_id_users"),
            ondelete="SET NULL",
        ),
        sa.ForeignKeyConstraint(
            ["review_id"],
            ["feedback.customer_reviews.id"],
            name=op.f("fk_review_escalations_review_id_customer_reviews"),
            ondelete="CASCADE",
        ),
        sa.PrimaryKeyConstraint("id", name=op.f("pk_review_escalations")),
        schema="feedback",
    )
    op.create_index(
        "idx_review_escalations_assigned_to_id",
        "review_escalations",
        ["assigned_to_id"],
        unique=False,
        schema="feedback",
    )
    op.create_index(
        "idx_review_escalations_is_resolved",
        "review_escalations",
        ["is_resolved"],
        unique=False,
        schema="feedback",
    )
    op.create_index(
        "idx_review_escalations_review_id",
        "review_escalations",
        ["review_id"],
        unique=False,
        schema="feedback",
    )
    op.create_index(
        op.f("ix_feedback_review_escalations_assigned_to_id"),
        "review_escalations",
        ["assigned_to_id"],
        unique=False,
        schema="feedback",
    )
    op.create_index(
        op.f("ix_feedback_review_escalations_is_resolved"),
        "review_escalations",
        ["is_resolved"],
        unique=False,
        schema="feedback",
    )
    op.create_index(
        op.f("ix_feedback_review_escalations_review_id"),
        "review_escalations",
        ["review_id"],
        unique=False,
        schema="feedback",
    )
    op.create_table(
        "sms_delivery_events",
        sa.Column("id", sa.UUID(), nullable=False),
        sa.Column("campaign_event_id", sa.UUID(), nullable=False),
        sa.Column("ringcentral_message_id", sa.String(length=255), nullable=False),
        sa.Column(
            "status",
            sa.Enum(
                "QUEUED",
                "SENDING",
                "SENT",
                "DELIVERED",
                "FAILED",
                "UNDELIVERED",
                name="sms_delivery_status",
                schema="newsletter",
            ),
            server_default="queued",
            nullable=False,
        ),
        sa.Column("delivery_timestamp", sa.DateTime(timezone=True), nullable=True),
        sa.Column("failure_reason", sa.Text(), nullable=True),
        sa.Column("carrier_error_code", sa.String(length=50), nullable=True),
        sa.Column("segments_used", sa.Integer(), server_default="1", nullable=False),
        sa.Column("cost_cents", sa.Integer(), nullable=True),
        sa.Column("ringcentral_metadata", postgresql.JSONB(astext_type=sa.Text()), nullable=True),
        sa.Column(
            "created_at",
            sa.DateTime(timezone=True),
            server_default=sa.text("now()"),
            nullable=False,
        ),
        sa.Column(
            "updated_at",
            sa.DateTime(timezone=True),
            server_default=sa.text("now()"),
            nullable=False,
        ),
        sa.ForeignKeyConstraint(
            ["campaign_event_id"],
            ["newsletter.campaign_events.id"],
            name=op.f("fk_sms_delivery_events_campaign_event_id_campaign_events"),
            ondelete="CASCADE",
        ),
        sa.PrimaryKeyConstraint("id", name=op.f("pk_sms_delivery_events")),
        schema="newsletter",
    )
    op.create_index(
        "ix_sms_delivery_campaign_event",
        "sms_delivery_events",
        ["campaign_event_id"],
        unique=False,
        schema="newsletter",
    )
    op.create_index(
        "ix_sms_delivery_ringcentral_msg_id",
        "sms_delivery_events",
        ["ringcentral_message_id"],
        unique=True,
        schema="newsletter",
    )
    op.create_index(
        "ix_sms_delivery_status",
        "sms_delivery_events",
        ["status"],
        unique=False,
        schema="newsletter",
    )
    op.create_index(
        "ix_sms_delivery_timestamp",
        "sms_delivery_events",
        ["delivery_timestamp"],
        unique=False,
        schema="newsletter",
    )
    op.drop_index(op.f("idx_webhook_events_type_processed"), table_name="webhook_events")
    op.drop_index(op.f("ix_webhook_events_stripe_event_id"), table_name="webhook_events")
    op.drop_index(op.f("ix_webhook_events_type"), table_name="webhook_events")
    op.drop_table("webhook_events")
    op.drop_index(op.f("idx_alert_rules_enabled"), table_name="monitoring_alert_rules")
    op.drop_index(op.f("idx_alert_rules_metric"), table_name="monitoring_alert_rules")
    op.drop_index(op.f("idx_alert_rules_type"), table_name="monitoring_alert_rules")
    op.drop_table("monitoring_alert_rules")
    op.drop_index(op.f("ix_consent_records_consent_source"), table_name="consent_records")
    op.drop_index(op.f("ix_consent_records_consent_timestamp"), table_name="consent_records")
    op.drop_index(op.f("ix_consent_records_customer_id"), table_name="consent_records")
    op.drop_index(op.f("ix_consent_records_email_consent"), table_name="consent_records")
    op.drop_index(op.f("ix_consent_records_lead_id"), table_name="consent_records")
    op.drop_index(op.f("ix_consent_records_sms_consent"), table_name="consent_records")
    op.drop_table("consent_records")
    op.drop_index(op.f("idx_reminders_booking"), table_name="booking_reminders")
    op.drop_index(
        op.f("idx_reminders_scheduled"),
        table_name="booking_reminders",
        postgresql_where="((status)::text = 'pending'::text)",
    )
    op.drop_index(op.f("idx_reminders_status"), table_name="booking_reminders")
    op.drop_table("booking_reminders")
    op.drop_index(op.f("idx_alerts_active_priority"), table_name="monitoring_alerts")
    op.drop_index(op.f("idx_alerts_category"), table_name="monitoring_alerts")
    op.drop_index(op.f("idx_alerts_priority"), table_name="monitoring_alerts")
    op.drop_index(op.f("idx_alerts_resource"), table_name="monitoring_alerts")
    op.drop_index(op.f("idx_alerts_status"), table_name="monitoring_alerts")
    op.drop_index(op.f("idx_alerts_triggered_at"), table_name="monitoring_alerts")
    op.drop_index(op.f("idx_alerts_type"), table_name="monitoring_alerts")
    op.drop_table("monitoring_alerts")
    op.drop_index(op.f("ix_disputes_stripe_dispute_id"), table_name="disputes")
    op.drop_table("disputes")
    op.drop_index(op.f("ix_customers_email"), table_name="customers")
    op.drop_index(op.f("ix_customers_stripe_customer_id"), table_name="customers")
    op.drop_index(op.f("ix_customers_user_id"), table_name="customers")
    op.drop_table("customers")
    op.drop_index(op.f("idx_feedback_rating"), table_name="feedback")
    op.drop_index(op.f("ix_feedback_booking_id"), table_name="feedback")
    op.drop_table("feedback")
    op.drop_index(op.f("ix_customer_sentiment_customer_id"), table_name="customer_sentiment")
    op.drop_table("customer_sentiment")
    op.drop_index(op.f("ix_products_stripe_product_id"), table_name="products")
    op.drop_table("products")
    op.drop_index(op.f("ix_referral_rewards_redeemed"), table_name="referral_rewards")
    op.drop_index(op.f("ix_referral_rewards_referral_id"), table_name="referral_rewards")
    op.drop_table("referral_rewards")
    op.drop_index(op.f("idx_ai_conversations_channel"), table_name="ai_conversations_legacy")
    op.drop_index(
        op.f("idx_ai_conversations_context"),
        table_name="ai_conversations_legacy",
        postgresql_using="gin",
    )
    op.drop_index(op.f("idx_ai_conversations_escalated"), table_name="ai_conversations_legacy")
    op.drop_index(op.f("idx_ai_conversations_last_message"), table_name="ai_conversations_legacy")
    op.drop_index(op.f("idx_ai_conversations_user_active"), table_name="ai_conversations_legacy")
    op.drop_index(op.f("ix_ai_conversations_is_active"), table_name="ai_conversations_legacy")
    op.drop_index(op.f("ix_ai_conversations_user_id"), table_name="ai_conversations_legacy")
    op.drop_table("ai_conversations_legacy")
    op.drop_index(op.f("ix_ai_messages_conversation_id"), table_name="ai_messages_legacy")
    op.drop_index(op.f("ix_ai_messages_timestamp"), table_name="ai_messages_legacy")
    op.drop_table("ai_messages_legacy")
    op.drop_index(op.f("ix_referrals_customer_id"), table_name="referrals")
    op.drop_index(op.f("ix_referrals_referral_code"), table_name="referrals")
    op.drop_table("referrals")
    op.drop_index(op.f("ix_error_logs_correlation_id"), table_name="error_logs")
    op.drop_index(op.f("ix_error_logs_level"), table_name="error_logs")
    op.drop_index(op.f("ix_error_logs_timestamp"), table_name="error_logs")
    op.drop_index(op.f("ix_error_logs_user_id"), table_name="error_logs")
    op.drop_table("error_logs")
    op.drop_index(op.f("ix_message_log_campaign_id"), table_name="message_log")
    op.drop_index(op.f("ix_message_log_channel"), table_name="message_log")
    op.drop_index(op.f("ix_message_log_contact"), table_name="message_log")
    op.drop_index(op.f("ix_message_log_customer_id"), table_name="message_log")
    op.drop_index(op.f("ix_message_log_frequency_check"), table_name="message_log")
    op.drop_index(op.f("ix_message_log_lead_id"), table_name="message_log")
    op.drop_index(op.f("ix_message_log_sent_at"), table_name="message_log")
    op.drop_table("message_log")
    op.drop_index(op.f("idx_users_active"), table_name="users")
    op.drop_index(op.f("idx_users_email"), table_name="users")
    op.drop_index(op.f("idx_users_role"), table_name="users")
    op.drop_table("users")
    op.drop_index(op.f("idx_payments_status_method"), table_name="payments")
    op.drop_index(op.f("idx_payments_user_booking"), table_name="payments")
    op.drop_index(op.f("ix_payments_booking_id"), table_name="payments")
    op.drop_index(op.f("ix_payments_status"), table_name="payments")
    op.drop_index(op.f("ix_payments_stripe_payment_intent_id"), table_name="payments")
    op.drop_index(op.f("ix_payments_user_id"), table_name="payments")
    op.drop_table("payments")
    op.drop_index(op.f("idx_automated_reminders_pending"), table_name="automated_reminders")
    op.drop_index(op.f("ix_automated_reminders_booking_id"), table_name="automated_reminders")
    op.drop_index(op.f("ix_automated_reminders_reminder_type"), table_name="automated_reminders")
    op.drop_index(op.f("ix_automated_reminders_scheduled_at"), table_name="automated_reminders")
    op.drop_index(op.f("ix_automated_reminders_status"), table_name="automated_reminders")
    op.drop_table("automated_reminders")
    op.drop_index(op.f("idx_invoices_user_booking"), table_name="invoices")
    op.drop_index(op.f("ix_invoices_booking_id"), table_name="invoices")
    op.drop_index(op.f("ix_invoices_status"), table_name="invoices")
    op.drop_index(op.f("ix_invoices_stripe_invoice_id"), table_name="invoices")
    op.drop_index(op.f("ix_invoices_user_id"), table_name="invoices")
    op.drop_table("invoices")
    op.drop_index(op.f("ix_alert_rules_enabled"), table_name="alert_rules")
    op.drop_index(op.f("ix_alert_rules_id"), table_name="alert_rules")
    op.drop_index(op.f("ix_alert_rules_metric_name"), table_name="alert_rules")
    op.drop_index(op.f("ix_alert_rules_name"), table_name="alert_rules")
    op.drop_table("alert_rules")
    op.drop_index(op.f("idx_audit_logs_action"), table_name="audit_logs")
    op.drop_index(op.f("idx_audit_logs_created_at"), table_name="audit_logs")
    op.drop_index(op.f("idx_audit_logs_resource"), table_name="audit_logs")
    op.drop_index(op.f("idx_audit_logs_resource_action"), table_name="audit_logs")
    op.drop_index(
        op.f("idx_audit_logs_station_id"),
        table_name="audit_logs",
        postgresql_where="(station_id IS NOT NULL)",
    )
    op.drop_index(op.f("idx_audit_logs_user_created"), table_name="audit_logs")
    op.drop_index(op.f("idx_audit_logs_user_id"), table_name="audit_logs")
    op.drop_index(op.f("idx_audit_logs_user_role"), table_name="audit_logs")
    op.drop_table("audit_logs")
    op.drop_index(op.f("ix_prices_stripe_price_id"), table_name="prices")
    op.drop_table("prices")
    op.drop_index(op.f("ix_refunds_stripe_refund_id"), table_name="refunds")
    op.drop_table("refunds")
    op.drop_index(op.f("ix_bookings_booking_datetime"), table_name="bookings")
    op.drop_index(op.f("ix_bookings_customer_deposit_deadline"), table_name="bookings")
    op.drop_index(op.f("ix_bookings_customer_id"), table_name="bookings")
    op.drop_index(op.f("ix_bookings_internal_deadline"), table_name="bookings")
    op.drop_index(op.f("ix_bookings_status"), table_name="bookings")
    op.drop_table("bookings")
    op.add_column("availability_calendar", sa.Column("max_capacity", sa.Integer(), nullable=False))
    op.add_column(
        "availability_calendar", sa.Column("booked_capacity", sa.Integer(), nullable=False)
    )
    op.add_column(
        "availability_calendar", sa.Column("blackout_reason", sa.String(length=500), nullable=True)
    )
    op.add_column(
        "availability_calendar", sa.Column("station_id", sa.String(length=36), nullable=True)
    )
    op.add_column(
        "availability_calendar", sa.Column("updated_at", sa.DateTime(timezone=True), nullable=False)
    )
    op.alter_column(
        "availability_calendar",
        "id",
        existing_type=sa.INTEGER(),
        type_=sa.String(length=36),
        existing_nullable=False,
    )
    op.alter_column(
        "availability_calendar",
        "time_slot",
        existing_type=sa.VARCHAR(length=20),
        type_=sa.Time(),
        existing_nullable=False,
    )
    op.alter_column(
        "availability_calendar", "is_available", existing_type=sa.BOOLEAN(), nullable=True
    )
    op.alter_column(
        "availability_calendar",
        "created_at",
        existing_type=postgresql.TIMESTAMP(),
        type_=sa.DateTime(timezone=True),
        existing_nullable=False,
        existing_server_default=sa.text("now()"),
    )
    op.drop_index(op.f("idx_availability_date_time"), table_name="availability_calendar")
    op.drop_index(op.f("ix_availability_calendar_date"), table_name="availability_calendar")
    op.drop_index(op.f("ix_availability_calendar_time_slot"), table_name="availability_calendar")
    op.create_index(
        "idx_calendar_available",
        "availability_calendar",
        ["is_available"],
        unique=False,
        schema="public",
    )
    op.create_index(
        "idx_calendar_date", "availability_calendar", ["date"], unique=False, schema="public"
    )
    op.create_index(
        "idx_calendar_datetime",
        "availability_calendar",
        ["date", "time_slot"],
        unique=False,
        schema="public",
    )
    op.create_index(
        "idx_calendar_station",
        "availability_calendar",
        ["station_id"],
        unique=False,
        schema="public",
    )
    op.drop_table_comment(
        "availability_calendar",
        existing_comment="Chef availability tracking for AI booking suggestions",
        schema=None,
    )
    op.drop_column("availability_calendar", "last_updated")
    op.drop_column("availability_calendar", "booking_id")
    op.drop_column("availability_calendar", "reason")
    op.add_column(
        "business_rules",
        sa.Column(
            "category",
            postgresql.ENUM(
                "POLICY",
                "PRICING",
                "MENU",
                "TRAVEL",
                "PAYMENT",
                "CANCELLATION",
                "TERMS",
                "GUIDELINES",
                name="rule_category",
            ),
            nullable=False,
        ),
    )
    op.add_column("business_rules", sa.Column("rule_name", sa.String(length=200), nullable=False))
    op.add_column("business_rules", sa.Column("rule_content", sa.Text(), nullable=False))
    op.add_column("business_rules", sa.Column("rule_summary", sa.String(length=500), nullable=True))
    op.add_column(
        "business_rules", sa.Column("keywords", postgresql.ARRAY(sa.String()), nullable=True)
    )
    op.add_column("business_rules", sa.Column("priority", sa.Integer(), nullable=True))
    op.add_column("business_rules", sa.Column("station_id", sa.String(length=36), nullable=True))
    op.add_column(
        "business_rules", sa.Column("effective_from", sa.DateTime(timezone=True), nullable=True)
    )
    op.add_column(
        "business_rules", sa.Column("effective_until", sa.DateTime(timezone=True), nullable=True)
    )
    op.add_column(
        "business_rules", sa.Column("updated_at", sa.DateTime(timezone=True), nullable=False)
    )
    op.alter_column(
        "business_rules",
        "id",
        existing_type=sa.INTEGER(),
        type_=sa.String(length=36),
        existing_nullable=False,
    )
    op.alter_column("business_rules", "is_active", existing_type=sa.BOOLEAN(), nullable=True)
    op.alter_column(
        "business_rules",
        "created_at",
        existing_type=postgresql.TIMESTAMP(),
        type_=sa.DateTime(timezone=True),
        existing_nullable=False,
        existing_server_default=sa.text("now()"),
    )
    op.alter_column("business_rules", "version", existing_type=sa.INTEGER(), nullable=True)
    op.drop_index(op.f("ix_business_rules_is_active"), table_name="business_rules")
    op.drop_index(op.f("ix_business_rules_rule_type"), table_name="business_rules")
    op.drop_index(op.f("idx_business_rules_active"), table_name="business_rules")
    op.create_index(
        "idx_business_rules_active", "business_rules", ["is_active"], unique=False, schema="public"
    )
    op.create_index(
        "idx_business_rules_category", "business_rules", ["category"], unique=False, schema="public"
    )
    op.create_index(
        "idx_business_rules_effective",
        "business_rules",
        ["effective_from", "effective_until"],
        unique=False,
        schema="public",
    )
    op.create_index(
        "idx_business_rules_keywords",
        "business_rules",
        ["keywords"],
        unique=False,
        schema="public",
        postgresql_using="gin",
    )
    op.create_index(
        "idx_business_rules_lookup",
        "business_rules",
        ["category", "is_active", "station_id"],
        unique=False,
        schema="public",
    )
    op.create_index(
        "idx_business_rules_station",
        "business_rules",
        ["station_id"],
        unique=False,
        schema="public",
    )
    op.drop_table_comment(
        "business_rules",
        existing_comment="Dynamic business policies for AI (cancellation, deposit, refund, etc.)",
        schema=None,
    )
    op.drop_column("business_rules", "title")
    op.drop_column("business_rules", "last_updated")
    op.drop_column("business_rules", "updated_by")
    op.drop_column("business_rules", "content")
    op.drop_column("business_rules", "rule_type")
    op.drop_column("business_rules", "value")
    op.drop_constraint(op.f("businesses_domain_key"), "businesses", type_="unique")
    op.drop_constraint(op.f("businesses_slug_key"), "businesses", type_="unique")
    op.create_index(op.f("ix_businesses_slug"), "businesses", ["slug"], unique=True)
    op.create_unique_constraint(op.f("uq_businesses_domain"), "businesses", ["domain"])
    op.add_column("catering_payments", sa.Column("is_deleted", sa.Boolean(), nullable=False))
    op.alter_column(
        "catering_payments",
        "booking_id",
        existing_type=sa.UUID(),
        type_=sa.Integer(),
        existing_nullable=False,
    )
    op.alter_column(
        "catering_payments",
        "created_at",
        existing_type=postgresql.TIMESTAMP(),
        nullable=True,
        existing_server_default=sa.text("CURRENT_TIMESTAMP"),
    )
    op.alter_column(
        "catering_payments",
        "updated_at",
        existing_type=postgresql.TIMESTAMP(),
        nullable=True,
        existing_server_default=sa.text("CURRENT_TIMESTAMP"),
    )
    op.drop_index(op.f("idx_payment_booking_id"), table_name="catering_payments")
    op.drop_index(op.f("idx_payment_method"), table_name="catering_payments")
    op.drop_index(op.f("idx_payment_notification_id"), table_name="catering_payments")
    op.drop_index(op.f("idx_payment_status"), table_name="catering_payments")
    op.drop_index(op.f("idx_payment_transaction_id"), table_name="catering_payments")
    op.create_index(
        op.f("ix_catering_payments_booking_id"), "catering_payments", ["booking_id"], unique=False
    )
    op.create_index(op.f("ix_catering_payments_id"), "catering_payments", ["id"], unique=False)
    op.create_index(
        op.f("ix_catering_payments_payment_method"),
        "catering_payments",
        ["payment_method"],
        unique=False,
    )
    op.create_index(
        op.f("ix_catering_payments_status"), "catering_payments", ["status"], unique=False
    )
    op.create_index(
        op.f("ix_catering_payments_transaction_id"),
        "catering_payments",
        ["transaction_id"],
        unique=True,
    )
    op.drop_constraint(
        op.f("fk_catering_payments_notification_id"), "catering_payments", type_="foreignkey"
    )
    op.drop_constraint(
        op.f("fk_catering_payments_booking_id"), "catering_payments", type_="foreignkey"
    )
    op.create_foreign_key(
        op.f("fk_catering_payments_booking_id_catering_bookings"),
        "catering_payments",
        "catering_bookings",
        ["booking_id"],
        ["id"],
        ondelete="CASCADE",
    )
    op.drop_column("catering_payments", "notification_id")
    op.drop_index(op.f("idx_crm_contacts_active"), table_name="crm_contacts")
    op.drop_index(op.f("idx_crm_contacts_created"), table_name="crm_contacts")
    op.drop_index(op.f("idx_crm_contacts_email"), table_name="crm_contacts")
    op.drop_index(op.f("idx_crm_contacts_phone"), table_name="crm_contacts")
    op.create_index(op.f("ix_crm_contacts_email"), "crm_contacts", ["email"], unique=False)
    op.create_index(
        op.f("ix_crm_contacts_phone_number"), "crm_contacts", ["phone_number"], unique=False
    )
    op.alter_column(
        "customer_review_blog_posts", "customer_id", existing_type=sa.INTEGER(), nullable=False
    )
    op.alter_column(
        "customer_review_blog_posts",
        "created_at",
        existing_type=postgresql.TIMESTAMP(),
        nullable=True,
        existing_server_default=sa.text("now()"),
    )
    op.alter_column(
        "customer_review_blog_posts",
        "updated_at",
        existing_type=postgresql.TIMESTAMP(),
        nullable=True,
        existing_server_default=sa.text("now()"),
    )
    op.alter_column(
        "customer_review_blog_posts",
        "is_deleted",
        existing_type=sa.BOOLEAN(),
        nullable=False,
        existing_server_default=sa.text("false"),
    )
    op.drop_index(op.f("idx_review_blog_created_at"), table_name="customer_review_blog_posts")
    op.drop_index(op.f("idx_review_blog_rating"), table_name="customer_review_blog_posts")
    op.drop_index(op.f("idx_review_blog_status"), table_name="customer_review_blog_posts")
    op.drop_index(op.f("idx_review_blog_status_created"), table_name="customer_review_blog_posts")
    op.create_index(
        op.f("ix_customer_review_blog_posts_id"), "customer_review_blog_posts", ["id"], unique=False
    )
    op.create_foreign_key(
        op.f("fk_customer_review_blog_posts_customer_id_customers"),
        "customer_review_blog_posts",
        "customers",
        ["customer_id"],
        ["id"],
        referent_schema="core",
        ondelete="CASCADE",
    )
    op.create_foreign_key(
        op.f("fk_customer_review_blog_posts_booking_id_bookings"),
        "customer_review_blog_posts",
        "bookings",
        ["booking_id"],
        ["id"],
        referent_schema="core",
        ondelete="SET NULL",
    )
    op.add_column(
        "customer_tone_preferences",
        sa.Column(
            "detected_tone",
            postgresql.ENUM("FORMAL", "CASUAL", "DIRECT", "WARM", "ANXIOUS", name="tone_type"),
            nullable=False,
        ),
    )
    op.add_column(
        "customer_tone_preferences",
        sa.Column("confidence_score", sa.Numeric(precision=5, scale=2), nullable=True),
    )
    op.add_column(
        "customer_tone_preferences",
        sa.Column("interaction_channel", sa.String(length=50), nullable=False),
    )
    op.add_column(
        "customer_tone_preferences", sa.Column("message_sample", sa.Text(), nullable=True)
    )
    op.add_column(
        "customer_tone_preferences",
        sa.Column("interaction_date", sa.DateTime(timezone=True), nullable=False),
    )
    op.alter_column(
        "customer_tone_preferences",
        "id",
        existing_type=sa.INTEGER(),
        type_=sa.String(length=36),
        existing_nullable=False,
    )
    op.alter_column(
        "customer_tone_preferences",
        "customer_id",
        existing_type=sa.VARCHAR(length=50),
        type_=sa.String(length=36),
        existing_nullable=False,
    )
    op.alter_column(
        "customer_tone_preferences",
        "created_at",
        existing_type=postgresql.TIMESTAMP(),
        type_=sa.DateTime(timezone=True),
        existing_nullable=False,
        existing_server_default=sa.text("now()"),
    )
    op.drop_index(
        op.f("ix_customer_tone_preferences_customer_id"), table_name="customer_tone_preferences"
    )
    op.create_index(
        "idx_tone_channel",
        "customer_tone_preferences",
        ["interaction_channel"],
        unique=False,
        schema="public",
    )
    op.create_index(
        "idx_tone_customer",
        "customer_tone_preferences",
        ["customer_id"],
        unique=False,
        schema="public",
    )
    op.create_index(
        "idx_tone_date",
        "customer_tone_preferences",
        ["interaction_date"],
        unique=False,
        schema="public",
    )
    op.create_index(
        "idx_tone_detected",
        "customer_tone_preferences",
        ["detected_tone"],
        unique=False,
        schema="public",
    )
    op.create_index(
        "idx_tone_history",
        "customer_tone_preferences",
        ["customer_id", "interaction_date"],
        unique=False,
        schema="public",
    )
    op.create_foreign_key(
        op.f("fk_customer_tone_preferences_customer_id_customers"),
        "customer_tone_preferences",
        "customers",
        ["customer_id"],
        ["id"],
        source_schema="public",
        referent_schema="core",
        ondelete="CASCADE",
    )
    op.drop_table_comment(
        "customer_tone_preferences",
        existing_comment="Remember customer communication style for personalized responses",
        schema=None,
    )
    op.drop_column("customer_tone_preferences", "interaction_count")
    op.drop_column("customer_tone_preferences", "last_updated")
    op.drop_column("customer_tone_preferences", "tone_confidence")
    op.drop_column("customer_tone_preferences", "last_interaction")
    op.drop_column("customer_tone_preferences", "preferred_tone")
    op.drop_constraint(op.f("email_labels_name_key"), "email_labels", type_="unique")
    op.drop_constraint(op.f("email_labels_slug_key"), "email_labels", type_="unique")
    op.add_column("escalations", sa.Column("conversation_id", sa.UUID(), nullable=True))
    op.add_column("escalations", sa.Column("customer_id", sa.UUID(), nullable=True))
    op.add_column("escalations", sa.Column("phone", sa.String(length=20), nullable=False))
    op.add_column("escalations", sa.Column("email", sa.String(length=255), nullable=True))
    op.add_column(
        "escalations",
        sa.Column(
            "preferred_method",
            sa.Enum("sms", "call", "email", name="escalationmethod"),
            nullable=False,
        ),
    )
    op.add_column("escalations", sa.Column("assigned_to_id", sa.UUID(), nullable=True))
    op.add_column(
        "escalations", sa.Column("assigned_at", sa.DateTime(timezone=True), nullable=True)
    )
    op.add_column("escalations", sa.Column("resolved_by_id", sa.UUID(), nullable=True))
    op.add_column(
        "escalations", sa.Column("admin_notified_at", sa.DateTime(timezone=True), nullable=True)
    )
    op.add_column(
        "escalations", sa.Column("admin_notification_sid", sa.String(length=100), nullable=True)
    )
    op.add_column(
        "escalations", sa.Column("admin_notification_status", sa.String(length=20), nullable=True)
    )
    op.add_column(
        "escalations", sa.Column("admin_notification_channel", sa.String(length=20), nullable=True)
    )
    op.add_column("escalations", sa.Column("sms_sent", sa.DateTime(timezone=True), nullable=True))
    op.add_column(
        "escalations", sa.Column("call_initiated", sa.DateTime(timezone=True), nullable=True)
    )
    op.add_column(
        "escalations", sa.Column("last_contact_at", sa.DateTime(timezone=True), nullable=True)
    )
    op.add_column("escalations", sa.Column("error_message", sa.Text(), nullable=True))
    op.add_column("escalations", sa.Column("retry_count", sa.String(length=10), nullable=False))
    op.add_column(
        "escalations",
        sa.Column("escalation_metadata", postgresql.JSONB(astext_type=sa.Text()), nullable=False),
    )
    op.add_column(
        "escalations", sa.Column("tags", postgresql.JSONB(astext_type=sa.Text()), nullable=False)
    )
    op.add_column(
        "escalations",
        sa.Column(
            "updated_at",
            sa.DateTime(timezone=True),
            server_default=sa.text("now()"),
            nullable=False,
        ),
    )
    op.add_column(
        "escalations", sa.Column("customer_consent", sa.String(length=10), nullable=False)
    )
    op.alter_column(
        "escalations", "id", existing_type=sa.INTEGER(), type_=sa.UUID(), existing_nullable=False
    )
    op.alter_column(
        "escalations",
        "reason",
        existing_type=sa.VARCHAR(length=255),
        type_=sa.Text(),
        existing_nullable=False,
    )
    op.alter_column(
        "escalations",
        "priority",
        existing_type=sa.VARCHAR(length=20),
        type_=sa.Enum("low", "medium", "high", "urgent", name="escalationpriority"),
        existing_nullable=False,
    )
    op.alter_column(
        "escalations",
        "status",
        existing_type=sa.VARCHAR(length=20),
        type_=sa.Enum(
            "pending",
            "assigned",
            "in_progress",
            "waiting_customer",
            "resolved",
            "closed",
            "error",
            name="escalationstatus",
        ),
        existing_nullable=False,
    )
    op.alter_column(
        "escalations",
        "resolved_at",
        existing_type=postgresql.TIMESTAMP(),
        type_=sa.DateTime(timezone=True),
        existing_nullable=True,
    )
    op.alter_column(
        "escalations",
        "created_at",
        existing_type=postgresql.TIMESTAMP(),
        type_=sa.DateTime(timezone=True),
        existing_nullable=False,
        existing_server_default=sa.text("now()"),
    )
    op.drop_index(op.f("idx_escalations_open_priority"), table_name="escalations")
    op.drop_index(op.f("ix_escalations_booking_id"), table_name="escalations")
    op.drop_index(op.f("ix_escalations_deadline"), table_name="escalations")
    op.create_index(
        op.f("ix_escalations_assigned_to_id"), "escalations", ["assigned_to_id"], unique=False
    )
    op.create_index(
        op.f("ix_escalations_conversation_id"), "escalations", ["conversation_id"], unique=False
    )
    op.create_index(op.f("ix_escalations_created_at"), "escalations", ["created_at"], unique=False)
    op.create_index(
        op.f("ix_escalations_customer_id"), "escalations", ["customer_id"], unique=False
    )
    op.create_index(op.f("ix_escalations_id"), "escalations", ["id"], unique=False)
    op.create_index(op.f("ix_escalations_phone"), "escalations", ["phone"], unique=False)
    op.create_foreign_key(
        op.f("fk_escalations_customer_id_customers"),
        "escalations",
        "customers",
        ["customer_id"],
        ["id"],
        referent_schema="core",
        ondelete="SET NULL",
    )
    op.drop_table_comment(
        "escalations", existing_comment="Human escalation queue for complex issues", schema=None
    )
    op.drop_column("escalations", "booking_id")
    op.drop_column("escalations", "deadline")
    op.drop_column("escalations", "action_required")
    op.drop_column("escalations", "customer_request")
    op.drop_column("escalations", "assigned_to")
    op.add_column("faq_items", sa.Column("short_answer", sa.String(length=500), nullable=True))
    op.add_column("faq_items", sa.Column("subcategory", sa.String(length=100), nullable=True))
    op.add_column("faq_items", sa.Column("keywords", postgresql.ARRAY(sa.String()), nullable=True))
    op.add_column("faq_items", sa.Column("tags", postgresql.ARRAY(sa.String()), nullable=True))
    op.add_column("faq_items", sa.Column("priority", sa.Integer(), nullable=True))
    op.add_column("faq_items", sa.Column("station_id", sa.String(length=36), nullable=True))
    op.add_column("faq_items", sa.Column("updated_at", sa.DateTime(timezone=True), nullable=False))
    op.alter_column(
        "faq_items",
        "id",
        existing_type=sa.INTEGER(),
        type_=sa.String(length=36),
        existing_nullable=False,
    )
    op.alter_column(
        "faq_items",
        "category",
        existing_type=sa.VARCHAR(length=50),
        type_=sa.String(length=100),
        existing_nullable=False,
    )
    op.alter_column("faq_items", "view_count", existing_type=sa.INTEGER(), nullable=True)
    op.alter_column("faq_items", "helpful_count", existing_type=sa.INTEGER(), nullable=True)
    op.alter_column("faq_items", "is_active", existing_type=sa.BOOLEAN(), nullable=True)
    op.alter_column(
        "faq_items",
        "created_at",
        existing_type=postgresql.TIMESTAMP(),
        type_=sa.DateTime(timezone=True),
        existing_nullable=False,
        existing_server_default=sa.text("now()"),
    )
    op.drop_index(op.f("idx_faq_items_category_active"), table_name="faq_items")
    op.drop_index(op.f("ix_faq_items_category"), table_name="faq_items")
    op.drop_index(op.f("ix_faq_items_is_active"), table_name="faq_items")
    op.create_index("idx_faq_active", "faq_items", ["is_active"], unique=False, schema="public")
    op.create_index("idx_faq_category", "faq_items", ["category"], unique=False, schema="public")
    op.create_index(
        "idx_faq_keywords",
        "faq_items",
        ["keywords"],
        unique=False,
        schema="public",
        postgresql_using="gin",
    )
    op.create_index(
        "idx_faq_lookup",
        "faq_items",
        ["category", "is_active", "priority"],
        unique=False,
        schema="public",
    )
    op.create_index("idx_faq_priority", "faq_items", ["priority"], unique=False, schema="public")
    op.create_index("idx_faq_station", "faq_items", ["station_id"], unique=False, schema="public")
    op.create_index(
        "idx_faq_tags", "faq_items", ["tags"], unique=False, schema="public", postgresql_using="gin"
    )
    op.drop_table_comment(
        "faq_items",
        existing_comment="FAQ database for AI to search and retrieve answers",
        schema=None,
    )
    op.drop_column("faq_items", "last_updated")
    op.alter_column(
        "notification_group_events", "created_by", existing_type=sa.UUID(), nullable=False
    )
    op.drop_index(
        op.f("idx_notification_group_events_event_type"), table_name="notification_group_events"
    )
    op.drop_index(
        op.f("idx_notification_group_events_group_id"), table_name="notification_group_events"
    )
    op.drop_constraint(op.f("uq_group_event"), "notification_group_events", type_="unique")
    op.create_index(
        op.f("ix_notification_group_events_event_type"),
        "notification_group_events",
        ["event_type"],
        unique=False,
    )
    op.create_index(
        op.f("ix_notification_group_events_group_id"),
        "notification_group_events",
        ["group_id"],
        unique=False,
    )
    op.drop_index(
        op.f("idx_notification_group_members_active"), table_name="notification_group_members"
    )
    op.drop_index(
        op.f("idx_notification_group_members_group_id"), table_name="notification_group_members"
    )
    op.drop_index(
        op.f("idx_notification_group_members_phone"), table_name="notification_group_members"
    )
    op.create_index(
        op.f("ix_notification_group_members_group_id"),
        "notification_group_members",
        ["group_id"],
        unique=False,
    )
    op.create_index(
        op.f("ix_notification_group_members_phone_number"),
        "notification_group_members",
        ["phone_number"],
        unique=False,
    )
    op.alter_column("notification_groups", "created_by", existing_type=sa.UUID(), nullable=False)
    op.drop_index(op.f("idx_notification_groups_active"), table_name="notification_groups")
    op.drop_index(op.f("idx_notification_groups_station_id"), table_name="notification_groups")
    op.drop_constraint(op.f("notification_groups_name_key"), "notification_groups", type_="unique")
    op.create_index(
        op.f("ix_notification_groups_name"), "notification_groups", ["name"], unique=True
    )
    op.create_index(
        op.f("ix_notification_groups_station_id"),
        "notification_groups",
        ["station_id"],
        unique=False,
    )
    op.add_column("payment_notifications", sa.Column("is_deleted", sa.Boolean(), nullable=False))
    op.alter_column(
        "payment_notifications",
        "booking_id",
        existing_type=sa.UUID(),
        type_=sa.Integer(),
        existing_nullable=True,
    )
    op.alter_column(
        "payment_notifications",
        "created_at",
        existing_type=postgresql.TIMESTAMP(),
        nullable=True,
        existing_server_default=sa.text("CURRENT_TIMESTAMP"),
    )
    op.alter_column(
        "payment_notifications",
        "updated_at",
        existing_type=postgresql.TIMESTAMP(),
        nullable=True,
        existing_server_default=sa.text("CURRENT_TIMESTAMP"),
    )
    op.drop_index(op.f("idx_notification_booking_id"), table_name="payment_notifications")
    op.drop_index(op.f("idx_notification_email_from"), table_name="payment_notifications")
    op.drop_index(op.f("idx_notification_email_id"), table_name="payment_notifications")
    op.drop_index(op.f("idx_notification_is_processed"), table_name="payment_notifications")
    op.drop_index(op.f("idx_notification_payment_id"), table_name="payment_notifications")
    op.drop_index(op.f("idx_notification_provider"), table_name="payment_notifications")
    op.drop_index(op.f("idx_notification_received_at"), table_name="payment_notifications")
    op.drop_index(
        op.f("idx_notification_requires_manual_review"), table_name="payment_notifications"
    )
    op.drop_index(op.f("idx_notification_sender_name"), table_name="payment_notifications")
    op.drop_index(op.f("idx_notification_sender_phone"), table_name="payment_notifications")
    op.drop_index(op.f("idx_notification_status"), table_name="payment_notifications")
    op.drop_index(op.f("idx_notification_transaction_id"), table_name="payment_notifications")
    op.create_index(
        op.f("ix_payment_notifications_booking_id"),
        "payment_notifications",
        ["booking_id"],
        unique=False,
    )
    op.create_index(
        op.f("ix_payment_notifications_email_from"),
        "payment_notifications",
        ["email_from"],
        unique=False,
    )
    op.create_index(
        op.f("ix_payment_notifications_email_id"),
        "payment_notifications",
        ["email_id"],
        unique=True,
    )
    op.create_index(
        op.f("ix_payment_notifications_id"), "payment_notifications", ["id"], unique=False
    )
    op.create_index(
        op.f("ix_payment_notifications_is_processed"),
        "payment_notifications",
        ["is_processed"],
        unique=False,
    )
    op.create_index(
        op.f("ix_payment_notifications_payment_id"),
        "payment_notifications",
        ["payment_id"],
        unique=False,
    )
    op.create_index(
        op.f("ix_payment_notifications_provider"),
        "payment_notifications",
        ["provider"],
        unique=False,
    )
    op.create_index(
        op.f("ix_payment_notifications_received_at"),
        "payment_notifications",
        ["received_at"],
        unique=False,
    )
    op.create_index(
        op.f("ix_payment_notifications_requires_manual_review"),
        "payment_notifications",
        ["requires_manual_review"],
        unique=False,
    )
    op.create_index(
        op.f("ix_payment_notifications_sender_name"),
        "payment_notifications",
        ["sender_name"],
        unique=False,
    )
    op.create_index(
        op.f("ix_payment_notifications_sender_phone"),
        "payment_notifications",
        ["sender_phone"],
        unique=False,
    )
    op.create_index(
        op.f("ix_payment_notifications_status"), "payment_notifications", ["status"], unique=False
    )
    op.create_index(
        op.f("ix_payment_notifications_transaction_id"),
        "payment_notifications",
        ["transaction_id"],
        unique=False,
    )
    op.drop_constraint(
        op.f("payment_notifications_reviewed_by_fkey"), "payment_notifications", type_="foreignkey"
    )
    op.drop_constraint(
        op.f("fk_payment_notifications_booking_id"), "payment_notifications", type_="foreignkey"
    )
    op.create_foreign_key(
        op.f("fk_payment_notifications_booking_id_catering_bookings"),
        "payment_notifications",
        "catering_bookings",
        ["booking_id"],
        ["id"],
        ondelete="SET NULL",
    )
    op.drop_column("payment_notifications", "reviewed_by")
    op.alter_column(
        "review_approval_log",
        "updated_at",
        existing_type=postgresql.TIMESTAMP(),
        nullable=True,
        existing_server_default=sa.text("now()"),
    )
    op.alter_column(
        "review_approval_log",
        "is_deleted",
        existing_type=sa.BOOLEAN(),
        nullable=False,
        existing_server_default=sa.text("false"),
    )
    op.drop_index(op.f("idx_approval_log_admin_id"), table_name="review_approval_log")
    op.drop_index(op.f("idx_approval_log_created_at"), table_name="review_approval_log")
    op.drop_index(op.f("idx_approval_log_review_id"), table_name="review_approval_log")
    op.create_index(op.f("ix_review_approval_log_id"), "review_approval_log", ["id"], unique=False)
    op.add_column("seasonal_offers", sa.Column("offer_name", sa.String(length=200), nullable=False))
    op.add_column("seasonal_offers", sa.Column("offer_description", sa.Text(), nullable=False))
    op.add_column("seasonal_offers", sa.Column("offer_type", sa.String(length=100), nullable=False))
    op.add_column(
        "seasonal_offers",
        sa.Column("discount_amount", sa.Numeric(precision=10, scale=2), nullable=True),
    )
    op.add_column(
        "seasonal_offers",
        sa.Column("discount_percentage", sa.Numeric(precision=5, scale=2), nullable=True),
    )
    op.add_column(
        "seasonal_offers", sa.Column("valid_until", sa.DateTime(timezone=True), nullable=False)
    )
    op.add_column("seasonal_offers", sa.Column("conditions", sa.JSON(), nullable=True))
    op.add_column(
        "seasonal_offers",
        sa.Column(
            "status",
            postgresql.ENUM("DRAFT", "ACTIVE", "EXPIRED", "SCHEDULED", name="offer_status"),
            nullable=True,
        ),
    )
    op.add_column("seasonal_offers", sa.Column("usage_count", sa.Integer(), nullable=True))
    op.add_column("seasonal_offers", sa.Column("station_id", sa.String(length=36), nullable=True))
    op.add_column(
        "seasonal_offers", sa.Column("updated_at", sa.DateTime(timezone=True), nullable=False)
    )
    op.alter_column(
        "seasonal_offers",
        "id",
        existing_type=sa.INTEGER(),
        type_=sa.String(length=36),
        existing_nullable=False,
    )
    op.alter_column(
        "seasonal_offers",
        "valid_from",
        existing_type=sa.DATE(),
        type_=sa.DateTime(timezone=True),
        existing_nullable=False,
    )
    op.alter_column(
        "seasonal_offers",
        "created_at",
        existing_type=postgresql.TIMESTAMP(),
        type_=sa.DateTime(timezone=True),
        existing_nullable=False,
        existing_server_default=sa.text("now()"),
    )
    op.drop_index(op.f("idx_seasonal_offers_dates"), table_name="seasonal_offers")
    op.drop_index(op.f("ix_seasonal_offers_is_active"), table_name="seasonal_offers")
    op.drop_index(op.f("ix_seasonal_offers_valid_from"), table_name="seasonal_offers")
    op.drop_index(op.f("ix_seasonal_offers_valid_to"), table_name="seasonal_offers")
    op.create_index(
        "idx_offers_dates",
        "seasonal_offers",
        ["valid_from", "valid_until"],
        unique=False,
        schema="public",
    )
    op.create_index(
        "idx_offers_station", "seasonal_offers", ["station_id"], unique=False, schema="public"
    )
    op.create_index(
        "idx_offers_status", "seasonal_offers", ["status"], unique=False, schema="public"
    )
    op.drop_table_comment(
        "seasonal_offers", existing_comment="Seasonal offers and holiday promotions", schema=None
    )
    op.drop_column("seasonal_offers", "title")
    op.drop_column("seasonal_offers", "valid_to")
    op.drop_column("seasonal_offers", "is_active")
    op.drop_column("seasonal_offers", "description")
    op.drop_column("seasonal_offers", "discount_type")
    op.drop_column("seasonal_offers", "discount_value")
    op.add_column(
        "system_events",
        sa.Column(
            "event_data", sa.JSON(), nullable=False, comment="Additional JSON data about the event"
        ),
    )
    op.alter_column(
        "system_events",
        "service",
        existing_type=sa.VARCHAR(length=100),
        comment="Service that logged the event (e.g., 'LeadService', 'BookingService')",
        existing_comment="Service that logged the event",
        existing_nullable=False,
    )
    op.alter_column(
        "system_events",
        "action",
        existing_type=sa.VARCHAR(length=100),
        comment="Action performed (e.g., 'lead_created', 'booking_confirmed')",
        existing_comment="Action performed",
        existing_nullable=False,
    )
    op.alter_column(
        "system_events",
        "entity_type",
        existing_type=sa.VARCHAR(length=50),
        comment="Type of entity (e.g., 'lead', 'booking', 'user')",
        existing_comment="Type of entity",
        existing_nullable=True,
    )
    op.alter_column(
        "system_events",
        "severity",
        existing_type=sa.VARCHAR(length=20),
        comment="Event severity: debug, info, warning, error, critical",
        existing_comment="Event severity",
        existing_nullable=False,
        existing_server_default=sa.text("'info'::character varying"),
    )
    op.drop_table_comment(
        "system_events",
        existing_comment="System event tracking for analytics and audit trails",
        schema=None,
    )
    op.drop_column("system_events", "metadata")
    op.add_column("terms_acknowledgments", sa.Column("is_deleted", sa.Boolean(), nullable=False))
    op.alter_column(
        "terms_acknowledgments",
        "customer_id",
        existing_type=sa.UUID(),
        type_=sa.Integer(),
        existing_nullable=False,
    )
    op.alter_column(
        "terms_acknowledgments",
        "booking_id",
        existing_type=sa.UUID(),
        type_=sa.Integer(),
        existing_nullable=True,
    )
    op.alter_column(
        "terms_acknowledgments",
        "acknowledged_at",
        existing_type=postgresql.TIMESTAMP(timezone=True),
        type_=sa.DateTime(),
        existing_nullable=False,
        existing_server_default=sa.text("now()"),
    )
    op.alter_column(
        "terms_acknowledgments",
        "channel",
        existing_type=sa.VARCHAR(length=20),
        type_=sa.Enum(
            "WEB",
            "PHONE",
            "SMS",
            "WHATSAPP",
            "AI_CHAT",
            "EMAIL",
            "IN_PERSON",
            name="acknowledgmentchannel",
        ),
        existing_nullable=False,
    )
    op.alter_column(
        "terms_acknowledgments",
        "created_at",
        existing_type=postgresql.TIMESTAMP(timezone=True),
        type_=sa.DateTime(),
        nullable=True,
        existing_server_default=sa.text("now()"),
    )
    op.alter_column(
        "terms_acknowledgments",
        "updated_at",
        existing_type=postgresql.TIMESTAMP(timezone=True),
        type_=sa.DateTime(),
        nullable=True,
        existing_server_default=sa.text("now()"),
    )
    op.drop_index(
        op.f("ix_terms_acknowledgments_customer_latest"), table_name="terms_acknowledgments"
    )
    op.create_index(
        op.f("ix_terms_acknowledgments_id"), "terms_acknowledgments", ["id"], unique=False
    )
    op.drop_constraint(
        op.f("terms_acknowledgments_customer_id_fkey"), "terms_acknowledgments", type_="foreignkey"
    )
    op.drop_constraint(
        op.f("terms_acknowledgments_booking_id_fkey"), "terms_acknowledgments", type_="foreignkey"
    )
    op.create_foreign_key(
        op.f("fk_terms_acknowledgments_booking_id_bookings"),
        "terms_acknowledgments",
        "bookings",
        ["booking_id"],
        ["id"],
        referent_schema="core",
    )
    op.create_foreign_key(
        op.f("fk_terms_acknowledgments_customer_id_customers"),
        "terms_acknowledgments",
        "customers",
        ["customer_id"],
        ["id"],
        referent_schema="core",
    )
    op.drop_column("terms_acknowledgments", "webhook_source_ip")
    op.drop_column("terms_acknowledgments", "sms_message_timestamp")
    op.drop_column("terms_acknowledgments", "sms_message_hash")
    op.drop_column("terms_acknowledgments", "sms_message_id")
    op.add_column("training_data", sa.Column("example_type", sa.String(length=100), nullable=False))
    op.add_column(
        "training_data",
        sa.Column(
            "tone",
            postgresql.ENUM("FORMAL", "CASUAL", "DIRECT", "WARM", "ANXIOUS", name="tone_type"),
            nullable=False,
        ),
    )
    op.add_column("training_data", sa.Column("context", sa.JSON(), nullable=True))
    op.add_column("training_data", sa.Column("quality_score", sa.Integer(), nullable=True))
    op.add_column("training_data", sa.Column("used_count", sa.Integer(), nullable=True))
    op.add_column("training_data", sa.Column("station_id", sa.String(length=36), nullable=True))
    op.add_column(
        "training_data", sa.Column("updated_at", sa.DateTime(timezone=True), nullable=False)
    )
    op.alter_column(
        "training_data",
        "id",
        existing_type=sa.INTEGER(),
        type_=sa.String(length=36),
        existing_nullable=False,
    )
    op.alter_column(
        "training_data",
        "scenario",
        existing_type=sa.VARCHAR(length=100),
        type_=sa.String(length=200),
        nullable=True,
    )
    op.alter_column("training_data", "is_active", existing_type=sa.BOOLEAN(), nullable=True)
    op.alter_column(
        "training_data",
        "created_at",
        existing_type=postgresql.TIMESTAMP(),
        type_=sa.DateTime(timezone=True),
        existing_nullable=False,
        existing_server_default=sa.text("now()"),
    )
    op.drop_index(op.f("idx_training_data_tone_scenario"), table_name="training_data")
    op.drop_index(op.f("ix_training_data_customer_tone"), table_name="training_data")
    op.drop_index(op.f("ix_training_data_is_active"), table_name="training_data")
    op.drop_index(op.f("ix_training_data_scenario"), table_name="training_data")
    op.create_index(
        "idx_training_active", "training_data", ["is_active"], unique=False, schema="public"
    )
    op.create_index(
        "idx_training_lookup",
        "training_data",
        ["tone", "example_type", "is_active"],
        unique=False,
        schema="public",
    )
    op.create_index(
        "idx_training_quality", "training_data", ["quality_score"], unique=False, schema="public"
    )
    op.create_index(
        "idx_training_station", "training_data", ["station_id"], unique=False, schema="public"
    )
    op.create_index("idx_training_tone", "training_data", ["tone"], unique=False, schema="public")
    op.create_index(
        "idx_training_type", "training_data", ["example_type"], unique=False, schema="public"
    )
    op.drop_table_comment(
        "training_data",
        existing_comment="Training examples for tone-matched AI responses",
        schema=None,
    )
    op.drop_column("training_data", "customer_tone")
    op.drop_column("training_data", "last_used")
    op.drop_column("training_data", "effectiveness_score")
    op.drop_column("training_data", "tags")
    op.add_column("upsell_rules", sa.Column("rule_name", sa.String(length=200), nullable=False))
    op.add_column(
        "upsell_rules",
        sa.Column(
            "trigger_type",
            postgresql.ENUM(
                "GUEST_COUNT",
                "EVENT_TYPE",
                "DATE",
                "LOCATION",
                "BUDGET",
                name="upsell_trigger_type",
            ),
            nullable=False,
        ),
    )
    op.add_column("upsell_rules", sa.Column("upsell_description", sa.Text(), nullable=False))
    op.add_column(
        "upsell_rules", sa.Column("upsell_price", sa.Numeric(precision=10, scale=2), nullable=True)
    )
    op.add_column("upsell_rules", sa.Column("priority", sa.Integer(), nullable=True))
    op.add_column("upsell_rules", sa.Column("station_id", sa.String(length=36), nullable=True))
    op.add_column(
        "upsell_rules", sa.Column("updated_at", sa.DateTime(timezone=True), nullable=False)
    )
    op.alter_column(
        "upsell_rules",
        "id",
        existing_type=sa.INTEGER(),
        type_=sa.String(length=36),
        existing_nullable=False,
    )
    op.alter_column(
        "upsell_rules",
        "trigger_condition",
        existing_type=sa.VARCHAR(length=255),
        type_=sa.JSON(),
        existing_nullable=False,
    )
    op.alter_column(
        "upsell_rules",
        "upsell_item",
        existing_type=sa.VARCHAR(length=100),
        type_=sa.String(length=200),
        existing_nullable=False,
    )
    op.alter_column("upsell_rules", "is_active", existing_type=sa.BOOLEAN(), nullable=True)
    op.alter_column(
        "upsell_rules",
        "created_at",
        existing_type=postgresql.TIMESTAMP(),
        type_=sa.DateTime(timezone=True),
        existing_nullable=False,
        existing_server_default=sa.text("now()"),
    )
    op.drop_index(op.f("ix_upsell_rules_is_active"), table_name="upsell_rules")
    op.create_index(
        "idx_upsell_active", "upsell_rules", ["is_active"], unique=False, schema="public"
    )
    op.create_index(
        "idx_upsell_priority", "upsell_rules", ["priority"], unique=False, schema="public"
    )
    op.create_index(
        "idx_upsell_station", "upsell_rules", ["station_id"], unique=False, schema="public"
    )
    op.create_index(
        "idx_upsell_trigger", "upsell_rules", ["trigger_type"], unique=False, schema="public"
    )
    op.drop_table_comment(
        "upsell_rules", existing_comment="Rules for contextual upselling suggestions", schema=None
    )
    op.drop_column("upsell_rules", "last_updated")
    op.drop_column("upsell_rules", "max_party_size")
    op.drop_column("upsell_rules", "tone_adaptation")
    op.drop_column("upsell_rules", "pitch_template")
    op.drop_column("upsell_rules", "min_party_size")
    # ### end Alembic commands ###


def downgrade() -> None:
    # ### commands auto generated by Alembic - please adjust! ###
    op.add_column(
        "upsell_rules",
        sa.Column("min_party_size", sa.INTEGER(), autoincrement=False, nullable=True),
    )
    op.add_column(
        "upsell_rules", sa.Column("pitch_template", sa.TEXT(), autoincrement=False, nullable=False)
    )
    op.add_column(
        "upsell_rules",
        sa.Column(
            "tone_adaptation",
            postgresql.JSONB(astext_type=sa.Text()),
            autoincrement=False,
            nullable=True,
        ),
    )
    op.add_column(
        "upsell_rules",
        sa.Column("max_party_size", sa.INTEGER(), autoincrement=False, nullable=True),
    )
    op.add_column(
        "upsell_rules",
        sa.Column(
            "last_updated",
            postgresql.TIMESTAMP(),
            server_default=sa.text("now()"),
            autoincrement=False,
            nullable=False,
        ),
    )
    op.create_table_comment(
        "upsell_rules",
        "Rules for contextual upselling suggestions",
        existing_comment=None,
        schema=None,
    )
    op.drop_index("idx_upsell_trigger", table_name="upsell_rules", schema="public")
    op.drop_index("idx_upsell_station", table_name="upsell_rules", schema="public")
    op.drop_index("idx_upsell_priority", table_name="upsell_rules", schema="public")
    op.drop_index("idx_upsell_active", table_name="upsell_rules", schema="public")
    op.create_index(op.f("ix_upsell_rules_is_active"), "upsell_rules", ["is_active"], unique=False)
    op.alter_column(
        "upsell_rules",
        "created_at",
        existing_type=sa.DateTime(timezone=True),
        type_=postgresql.TIMESTAMP(),
        existing_nullable=False,
        existing_server_default=sa.text("now()"),
    )
    op.alter_column("upsell_rules", "is_active", existing_type=sa.BOOLEAN(), nullable=False)
    op.alter_column(
        "upsell_rules",
        "upsell_item",
        existing_type=sa.String(length=200),
        type_=sa.VARCHAR(length=100),
        existing_nullable=False,
    )
    op.alter_column(
        "upsell_rules",
        "trigger_condition",
        existing_type=sa.JSON(),
        type_=sa.VARCHAR(length=255),
        existing_nullable=False,
    )
    op.alter_column(
        "upsell_rules",
        "id",
        existing_type=sa.String(length=36),
        type_=sa.INTEGER(),
        existing_nullable=False,
    )
    op.drop_column("upsell_rules", "updated_at")
    op.drop_column("upsell_rules", "station_id")
    op.drop_column("upsell_rules", "priority")
    op.drop_column("upsell_rules", "upsell_price")
    op.drop_column("upsell_rules", "upsell_description")
    op.drop_column("upsell_rules", "trigger_type")
    op.drop_column("upsell_rules", "rule_name")
    op.add_column(
        "training_data",
        sa.Column(
            "tags", postgresql.ARRAY(sa.VARCHAR(length=50)), autoincrement=False, nullable=True
        ),
    )
    op.add_column(
        "training_data",
        sa.Column(
            "effectiveness_score",
            sa.NUMERIC(precision=3, scale=2),
            autoincrement=False,
            nullable=True,
        ),
    )
    op.add_column(
        "training_data",
        sa.Column("last_used", postgresql.TIMESTAMP(), autoincrement=False, nullable=True),
    )
    op.add_column(
        "training_data",
        sa.Column("customer_tone", sa.VARCHAR(length=20), autoincrement=False, nullable=False),
    )
    op.create_table_comment(
        "training_data",
        "Training examples for tone-matched AI responses",
        existing_comment=None,
        schema=None,
    )
    op.drop_index("idx_training_type", table_name="training_data", schema="public")
    op.drop_index("idx_training_tone", table_name="training_data", schema="public")
    op.drop_index("idx_training_station", table_name="training_data", schema="public")
    op.drop_index("idx_training_quality", table_name="training_data", schema="public")
    op.drop_index("idx_training_lookup", table_name="training_data", schema="public")
    op.drop_index("idx_training_active", table_name="training_data", schema="public")
    op.create_index(op.f("ix_training_data_scenario"), "training_data", ["scenario"], unique=False)
    op.create_index(
        op.f("ix_training_data_is_active"), "training_data", ["is_active"], unique=False
    )
    op.create_index(
        op.f("ix_training_data_customer_tone"), "training_data", ["customer_tone"], unique=False
    )
    op.create_index(
        op.f("idx_training_data_tone_scenario"),
        "training_data",
        ["customer_tone", "scenario", "is_active"],
        unique=False,
    )
    op.alter_column(
        "training_data",
        "created_at",
        existing_type=sa.DateTime(timezone=True),
        type_=postgresql.TIMESTAMP(),
        existing_nullable=False,
        existing_server_default=sa.text("now()"),
    )
    op.alter_column("training_data", "is_active", existing_type=sa.BOOLEAN(), nullable=False)
    op.alter_column(
        "training_data",
        "scenario",
        existing_type=sa.String(length=200),
        type_=sa.VARCHAR(length=100),
        nullable=False,
    )
    op.alter_column(
        "training_data",
        "id",
        existing_type=sa.String(length=36),
        type_=sa.INTEGER(),
        existing_nullable=False,
    )
    op.drop_column("training_data", "updated_at")
    op.drop_column("training_data", "station_id")
    op.drop_column("training_data", "used_count")
    op.drop_column("training_data", "quality_score")
    op.drop_column("training_data", "context")
    op.drop_column("training_data", "tone")
    op.drop_column("training_data", "example_type")
    op.add_column(
        "terms_acknowledgments",
        sa.Column("sms_message_id", sa.VARCHAR(length=100), autoincrement=False, nullable=True),
    )
    op.add_column(
        "terms_acknowledgments",
        sa.Column("sms_message_hash", sa.VARCHAR(length=64), autoincrement=False, nullable=True),
    )
    op.add_column(
        "terms_acknowledgments",
        sa.Column(
            "sms_message_timestamp",
            postgresql.TIMESTAMP(timezone=True),
            autoincrement=False,
            nullable=True,
        ),
    )
    op.add_column(
        "terms_acknowledgments",
        sa.Column("webhook_source_ip", postgresql.INET(), autoincrement=False, nullable=True),
    )
    op.drop_constraint(
        op.f("fk_terms_acknowledgments_customer_id_customers"),
        "terms_acknowledgments",
        type_="foreignkey",
    )
    op.drop_constraint(
        op.f("fk_terms_acknowledgments_booking_id_bookings"),
        "terms_acknowledgments",
        type_="foreignkey",
    )
    op.create_foreign_key(
        op.f("terms_acknowledgments_booking_id_fkey"),
        "terms_acknowledgments",
        "bookings",
        ["booking_id"],
        ["id"],
        referent_schema="core",
        ondelete="SET NULL",
    )
    op.create_foreign_key(
        op.f("terms_acknowledgments_customer_id_fkey"),
        "terms_acknowledgments",
        "customers",
        ["customer_id"],
        ["id"],
        referent_schema="core",
        ondelete="CASCADE",
    )
    op.drop_index(op.f("ix_terms_acknowledgments_id"), table_name="terms_acknowledgments")
    op.create_index(
        op.f("ix_terms_acknowledgments_customer_latest"),
        "terms_acknowledgments",
        ["customer_id", sa.literal_column("acknowledged_at DESC")],
        unique=False,
    )
    op.alter_column(
        "terms_acknowledgments",
        "updated_at",
        existing_type=sa.DateTime(),
        type_=postgresql.TIMESTAMP(timezone=True),
        nullable=False,
        existing_server_default=sa.text("now()"),
    )
    op.alter_column(
        "terms_acknowledgments",
        "created_at",
        existing_type=sa.DateTime(),
        type_=postgresql.TIMESTAMP(timezone=True),
        nullable=False,
        existing_server_default=sa.text("now()"),
    )
    op.alter_column(
        "terms_acknowledgments",
        "channel",
        existing_type=sa.Enum(
            "WEB",
            "PHONE",
            "SMS",
            "WHATSAPP",
            "AI_CHAT",
            "EMAIL",
            "IN_PERSON",
            name="acknowledgmentchannel",
        ),
        type_=sa.VARCHAR(length=20),
        existing_nullable=False,
    )
    op.alter_column(
        "terms_acknowledgments",
        "acknowledged_at",
        existing_type=sa.DateTime(),
        type_=postgresql.TIMESTAMP(timezone=True),
        existing_nullable=False,
        existing_server_default=sa.text("now()"),
    )
    op.alter_column(
        "terms_acknowledgments",
        "booking_id",
        existing_type=sa.Integer(),
        type_=sa.UUID(),
        existing_nullable=True,
    )
    op.alter_column(
        "terms_acknowledgments",
        "customer_id",
        existing_type=sa.Integer(),
        type_=sa.UUID(),
        existing_nullable=False,
    )
    op.drop_column("terms_acknowledgments", "is_deleted")
    op.add_column(
        "system_events",
        sa.Column(
            "metadata",
            postgresql.JSON(astext_type=sa.Text()),
            server_default=sa.text("'{}'::json"),
            autoincrement=False,
            nullable=False,
            comment="Additional JSON data",
        ),
    )
    op.create_table_comment(
        "system_events",
        "System event tracking for analytics and audit trails",
        existing_comment=None,
        schema=None,
    )
    op.alter_column(
        "system_events",
        "severity",
        existing_type=sa.VARCHAR(length=20),
        comment="Event severity",
        existing_comment="Event severity: debug, info, warning, error, critical",
        existing_nullable=False,
        existing_server_default=sa.text("'info'::character varying"),
    )
    op.alter_column(
        "system_events",
        "entity_type",
        existing_type=sa.VARCHAR(length=50),
        comment="Type of entity",
        existing_comment="Type of entity (e.g., 'lead', 'booking', 'user')",
        existing_nullable=True,
    )
    op.alter_column(
        "system_events",
        "action",
        existing_type=sa.VARCHAR(length=100),
        comment="Action performed",
        existing_comment="Action performed (e.g., 'lead_created', 'booking_confirmed')",
        existing_nullable=False,
    )
    op.alter_column(
        "system_events",
        "service",
        existing_type=sa.VARCHAR(length=100),
        comment="Service that logged the event",
        existing_comment="Service that logged the event (e.g., 'LeadService', 'BookingService')",
        existing_nullable=False,
    )
    op.drop_column("system_events", "event_data")
    op.add_column(
        "seasonal_offers",
        sa.Column(
            "discount_value", sa.NUMERIC(precision=10, scale=2), autoincrement=False, nullable=False
        ),
    )
    op.add_column(
        "seasonal_offers",
        sa.Column("discount_type", sa.VARCHAR(length=50), autoincrement=False, nullable=False),
    )
    op.add_column(
        "seasonal_offers", sa.Column("description", sa.TEXT(), autoincrement=False, nullable=False)
    )
    op.add_column(
        "seasonal_offers", sa.Column("is_active", sa.BOOLEAN(), autoincrement=False, nullable=False)
    )
    op.add_column(
        "seasonal_offers", sa.Column("valid_to", sa.DATE(), autoincrement=False, nullable=False)
    )
    op.add_column(
        "seasonal_offers",
        sa.Column("title", sa.VARCHAR(length=255), autoincrement=False, nullable=False),
    )
    op.create_table_comment(
        "seasonal_offers",
        "Seasonal offers and holiday promotions",
        existing_comment=None,
        schema=None,
    )
    op.drop_index("idx_offers_status", table_name="seasonal_offers", schema="public")
    op.drop_index("idx_offers_station", table_name="seasonal_offers", schema="public")
    op.drop_index("idx_offers_dates", table_name="seasonal_offers", schema="public")
    op.create_index(
        op.f("ix_seasonal_offers_valid_to"), "seasonal_offers", ["valid_to"], unique=False
    )
    op.create_index(
        op.f("ix_seasonal_offers_valid_from"), "seasonal_offers", ["valid_from"], unique=False
    )
    op.create_index(
        op.f("ix_seasonal_offers_is_active"), "seasonal_offers", ["is_active"], unique=False
    )
    op.create_index(
        op.f("idx_seasonal_offers_dates"),
        "seasonal_offers",
        ["valid_from", "valid_to", "is_active"],
        unique=False,
    )
    op.alter_column(
        "seasonal_offers",
        "created_at",
        existing_type=sa.DateTime(timezone=True),
        type_=postgresql.TIMESTAMP(),
        existing_nullable=False,
        existing_server_default=sa.text("now()"),
    )
    op.alter_column(
        "seasonal_offers",
        "valid_from",
        existing_type=sa.DateTime(timezone=True),
        type_=sa.DATE(),
        existing_nullable=False,
    )
    op.alter_column(
        "seasonal_offers",
        "id",
        existing_type=sa.String(length=36),
        type_=sa.INTEGER(),
        existing_nullable=False,
    )
    op.drop_column("seasonal_offers", "updated_at")
    op.drop_column("seasonal_offers", "station_id")
    op.drop_column("seasonal_offers", "usage_count")
    op.drop_column("seasonal_offers", "status")
    op.drop_column("seasonal_offers", "conditions")
    op.drop_column("seasonal_offers", "valid_until")
    op.drop_column("seasonal_offers", "discount_percentage")
    op.drop_column("seasonal_offers", "discount_amount")
    op.drop_column("seasonal_offers", "offer_type")
    op.drop_column("seasonal_offers", "offer_description")
    op.drop_column("seasonal_offers", "offer_name")
    op.drop_index(op.f("ix_review_approval_log_id"), table_name="review_approval_log")
    op.create_index(
        op.f("idx_approval_log_review_id"), "review_approval_log", ["review_id"], unique=False
    )
    op.create_index(
        op.f("idx_approval_log_created_at"),
        "review_approval_log",
        [sa.literal_column("created_at DESC")],
        unique=False,
    )
    op.create_index(
        op.f("idx_approval_log_admin_id"), "review_approval_log", ["admin_id"], unique=False
    )
    op.alter_column(
        "review_approval_log",
        "is_deleted",
        existing_type=sa.BOOLEAN(),
        nullable=True,
        existing_server_default=sa.text("false"),
    )
    op.alter_column(
        "review_approval_log",
        "updated_at",
        existing_type=postgresql.TIMESTAMP(),
        nullable=False,
        existing_server_default=sa.text("now()"),
    )
    op.add_column(
        "payment_notifications",
        sa.Column("reviewed_by", sa.UUID(), autoincrement=False, nullable=True),
    )
    op.drop_constraint(
        op.f("fk_payment_notifications_booking_id_catering_bookings"),
        "payment_notifications",
        type_="foreignkey",
    )
    op.create_foreign_key(
        op.f("fk_payment_notifications_booking_id"),
        "payment_notifications",
        "bookings",
        ["booking_id"],
        ["id"],
        referent_schema="core",
        ondelete="SET NULL",
    )
    op.create_foreign_key(
        op.f("payment_notifications_reviewed_by_fkey"),
        "payment_notifications",
        "users",
        ["reviewed_by"],
        ["id"],
        referent_schema="identity",
        ondelete="SET NULL",
    )
    op.drop_index(
        op.f("ix_payment_notifications_transaction_id"), table_name="payment_notifications"
    )
    op.drop_index(op.f("ix_payment_notifications_status"), table_name="payment_notifications")
    op.drop_index(op.f("ix_payment_notifications_sender_phone"), table_name="payment_notifications")
    op.drop_index(op.f("ix_payment_notifications_sender_name"), table_name="payment_notifications")
    op.drop_index(
        op.f("ix_payment_notifications_requires_manual_review"), table_name="payment_notifications"
    )
    op.drop_index(op.f("ix_payment_notifications_received_at"), table_name="payment_notifications")
    op.drop_index(op.f("ix_payment_notifications_provider"), table_name="payment_notifications")
    op.drop_index(op.f("ix_payment_notifications_payment_id"), table_name="payment_notifications")
    op.drop_index(op.f("ix_payment_notifications_is_processed"), table_name="payment_notifications")
    op.drop_index(op.f("ix_payment_notifications_id"), table_name="payment_notifications")
    op.drop_index(op.f("ix_payment_notifications_email_id"), table_name="payment_notifications")
    op.drop_index(op.f("ix_payment_notifications_email_from"), table_name="payment_notifications")
    op.drop_index(op.f("ix_payment_notifications_booking_id"), table_name="payment_notifications")
    op.create_index(
        op.f("idx_notification_transaction_id"),
        "payment_notifications",
        ["transaction_id"],
        unique=False,
    )
    op.create_index(
        op.f("idx_notification_status"), "payment_notifications", ["status"], unique=False
    )
    op.create_index(
        op.f("idx_notification_sender_phone"),
        "payment_notifications",
        ["sender_phone"],
        unique=False,
    )
    op.create_index(
        op.f("idx_notification_sender_name"), "payment_notifications", ["sender_name"], unique=False
    )
    op.create_index(
        op.f("idx_notification_requires_manual_review"),
        "payment_notifications",
        ["requires_manual_review"],
        unique=False,
    )
    op.create_index(
        op.f("idx_notification_received_at"), "payment_notifications", ["received_at"], unique=False
    )
    op.create_index(
        op.f("idx_notification_provider"), "payment_notifications", ["provider"], unique=False
    )
    op.create_index(
        op.f("idx_notification_payment_id"), "payment_notifications", ["payment_id"], unique=False
    )
    op.create_index(
        op.f("idx_notification_is_processed"),
        "payment_notifications",
        ["is_processed"],
        unique=False,
    )
    op.create_index(
        op.f("idx_notification_email_id"), "payment_notifications", ["email_id"], unique=True
    )
    op.create_index(
        op.f("idx_notification_email_from"), "payment_notifications", ["email_from"], unique=False
    )
    op.create_index(
        op.f("idx_notification_booking_id"), "payment_notifications", ["booking_id"], unique=False
    )
    op.alter_column(
        "payment_notifications",
        "updated_at",
        existing_type=postgresql.TIMESTAMP(),
        nullable=False,
        existing_server_default=sa.text("CURRENT_TIMESTAMP"),
    )
    op.alter_column(
        "payment_notifications",
        "created_at",
        existing_type=postgresql.TIMESTAMP(),
        nullable=False,
        existing_server_default=sa.text("CURRENT_TIMESTAMP"),
    )
    op.alter_column(
        "payment_notifications",
        "booking_id",
        existing_type=sa.Integer(),
        type_=sa.UUID(),
        existing_nullable=True,
    )
    op.drop_column("payment_notifications", "is_deleted")
    op.drop_index(op.f("ix_notification_groups_station_id"), table_name="notification_groups")
    op.drop_index(op.f("ix_notification_groups_name"), table_name="notification_groups")
    op.create_unique_constraint(
        op.f("notification_groups_name_key"),
        "notification_groups",
        ["name"],
        postgresql_nulls_not_distinct=False,
    )
    op.create_index(
        op.f("idx_notification_groups_station_id"),
        "notification_groups",
        ["station_id"],
        unique=False,
    )
    op.create_index(
        op.f("idx_notification_groups_active"), "notification_groups", ["is_active"], unique=False
    )
    op.alter_column("notification_groups", "created_by", existing_type=sa.UUID(), nullable=True)
    op.drop_index(
        op.f("ix_notification_group_members_phone_number"), table_name="notification_group_members"
    )
    op.drop_index(
        op.f("ix_notification_group_members_group_id"), table_name="notification_group_members"
    )
    op.create_index(
        op.f("idx_notification_group_members_phone"),
        "notification_group_members",
        ["phone_number"],
        unique=False,
    )
    op.create_index(
        op.f("idx_notification_group_members_group_id"),
        "notification_group_members",
        ["group_id"],
        unique=False,
    )
    op.create_index(
        op.f("idx_notification_group_members_active"),
        "notification_group_members",
        ["is_active"],
        unique=False,
    )
    op.drop_index(
        op.f("ix_notification_group_events_group_id"), table_name="notification_group_events"
    )
    op.drop_index(
        op.f("ix_notification_group_events_event_type"), table_name="notification_group_events"
    )
    op.create_unique_constraint(
        op.f("uq_group_event"),
        "notification_group_events",
        ["group_id", "event_type"],
        postgresql_nulls_not_distinct=False,
    )
    op.create_index(
        op.f("idx_notification_group_events_group_id"),
        "notification_group_events",
        ["group_id"],
        unique=False,
    )
    op.create_index(
        op.f("idx_notification_group_events_event_type"),
        "notification_group_events",
        ["event_type"],
        unique=False,
    )
    op.alter_column(
        "notification_group_events", "created_by", existing_type=sa.UUID(), nullable=True
    )
    op.add_column(
        "faq_items",
        sa.Column(
            "last_updated",
            postgresql.TIMESTAMP(),
            server_default=sa.text("now()"),
            autoincrement=False,
            nullable=False,
        ),
    )
    op.create_table_comment(
        "faq_items",
        "FAQ database for AI to search and retrieve answers",
        existing_comment=None,
        schema=None,
    )
    op.drop_index("idx_faq_tags", table_name="faq_items", schema="public", postgresql_using="gin")
    op.drop_index("idx_faq_station", table_name="faq_items", schema="public")
    op.drop_index("idx_faq_priority", table_name="faq_items", schema="public")
    op.drop_index("idx_faq_lookup", table_name="faq_items", schema="public")
    op.drop_index(
        "idx_faq_keywords", table_name="faq_items", schema="public", postgresql_using="gin"
    )
    op.drop_index("idx_faq_category", table_name="faq_items", schema="public")
    op.drop_index("idx_faq_active", table_name="faq_items", schema="public")
    op.create_index(op.f("ix_faq_items_is_active"), "faq_items", ["is_active"], unique=False)
    op.create_index(op.f("ix_faq_items_category"), "faq_items", ["category"], unique=False)
    op.create_index(
        op.f("idx_faq_items_category_active"), "faq_items", ["category", "is_active"], unique=False
    )
    op.alter_column(
        "faq_items",
        "created_at",
        existing_type=sa.DateTime(timezone=True),
        type_=postgresql.TIMESTAMP(),
        existing_nullable=False,
        existing_server_default=sa.text("now()"),
    )
    op.alter_column("faq_items", "is_active", existing_type=sa.BOOLEAN(), nullable=False)
    op.alter_column("faq_items", "helpful_count", existing_type=sa.INTEGER(), nullable=False)
    op.alter_column("faq_items", "view_count", existing_type=sa.INTEGER(), nullable=False)
    op.alter_column(
        "faq_items",
        "category",
        existing_type=sa.String(length=100),
        type_=sa.VARCHAR(length=50),
        existing_nullable=False,
    )
    op.alter_column(
        "faq_items",
        "id",
        existing_type=sa.String(length=36),
        type_=sa.INTEGER(),
        existing_nullable=False,
    )
    op.drop_column("faq_items", "updated_at")
    op.drop_column("faq_items", "station_id")
    op.drop_column("faq_items", "priority")
    op.drop_column("faq_items", "tags")
    op.drop_column("faq_items", "keywords")
    op.drop_column("faq_items", "subcategory")
    op.drop_column("faq_items", "short_answer")
    op.add_column(
        "escalations",
        sa.Column("assigned_to", sa.VARCHAR(length=100), autoincrement=False, nullable=True),
    )
    op.add_column(
        "escalations", sa.Column("customer_request", sa.TEXT(), autoincrement=False, nullable=True)
    )
    op.add_column(
        "escalations", sa.Column("action_required", sa.TEXT(), autoincrement=False, nullable=False)
    )
    op.add_column(
        "escalations",
        sa.Column("deadline", postgresql.TIMESTAMP(), autoincrement=False, nullable=True),
    )
    op.add_column(
        "escalations",
        sa.Column("booking_id", sa.VARCHAR(length=50), autoincrement=False, nullable=False),
    )
    op.create_table_comment(
        "escalations",
        "Human escalation queue for complex issues",
        existing_comment=None,
        schema=None,
    )
    op.drop_constraint(
        op.f("fk_escalations_customer_id_customers"), "escalations", type_="foreignkey"
    )
    op.drop_index(op.f("ix_escalations_phone"), table_name="escalations")
    op.drop_index(op.f("ix_escalations_id"), table_name="escalations")
    op.drop_index(op.f("ix_escalations_customer_id"), table_name="escalations")
    op.drop_index(op.f("ix_escalations_created_at"), table_name="escalations")
    op.drop_index(op.f("ix_escalations_conversation_id"), table_name="escalations")
    op.drop_index(op.f("ix_escalations_assigned_to_id"), table_name="escalations")
    op.create_index(op.f("ix_escalations_deadline"), "escalations", ["deadline"], unique=False)
    op.create_index(op.f("ix_escalations_booking_id"), "escalations", ["booking_id"], unique=False)
    op.create_index(
        op.f("idx_escalations_open_priority"),
        "escalations",
        ["status", "priority", "deadline"],
        unique=False,
    )
    op.alter_column(
        "escalations",
        "created_at",
        existing_type=sa.DateTime(timezone=True),
        type_=postgresql.TIMESTAMP(),
        existing_nullable=False,
        existing_server_default=sa.text("now()"),
    )
    op.alter_column(
        "escalations",
        "resolved_at",
        existing_type=sa.DateTime(timezone=True),
        type_=postgresql.TIMESTAMP(),
        existing_nullable=True,
    )
    op.alter_column(
        "escalations",
        "status",
        existing_type=sa.Enum(
            "pending",
            "assigned",
            "in_progress",
            "waiting_customer",
            "resolved",
            "closed",
            "error",
            name="escalationstatus",
        ),
        type_=sa.VARCHAR(length=20),
        existing_nullable=False,
    )
    op.alter_column(
        "escalations",
        "priority",
        existing_type=sa.Enum("low", "medium", "high", "urgent", name="escalationpriority"),
        type_=sa.VARCHAR(length=20),
        existing_nullable=False,
    )
    op.alter_column(
        "escalations",
        "reason",
        existing_type=sa.Text(),
        type_=sa.VARCHAR(length=255),
        existing_nullable=False,
    )
    op.alter_column(
        "escalations", "id", existing_type=sa.UUID(), type_=sa.INTEGER(), existing_nullable=False
    )
    op.drop_column("escalations", "customer_consent")
    op.drop_column("escalations", "updated_at")
    op.drop_column("escalations", "tags")
    op.drop_column("escalations", "escalation_metadata")
    op.drop_column("escalations", "retry_count")
    op.drop_column("escalations", "error_message")
    op.drop_column("escalations", "last_contact_at")
    op.drop_column("escalations", "call_initiated")
    op.drop_column("escalations", "sms_sent")
    op.drop_column("escalations", "admin_notification_channel")
    op.drop_column("escalations", "admin_notification_status")
    op.drop_column("escalations", "admin_notification_sid")
    op.drop_column("escalations", "admin_notified_at")
    op.drop_column("escalations", "resolved_by_id")
    op.drop_column("escalations", "assigned_at")
    op.drop_column("escalations", "assigned_to_id")
    op.drop_column("escalations", "preferred_method")
    op.drop_column("escalations", "email")
    op.drop_column("escalations", "phone")
    op.drop_column("escalations", "customer_id")
    op.drop_column("escalations", "conversation_id")
    op.create_unique_constraint(
        op.f("email_labels_slug_key"), "email_labels", ["slug"], postgresql_nulls_not_distinct=False
    )
    op.create_unique_constraint(
        op.f("email_labels_name_key"), "email_labels", ["name"], postgresql_nulls_not_distinct=False
    )
    op.add_column(
        "customer_tone_preferences",
        sa.Column("preferred_tone", sa.VARCHAR(length=20), autoincrement=False, nullable=False),
    )
    op.add_column(
        "customer_tone_preferences",
        sa.Column("last_interaction", postgresql.TIMESTAMP(), autoincrement=False, nullable=False),
    )
    op.add_column(
        "customer_tone_preferences",
        sa.Column(
            "tone_confidence", sa.NUMERIC(precision=3, scale=2), autoincrement=False, nullable=False
        ),
    )
    op.add_column(
        "customer_tone_preferences",
        sa.Column(
            "last_updated",
            postgresql.TIMESTAMP(),
            server_default=sa.text("now()"),
            autoincrement=False,
            nullable=False,
        ),
    )
    op.add_column(
        "customer_tone_preferences",
        sa.Column("interaction_count", sa.INTEGER(), autoincrement=False, nullable=False),
    )
    op.create_table_comment(
        "customer_tone_preferences",
        "Remember customer communication style for personalized responses",
        existing_comment=None,
        schema=None,
    )
    op.drop_constraint(
        op.f("fk_customer_tone_preferences_customer_id_customers"),
        "customer_tone_preferences",
        schema="public",
        type_="foreignkey",
    )
    op.drop_index("idx_tone_history", table_name="customer_tone_preferences", schema="public")
    op.drop_index("idx_tone_detected", table_name="customer_tone_preferences", schema="public")
    op.drop_index("idx_tone_date", table_name="customer_tone_preferences", schema="public")
    op.drop_index("idx_tone_customer", table_name="customer_tone_preferences", schema="public")
    op.drop_index("idx_tone_channel", table_name="customer_tone_preferences", schema="public")
    op.create_index(
        op.f("ix_customer_tone_preferences_customer_id"),
        "customer_tone_preferences",
        ["customer_id"],
        unique=True,
    )
    op.alter_column(
        "customer_tone_preferences",
        "created_at",
        existing_type=sa.DateTime(timezone=True),
        type_=postgresql.TIMESTAMP(),
        existing_nullable=False,
        existing_server_default=sa.text("now()"),
    )
    op.alter_column(
        "customer_tone_preferences",
        "customer_id",
        existing_type=sa.String(length=36),
        type_=sa.VARCHAR(length=50),
        existing_nullable=False,
    )
    op.alter_column(
        "customer_tone_preferences",
        "id",
        existing_type=sa.String(length=36),
        type_=sa.INTEGER(),
        existing_nullable=False,
    )
    op.drop_column("customer_tone_preferences", "interaction_date")
    op.drop_column("customer_tone_preferences", "message_sample")
    op.drop_column("customer_tone_preferences", "interaction_channel")
    op.drop_column("customer_tone_preferences", "confidence_score")
    op.drop_column("customer_tone_preferences", "detected_tone")
    op.drop_constraint(
        op.f("fk_customer_review_blog_posts_booking_id_bookings"),
        "customer_review_blog_posts",
        type_="foreignkey",
    )
    op.drop_constraint(
        op.f("fk_customer_review_blog_posts_customer_id_customers"),
        "customer_review_blog_posts",
        type_="foreignkey",
    )
    op.drop_index(op.f("ix_customer_review_blog_posts_id"), table_name="customer_review_blog_posts")
    op.create_index(
        op.f("idx_review_blog_status_created"),
        "customer_review_blog_posts",
        ["status", sa.literal_column("created_at DESC")],
        unique=False,
    )
    op.create_index(
        op.f("idx_review_blog_status"), "customer_review_blog_posts", ["status"], unique=False
    )
    op.create_index(
        op.f("idx_review_blog_rating"), "customer_review_blog_posts", ["rating"], unique=False
    )
    op.create_index(
        op.f("idx_review_blog_created_at"),
        "customer_review_blog_posts",
        [sa.literal_column("created_at DESC")],
        unique=False,
    )
    op.alter_column(
        "customer_review_blog_posts",
        "is_deleted",
        existing_type=sa.BOOLEAN(),
        nullable=True,
        existing_server_default=sa.text("false"),
    )
    op.alter_column(
        "customer_review_blog_posts",
        "updated_at",
        existing_type=postgresql.TIMESTAMP(),
        nullable=False,
        existing_server_default=sa.text("now()"),
    )
    op.alter_column(
        "customer_review_blog_posts",
        "created_at",
        existing_type=postgresql.TIMESTAMP(),
        nullable=False,
        existing_server_default=sa.text("now()"),
    )
    op.alter_column(
        "customer_review_blog_posts", "customer_id", existing_type=sa.INTEGER(), nullable=True
    )
    op.drop_index(op.f("ix_crm_contacts_phone_number"), table_name="crm_contacts")
    op.drop_index(op.f("ix_crm_contacts_email"), table_name="crm_contacts")
    op.create_index(op.f("idx_crm_contacts_phone"), "crm_contacts", ["phone_number"], unique=False)
    op.create_index(op.f("idx_crm_contacts_email"), "crm_contacts", ["email"], unique=False)
    op.create_index(op.f("idx_crm_contacts_created"), "crm_contacts", ["created_at"], unique=False)
    op.create_index(op.f("idx_crm_contacts_active"), "crm_contacts", ["is_active"], unique=False)
    op.add_column(
        "catering_payments",
        sa.Column("notification_id", sa.INTEGER(), autoincrement=False, nullable=True),
    )
    op.drop_constraint(
        op.f("fk_catering_payments_booking_id_catering_bookings"),
        "catering_payments",
        type_="foreignkey",
    )
    op.create_foreign_key(
        op.f("fk_catering_payments_booking_id"),
        "catering_payments",
        "bookings",
        ["booking_id"],
        ["id"],
        referent_schema="core",
        ondelete="CASCADE",
    )
    op.create_foreign_key(
        op.f("fk_catering_payments_notification_id"),
        "catering_payments",
        "payment_notifications",
        ["notification_id"],
        ["id"],
        ondelete="SET NULL",
    )
    op.drop_index(op.f("ix_catering_payments_transaction_id"), table_name="catering_payments")
    op.drop_index(op.f("ix_catering_payments_status"), table_name="catering_payments")
    op.drop_index(op.f("ix_catering_payments_payment_method"), table_name="catering_payments")
    op.drop_index(op.f("ix_catering_payments_id"), table_name="catering_payments")
    op.drop_index(op.f("ix_catering_payments_booking_id"), table_name="catering_payments")
    op.create_index(
        op.f("idx_payment_transaction_id"), "catering_payments", ["transaction_id"], unique=True
    )
    op.create_index(op.f("idx_payment_status"), "catering_payments", ["status"], unique=False)
    op.create_index(
        op.f("idx_payment_notification_id"), "catering_payments", ["notification_id"], unique=False
    )
    op.create_index(
        op.f("idx_payment_method"), "catering_payments", ["payment_method"], unique=False
    )
    op.create_index(
        op.f("idx_payment_booking_id"), "catering_payments", ["booking_id"], unique=False
    )
    op.alter_column(
        "catering_payments",
        "updated_at",
        existing_type=postgresql.TIMESTAMP(),
        nullable=False,
        existing_server_default=sa.text("CURRENT_TIMESTAMP"),
    )
    op.alter_column(
        "catering_payments",
        "created_at",
        existing_type=postgresql.TIMESTAMP(),
        nullable=False,
        existing_server_default=sa.text("CURRENT_TIMESTAMP"),
    )
    op.alter_column(
        "catering_payments",
        "booking_id",
        existing_type=sa.Integer(),
        type_=sa.UUID(),
        existing_nullable=False,
    )
    op.drop_column("catering_payments", "is_deleted")
    op.drop_constraint(op.f("uq_businesses_domain"), "businesses", type_="unique")
    op.drop_index(op.f("ix_businesses_slug"), table_name="businesses")
    op.create_unique_constraint(
        op.f("businesses_slug_key"), "businesses", ["slug"], postgresql_nulls_not_distinct=False
    )
    op.create_unique_constraint(
        op.f("businesses_domain_key"), "businesses", ["domain"], postgresql_nulls_not_distinct=False
    )
    op.add_column(
        "business_rules",
        sa.Column(
            "value", postgresql.JSONB(astext_type=sa.Text()), autoincrement=False, nullable=True
        ),
    )
    op.add_column(
        "business_rules",
        sa.Column("rule_type", sa.VARCHAR(length=50), autoincrement=False, nullable=False),
    )
    op.add_column(
        "business_rules", sa.Column("content", sa.TEXT(), autoincrement=False, nullable=False)
    )
    op.add_column(
        "business_rules",
        sa.Column("updated_by", sa.VARCHAR(length=100), autoincrement=False, nullable=True),
    )
    op.add_column(
        "business_rules",
        sa.Column(
            "last_updated",
            postgresql.TIMESTAMP(),
            server_default=sa.text("now()"),
            autoincrement=False,
            nullable=False,
        ),
    )
    op.add_column(
        "business_rules",
        sa.Column("title", sa.VARCHAR(length=255), autoincrement=False, nullable=False),
    )
    op.create_table_comment(
        "business_rules",
        "Dynamic business policies for AI (cancellation, deposit, refund, etc.)",
        existing_comment=None,
        schema=None,
    )
    op.drop_index("idx_business_rules_station", table_name="business_rules", schema="public")
    op.drop_index("idx_business_rules_lookup", table_name="business_rules", schema="public")
    op.drop_index(
        "idx_business_rules_keywords",
        table_name="business_rules",
        schema="public",
        postgresql_using="gin",
    )
    op.drop_index("idx_business_rules_effective", table_name="business_rules", schema="public")
    op.drop_index("idx_business_rules_category", table_name="business_rules", schema="public")
    op.drop_index("idx_business_rules_active", table_name="business_rules", schema="public")
    op.create_index(
        op.f("idx_business_rules_active"),
        "business_rules",
        ["rule_type", "is_active"],
        unique=False,
    )
    op.create_index(
        op.f("ix_business_rules_rule_type"), "business_rules", ["rule_type"], unique=False
    )
    op.create_index(
        op.f("ix_business_rules_is_active"), "business_rules", ["is_active"], unique=False
    )
    op.alter_column("business_rules", "version", existing_type=sa.INTEGER(), nullable=False)
    op.alter_column(
        "business_rules",
        "created_at",
        existing_type=sa.DateTime(timezone=True),
        type_=postgresql.TIMESTAMP(),
        existing_nullable=False,
        existing_server_default=sa.text("now()"),
    )
    op.alter_column("business_rules", "is_active", existing_type=sa.BOOLEAN(), nullable=False)
    op.alter_column(
        "business_rules",
        "id",
        existing_type=sa.String(length=36),
        type_=sa.INTEGER(),
        existing_nullable=False,
    )
    op.drop_column("business_rules", "updated_at")
    op.drop_column("business_rules", "effective_until")
    op.drop_column("business_rules", "effective_from")
    op.drop_column("business_rules", "station_id")
    op.drop_column("business_rules", "priority")
    op.drop_column("business_rules", "keywords")
    op.drop_column("business_rules", "rule_summary")
    op.drop_column("business_rules", "rule_content")
    op.drop_column("business_rules", "rule_name")
    op.drop_column("business_rules", "category")
    op.add_column(
        "availability_calendar",
        sa.Column("reason", sa.VARCHAR(length=255), autoincrement=False, nullable=True),
    )
    op.add_column(
        "availability_calendar",
        sa.Column("booking_id", sa.VARCHAR(length=50), autoincrement=False, nullable=True),
    )
    op.add_column(
        "availability_calendar",
        sa.Column(
            "last_updated",
            postgresql.TIMESTAMP(),
            server_default=sa.text("now()"),
            autoincrement=False,
            nullable=False,
        ),
    )
    op.create_table_comment(
        "availability_calendar",
        "Chef availability tracking for AI booking suggestions",
        existing_comment=None,
        schema=None,
    )
    op.drop_index("idx_calendar_station", table_name="availability_calendar", schema="public")
    op.drop_index("idx_calendar_datetime", table_name="availability_calendar", schema="public")
    op.drop_index("idx_calendar_date", table_name="availability_calendar", schema="public")
    op.drop_index("idx_calendar_available", table_name="availability_calendar", schema="public")
    op.create_index(
        op.f("ix_availability_calendar_time_slot"),
        "availability_calendar",
        ["time_slot"],
        unique=False,
    )
    op.create_index(
        op.f("ix_availability_calendar_date"), "availability_calendar", ["date"], unique=False
    )
    op.create_index(
        op.f("idx_availability_date_time"),
        "availability_calendar",
        ["date", "time_slot", "is_available"],
        unique=False,
    )
    op.alter_column(
        "availability_calendar",
        "created_at",
        existing_type=sa.DateTime(timezone=True),
        type_=postgresql.TIMESTAMP(),
        existing_nullable=False,
        existing_server_default=sa.text("now()"),
    )
    op.alter_column(
        "availability_calendar", "is_available", existing_type=sa.BOOLEAN(), nullable=False
    )
    op.alter_column(
        "availability_calendar",
        "time_slot",
        existing_type=sa.Time(),
        type_=sa.VARCHAR(length=20),
        existing_nullable=False,
    )
    op.alter_column(
        "availability_calendar",
        "id",
        existing_type=sa.String(length=36),
        type_=sa.INTEGER(),
        existing_nullable=False,
    )
    op.drop_column("availability_calendar", "updated_at")
    op.drop_column("availability_calendar", "station_id")
    op.drop_column("availability_calendar", "blackout_reason")
    op.drop_column("availability_calendar", "booked_capacity")
    op.drop_column("availability_calendar", "max_capacity")
    op.create_table(
        "bookings",
        sa.Column("id", sa.INTEGER(), autoincrement=True, nullable=False),
        sa.Column("customer_id", sa.VARCHAR(), autoincrement=False, nullable=False),
        sa.Column("booking_datetime", postgresql.TIMESTAMP(), autoincrement=False, nullable=False),
        sa.Column("party_size", sa.INTEGER(), autoincrement=False, nullable=False),
        sa.Column(
            "status",
            postgresql.ENUM(
                "pending",
                "confirmed",
                "seated",
                "completed",
                "cancelled",
                "no_show",
                name="bookingstatus",
            ),
            server_default=sa.text("'pending'::bookingstatus"),
            autoincrement=False,
            nullable=False,
        ),
        sa.Column(
            "version",
            sa.INTEGER(),
            server_default=sa.text("1"),
            autoincrement=False,
            nullable=False,
        ),
        sa.Column("contact_phone", sa.VARCHAR(length=20), autoincrement=False, nullable=True),
        sa.Column("contact_email", sa.VARCHAR(length=255), autoincrement=False, nullable=True),
        sa.Column(
            "sms_consent",
            sa.BOOLEAN(),
            server_default=sa.text("false"),
            autoincrement=False,
            nullable=False,
        ),
        sa.Column(
            "sms_consent_timestamp", postgresql.TIMESTAMP(), autoincrement=False, nullable=True
        ),
        sa.Column("special_requests", sa.TEXT(), autoincrement=False, nullable=True),
        sa.Column("internal_notes", sa.TEXT(), autoincrement=False, nullable=True),
        sa.Column("confirmed_at", postgresql.TIMESTAMP(), autoincrement=False, nullable=True),
        sa.Column("seated_at", postgresql.TIMESTAMP(), autoincrement=False, nullable=True),
        sa.Column("completed_at", postgresql.TIMESTAMP(), autoincrement=False, nullable=True),
        sa.Column("cancelled_at", postgresql.TIMESTAMP(), autoincrement=False, nullable=True),
        sa.Column("cancellation_reason", sa.TEXT(), autoincrement=False, nullable=True),
        sa.Column(
            "customer_deposit_deadline", postgresql.TIMESTAMP(), autoincrement=False, nullable=True
        ),
        sa.Column("internal_deadline", postgresql.TIMESTAMP(), autoincrement=False, nullable=True),
        sa.Column("deposit_deadline", postgresql.TIMESTAMP(), autoincrement=False, nullable=True),
        sa.Column(
            "deposit_confirmed_at", postgresql.TIMESTAMP(), autoincrement=False, nullable=True
        ),
        sa.Column(
            "deposit_confirmed_by", sa.VARCHAR(length=255), autoincrement=False, nullable=True
        ),
        sa.Column(
            "hold_on_request",
            sa.BOOLEAN(),
            server_default=sa.text("false"),
            autoincrement=False,
            nullable=False,
        ),
        sa.Column("held_by", sa.VARCHAR(length=255), autoincrement=False, nullable=True),
        sa.Column("held_at", postgresql.TIMESTAMP(), autoincrement=False, nullable=True),
        sa.Column("hold_reason", sa.TEXT(), autoincrement=False, nullable=True),
        sa.Column("table_number", sa.VARCHAR(length=10), autoincrement=False, nullable=True),
        sa.Column(
            "created_at",
            postgresql.TIMESTAMP(),
            server_default=sa.text("CURRENT_TIMESTAMP"),
            autoincrement=False,
            nullable=False,
        ),
        sa.Column(
            "updated_at",
            postgresql.TIMESTAMP(),
            server_default=sa.text("CURRENT_TIMESTAMP"),
            autoincrement=False,
            nullable=False,
        ),
        sa.ForeignKeyConstraint(
            ["customer_id"],
            ["customers.id"],
            name=op.f("fk_bookings_customer_id_customers"),
            ondelete="CASCADE",
        ),
        sa.PrimaryKeyConstraint("id", name=op.f("pk_bookings")),
    )
    op.create_index(op.f("ix_bookings_status"), "bookings", ["status"], unique=False)
    op.create_index(
        op.f("ix_bookings_internal_deadline"), "bookings", ["internal_deadline"], unique=False
    )
    op.create_index(op.f("ix_bookings_customer_id"), "bookings", ["customer_id"], unique=False)
    op.create_index(
        op.f("ix_bookings_customer_deposit_deadline"),
        "bookings",
        ["customer_deposit_deadline"],
        unique=False,
    )
    op.create_index(
        op.f("ix_bookings_booking_datetime"), "bookings", ["booking_datetime"], unique=False
    )
    op.create_table(
        "refunds",
        sa.Column("id", sa.VARCHAR(), autoincrement=False, nullable=False),
        sa.Column("stripe_refund_id", sa.VARCHAR(), autoincrement=False, nullable=False),
        sa.Column("payment_id", sa.VARCHAR(), autoincrement=False, nullable=True),
        sa.Column("amount", sa.NUMERIC(precision=10, scale=2), autoincrement=False, nullable=False),
        sa.Column("currency", sa.VARCHAR(), autoincrement=False, nullable=True),
        sa.Column("status", sa.VARCHAR(), autoincrement=False, nullable=False),
        sa.Column("reason", sa.VARCHAR(), autoincrement=False, nullable=True),
        sa.Column("requested_by", sa.VARCHAR(), autoincrement=False, nullable=True),
        sa.Column("notes", sa.TEXT(), autoincrement=False, nullable=True),
        sa.Column(
            "created_at",
            postgresql.TIMESTAMP(timezone=True),
            server_default=sa.text("now()"),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column(
            "updated_at", postgresql.TIMESTAMP(timezone=True), autoincrement=False, nullable=True
        ),
        sa.ForeignKeyConstraint(
            ["payment_id"], ["payments.id"], name=op.f("refunds_payment_id_fkey")
        ),
        sa.PrimaryKeyConstraint("id", name=op.f("refunds_pkey")),
    )
    op.create_index(
        op.f("ix_refunds_stripe_refund_id"), "refunds", ["stripe_refund_id"], unique=True
    )
    op.create_table(
        "prices",
        sa.Column("id", sa.VARCHAR(), autoincrement=False, nullable=False),
        sa.Column("stripe_price_id", sa.VARCHAR(), autoincrement=False, nullable=False),
        sa.Column("product_id", sa.VARCHAR(), autoincrement=False, nullable=True),
        sa.Column("stripe_product_id", sa.VARCHAR(), autoincrement=False, nullable=False),
        sa.Column("unit_amount", sa.INTEGER(), autoincrement=False, nullable=False),
        sa.Column("currency", sa.VARCHAR(), autoincrement=False, nullable=True),
        sa.Column("active", sa.BOOLEAN(), autoincrement=False, nullable=True),
        sa.Column("recurring_interval", sa.VARCHAR(), autoincrement=False, nullable=True),
        sa.Column("recurring_interval_count", sa.INTEGER(), autoincrement=False, nullable=True),
        sa.Column("nickname", sa.VARCHAR(), autoincrement=False, nullable=True),
        sa.Column(
            "created_at",
            postgresql.TIMESTAMP(timezone=True),
            server_default=sa.text("now()"),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column(
            "updated_at", postgresql.TIMESTAMP(timezone=True), autoincrement=False, nullable=True
        ),
        sa.ForeignKeyConstraint(
            ["product_id"], ["products.id"], name=op.f("prices_product_id_fkey")
        ),
        sa.PrimaryKeyConstraint("id", name=op.f("prices_pkey")),
    )
    op.create_index(op.f("ix_prices_stripe_price_id"), "prices", ["stripe_price_id"], unique=True)
    op.create_table(
        "audit_logs",
        sa.Column(
            "id",
            sa.UUID(),
            server_default=sa.text("gen_random_uuid()"),
            autoincrement=False,
            nullable=False,
        ),
        sa.Column(
            "created_at",
            postgresql.TIMESTAMP(timezone=True),
            server_default=sa.text("CURRENT_TIMESTAMP"),
            autoincrement=False,
            nullable=False,
        ),
        sa.Column(
            "user_id",
            sa.UUID(),
            autoincrement=False,
            nullable=False,
            comment="User who performed the action",
        ),
        sa.Column(
            "user_role",
            sa.VARCHAR(length=50),
            autoincrement=False,
            nullable=False,
            comment="Role of user at time of action",
        ),
        sa.Column(
            "user_name",
            sa.VARCHAR(length=255),
            autoincrement=False,
            nullable=False,
            comment="Display name of user",
        ),
        sa.Column(
            "user_email",
            sa.VARCHAR(length=255),
            autoincrement=False,
            nullable=False,
            comment="Email of user",
        ),
        sa.Column(
            "action",
            postgresql.ENUM("VIEW", "CREATE", "UPDATE", "DELETE", name="audit_action"),
            autoincrement=False,
            nullable=False,
        ),
        sa.Column(
            "resource_type",
            sa.VARCHAR(length=50),
            autoincrement=False,
            nullable=False,
            comment="Type of resource (booking, customer, etc)",
        ),
        sa.Column(
            "resource_id",
            sa.VARCHAR(length=255),
            autoincrement=False,
            nullable=False,
            comment="ID of affected resource",
        ),
        sa.Column(
            "resource_name",
            sa.VARCHAR(length=255),
            autoincrement=False,
            nullable=True,
            comment="Friendly name for UI display",
        ),
        sa.Column(
            "ip_address",
            postgresql.INET(),
            autoincrement=False,
            nullable=True,
            comment="IP address of request",
        ),
        sa.Column(
            "user_agent",
            sa.TEXT(),
            autoincrement=False,
            nullable=True,
            comment="Browser/device information",
        ),
        sa.Column(
            "station_id",
            sa.UUID(),
            autoincrement=False,
            nullable=True,
            comment="Station context if applicable",
        ),
        sa.Column(
            "delete_reason",
            sa.TEXT(),
            autoincrement=False,
            nullable=True,
            comment="Reason for deletion (required for DELETE)",
        ),
        sa.Column(
            "old_values",
            postgresql.JSONB(astext_type=sa.Text()),
            autoincrement=False,
            nullable=True,
            comment="State before change (JSON)",
        ),
        sa.Column(
            "new_values",
            postgresql.JSONB(astext_type=sa.Text()),
            autoincrement=False,
            nullable=True,
            comment="State after change (JSON)",
        ),
        sa.Column(
            "metadata",
            postgresql.JSONB(astext_type=sa.Text()),
            autoincrement=False,
            nullable=True,
            comment="Additional context",
        ),
        sa.CheckConstraint(
            "action <> 'DELETE'::audit_action OR delete_reason IS NOT NULL AND length(delete_reason) >= 10",
            name=op.f("delete_must_have_reason"),
        ),
        sa.PrimaryKeyConstraint("id", name=op.f("audit_logs_pkey")),
        comment="Comprehensive audit log for all admin actions",
    )
    op.create_index(op.f("idx_audit_logs_user_role"), "audit_logs", ["user_role"], unique=False)
    op.create_index(op.f("idx_audit_logs_user_id"), "audit_logs", ["user_id"], unique=False)
    op.create_index(
        op.f("idx_audit_logs_user_created"),
        "audit_logs",
        ["user_id", sa.literal_column("created_at DESC")],
        unique=False,
    )
    op.create_index(
        op.f("idx_audit_logs_station_id"),
        "audit_logs",
        ["station_id"],
        unique=False,
        postgresql_where="(station_id IS NOT NULL)",
    )
    op.create_index(
        op.f("idx_audit_logs_resource_action"),
        "audit_logs",
        ["resource_type", "resource_id", "action"],
        unique=False,
    )
    op.create_index(
        op.f("idx_audit_logs_resource"),
        "audit_logs",
        ["resource_type", "resource_id"],
        unique=False,
    )
    op.create_index(
        op.f("idx_audit_logs_created_at"),
        "audit_logs",
        [sa.literal_column("created_at DESC")],
        unique=False,
    )
    op.create_index(op.f("idx_audit_logs_action"), "audit_logs", ["action"], unique=False)
    op.create_table(
        "alert_rules",
        sa.Column("id", sa.INTEGER(), autoincrement=True, nullable=False),
        sa.Column("name", sa.VARCHAR(length=255), autoincrement=False, nullable=False),
        sa.Column("description", sa.VARCHAR(length=1000), autoincrement=False, nullable=True),
        sa.Column("metric_name", sa.VARCHAR(length=100), autoincrement=False, nullable=False),
        sa.Column("operator", sa.VARCHAR(length=10), autoincrement=False, nullable=False),
        sa.Column(
            "threshold_value",
            sa.DOUBLE_PRECISION(precision=53),
            autoincrement=False,
            nullable=False,
        ),
        sa.Column(
            "duration_seconds",
            sa.INTEGER(),
            server_default=sa.text("0"),
            autoincrement=False,
            nullable=False,
        ),
        sa.Column(
            "cooldown_seconds",
            sa.INTEGER(),
            server_default=sa.text("300"),
            autoincrement=False,
            nullable=False,
        ),
        sa.Column(
            "severity",
            sa.VARCHAR(length=20),
            server_default=sa.text("'medium'::character varying"),
            autoincrement=False,
            nullable=False,
        ),
        sa.Column(
            "enabled",
            sa.BOOLEAN(),
            server_default=sa.text("true"),
            autoincrement=False,
            nullable=False,
        ),
        sa.Column(
            "alert_title_template", sa.VARCHAR(length=500), autoincrement=False, nullable=True
        ),
        sa.Column(
            "alert_message_template", sa.VARCHAR(length=2000), autoincrement=False, nullable=True
        ),
        sa.Column(
            "tags", postgresql.JSONB(astext_type=sa.Text()), autoincrement=False, nullable=True
        ),
        sa.Column(
            "metadata", postgresql.JSONB(astext_type=sa.Text()), autoincrement=False, nullable=True
        ),
        sa.Column(
            "created_at",
            postgresql.TIMESTAMP(timezone=True),
            server_default=sa.text("now()"),
            autoincrement=False,
            nullable=False,
        ),
        sa.Column(
            "updated_at", postgresql.TIMESTAMP(timezone=True), autoincrement=False, nullable=True
        ),
        sa.Column(
            "last_triggered_at",
            postgresql.TIMESTAMP(timezone=True),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column(
            "trigger_count",
            sa.INTEGER(),
            server_default=sa.text("0"),
            autoincrement=False,
            nullable=False,
        ),
        sa.PrimaryKeyConstraint("id", name=op.f("alert_rules_pkey")),
    )
    op.create_index(op.f("ix_alert_rules_name"), "alert_rules", ["name"], unique=True)
    op.create_index(
        op.f("ix_alert_rules_metric_name"), "alert_rules", ["metric_name"], unique=False
    )
    op.create_index(op.f("ix_alert_rules_id"), "alert_rules", ["id"], unique=False)
    op.create_index(op.f("ix_alert_rules_enabled"), "alert_rules", ["enabled"], unique=False)
    op.create_table(
        "invoices",
        sa.Column("id", sa.VARCHAR(), autoincrement=False, nullable=False),
        sa.Column("user_id", sa.VARCHAR(), autoincrement=False, nullable=False),
        sa.Column("booking_id", sa.VARCHAR(), autoincrement=False, nullable=True),
        sa.Column("stripe_invoice_id", sa.VARCHAR(), autoincrement=False, nullable=True),
        sa.Column("stripe_customer_id", sa.VARCHAR(), autoincrement=False, nullable=True),
        sa.Column(
            "amount_due", sa.NUMERIC(precision=10, scale=2), autoincrement=False, nullable=False
        ),
        sa.Column(
            "amount_paid", sa.NUMERIC(precision=10, scale=2), autoincrement=False, nullable=True
        ),
        sa.Column("currency", sa.VARCHAR(), autoincrement=False, nullable=True),
        sa.Column("status", sa.VARCHAR(), autoincrement=False, nullable=False),
        sa.Column("hosted_invoice_url", sa.VARCHAR(), autoincrement=False, nullable=True),
        sa.Column("invoice_pdf_url", sa.VARCHAR(), autoincrement=False, nullable=True),
        sa.Column(
            "due_date", postgresql.TIMESTAMP(timezone=True), autoincrement=False, nullable=True
        ),
        sa.Column(
            "paid_at", postgresql.TIMESTAMP(timezone=True), autoincrement=False, nullable=True
        ),
        sa.Column(
            "created_at",
            postgresql.TIMESTAMP(timezone=True),
            server_default=sa.text("now()"),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column(
            "updated_at", postgresql.TIMESTAMP(timezone=True), autoincrement=False, nullable=True
        ),
        sa.ForeignKeyConstraint(
            ["stripe_customer_id"],
            ["customers.stripe_customer_id"],
            name=op.f("invoices_stripe_customer_id_fkey"),
        ),
        sa.PrimaryKeyConstraint("id", name=op.f("invoices_pkey")),
    )
    op.create_index(op.f("ix_invoices_user_id"), "invoices", ["user_id"], unique=False)
    op.create_index(
        op.f("ix_invoices_stripe_invoice_id"), "invoices", ["stripe_invoice_id"], unique=True
    )
    op.create_index(op.f("ix_invoices_status"), "invoices", ["status"], unique=False)
    op.create_index(op.f("ix_invoices_booking_id"), "invoices", ["booking_id"], unique=False)
    op.create_index(
        op.f("idx_invoices_user_booking"), "invoices", ["user_id", "booking_id"], unique=False
    )
    op.create_table(
        "automated_reminders",
        sa.Column("id", sa.INTEGER(), autoincrement=True, nullable=False),
        sa.Column("booking_id", sa.VARCHAR(length=50), autoincrement=False, nullable=False),
        sa.Column("reminder_type", sa.VARCHAR(length=50), autoincrement=False, nullable=False),
        sa.Column("scheduled_at", postgresql.TIMESTAMP(), autoincrement=False, nullable=False),
        sa.Column("sent_at", postgresql.TIMESTAMP(), autoincrement=False, nullable=True),
        sa.Column("status", sa.VARCHAR(length=20), autoincrement=False, nullable=False),
        sa.Column("channel", sa.VARCHAR(length=20), autoincrement=False, nullable=False),
        sa.Column("message_content", sa.TEXT(), autoincrement=False, nullable=True),
        sa.Column("response_received", sa.BOOLEAN(), autoincrement=False, nullable=False),
        sa.Column("customer_response", sa.TEXT(), autoincrement=False, nullable=True),
        sa.Column(
            "created_at",
            postgresql.TIMESTAMP(),
            server_default=sa.text("now()"),
            autoincrement=False,
            nullable=False,
        ),
        sa.PrimaryKeyConstraint("id", name=op.f("automated_reminders_pkey")),
        comment="Track automated reminder sends (7-day, 4-day, 24-hour, post-event)",
    )
    op.create_index(
        op.f("ix_automated_reminders_status"), "automated_reminders", ["status"], unique=False
    )
    op.create_index(
        op.f("ix_automated_reminders_scheduled_at"),
        "automated_reminders",
        ["scheduled_at"],
        unique=False,
    )
    op.create_index(
        op.f("ix_automated_reminders_reminder_type"),
        "automated_reminders",
        ["reminder_type"],
        unique=False,
    )
    op.create_index(
        op.f("ix_automated_reminders_booking_id"),
        "automated_reminders",
        ["booking_id"],
        unique=False,
    )
    op.create_index(
        op.f("idx_automated_reminders_pending"),
        "automated_reminders",
        ["status", "scheduled_at"],
        unique=False,
    )
    op.create_table(
        "payments",
        sa.Column("id", sa.VARCHAR(), autoincrement=False, nullable=False),
        sa.Column("user_id", sa.VARCHAR(), autoincrement=False, nullable=False),
        sa.Column("booking_id", sa.VARCHAR(), autoincrement=False, nullable=True),
        sa.Column("stripe_payment_intent_id", sa.VARCHAR(), autoincrement=False, nullable=True),
        sa.Column("stripe_customer_id", sa.VARCHAR(), autoincrement=False, nullable=True),
        sa.Column("amount", sa.NUMERIC(precision=10, scale=2), autoincrement=False, nullable=False),
        sa.Column("currency", sa.VARCHAR(), autoincrement=False, nullable=True),
        sa.Column("status", sa.VARCHAR(), autoincrement=False, nullable=False),
        sa.Column("method", sa.VARCHAR(), autoincrement=False, nullable=False),
        sa.Column("payment_type", sa.VARCHAR(), autoincrement=False, nullable=True),
        sa.Column("description", sa.TEXT(), autoincrement=False, nullable=True),
        sa.Column("metadata_json", sa.TEXT(), autoincrement=False, nullable=True),
        sa.Column(
            "stripe_fee", sa.NUMERIC(precision=10, scale=2), autoincrement=False, nullable=True
        ),
        sa.Column(
            "net_amount", sa.NUMERIC(precision=10, scale=2), autoincrement=False, nullable=True
        ),
        sa.Column(
            "created_at",
            postgresql.TIMESTAMP(timezone=True),
            server_default=sa.text("now()"),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column(
            "updated_at", postgresql.TIMESTAMP(timezone=True), autoincrement=False, nullable=True
        ),
        sa.ForeignKeyConstraint(
            ["stripe_customer_id"],
            ["customers.stripe_customer_id"],
            name="payments_stripe_customer_id_fkey",
        ),
        sa.PrimaryKeyConstraint("id", name="payments_pkey"),
        postgresql_ignore_search_path=False,
    )
    op.create_index(op.f("ix_payments_user_id"), "payments", ["user_id"], unique=False)
    op.create_index(
        op.f("ix_payments_stripe_payment_intent_id"),
        "payments",
        ["stripe_payment_intent_id"],
        unique=True,
    )
    op.create_index(op.f("ix_payments_status"), "payments", ["status"], unique=False)
    op.create_index(op.f("ix_payments_booking_id"), "payments", ["booking_id"], unique=False)
    op.create_index(
        op.f("idx_payments_user_booking"), "payments", ["user_id", "booking_id"], unique=False
    )
    op.create_index(
        op.f("idx_payments_status_method"), "payments", ["status", "method"], unique=False
    )
    op.create_table(
        "users",
        sa.Column(
            "id",
            sa.UUID(),
            server_default=sa.text("gen_random_uuid()"),
            autoincrement=False,
            nullable=False,
        ),
        sa.Column("email", sa.VARCHAR(length=255), autoincrement=False, nullable=False),
        sa.Column("password_hash", sa.VARCHAR(length=255), autoincrement=False, nullable=False),
        sa.Column("first_name", sa.VARCHAR(length=100), autoincrement=False, nullable=False),
        sa.Column("last_name", sa.VARCHAR(length=100), autoincrement=False, nullable=False),
        sa.Column("phone", sa.VARCHAR(length=20), autoincrement=False, nullable=True),
        sa.Column(
            "role",
            sa.VARCHAR(length=20),
            server_default=sa.text("'customer'::character varying"),
            autoincrement=False,
            nullable=False,
        ),
        sa.Column(
            "is_active",
            sa.BOOLEAN(),
            server_default=sa.text("true"),
            autoincrement=False,
            nullable=False,
        ),
        sa.Column(
            "is_verified",
            sa.BOOLEAN(),
            server_default=sa.text("false"),
            autoincrement=False,
            nullable=False,
        ),
        sa.Column(
            "created_at",
            postgresql.TIMESTAMP(timezone=True),
            server_default=sa.text("now()"),
            autoincrement=False,
            nullable=False,
        ),
        sa.Column(
            "updated_at",
            postgresql.TIMESTAMP(timezone=True),
            server_default=sa.text("now()"),
            autoincrement=False,
            nullable=False,
        ),
        sa.CheckConstraint(
            "role::text = ANY (ARRAY['customer'::character varying, 'admin'::character varying, 'super_admin'::character varying, 'staff'::character varying]::text[])",
            name=op.f("ck_users_role_valid"),
        ),
        sa.PrimaryKeyConstraint("id", name=op.f("users_pkey")),
        sa.UniqueConstraint(
            "email",
            name=op.f("uq_users_email"),
            postgresql_include=[],
            postgresql_nulls_not_distinct=False,
        ),
    )
    op.create_index(op.f("idx_users_role"), "users", ["role"], unique=False)
    op.create_index(op.f("idx_users_email"), "users", ["email"], unique=True)
    op.create_index(op.f("idx_users_active"), "users", ["is_active"], unique=False)
    op.create_table(
        "message_log",
        sa.Column(
            "id",
            sa.UUID(),
            server_default=sa.text("gen_random_uuid()"),
            autoincrement=False,
            nullable=False,
        ),
        sa.Column("contact", sa.VARCHAR(length=255), autoincrement=False, nullable=False),
        sa.Column("channel", sa.VARCHAR(length=20), autoincrement=False, nullable=False),
        sa.Column("message_type", sa.VARCHAR(length=50), autoincrement=False, nullable=False),
        sa.Column("campaign_id", sa.UUID(), autoincrement=False, nullable=True),
        sa.Column("lead_id", sa.UUID(), autoincrement=False, nullable=True),
        sa.Column("customer_id", sa.UUID(), autoincrement=False, nullable=True),
        sa.Column(
            "sent_at",
            postgresql.TIMESTAMP(timezone=True),
            server_default=sa.text("now()"),
            autoincrement=False,
            nullable=False,
        ),
        sa.Column("status", sa.VARCHAR(length=20), autoincrement=False, nullable=False),
        sa.Column(
            "created_at",
            postgresql.TIMESTAMP(timezone=True),
            server_default=sa.text("now()"),
            autoincrement=False,
            nullable=False,
        ),
        sa.PrimaryKeyConstraint("id", name=op.f("message_log_pkey")),
    )
    op.create_index(op.f("ix_message_log_sent_at"), "message_log", ["sent_at"], unique=False)
    op.create_index(op.f("ix_message_log_lead_id"), "message_log", ["lead_id"], unique=False)
    op.create_index(
        op.f("ix_message_log_frequency_check"),
        "message_log",
        ["contact", "channel", "sent_at"],
        unique=False,
    )
    op.create_index(
        op.f("ix_message_log_customer_id"), "message_log", ["customer_id"], unique=False
    )
    op.create_index(op.f("ix_message_log_contact"), "message_log", ["contact"], unique=False)
    op.create_index(op.f("ix_message_log_channel"), "message_log", ["channel"], unique=False)
    op.create_index(
        op.f("ix_message_log_campaign_id"), "message_log", ["campaign_id"], unique=False
    )
    op.create_table(
        "error_logs",
        sa.Column("id", sa.INTEGER(), autoincrement=True, nullable=False),
        sa.Column("correlation_id", sa.VARCHAR(length=36), autoincrement=False, nullable=False),
        sa.Column("timestamp", postgresql.TIMESTAMP(), autoincrement=False, nullable=True),
        sa.Column("method", sa.VARCHAR(length=10), autoincrement=False, nullable=True),
        sa.Column("path", sa.VARCHAR(length=512), autoincrement=False, nullable=True),
        sa.Column("client_ip", sa.VARCHAR(length=45), autoincrement=False, nullable=True),
        sa.Column("user_id", sa.INTEGER(), autoincrement=False, nullable=True),
        sa.Column("user_role", sa.VARCHAR(length=50), autoincrement=False, nullable=True),
        sa.Column("error_type", sa.VARCHAR(length=100), autoincrement=False, nullable=True),
        sa.Column("error_message", sa.TEXT(), autoincrement=False, nullable=True),
        sa.Column("error_traceback", sa.TEXT(), autoincrement=False, nullable=True),
        sa.Column("status_code", sa.INTEGER(), autoincrement=False, nullable=True),
        sa.Column("request_body", sa.TEXT(), autoincrement=False, nullable=True),
        sa.Column("request_headers", sa.TEXT(), autoincrement=False, nullable=True),
        sa.Column("user_agent", sa.VARCHAR(length=512), autoincrement=False, nullable=True),
        sa.Column("response_time_ms", sa.INTEGER(), autoincrement=False, nullable=True),
        sa.Column("level", sa.VARCHAR(length=20), autoincrement=False, nullable=True),
        sa.Column("resolved", sa.INTEGER(), autoincrement=False, nullable=True),
        sa.Column("resolved_at", postgresql.TIMESTAMP(), autoincrement=False, nullable=True),
        sa.Column("resolved_by", sa.INTEGER(), autoincrement=False, nullable=True),
        sa.Column("resolution_notes", sa.TEXT(), autoincrement=False, nullable=True),
        sa.PrimaryKeyConstraint("id", name=op.f("error_logs_pkey")),
    )
    op.create_index(op.f("ix_error_logs_user_id"), "error_logs", ["user_id"], unique=False)
    op.create_index(op.f("ix_error_logs_timestamp"), "error_logs", ["timestamp"], unique=False)
    op.create_index(op.f("ix_error_logs_level"), "error_logs", ["level"], unique=False)
    op.create_index(
        op.f("ix_error_logs_correlation_id"), "error_logs", ["correlation_id"], unique=False
    )
    op.create_table(
        "referrals",
        sa.Column(
            "id",
            sa.UUID(),
            server_default=sa.text("gen_random_uuid()"),
            autoincrement=False,
            nullable=False,
        ),
        sa.Column("customer_id", sa.UUID(), autoincrement=False, nullable=True),
        sa.Column("referral_code", sa.VARCHAR(length=20), autoincrement=False, nullable=False),
        sa.Column("total_referrals", sa.INTEGER(), autoincrement=False, nullable=False),
        sa.Column("total_conversions", sa.INTEGER(), autoincrement=False, nullable=False),
        sa.Column(
            "created_at",
            postgresql.TIMESTAMP(timezone=True),
            server_default=sa.text("now()"),
            autoincrement=False,
            nullable=False,
        ),
        sa.Column(
            "updated_at",
            postgresql.TIMESTAMP(timezone=True),
            server_default=sa.text("now()"),
            autoincrement=False,
            nullable=False,
        ),
        sa.PrimaryKeyConstraint("id", name="referrals_pkey"),
        postgresql_ignore_search_path=False,
    )
    op.create_index(op.f("ix_referrals_referral_code"), "referrals", ["referral_code"], unique=True)
    op.create_index(op.f("ix_referrals_customer_id"), "referrals", ["customer_id"], unique=False)
    op.create_table(
        "ai_messages_legacy",
        sa.Column("id", sa.VARCHAR(length=100), autoincrement=False, nullable=False),
        sa.Column("conversation_id", sa.VARCHAR(length=100), autoincrement=False, nullable=False),
        sa.Column("role", sa.VARCHAR(length=20), autoincrement=False, nullable=False),
        sa.Column("content", sa.TEXT(), autoincrement=False, nullable=False),
        sa.Column(
            "timestamp",
            postgresql.TIMESTAMP(),
            server_default=sa.text("CURRENT_TIMESTAMP"),
            autoincrement=False,
            nullable=False,
        ),
        sa.Column(
            "message_metadata",
            postgresql.JSONB(astext_type=sa.Text()),
            server_default=sa.text("'{}'::jsonb"),
            autoincrement=False,
            nullable=False,
        ),
        sa.Column(
            "channel",
            sa.VARCHAR(length=20),
            server_default=sa.text("'web'::character varying"),
            autoincrement=False,
            nullable=False,
        ),
        sa.Column(
            "emotion_score", sa.DOUBLE_PRECISION(precision=53), autoincrement=False, nullable=True
        ),
        sa.Column("emotion_label", sa.VARCHAR(length=20), autoincrement=False, nullable=True),
        sa.Column(
            "detected_emotions",
            postgresql.JSONB(astext_type=sa.Text()),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column("input_tokens", sa.INTEGER(), autoincrement=False, nullable=True),
        sa.Column("output_tokens", sa.INTEGER(), autoincrement=False, nullable=True),
        sa.Column(
            "tool_calls",
            postgresql.JSONB(astext_type=sa.Text()),
            autoincrement=False,
            nullable=True,
        ),
        sa.ForeignKeyConstraint(
            ["conversation_id"],
            ["ai_conversations_legacy.id"],
            name=op.f("fk_ai_messages_conversation_id_ai_conversations"),
            ondelete="CASCADE",
        ),
        sa.PrimaryKeyConstraint("id", name=op.f("pk_ai_messages")),
    )
    op.create_index(
        op.f("ix_ai_messages_timestamp"), "ai_messages_legacy", ["timestamp"], unique=False
    )
    op.create_index(
        op.f("ix_ai_messages_conversation_id"),
        "ai_messages_legacy",
        ["conversation_id"],
        unique=False,
    )
    op.create_table(
        "ai_conversations_legacy",
        sa.Column("id", sa.VARCHAR(length=100), autoincrement=False, nullable=False),
        sa.Column("user_id", sa.VARCHAR(length=100), autoincrement=False, nullable=True),
        sa.Column(
            "channel",
            sa.VARCHAR(length=20),
            server_default=sa.text("'web'::character varying"),
            autoincrement=False,
            nullable=False,
        ),
        sa.Column(
            "started_at",
            postgresql.TIMESTAMP(),
            server_default=sa.text("CURRENT_TIMESTAMP"),
            autoincrement=False,
            nullable=False,
        ),
        sa.Column(
            "last_message_at",
            postgresql.TIMESTAMP(),
            server_default=sa.text("CURRENT_TIMESTAMP"),
            autoincrement=False,
            nullable=False,
        ),
        sa.Column(
            "message_count",
            sa.INTEGER(),
            server_default=sa.text("0"),
            autoincrement=False,
            nullable=False,
        ),
        sa.Column(
            "context",
            postgresql.JSONB(astext_type=sa.Text()),
            server_default=sa.text("'{}'::jsonb"),
            autoincrement=False,
            nullable=False,
        ),
        sa.Column(
            "average_emotion_score",
            sa.DOUBLE_PRECISION(precision=53),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column("emotion_trend", sa.VARCHAR(length=20), autoincrement=False, nullable=True),
        sa.Column(
            "escalated",
            sa.BOOLEAN(),
            server_default=sa.text("false"),
            autoincrement=False,
            nullable=False,
        ),
        sa.Column("escalated_at", postgresql.TIMESTAMP(), autoincrement=False, nullable=True),
        sa.Column(
            "is_active",
            sa.BOOLEAN(),
            server_default=sa.text("true"),
            autoincrement=False,
            nullable=False,
        ),
        sa.Column("closed_at", postgresql.TIMESTAMP(), autoincrement=False, nullable=True),
        sa.Column("closed_reason", sa.VARCHAR(length=100), autoincrement=False, nullable=True),
        sa.PrimaryKeyConstraint("id", name=op.f("pk_ai_conversations")),
    )
    op.create_index(
        op.f("ix_ai_conversations_user_id"), "ai_conversations_legacy", ["user_id"], unique=False
    )
    op.create_index(
        op.f("ix_ai_conversations_is_active"),
        "ai_conversations_legacy",
        ["is_active"],
        unique=False,
    )
    op.create_index(
        op.f("idx_ai_conversations_user_active"),
        "ai_conversations_legacy",
        ["user_id", "is_active"],
        unique=False,
    )
    op.create_index(
        op.f("idx_ai_conversations_last_message"),
        "ai_conversations_legacy",
        ["last_message_at"],
        unique=False,
    )
    op.create_index(
        op.f("idx_ai_conversations_escalated"),
        "ai_conversations_legacy",
        ["escalated", "escalated_at"],
        unique=False,
    )
    op.create_index(
        op.f("idx_ai_conversations_context"),
        "ai_conversations_legacy",
        ["context"],
        unique=False,
        postgresql_using="gin",
    )
    op.create_index(
        op.f("idx_ai_conversations_channel"), "ai_conversations_legacy", ["channel"], unique=False
    )
    op.create_table(
        "referral_rewards",
        sa.Column(
            "id",
            sa.UUID(),
            server_default=sa.text("gen_random_uuid()"),
            autoincrement=False,
            nullable=False,
        ),
        sa.Column("referral_id", sa.UUID(), autoincrement=False, nullable=False),
        sa.Column("reward_type", sa.VARCHAR(length=100), autoincrement=False, nullable=False),
        sa.Column("reward_description", sa.TEXT(), autoincrement=False, nullable=False),
        sa.Column(
            "unlocked_at",
            postgresql.TIMESTAMP(timezone=True),
            server_default=sa.text("now()"),
            autoincrement=False,
            nullable=False,
        ),
        sa.Column("redeemed", sa.BOOLEAN(), autoincrement=False, nullable=False),
        sa.Column(
            "redeemed_at", postgresql.TIMESTAMP(timezone=True), autoincrement=False, nullable=True
        ),
        sa.Column(
            "created_at",
            postgresql.TIMESTAMP(timezone=True),
            server_default=sa.text("now()"),
            autoincrement=False,
            nullable=False,
        ),
        sa.Column(
            "updated_at",
            postgresql.TIMESTAMP(timezone=True),
            server_default=sa.text("now()"),
            autoincrement=False,
            nullable=False,
        ),
        sa.ForeignKeyConstraint(
            ["referral_id"],
            ["referrals.id"],
            name=op.f("referral_rewards_referral_id_fkey"),
            ondelete="CASCADE",
        ),
        sa.PrimaryKeyConstraint("id", name=op.f("referral_rewards_pkey")),
    )
    op.create_index(
        op.f("ix_referral_rewards_referral_id"), "referral_rewards", ["referral_id"], unique=False
    )
    op.create_index(
        op.f("ix_referral_rewards_redeemed"), "referral_rewards", ["redeemed"], unique=False
    )
    op.create_table(
        "products",
        sa.Column("id", sa.VARCHAR(), autoincrement=False, nullable=False),
        sa.Column("stripe_product_id", sa.VARCHAR(), autoincrement=False, nullable=False),
        sa.Column("name", sa.VARCHAR(), autoincrement=False, nullable=False),
        sa.Column("description", sa.TEXT(), autoincrement=False, nullable=True),
        sa.Column("active", sa.BOOLEAN(), autoincrement=False, nullable=True),
        sa.Column("category", sa.VARCHAR(), autoincrement=False, nullable=True),
        sa.Column(
            "created_at",
            postgresql.TIMESTAMP(timezone=True),
            server_default=sa.text("now()"),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column(
            "updated_at", postgresql.TIMESTAMP(timezone=True), autoincrement=False, nullable=True
        ),
        sa.PrimaryKeyConstraint("id", name=op.f("products_pkey")),
    )
    op.create_index(
        op.f("ix_products_stripe_product_id"), "products", ["stripe_product_id"], unique=True
    )
    op.create_table(
        "customer_sentiment",
        sa.Column("id", sa.INTEGER(), autoincrement=True, nullable=False),
        sa.Column("customer_id", sa.VARCHAR(length=50), autoincrement=False, nullable=False),
        sa.Column(
            "sentiment_score", sa.NUMERIC(precision=3, scale=2), autoincrement=False, nullable=False
        ),
        sa.Column("last_rating", sa.INTEGER(), autoincrement=False, nullable=True),
        sa.Column("total_bookings", sa.INTEGER(), autoincrement=False, nullable=False),
        sa.Column("is_repeat_customer", sa.BOOLEAN(), autoincrement=False, nullable=False),
        sa.Column("is_referrer", sa.BOOLEAN(), autoincrement=False, nullable=False),
        sa.Column(
            "preferred_proteins",
            postgresql.JSONB(astext_type=sa.Text()),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column(
            "favorite_addons",
            postgresql.JSONB(astext_type=sa.Text()),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column("last_booking_date", sa.DATE(), autoincrement=False, nullable=True),
        sa.Column(
            "created_at",
            postgresql.TIMESTAMP(),
            server_default=sa.text("now()"),
            autoincrement=False,
            nullable=False,
        ),
        sa.Column(
            "last_updated",
            postgresql.TIMESTAMP(),
            server_default=sa.text("now()"),
            autoincrement=False,
            nullable=False,
        ),
        sa.PrimaryKeyConstraint("id", name=op.f("customer_sentiment_pkey")),
        comment="Customer sentiment tracking and preferences",
    )
    op.create_index(
        op.f("ix_customer_sentiment_customer_id"),
        "customer_sentiment",
        ["customer_id"],
        unique=True,
    )
    op.create_table(
        "feedback",
        sa.Column("id", sa.INTEGER(), autoincrement=True, nullable=False),
        sa.Column("booking_id", sa.VARCHAR(length=50), autoincrement=False, nullable=False),
        sa.Column("rating", sa.INTEGER(), autoincrement=False, nullable=False),
        sa.Column("feedback_text", sa.TEXT(), autoincrement=False, nullable=True),
        sa.Column("review_source", sa.VARCHAR(length=50), autoincrement=False, nullable=True),
        sa.Column("escalated_to_human", sa.BOOLEAN(), autoincrement=False, nullable=False),
        sa.Column("human_followup_completed", sa.BOOLEAN(), autoincrement=False, nullable=False),
        sa.Column(
            "created_at",
            postgresql.TIMESTAMP(),
            server_default=sa.text("now()"),
            autoincrement=False,
            nullable=False,
        ),
        sa.Column(
            "last_updated",
            postgresql.TIMESTAMP(),
            server_default=sa.text("now()"),
            autoincrement=False,
            nullable=False,
        ),
        sa.PrimaryKeyConstraint("id", name=op.f("feedback_pkey")),
        comment="Customer feedback and review tracking",
    )
    op.create_index(op.f("ix_feedback_booking_id"), "feedback", ["booking_id"], unique=True)
    op.create_index(
        op.f("idx_feedback_rating"), "feedback", ["rating", "escalated_to_human"], unique=False
    )
    op.create_table(
        "customers",
        sa.Column("id", sa.VARCHAR(), autoincrement=False, nullable=False),
        sa.Column("user_id", sa.VARCHAR(), autoincrement=False, nullable=False),
        sa.Column("email", sa.VARCHAR(), autoincrement=False, nullable=False),
        sa.Column("stripe_customer_id", sa.VARCHAR(), autoincrement=False, nullable=False),
        sa.Column("name", sa.VARCHAR(), autoincrement=False, nullable=True),
        sa.Column("phone", sa.VARCHAR(), autoincrement=False, nullable=True),
        sa.Column("preferred_payment_method", sa.VARCHAR(), autoincrement=False, nullable=True),
        sa.Column(
            "total_spent", sa.NUMERIC(precision=10, scale=2), autoincrement=False, nullable=True
        ),
        sa.Column("total_bookings", sa.INTEGER(), autoincrement=False, nullable=True),
        sa.Column(
            "zelle_savings", sa.NUMERIC(precision=10, scale=2), autoincrement=False, nullable=True
        ),
        sa.Column("loyalty_tier", sa.VARCHAR(), autoincrement=False, nullable=True),
        sa.Column(
            "created_at",
            postgresql.TIMESTAMP(timezone=True),
            server_default=sa.text("now()"),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column(
            "updated_at", postgresql.TIMESTAMP(timezone=True), autoincrement=False, nullable=True
        ),
        sa.PrimaryKeyConstraint("id", name="customers_pkey"),
        sa.UniqueConstraint(
            "email",
            name="customers_email_key",
            postgresql_include=[],
            postgresql_nulls_not_distinct=False,
        ),
        sa.UniqueConstraint(
            "stripe_customer_id",
            name="customers_stripe_customer_id_key",
            postgresql_include=[],
            postgresql_nulls_not_distinct=False,
        ),
        sa.UniqueConstraint(
            "user_id",
            name="customers_user_id_key",
            postgresql_include=[],
            postgresql_nulls_not_distinct=False,
        ),
        postgresql_ignore_search_path=False,
    )
    op.create_index(op.f("ix_customers_user_id"), "customers", ["user_id"], unique=True)
    op.create_index(
        op.f("ix_customers_stripe_customer_id"), "customers", ["stripe_customer_id"], unique=True
    )
    op.create_index(op.f("ix_customers_email"), "customers", ["email"], unique=True)
    op.create_table(
        "disputes",
        sa.Column("id", sa.VARCHAR(), autoincrement=False, nullable=False),
        sa.Column("stripe_dispute_id", sa.VARCHAR(), autoincrement=False, nullable=False),
        sa.Column("payment_id", sa.VARCHAR(), autoincrement=False, nullable=True),
        sa.Column("amount", sa.NUMERIC(precision=10, scale=2), autoincrement=False, nullable=False),
        sa.Column("currency", sa.VARCHAR(), autoincrement=False, nullable=True),
        sa.Column("status", sa.VARCHAR(), autoincrement=False, nullable=False),
        sa.Column("reason", sa.VARCHAR(), autoincrement=False, nullable=True),
        sa.Column("evidence_details", sa.TEXT(), autoincrement=False, nullable=True),
        sa.Column(
            "evidence_due_by",
            postgresql.TIMESTAMP(timezone=True),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column(
            "resolved_at", postgresql.TIMESTAMP(timezone=True), autoincrement=False, nullable=True
        ),
        sa.Column("resolution", sa.VARCHAR(), autoincrement=False, nullable=True),
        sa.Column(
            "created_at",
            postgresql.TIMESTAMP(timezone=True),
            server_default=sa.text("now()"),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column(
            "updated_at", postgresql.TIMESTAMP(timezone=True), autoincrement=False, nullable=True
        ),
        sa.ForeignKeyConstraint(
            ["payment_id"], ["payments.id"], name=op.f("disputes_payment_id_fkey")
        ),
        sa.PrimaryKeyConstraint("id", name=op.f("disputes_pkey")),
    )
    op.create_index(
        op.f("ix_disputes_stripe_dispute_id"), "disputes", ["stripe_dispute_id"], unique=True
    )
    op.create_table(
        "monitoring_alerts",
        sa.Column("id", sa.INTEGER(), autoincrement=True, nullable=False),
        sa.Column("alert_type", sa.VARCHAR(length=100), autoincrement=False, nullable=False),
        sa.Column("category", sa.VARCHAR(length=50), autoincrement=False, nullable=False),
        sa.Column("title", sa.VARCHAR(length=255), autoincrement=False, nullable=False),
        sa.Column("message", sa.TEXT(), autoincrement=False, nullable=False),
        sa.Column("priority", sa.VARCHAR(length=20), autoincrement=False, nullable=False),
        sa.Column(
            "status",
            sa.VARCHAR(length=20),
            server_default=sa.text("'active'::character varying"),
            autoincrement=False,
            nullable=False,
        ),
        sa.Column("source", sa.VARCHAR(length=100), autoincrement=False, nullable=True),
        sa.Column("resource", sa.VARCHAR(length=255), autoincrement=False, nullable=True),
        sa.Column(
            "metadata", postgresql.JSON(astext_type=sa.Text()), autoincrement=False, nullable=True
        ),
        sa.Column("metric_name", sa.VARCHAR(length=100), autoincrement=False, nullable=True),
        sa.Column("metric_value", sa.VARCHAR(length=50), autoincrement=False, nullable=True),
        sa.Column("threshold_value", sa.VARCHAR(length=50), autoincrement=False, nullable=True),
        sa.Column(
            "notification_channels",
            postgresql.JSON(astext_type=sa.Text()),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column(
            "notification_sent_at", postgresql.TIMESTAMP(), autoincrement=False, nullable=True
        ),
        sa.Column(
            "notification_count",
            sa.INTEGER(),
            server_default=sa.text("0"),
            autoincrement=False,
            nullable=False,
        ),
        sa.Column("acknowledged_by", sa.VARCHAR(length=255), autoincrement=False, nullable=True),
        sa.Column("acknowledged_at", postgresql.TIMESTAMP(), autoincrement=False, nullable=True),
        sa.Column("resolved_by", sa.VARCHAR(length=255), autoincrement=False, nullable=True),
        sa.Column("resolved_at", postgresql.TIMESTAMP(), autoincrement=False, nullable=True),
        sa.Column("resolution_notes", sa.TEXT(), autoincrement=False, nullable=True),
        sa.Column("suppressed_until", postgresql.TIMESTAMP(), autoincrement=False, nullable=True),
        sa.Column("suppressed_by", sa.VARCHAR(length=255), autoincrement=False, nullable=True),
        sa.Column("suppression_reason", sa.TEXT(), autoincrement=False, nullable=True),
        sa.Column("triggered_at", postgresql.TIMESTAMP(), autoincrement=False, nullable=False),
        sa.Column("updated_at", postgresql.TIMESTAMP(), autoincrement=False, nullable=False),
        sa.Column("expires_at", postgresql.TIMESTAMP(), autoincrement=False, nullable=True),
        sa.PrimaryKeyConstraint("id", name=op.f("monitoring_alerts_pkey")),
    )
    op.create_index(op.f("idx_alerts_type"), "monitoring_alerts", ["alert_type"], unique=False)
    op.create_index(
        op.f("idx_alerts_triggered_at"), "monitoring_alerts", ["triggered_at"], unique=False
    )
    op.create_index(op.f("idx_alerts_status"), "monitoring_alerts", ["status"], unique=False)
    op.create_index(op.f("idx_alerts_resource"), "monitoring_alerts", ["resource"], unique=False)
    op.create_index(op.f("idx_alerts_priority"), "monitoring_alerts", ["priority"], unique=False)
    op.create_index(op.f("idx_alerts_category"), "monitoring_alerts", ["category"], unique=False)
    op.create_index(
        op.f("idx_alerts_active_priority"),
        "monitoring_alerts",
        ["status", "priority"],
        unique=False,
    )
    op.create_table(
        "booking_reminders",
        sa.Column(
            "id",
            sa.UUID(),
            server_default=sa.text("gen_random_uuid()"),
            autoincrement=False,
            nullable=False,
        ),
        sa.Column("booking_id", sa.UUID(), autoincrement=False, nullable=False),
        sa.Column("reminder_type", sa.VARCHAR(length=50), autoincrement=False, nullable=False),
        sa.Column(
            "scheduled_for",
            postgresql.TIMESTAMP(timezone=True),
            autoincrement=False,
            nullable=False,
        ),
        sa.Column(
            "sent_at", postgresql.TIMESTAMP(timezone=True), autoincrement=False, nullable=True
        ),
        sa.Column(
            "status",
            sa.VARCHAR(length=50),
            server_default=sa.text("'pending'::character varying"),
            autoincrement=False,
            nullable=False,
        ),
        sa.Column("message", sa.TEXT(), autoincrement=False, nullable=True),
        sa.Column("error_message", sa.TEXT(), autoincrement=False, nullable=True),
        sa.Column(
            "created_at",
            postgresql.TIMESTAMP(timezone=True),
            server_default=sa.text("now()"),
            autoincrement=False,
            nullable=False,
        ),
        sa.Column(
            "updated_at",
            postgresql.TIMESTAMP(timezone=True),
            server_default=sa.text("now()"),
            autoincrement=False,
            nullable=False,
        ),
        sa.ForeignKeyConstraint(
            ["booking_id"],
            ["core.bookings.id"],
            name=op.f("booking_reminders_booking_id_fkey"),
            ondelete="CASCADE",
        ),
        sa.PrimaryKeyConstraint("id", name=op.f("booking_reminders_pkey")),
    )
    op.create_index(op.f("idx_reminders_status"), "booking_reminders", ["status"], unique=False)
    op.create_index(
        op.f("idx_reminders_scheduled"),
        "booking_reminders",
        ["scheduled_for"],
        unique=False,
        postgresql_where="((status)::text = 'pending'::text)",
    )
    op.create_index(
        op.f("idx_reminders_booking"), "booking_reminders", ["booking_id"], unique=False
    )
    op.create_table(
        "consent_records",
        sa.Column(
            "id",
            sa.UUID(),
            server_default=sa.text("gen_random_uuid()"),
            autoincrement=False,
            nullable=False,
        ),
        sa.Column("lead_id", sa.UUID(), autoincrement=False, nullable=True),
        sa.Column("customer_id", sa.UUID(), autoincrement=False, nullable=True),
        sa.Column("ip_address", sa.VARCHAR(length=45), autoincrement=False, nullable=True),
        sa.Column("user_agent", sa.TEXT(), autoincrement=False, nullable=True),
        sa.Column("consent_source", sa.VARCHAR(length=100), autoincrement=False, nullable=False),
        sa.Column(
            "consent_timestamp",
            postgresql.TIMESTAMP(timezone=True),
            server_default=sa.text("now()"),
            autoincrement=False,
            nullable=False,
        ),
        sa.Column("consent_text", sa.TEXT(), autoincrement=False, nullable=True),
        sa.Column("sms_consent", sa.BOOLEAN(), autoincrement=False, nullable=False),
        sa.Column("email_consent", sa.BOOLEAN(), autoincrement=False, nullable=False),
        sa.Column(
            "created_at",
            postgresql.TIMESTAMP(timezone=True),
            server_default=sa.text("now()"),
            autoincrement=False,
            nullable=False,
        ),
        sa.Column(
            "updated_at",
            postgresql.TIMESTAMP(timezone=True),
            server_default=sa.text("now()"),
            autoincrement=False,
            nullable=False,
        ),
        sa.PrimaryKeyConstraint("id", name=op.f("consent_records_pkey")),
    )
    op.create_index(
        op.f("ix_consent_records_sms_consent"), "consent_records", ["sms_consent"], unique=False
    )
    op.create_index(
        op.f("ix_consent_records_lead_id"), "consent_records", ["lead_id"], unique=False
    )
    op.create_index(
        op.f("ix_consent_records_email_consent"), "consent_records", ["email_consent"], unique=False
    )
    op.create_index(
        op.f("ix_consent_records_customer_id"), "consent_records", ["customer_id"], unique=False
    )
    op.create_index(
        op.f("ix_consent_records_consent_timestamp"),
        "consent_records",
        ["consent_timestamp"],
        unique=False,
    )
    op.create_index(
        op.f("ix_consent_records_consent_source"),
        "consent_records",
        ["consent_source"],
        unique=False,
    )
    op.create_table(
        "monitoring_alert_rules",
        sa.Column("id", sa.INTEGER(), autoincrement=True, nullable=False),
        sa.Column("name", sa.VARCHAR(length=100), autoincrement=False, nullable=False),
        sa.Column("description", sa.TEXT(), autoincrement=False, nullable=True),
        sa.Column("alert_type", sa.VARCHAR(length=100), autoincrement=False, nullable=False),
        sa.Column("category", sa.VARCHAR(length=50), autoincrement=False, nullable=False),
        sa.Column("metric_name", sa.VARCHAR(length=100), autoincrement=False, nullable=False),
        sa.Column("operator", sa.VARCHAR(length=10), autoincrement=False, nullable=False),
        sa.Column(
            "threshold", sa.DOUBLE_PRECISION(precision=53), autoincrement=False, nullable=False
        ),
        sa.Column(
            "duration_seconds",
            sa.INTEGER(),
            server_default=sa.text("60"),
            autoincrement=False,
            nullable=False,
        ),
        sa.Column("priority", sa.VARCHAR(length=20), autoincrement=False, nullable=False),
        sa.Column(
            "notification_channels",
            postgresql.JSON(astext_type=sa.Text()),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column(
            "cooldown_seconds",
            sa.INTEGER(),
            server_default=sa.text("300"),
            autoincrement=False,
            nullable=False,
        ),
        sa.Column(
            "is_enabled",
            sa.BOOLEAN(),
            server_default=sa.text("true"),
            autoincrement=False,
            nullable=False,
        ),
        sa.Column("last_triggered_at", postgresql.TIMESTAMP(), autoincrement=False, nullable=True),
        sa.Column("created_at", postgresql.TIMESTAMP(), autoincrement=False, nullable=False),
        sa.Column("updated_at", postgresql.TIMESTAMP(), autoincrement=False, nullable=False),
        sa.Column("created_by", sa.VARCHAR(length=255), autoincrement=False, nullable=True),
        sa.PrimaryKeyConstraint("id", name=op.f("monitoring_alert_rules_pkey")),
    )
    op.create_index(
        op.f("idx_alert_rules_type"), "monitoring_alert_rules", ["alert_type"], unique=False
    )
    op.create_index(
        op.f("idx_alert_rules_metric"), "monitoring_alert_rules", ["metric_name"], unique=False
    )
    op.create_index(
        op.f("idx_alert_rules_enabled"), "monitoring_alert_rules", ["is_enabled"], unique=False
    )
    op.create_table(
        "webhook_events",
        sa.Column("id", sa.VARCHAR(), autoincrement=False, nullable=False),
        sa.Column("type", sa.VARCHAR(), autoincrement=False, nullable=False),
        sa.Column("stripe_event_id", sa.VARCHAR(), autoincrement=False, nullable=False),
        sa.Column("payload_json", sa.TEXT(), autoincrement=False, nullable=False),
        sa.Column("processed", sa.BOOLEAN(), autoincrement=False, nullable=True),
        sa.Column("processing_error", sa.TEXT(), autoincrement=False, nullable=True),
        sa.Column("retry_count", sa.INTEGER(), autoincrement=False, nullable=True),
        sa.Column(
            "created_at",
            postgresql.TIMESTAMP(timezone=True),
            server_default=sa.text("now()"),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column(
            "processed_at", postgresql.TIMESTAMP(timezone=True), autoincrement=False, nullable=True
        ),
        sa.PrimaryKeyConstraint("id", name=op.f("webhook_events_pkey")),
    )
    op.create_index(op.f("ix_webhook_events_type"), "webhook_events", ["type"], unique=False)
    op.create_index(
        op.f("ix_webhook_events_stripe_event_id"),
        "webhook_events",
        ["stripe_event_id"],
        unique=True,
    )
    op.create_index(
        op.f("idx_webhook_events_type_processed"),
        "webhook_events",
        ["type", "processed"],
        unique=False,
    )
    op.drop_index(
        "ix_sms_delivery_timestamp", table_name="sms_delivery_events", schema="newsletter"
    )
    op.drop_index("ix_sms_delivery_status", table_name="sms_delivery_events", schema="newsletter")
    op.drop_index(
        "ix_sms_delivery_ringcentral_msg_id", table_name="sms_delivery_events", schema="newsletter"
    )
    op.drop_index(
        "ix_sms_delivery_campaign_event", table_name="sms_delivery_events", schema="newsletter"
    )
    op.drop_table("sms_delivery_events", schema="newsletter")
    op.drop_index(
        op.f("ix_feedback_review_escalations_review_id"),
        table_name="review_escalations",
        schema="feedback",
    )
    op.drop_index(
        op.f("ix_feedback_review_escalations_is_resolved"),
        table_name="review_escalations",
        schema="feedback",
    )
    op.drop_index(
        op.f("ix_feedback_review_escalations_assigned_to_id"),
        table_name="review_escalations",
        schema="feedback",
    )
    op.drop_index(
        "idx_review_escalations_review_id", table_name="review_escalations", schema="feedback"
    )
    op.drop_index(
        "idx_review_escalations_is_resolved", table_name="review_escalations", schema="feedback"
    )
    op.drop_index(
        "idx_review_escalations_assigned_to_id", table_name="review_escalations", schema="feedback"
    )
    op.drop_table("review_escalations", schema="feedback")
    op.drop_index("idx_training_quality", table_name="training_data", schema="ai")
    op.drop_index("idx_training_message", table_name="training_data", schema="ai")
    op.drop_index("idx_training_conversation", table_name="training_data", schema="ai")
    op.drop_index("idx_training_category", table_name="training_data", schema="ai")
    op.drop_index("idx_training_approved", table_name="training_data", schema="ai")
    op.drop_table("training_data", schema="ai")
    op.drop_index(
        op.f("ix_newsletter_sms_send_queue_subscriber_id"),
        table_name="sms_send_queue",
        schema="newsletter",
    )
    op.drop_index(
        op.f("ix_newsletter_sms_send_queue_status"),
        table_name="sms_send_queue",
        schema="newsletter",
    )
    op.drop_index(
        op.f("ix_newsletter_sms_send_queue_scheduled_at"),
        table_name="sms_send_queue",
        schema="newsletter",
    )
    op.drop_index(
        op.f("ix_newsletter_sms_send_queue_phone_number"),
        table_name="sms_send_queue",
        schema="newsletter",
    )
    op.drop_index(
        op.f("ix_newsletter_sms_send_queue_campaign_id"),
        table_name="sms_send_queue",
        schema="newsletter",
    )
    op.drop_index("idx_sms_queue_retry", table_name="sms_send_queue", schema="newsletter")
    op.drop_index("idx_sms_queue_priority", table_name="sms_send_queue", schema="newsletter")
    op.drop_index("idx_sms_queue_pending", table_name="sms_send_queue", schema="newsletter")
    op.drop_table("sms_send_queue", schema="newsletter")
    op.drop_index(
        "ix_newsletter_events_subscriber", table_name="campaign_events", schema="newsletter"
    )
    op.drop_index(
        "ix_newsletter_events_campaign", table_name="campaign_events", schema="newsletter"
    )
    op.drop_table("campaign_events", schema="newsletter")
    op.drop_index("ix_lead_events_lead", table_name="lead_events", schema="lead")
    op.drop_table("lead_events", schema="lead")
    op.drop_table("lead_context", schema="lead")
    op.drop_index("ix_lead_contacts_lead", table_name="lead_contacts", schema="lead")
    op.drop_index("ix_lead_contacts_channel", table_name="lead_contacts", schema="lead")
    op.drop_table("lead_contacts", schema="lead")
    op.drop_table("payment_matches", schema="integra")
    op.drop_table("call_sessions", schema="integra")
    op.drop_index(
        op.f("ix_feedback_customer_reviews_status"),
        table_name="customer_reviews",
        schema="feedback",
    )
    op.drop_index(
        op.f("ix_feedback_customer_reviews_rating"),
        table_name="customer_reviews",
        schema="feedback",
    )
    op.drop_index(
        op.f("ix_feedback_customer_reviews_customer_id"),
        table_name="customer_reviews",
        schema="feedback",
    )
    op.drop_index(
        op.f("ix_feedback_customer_reviews_booking_id"),
        table_name="customer_reviews",
        schema="feedback",
    )
    op.drop_index("idx_customer_reviews_status", table_name="customer_reviews", schema="feedback")
    op.drop_index("idx_customer_reviews_rating", table_name="customer_reviews", schema="feedback")
    op.drop_index(
        "idx_customer_reviews_customer_id", table_name="customer_reviews", schema="feedback"
    )
    op.drop_index(
        "idx_customer_reviews_created_at", table_name="customer_reviews", schema="feedback"
    )
    op.drop_index(
        "idx_customer_reviews_booking_id", table_name="customer_reviews", schema="feedback"
    )
    op.drop_table("customer_reviews", schema="feedback")
    op.drop_index(op.f("ix_core_payments_status"), table_name="payments", schema="core")
    op.drop_index(op.f("ix_core_payments_received_at"), table_name="payments", schema="core")
    op.drop_index(op.f("ix_core_payments_id"), table_name="payments", schema="core")
    op.drop_index(op.f("ix_core_payments_booking_id"), table_name="payments", schema="core")
    op.drop_table("payments", schema="core")
    op.drop_index("idx_messages_thread_id", table_name="messages", schema="core")
    op.drop_index("idx_messages_created_at", table_name="messages", schema="core")
    op.drop_table("messages", schema="core")
    op.drop_index(
        op.f("ix_core_booking_reminders_status"), table_name="booking_reminders", schema="core"
    )
    op.drop_index(
        op.f("ix_core_booking_reminders_scheduled_for"),
        table_name="booking_reminders",
        schema="core",
    )
    op.drop_index(
        op.f("ix_core_booking_reminders_booking_id"), table_name="booking_reminders", schema="core"
    )
    op.drop_table("booking_reminders", schema="core")
    op.drop_index(op.f("ix_ai_messages_timestamp"), table_name="messages", schema="ai")
    op.drop_index(op.f("ix_ai_messages_conversation_id"), table_name="messages", schema="ai")
    op.drop_index("idx_messages_training_data", table_name="messages", schema="ai")
    op.drop_index(
        "idx_messages_tool_calls", table_name="messages", schema="ai", postgresql_using="gin"
    )
    op.drop_index("idx_messages_role_created", table_name="messages", schema="ai")
    op.drop_index("idx_messages_model_used", table_name="messages", schema="ai")
    op.drop_index(
        "idx_messages_metadata", table_name="messages", schema="ai", postgresql_using="gin"
    )
    op.drop_index(
        "idx_messages_kb_sources", table_name="messages", schema="ai", postgresql_using="gin"
    )
    op.drop_index("idx_messages_human_feedback", table_name="messages", schema="ai")
    op.drop_index("idx_messages_emotion_label", table_name="messages", schema="ai")
    op.drop_index("idx_messages_emotion_history", table_name="messages", schema="ai")
    op.drop_index(
        "idx_messages_detected_emotions", table_name="messages", schema="ai", postgresql_using="gin"
    )
    op.drop_index("idx_messages_conversation_timestamp", table_name="messages", schema="ai")
    op.drop_index("idx_messages_conversation_role", table_name="messages", schema="ai")
    op.drop_index("idx_messages_channel", table_name="messages", schema="ai")
    op.drop_table("messages", schema="ai")
    op.drop_index("idx_analytics_satisfaction", table_name="conversation_analytics", schema="ai")
    op.drop_index("idx_analytics_response_time", table_name="conversation_analytics", schema="ai")
    op.drop_index("idx_analytics_resolution_time", table_name="conversation_analytics", schema="ai")
    op.drop_index("idx_analytics_resolution", table_name="conversation_analytics", schema="ai")
    op.drop_index("idx_analytics_cost", table_name="conversation_analytics", schema="ai")
    op.drop_index("idx_analytics_conversation", table_name="conversation_analytics", schema="ai")
    op.drop_index("idx_analytics_confidence", table_name="conversation_analytics", schema="ai")
    op.drop_table("conversation_analytics", schema="ai")
    op.drop_index("idx_usage_performance", table_name="ai_usage", schema="ai")
    op.drop_index("idx_usage_model", table_name="ai_usage", schema="ai")
    op.drop_index("idx_usage_cost", table_name="ai_usage", schema="ai")
    op.drop_index("idx_usage_conversation", table_name="ai_usage", schema="ai")
    op.drop_table("ai_usage", schema="ai")
    op.drop_index(
        "ix_newsletter_subscribers_subscribed", table_name="subscribers", schema="newsletter"
    )
    op.drop_index(
        "ix_newsletter_subscribers_engagement", table_name="subscribers", schema="newsletter"
    )
    op.drop_index(
        "ix_newsletter_subscribers_customer", table_name="subscribers", schema="newsletter"
    )
    op.drop_table("subscribers", schema="newsletter")
    op.drop_index("ix_social_messages_thread_id", table_name="social_messages", schema="lead")
    op.drop_index("ix_social_messages_sent_at", table_name="social_messages", schema="lead")
    op.drop_index(
        op.f("ix_lead_social_messages_thread_id"), table_name="social_messages", schema="lead"
    )
    op.drop_table("social_messages", schema="lead")
    op.drop_index("ix_lead_leads_status", table_name="leads", schema="lead")
    op.drop_index("ix_lead_leads_source", table_name="leads", schema="lead")
    op.drop_index("ix_lead_leads_score", table_name="leads", schema="lead")
    op.drop_index("ix_lead_leads_followup", table_name="leads", schema="lead")
    op.drop_index("ix_lead_leads_customer", table_name="leads", schema="lead")
    op.drop_table("leads", schema="lead")
    op.drop_index("idx_admin_access_user", table_name="admin_access_logs", schema="identity")
    op.drop_index("idx_admin_access_email", table_name="admin_access_logs", schema="identity")
    op.drop_index("idx_admin_access_created", table_name="admin_access_logs", schema="identity")
    op.drop_index("idx_admin_access_action", table_name="admin_access_logs", schema="identity")
    op.drop_table("admin_access_logs", schema="identity")
    op.drop_index("idx_crm_leads_status", table_name="leads", schema="crm")
    op.drop_index("idx_crm_leads_source", table_name="leads", schema="crm")
    op.drop_index("idx_crm_leads_score", table_name="leads", schema="crm")
    op.drop_index("idx_crm_leads_followup", table_name="leads", schema="crm")
    op.drop_index("idx_crm_leads_customer", table_name="leads", schema="crm")
    op.drop_table("leads", schema="crm")
    op.drop_index(
        op.f("ix_core_message_threads_status"), table_name="message_threads", schema="core"
    )
    op.drop_index("idx_message_threads_status", table_name="message_threads", schema="core")
    op.drop_index("idx_message_threads_station_id", table_name="message_threads", schema="core")
    op.drop_index("idx_message_threads_customer_id", table_name="message_threads", schema="core")
    op.drop_index("idx_message_threads_created_at", table_name="message_threads", schema="core")
    op.drop_table("message_threads", schema="core")
    op.drop_index(op.f("ix_core_bookings_status"), table_name="bookings", schema="core")
    op.drop_index(op.f("ix_core_bookings_slot"), table_name="bookings", schema="core")
    op.drop_index(op.f("ix_core_bookings_internal_deadline"), table_name="bookings", schema="core")
    op.drop_index(op.f("ix_core_bookings_id"), table_name="bookings", schema="core")
    op.drop_index("ix_core_bookings_date_slot", table_name="bookings", schema="core")
    op.drop_index(op.f("ix_core_bookings_date"), table_name="bookings", schema="core")
    op.drop_index(op.f("ix_core_bookings_customer_id"), table_name="bookings", schema="core")
    op.drop_index(
        op.f("ix_core_bookings_customer_deposit_deadline"), table_name="bookings", schema="core"
    )
    op.drop_index("ix_core_bookings_chef_slot_unique", table_name="bookings", schema="core")
    op.drop_index("ix_bookings_sms_consent", table_name="bookings", schema="core")
    op.drop_index("ix_bookings_internal_deadline", table_name="bookings", schema="core")
    op.drop_index("ix_bookings_customer_deposit_deadline", table_name="bookings", schema="core")
    op.drop_index("idx_booking_station_date", table_name="bookings", schema="core")
    op.drop_index("idx_booking_station_customer", table_name="bookings", schema="core")
    op.drop_index("idx_booking_date_slot_active", table_name="bookings", schema="core")
    op.drop_table("bookings", schema="core")
    op.drop_index(
        op.f("ix_communications_call_recordings_status"),
        table_name="call_recordings",
        schema="communications",
    )
    op.drop_index(
        op.f("ix_communications_call_recordings_rc_call_id"),
        table_name="call_recordings",
        schema="communications",
    )
    op.drop_index(
        op.f("ix_communications_call_recordings_escalation_id"),
        table_name="call_recordings",
        schema="communications",
    )
    op.drop_index(
        op.f("ix_communications_call_recordings_delete_after"),
        table_name="call_recordings",
        schema="communications",
    )
    op.drop_index(
        op.f("ix_communications_call_recordings_call_started_at"),
        table_name="call_recordings",
        schema="communications",
    )
    op.drop_index(
        "idx_call_recordings_status", table_name="call_recordings", schema="communications"
    )
    op.drop_index(
        "idx_call_recordings_rc_call_id", table_name="call_recordings", schema="communications"
    )
    op.drop_index(
        "idx_call_recordings_escalation_id", table_name="call_recordings", schema="communications"
    )
    op.drop_index(
        "idx_call_recordings_delete_after", table_name="call_recordings", schema="communications"
    )
    op.drop_index(
        "idx_call_recordings_date_status", table_name="call_recordings", schema="communications"
    )
    op.drop_index(
        "idx_call_recordings_call_started_at", table_name="call_recordings", schema="communications"
    )
    op.drop_table("call_recordings", schema="communications")
    op.drop_index(op.f("ix_ai_conversations_user_id"), table_name="conversations", schema="ai")
    op.drop_index(op.f("ix_ai_conversations_is_active"), table_name="conversations", schema="ai")
    op.drop_index(op.f("ix_ai_conversations_customer_id"), table_name="conversations", schema="ai")
    op.drop_index("idx_conversations_user_channel", table_name="conversations", schema="ai")
    op.drop_index("idx_conversations_user_active", table_name="conversations", schema="ai")
    op.drop_index("idx_conversations_status_updated", table_name="conversations", schema="ai")
    op.drop_index("idx_conversations_route_decision", table_name="conversations", schema="ai")
    op.drop_index("idx_conversations_last_message", table_name="conversations", schema="ai")
    op.drop_index("idx_conversations_escalated", table_name="conversations", schema="ai")
    op.drop_index("idx_conversations_emotion_trend", table_name="conversations", schema="ai")
    op.drop_index("idx_conversations_emotion_active", table_name="conversations", schema="ai")
    op.drop_index("idx_conversations_customer_id", table_name="conversations", schema="ai")
    op.drop_index("idx_conversations_created", table_name="conversations", schema="ai")
    op.drop_index(
        "idx_conversations_context", table_name="conversations", schema="ai", postgresql_using="gin"
    )
    op.drop_index("idx_conversations_closed", table_name="conversations", schema="ai")
    op.drop_index("idx_conversations_channel_status", table_name="conversations", schema="ai")
    op.drop_index(
        "idx_conversations_channel_metadata",
        table_name="conversations",
        schema="ai",
        postgresql_using="gin",
    )
    op.drop_index("idx_conversations_assigned_agent", table_name="conversations", schema="ai")
    op.drop_table("conversations", schema="ai")
    op.drop_index(op.f("ix_support_escalations_status"), table_name="escalations", schema="support")
    op.drop_index(
        op.f("ix_support_escalations_customer_phone"), table_name="escalations", schema="support"
    )
    op.drop_index(
        op.f("ix_support_escalations_conversation_id"), table_name="escalations", schema="support"
    )
    op.drop_index(
        op.f("ix_support_escalations_assigned_to_id"), table_name="escalations", schema="support"
    )
    op.drop_index("idx_escalations_status_priority", table_name="escalations", schema="support")
    op.drop_index("idx_escalations_status", table_name="escalations", schema="support")
    op.drop_index("idx_escalations_customer_phone", table_name="escalations", schema="support")
    op.drop_index("idx_escalations_created_at", table_name="escalations", schema="support")
    op.drop_index("idx_escalations_conversation_id", table_name="escalations", schema="support")
    op.drop_index("idx_escalations_assigned_to_id", table_name="escalations", schema="support")
    op.drop_index("idx_escalations_assigned_status", table_name="escalations", schema="support")
    op.drop_table("escalations", schema="support")
    op.drop_table("role_permissions")
    op.drop_index("ix_reviews_source", table_name="reviews", schema="public")
    op.drop_index("ix_reviews_rating", table_name="reviews", schema="public")
    op.drop_index("ix_reviews_customer_id", table_name="reviews", schema="public")
    op.drop_index(op.f("ix_public_reviews_status"), table_name="reviews", schema="public")
    op.drop_index(op.f("ix_public_reviews_source"), table_name="reviews", schema="public")
    op.drop_index(op.f("ix_public_reviews_customer_id"), table_name="reviews", schema="public")
    op.drop_index(op.f("ix_public_reviews_booking_id"), table_name="reviews", schema="public")
    op.drop_index(op.f("ix_public_reviews_account_id"), table_name="reviews", schema="public")
    op.drop_table("reviews", schema="public")
    op.drop_index("idx_ops_shifts_date", table_name="shift_schedules", schema="ops")
    op.drop_index("idx_ops_shifts_chef", table_name="shift_schedules", schema="ops")
    op.drop_table("shift_schedules", schema="ops")
    op.drop_index("idx_ops_inventory_trans_type", table_name="inventory_transactions", schema="ops")
    op.drop_index("idx_ops_inventory_trans_item", table_name="inventory_transactions", schema="ops")
    op.drop_table("inventory_transactions", schema="ops")
    op.drop_index("idx_ops_maintenance_type", table_name="equipment_maintenance", schema="ops")
    op.drop_index("idx_ops_maintenance_equipment", table_name="equipment_maintenance", schema="ops")
    op.drop_table("equipment_maintenance", schema="ops")
    op.drop_index("idx_ops_chef_timeoff_status", table_name="chef_timeoff", schema="ops")
    op.drop_index("idx_ops_chef_timeoff_chef", table_name="chef_timeoff", schema="ops")
    op.drop_table("chef_timeoff", schema="ops")
    op.drop_index("idx_ops_chef_availability_chef", table_name="chef_availability", schema="ops")
    op.drop_table("chef_availability", schema="ops")
    op.drop_index("idx_sms_templates_status", table_name="sms_templates", schema="newsletter")
    op.drop_index("idx_sms_templates_source", table_name="sms_templates", schema="newsletter")
    op.drop_index("idx_sms_templates_category", table_name="sms_templates", schema="newsletter")
    op.drop_index("idx_sms_templates_active", table_name="sms_templates", schema="newsletter")
    op.drop_table("sms_templates", schema="newsletter")
    op.drop_index(
        "idx_campaign_sms_limits_month", table_name="campaign_sms_limits", schema="newsletter"
    )
    op.drop_index(
        "idx_campaign_sms_limits_exceeded", table_name="campaign_sms_limits", schema="newsletter"
    )
    op.drop_table("campaign_sms_limits", schema="newsletter")
    op.drop_index(
        op.f("ix_marketing_qr_scans_scanned_at"), table_name="qr_scans", schema="marketing"
    )
    op.drop_index(
        op.f("ix_marketing_qr_scans_qr_code_id"), table_name="qr_scans", schema="marketing"
    )
    op.drop_index("idx_qr_scans_scanned_at", table_name="qr_scans", schema="marketing")
    op.drop_index("idx_qr_scans_qr_code_id", table_name="qr_scans", schema="marketing")
    op.drop_table("qr_scans", schema="marketing")
    op.drop_index("ix_social_threads_status", table_name="social_threads", schema="lead")
    op.drop_index("ix_social_threads_platform", table_name="social_threads", schema="lead")
    op.drop_index("ix_social_threads_lead", table_name="social_threads", schema="lead")
    op.drop_index("ix_social_threads_customer", table_name="social_threads", schema="lead")
    op.drop_index("ix_social_threads_assigned_to", table_name="social_threads", schema="lead")
    op.drop_index("ix_social_threads_account_id", table_name="social_threads", schema="lead")
    op.drop_index(op.f("ix_lead_social_threads_status"), table_name="social_threads", schema="lead")
    op.drop_index(
        op.f("ix_lead_social_threads_social_identity_id"),
        table_name="social_threads",
        schema="lead",
    )
    op.drop_index(
        op.f("ix_lead_social_threads_platform"), table_name="social_threads", schema="lead"
    )
    op.drop_index(
        op.f("ix_lead_social_threads_lead_id"), table_name="social_threads", schema="lead"
    )
    op.drop_index(
        op.f("ix_lead_social_threads_customer_id"), table_name="social_threads", schema="lead"
    )
    op.drop_index(
        op.f("ix_lead_social_threads_assigned_to"), table_name="social_threads", schema="lead"
    )
    op.drop_index(
        op.f("ix_lead_social_threads_account_id"), table_name="social_threads", schema="lead"
    )
    op.drop_table("social_threads", schema="lead")
    op.drop_index(
        op.f("ix_lead_sms_delivery_events_subscriber_id"),
        table_name="sms_delivery_events",
        schema="lead",
    )
    op.drop_index(
        op.f("ix_lead_sms_delivery_events_status"), table_name="sms_delivery_events", schema="lead"
    )
    op.drop_index(
        op.f("ix_lead_sms_delivery_events_campaign_id"),
        table_name="sms_delivery_events",
        schema="lead",
    )
    op.drop_table("sms_delivery_events", schema="lead")
    op.drop_index(
        op.f("ix_lead_campaign_events_subscriber_id"), table_name="campaign_events", schema="lead"
    )
    op.drop_index(
        op.f("ix_lead_campaign_events_event_type"), table_name="campaign_events", schema="lead"
    )
    op.drop_index(
        op.f("ix_lead_campaign_events_campaign_id"), table_name="campaign_events", schema="lead"
    )
    op.drop_table("campaign_events", schema="lead")
    op.drop_table("user_roles", schema="identity")
    op.drop_index("idx_station_users_user_id", table_name="station_users", schema="identity")
    op.drop_index("idx_station_users_station_id", table_name="station_users", schema="identity")
    op.drop_table("station_users", schema="identity")
    op.drop_index(
        op.f("ix_identity_station_audit_logs_created_at"),
        table_name="station_audit_logs",
        schema="identity",
    )
    op.drop_index(
        op.f("ix_identity_station_audit_logs_action"),
        table_name="station_audit_logs",
        schema="identity",
    )
    op.drop_index(
        "idx_station_audit_logs_user_id", table_name="station_audit_logs", schema="identity"
    )
    op.drop_index(
        "idx_station_audit_logs_station_id", table_name="station_audit_logs", schema="identity"
    )
    op.drop_index(
        "idx_station_audit_logs_created_at", table_name="station_audit_logs", schema="identity"
    )
    op.drop_index(
        "idx_station_audit_logs_action", table_name="station_audit_logs", schema="identity"
    )
    op.drop_table("station_audit_logs", schema="identity")
    op.drop_index(
        op.f("ix_identity_station_access_tokens_token"),
        table_name="station_access_tokens",
        schema="identity",
    )
    op.drop_index(
        op.f("ix_identity_station_access_tokens_is_active"),
        table_name="station_access_tokens",
        schema="identity",
    )
    op.drop_index(
        "idx_station_access_tokens_token", table_name="station_access_tokens", schema="identity"
    )
    op.drop_index(
        "idx_station_access_tokens_station_id",
        table_name="station_access_tokens",
        schema="identity",
    )
    op.drop_index(
        "idx_station_access_tokens_active", table_name="station_access_tokens", schema="identity"
    )
    op.drop_table("station_access_tokens", schema="identity")
    op.drop_index(
        op.f("ix_identity_social_accounts_provider"),
        table_name="social_accounts",
        schema="identity",
    )
    op.drop_index("idx_social_accounts_user_id", table_name="social_accounts", schema="identity")
    op.drop_index("idx_social_accounts_provider", table_name="social_accounts", schema="identity")
    op.drop_table("social_accounts", schema="identity")
    op.drop_index("idx_role_permissions_role_id", table_name="role_permissions", schema="identity")
    op.drop_index(
        "idx_role_permissions_permission_id", table_name="role_permissions", schema="identity"
    )
    op.drop_table("role_permissions", schema="identity")
    op.drop_index("idx_google_oauth_user", table_name="oauth_accounts", schema="identity")
    op.drop_index("idx_google_oauth_provider", table_name="oauth_accounts", schema="identity")
    op.drop_index("idx_google_oauth_email", table_name="oauth_accounts", schema="identity")
    op.drop_table("oauth_accounts", schema="identity")
    op.drop_index("idx_admin_invitations_status", table_name="admin_invitations", schema="identity")
    op.drop_index(
        "idx_admin_invitations_station", table_name="admin_invitations", schema="identity"
    )
    op.drop_index("idx_admin_invitations_email", table_name="admin_invitations", schema="identity")
    op.drop_index("idx_admin_invitations_code", table_name="admin_invitations", schema="identity")
    op.drop_table("admin_invitations", schema="identity")
    op.drop_index(
        op.f("ix_events_outbox_entries_target"), table_name="outbox_entries", schema="events"
    )
    op.drop_index(
        op.f("ix_events_outbox_entries_status"), table_name="outbox_entries", schema="events"
    )
    op.drop_index(
        op.f("ix_events_outbox_entries_event_id"), table_name="outbox_entries", schema="events"
    )
    op.drop_table("outbox_entries", schema="events")
    op.drop_index("idx_crm_segment_rules_segment", table_name="segment_rules", schema="crm")
    op.drop_table("segment_rules", schema="crm")
    op.drop_index(op.f("ix_core_reviews_status"), table_name="reviews", schema="core")
    op.drop_index("idx_reviews_thread_id", table_name="reviews", schema="core")
    op.drop_index("idx_reviews_status", table_name="reviews", schema="core")
    op.drop_index("idx_reviews_rating", table_name="reviews", schema="core")
    op.drop_table("reviews", schema="core")
    op.drop_index("ix_core_customers_email_active", table_name="customers", schema="core")
    op.drop_index("idx_customer_station_email", table_name="customers", schema="core")
    op.drop_index("idx_customer_station_created", table_name="customers", schema="core")
    op.drop_table("customers", schema="core")
    op.drop_index(
        op.f("ix_ai_ai_rlhf_scores_tutor_pair_id"), table_name="ai_rlhf_scores", schema="ai"
    )
    op.drop_index(op.f("ix_ai_ai_rlhf_scores_id"), table_name="ai_rlhf_scores", schema="ai")
    op.drop_index(op.f("ix_ai_ai_rlhf_scores_created_at"), table_name="ai_rlhf_scores", schema="ai")
    op.drop_index("idx_rlhf_tutor", table_name="ai_rlhf_scores", schema="ai")
    op.drop_index("idx_rlhf_reviewer", table_name="ai_rlhf_scores", schema="ai")
    op.drop_index("idx_rlhf_production", table_name="ai_rlhf_scores", schema="ai")
    op.drop_index("idx_rlhf_overall", table_name="ai_rlhf_scores", schema="ai")
    op.drop_table("ai_rlhf_scores", schema="ai")
    op.drop_index(op.f("ix_roles_name"), table_name="roles")
    op.drop_index(op.f("ix_roles_created_at"), table_name="roles")
    op.drop_table("roles")
    op.drop_index("idx_sync_history_user", table_name="sync_history", schema="public")
    op.drop_index("idx_sync_history_status", table_name="sync_history", schema="public")
    op.drop_index("idx_sync_history_source", table_name="sync_history", schema="public")
    op.drop_index("idx_sync_history_created", table_name="sync_history", schema="public")
    op.drop_table("sync_history", schema="public")
    op.drop_index(
        op.f("ix_public_discount_coupons_code"), table_name="discount_coupons", schema="public"
    )
    op.drop_table("discount_coupons", schema="public")
    op.drop_index(
        op.f("ix_public_customer_reviews_customer_id"),
        table_name="customer_reviews",
        schema="public",
    )
    op.drop_index(
        op.f("ix_public_customer_reviews_booking_id"),
        table_name="customer_reviews",
        schema="public",
    )
    op.drop_table("customer_reviews", schema="public")
    op.drop_index(op.f("ix_permissions_resource"), table_name="permissions")
    op.drop_index(op.f("ix_permissions_name"), table_name="permissions")
    op.drop_index(op.f("ix_permissions_action"), table_name="permissions")
    op.drop_table("permissions")
    op.drop_index("idx_ops_travel_zones_active", table_name="travel_zones", schema="ops")
    op.drop_table("travel_zones", schema="ops")
    op.drop_index("idx_ops_pricing_rules_type", table_name="pricing_rules", schema="ops")
    op.drop_index("idx_ops_pricing_rules_priority", table_name="pricing_rules", schema="ops")
    op.drop_index("idx_ops_pricing_rules_active", table_name="pricing_rules", schema="ops")
    op.drop_table("pricing_rules", schema="ops")
    op.drop_index("idx_ops_menu_items_category", table_name="menu_items", schema="ops")
    op.drop_index("idx_ops_menu_items_available", table_name="menu_items", schema="ops")
    op.drop_table("menu_items", schema="ops")
    op.drop_index("idx_ops_inventory_reorder", table_name="inventory", schema="ops")
    op.drop_index("idx_ops_inventory_category", table_name="inventory", schema="ops")
    op.drop_table("inventory", schema="ops")
    op.drop_index("idx_ops_equipment_type", table_name="equipment", schema="ops")
    op.drop_index("idx_ops_equipment_status", table_name="equipment", schema="ops")
    op.drop_table("equipment", schema="ops")
    op.drop_index("idx_ops_chefs_specialty", table_name="chefs", schema="ops")
    op.drop_index("idx_ops_chefs_rating", table_name="chefs", schema="ops")
    op.drop_index("idx_ops_chefs_active", table_name="chefs", schema="ops")
    op.drop_table("chefs", schema="ops")
    op.drop_index("ix_newsletter_campaigns_status", table_name="campaigns", schema="newsletter")
    op.drop_index("ix_newsletter_campaigns_sent", table_name="campaigns", schema="newsletter")
    op.drop_table("campaigns", schema="newsletter")
    op.drop_index(op.f("ix_marketing_qr_codes_type"), table_name="qr_codes", schema="marketing")
    op.drop_index(
        op.f("ix_marketing_qr_codes_is_active"), table_name="qr_codes", schema="marketing"
    )
    op.drop_index(op.f("ix_marketing_qr_codes_code"), table_name="qr_codes", schema="marketing")
    op.drop_index("idx_qr_codes_type", table_name="qr_codes", schema="marketing")
    op.drop_index("idx_qr_codes_code", table_name="qr_codes", schema="marketing")
    op.drop_index("idx_qr_codes_active", table_name="qr_codes", schema="marketing")
    op.drop_table("qr_codes", schema="marketing")
    op.drop_index(op.f("ix_lead_subscribers_phone"), table_name="subscribers", schema="lead")
    op.drop_index(op.f("ix_lead_subscribers_lead_id"), table_name="subscribers", schema="lead")
    op.drop_index(op.f("ix_lead_subscribers_email"), table_name="subscribers", schema="lead")
    op.drop_index(op.f("ix_lead_subscribers_customer_id"), table_name="subscribers", schema="lead")
    op.drop_table("subscribers", schema="lead")
    op.drop_index(
        "ix_social_identities_platform_handle", table_name="social_identities", schema="lead"
    )
    op.drop_index("ix_social_identities_platform", table_name="social_identities", schema="lead")
    op.drop_index("ix_social_identities_customer_id", table_name="social_identities", schema="lead")
    op.drop_index(
        op.f("ix_lead_social_identities_platform"), table_name="social_identities", schema="lead"
    )
    op.drop_index(
        op.f("ix_lead_social_identities_customer_id"), table_name="social_identities", schema="lead"
    )
    op.drop_table("social_identities", schema="lead")
    op.drop_index(
        "ix_social_accounts_platform_page_id", table_name="social_accounts", schema="lead"
    )
    op.drop_index("ix_social_accounts_platform", table_name="social_accounts", schema="lead")
    op.drop_index("ix_social_accounts_is_active", table_name="social_accounts", schema="lead")
    op.drop_index(
        op.f("ix_lead_social_accounts_platform"), table_name="social_accounts", schema="lead"
    )
    op.drop_index(
        op.f("ix_lead_social_accounts_is_active"), table_name="social_accounts", schema="lead"
    )
    op.drop_table("social_accounts", schema="lead")
    op.drop_table("campaigns", schema="lead")
    op.drop_index("ix_social_inbox_platform_received", table_name="social_inbox", schema="integra")
    op.drop_table("social_inbox", schema="integra")
    op.drop_index(
        "ix_integra_payment_events_provider_id", table_name="payment_events", schema="integra"
    )
    op.drop_index(
        "ix_integra_payment_events_occurred", table_name="payment_events", schema="integra"
    )
    op.drop_table("payment_events", schema="integra")
    op.drop_index(op.f("ix_identity_users_status"), table_name="users", schema="identity")
    op.drop_index(op.f("ix_identity_users_email"), table_name="users", schema="identity")
    op.drop_index("idx_users_status", table_name="users", schema="identity")
    op.drop_index("idx_users_email", table_name="users", schema="identity")
    op.drop_index("idx_users_created_at", table_name="users", schema="identity")
    op.drop_table("users", schema="identity")
    op.drop_index("idx_station_status", table_name="stations", schema="identity")
    op.drop_index("idx_station_code", table_name="stations", schema="identity")
    op.drop_table("stations", schema="identity")
    op.drop_index(op.f("ix_identity_roles_role_type"), table_name="roles", schema="identity")
    op.drop_index(op.f("ix_identity_roles_name"), table_name="roles", schema="identity")
    op.drop_index(op.f("ix_identity_roles_is_active"), table_name="roles", schema="identity")
    op.drop_index("idx_roles_role_type", table_name="roles", schema="identity")
    op.drop_index("idx_roles_name", table_name="roles", schema="identity")
    op.drop_index("idx_roles_active", table_name="roles", schema="identity")
    op.drop_table("roles", schema="identity")
    op.drop_index("idx_permissions_resource_action", table_name="permissions", schema="identity")
    op.drop_table("permissions", schema="identity")
    op.drop_index(
        op.f("ix_feedback_discount_coupons_valid_until"),
        table_name="discount_coupons",
        schema="feedback",
    )
    op.drop_index(
        op.f("ix_feedback_discount_coupons_valid_from"),
        table_name="discount_coupons",
        schema="feedback",
    )
    op.drop_index(
        op.f("ix_feedback_discount_coupons_status"),
        table_name="discount_coupons",
        schema="feedback",
    )
    op.drop_index(
        op.f("ix_feedback_discount_coupons_code"), table_name="discount_coupons", schema="feedback"
    )
    op.drop_index(
        "idx_discount_coupons_valid_until", table_name="discount_coupons", schema="feedback"
    )
    op.drop_index(
        "idx_discount_coupons_valid_from", table_name="discount_coupons", schema="feedback"
    )
    op.drop_index("idx_discount_coupons_status", table_name="discount_coupons", schema="feedback")
    op.drop_index("idx_discount_coupons_code", table_name="discount_coupons", schema="feedback")
    op.drop_table("discount_coupons", schema="feedback")
    op.drop_index(op.f("ix_events_outbox_status"), table_name="outbox", schema="events")
    op.drop_index(op.f("ix_events_outbox_scheduled_at"), table_name="outbox", schema="events")
    op.drop_index(op.f("ix_events_outbox_destination"), table_name="outbox", schema="events")
    op.drop_index(op.f("ix_events_outbox_created_at"), table_name="outbox", schema="events")
    op.drop_index(op.f("ix_events_outbox_aggregate_id"), table_name="outbox", schema="events")
    op.drop_index("idx_outbox_status", table_name="outbox", schema="events")
    op.drop_index("idx_outbox_scheduled_at", table_name="outbox", schema="events")
    op.drop_index("idx_outbox_destination", table_name="outbox", schema="events")
    op.drop_index("idx_outbox_created_at", table_name="outbox", schema="events")
    op.drop_index("idx_outbox_aggregate_id", table_name="outbox", schema="events")
    op.drop_table("outbox", schema="events")
    op.drop_index(op.f("ix_events_inbox_source"), table_name="inbox", schema="events")
    op.drop_index(op.f("ix_events_inbox_received_at"), table_name="inbox", schema="events")
    op.drop_index(op.f("ix_events_inbox_message_id"), table_name="inbox", schema="events")
    op.drop_index(op.f("ix_events_inbox_is_processed"), table_name="inbox", schema="events")
    op.drop_index("idx_inbox_source", table_name="inbox", schema="events")
    op.drop_index("idx_inbox_received_at", table_name="inbox", schema="events")
    op.drop_index("idx_inbox_processed", table_name="inbox", schema="events")
    op.drop_index("idx_inbox_message_id", table_name="inbox", schema="events")
    op.drop_table("inbox", schema="events")
    op.drop_index(
        op.f("ix_events_domain_events_occurred_at"), table_name="domain_events", schema="events"
    )
    op.drop_index(
        op.f("ix_events_domain_events_event_type"), table_name="domain_events", schema="events"
    )
    op.drop_index(
        op.f("ix_events_domain_events_aggregate_type"), table_name="domain_events", schema="events"
    )
    op.drop_index(
        op.f("ix_events_domain_events_aggregate_id"), table_name="domain_events", schema="events"
    )
    op.drop_index("idx_domain_events_occurred_at", table_name="domain_events", schema="events")
    op.drop_index("idx_domain_events_event_type", table_name="domain_events", schema="events")
    op.drop_index(
        "idx_domain_events_aggregate_type_id", table_name="domain_events", schema="events"
    )
    op.drop_index("idx_domain_events_aggregate_id", table_name="domain_events", schema="events")
    op.drop_table("domain_events", schema="events")
    op.drop_index(op.f("ix_email_threads_thread_id"), table_name="email_threads")
    op.drop_index(op.f("ix_email_threads_subject"), table_name="email_threads")
    op.drop_index(op.f("ix_email_threads_last_message_at"), table_name="email_threads")
    op.drop_index(op.f("ix_email_threads_is_starred"), table_name="email_threads")
    op.drop_index(op.f("ix_email_threads_is_read"), table_name="email_threads")
    op.drop_index(op.f("ix_email_threads_is_archived"), table_name="email_threads")
    op.drop_index(op.f("ix_email_threads_inbox"), table_name="email_threads")
    op.drop_index(op.f("ix_email_threads_id"), table_name="email_threads")
    op.drop_index(op.f("ix_email_threads_first_message_at"), table_name="email_threads")
    op.drop_index("idx_inbox_read_archived", table_name="email_threads")
    op.drop_index("idx_inbox_last_message", table_name="email_threads")
    op.drop_table("email_threads")
    op.drop_index(op.f("ix_email_sync_status_inbox"), table_name="email_sync_status")
    op.drop_index(op.f("ix_email_sync_status_id"), table_name="email_sync_status")
    op.drop_table("email_sync_status")
    op.drop_index(op.f("ix_email_messages_thread_id"), table_name="email_messages")
    op.drop_index(op.f("ix_email_messages_subject"), table_name="email_messages")
    op.drop_index(op.f("ix_email_messages_received_at"), table_name="email_messages")
    op.drop_index(op.f("ix_email_messages_message_id"), table_name="email_messages")
    op.drop_index(op.f("ix_email_messages_is_starred"), table_name="email_messages")
    op.drop_index(op.f("ix_email_messages_is_read"), table_name="email_messages")
    op.drop_index(op.f("ix_email_messages_is_archived"), table_name="email_messages")
    op.drop_index(op.f("ix_email_messages_inbox"), table_name="email_messages")
    op.drop_index(op.f("ix_email_messages_imap_uid"), table_name="email_messages")
    op.drop_index(op.f("ix_email_messages_id"), table_name="email_messages")
    op.drop_index(op.f("ix_email_messages_from_address"), table_name="email_messages")
    op.drop_index("idx_thread_received", table_name="email_messages")
    op.drop_index("idx_inbox_received", table_name="email_messages")
    op.drop_index("idx_inbox_read_archived", table_name="email_messages")
    op.drop_index("idx_from_address_received", table_name="email_messages")
    op.drop_table("email_messages")
    op.drop_index("idx_crm_segments_active", table_name="customer_segments", schema="crm")
    op.drop_table("customer_segments", schema="crm")
    op.drop_index("idx_crm_campaigns_status", table_name="campaigns", schema="crm")
    op.drop_index("idx_crm_campaigns_sent", table_name="campaigns", schema="crm")
    op.drop_index("idx_crm_campaigns_channel", table_name="campaigns", schema="crm")
    op.drop_table("campaigns", schema="crm")
    op.drop_index(op.f("ix_core_social_threads_status"), table_name="social_threads", schema="core")
    op.drop_index(
        op.f("ix_core_social_threads_platform"), table_name="social_threads", schema="core"
    )
    op.drop_index("idx_social_threads_status", table_name="social_threads", schema="core")
    op.drop_index("idx_social_threads_platform", table_name="social_threads", schema="core")
    op.drop_index("idx_social_threads_created_at", table_name="social_threads", schema="core")
    op.drop_table("social_threads", schema="core")
    op.drop_index(op.f("ix_core_pricing_tiers_level"), table_name="pricing_tiers", schema="core")
    op.drop_index(
        op.f("ix_core_pricing_tiers_is_active"), table_name="pricing_tiers", schema="core"
    )
    op.drop_index("idx_pricing_tiers_level", table_name="pricing_tiers", schema="core")
    op.drop_index("idx_pricing_tiers_active", table_name="pricing_tiers", schema="core")
    op.drop_table("pricing_tiers", schema="core")
    op.drop_index(op.f("ix_core_chefs_phone"), table_name="chefs", schema="core")
    op.drop_index(op.f("ix_core_chefs_is_active"), table_name="chefs", schema="core")
    op.drop_index(op.f("ix_core_chefs_email"), table_name="chefs", schema="core")
    op.drop_index("idx_chefs_phone", table_name="chefs", schema="core")
    op.drop_index("idx_chefs_email", table_name="chefs", schema="core")
    op.drop_index("idx_chefs_active", table_name="chefs", schema="core")
    op.drop_table("chefs", schema="core")
    op.drop_index(op.f("ix_catering_bookings_status"), table_name="catering_bookings")
    op.drop_index(op.f("ix_catering_bookings_id"), table_name="catering_bookings")
    op.drop_index(op.f("ix_catering_bookings_event_date"), table_name="catering_bookings")
    op.drop_index(op.f("ix_catering_bookings_customer_phone"), table_name="catering_bookings")
    op.drop_index(op.f("ix_catering_bookings_customer_name"), table_name="catering_bookings")
    op.drop_index(op.f("ix_catering_bookings_customer_email"), table_name="catering_bookings")
    op.drop_table("catering_bookings")
    op.drop_index(op.f("ix_call_recordings_to_phone"), table_name="call_recordings")
    op.drop_index(op.f("ix_call_recordings_status"), table_name="call_recordings")
    op.drop_index(op.f("ix_call_recordings_rc_recording_id"), table_name="call_recordings")
    op.drop_index(op.f("ix_call_recordings_rc_call_id"), table_name="call_recordings")
    op.drop_index(op.f("ix_call_recordings_id"), table_name="call_recordings")
    op.drop_index(op.f("ix_call_recordings_from_phone"), table_name="call_recordings")
    op.drop_index(op.f("ix_call_recordings_escalation_id"), table_name="call_recordings")
    op.drop_index(op.f("ix_call_recordings_delete_after"), table_name="call_recordings")
    op.drop_index(op.f("ix_call_recordings_customer_id"), table_name="call_recordings")
    op.drop_index(op.f("ix_call_recordings_created_at"), table_name="call_recordings")
    op.drop_index(op.f("ix_call_recordings_call_type"), table_name="call_recordings")
    op.drop_index(op.f("ix_call_recordings_call_started_at"), table_name="call_recordings")
    op.drop_index(op.f("ix_call_recordings_booking_id"), table_name="call_recordings")
    op.drop_table("call_recordings")
    op.drop_index("idx_kb_usage_success", table_name="kb_chunks", schema="ai")
    op.drop_index("idx_kb_updated", table_name="kb_chunks", schema="ai")
    op.drop_index("idx_kb_tags", table_name="kb_chunks", schema="ai", postgresql_using="gin")
    op.drop_index("idx_kb_source_type", table_name="kb_chunks", schema="ai")
    op.drop_index("idx_kb_source_message", table_name="kb_chunks", schema="ai")
    op.drop_index("idx_kb_category", table_name="kb_chunks", schema="ai")
    op.drop_table("kb_chunks", schema="ai")
    op.drop_index("idx_escalation_updated", table_name="escalation_rules", schema="ai")
    op.drop_index("idx_escalation_active_priority", table_name="escalation_rules", schema="ai")
    op.drop_table("escalation_rules", schema="ai")
    op.drop_index(
        op.f("ix_ai_customer_engagement_followups_user_id"),
        table_name="customer_engagement_followups",
        schema="ai",
    )
    op.drop_index(
        op.f("ix_ai_customer_engagement_followups_scheduled_at"),
        table_name="customer_engagement_followups",
        schema="ai",
    )
    op.drop_index(
        op.f("ix_ai_customer_engagement_followups_conversation_id"),
        table_name="customer_engagement_followups",
        schema="ai",
    )
    op.drop_index(
        "idx_followups_user_status", table_name="customer_engagement_followups", schema="ai"
    )
    op.drop_index(
        "idx_followups_trigger_type", table_name="customer_engagement_followups", schema="ai"
    )
    op.drop_index(
        "idx_followups_status_scheduled", table_name="customer_engagement_followups", schema="ai"
    )
    op.drop_index("idx_followups_executed", table_name="customer_engagement_followups", schema="ai")
    op.drop_index(
        "idx_followups_duplicate_check", table_name="customer_engagement_followups", schema="ai"
    )
    op.drop_index("idx_followups_created", table_name="customer_engagement_followups", schema="ai")
    op.drop_index(
        "idx_followups_conversation", table_name="customer_engagement_followups", schema="ai"
    )
    op.drop_table("customer_engagement_followups", schema="ai")
    op.drop_index(op.f("ix_ai_ai_tutor_pairs_id"), table_name="ai_tutor_pairs", schema="ai")
    op.drop_index(op.f("ix_ai_ai_tutor_pairs_created_at"), table_name="ai_tutor_pairs", schema="ai")
    op.drop_index("idx_tutor_similarity", table_name="ai_tutor_pairs", schema="ai")
    op.drop_index("idx_tutor_quality", table_name="ai_tutor_pairs", schema="ai")
    op.drop_index("idx_tutor_production", table_name="ai_tutor_pairs", schema="ai")
    op.drop_index("idx_tutor_feedback", table_name="ai_tutor_pairs", schema="ai")
    op.drop_index("idx_tutor_created", table_name="ai_tutor_pairs", schema="ai")
    op.drop_index("idx_tutor_agent", table_name="ai_tutor_pairs", schema="ai")
    op.drop_table("ai_tutor_pairs", schema="ai")
    op.drop_index(op.f("ix_ai_ai_export_jobs_status"), table_name="ai_export_jobs", schema="ai")
    op.drop_index(op.f("ix_ai_ai_export_jobs_id"), table_name="ai_export_jobs", schema="ai")
    op.drop_index(op.f("ix_ai_ai_export_jobs_created_at"), table_name="ai_export_jobs", schema="ai")
    op.drop_index("idx_export_type", table_name="ai_export_jobs", schema="ai")
    op.drop_index("idx_export_status", table_name="ai_export_jobs", schema="ai")
    op.drop_index("idx_export_creator", table_name="ai_export_jobs", schema="ai")
    op.drop_table("ai_export_jobs", schema="ai")
    # ### end Alembic commands ###
