# üóÑÔ∏è Database Migrations Guide

**Purpose:** Comprehensive guide for managing database schema changes using Alembic  
**Database:** PostgreSQL  
**Migration Tool:** Alembic (SQLAlchemy-based)  
**Location:** `apps/backend/src/db/migrations/`

---

## üìã Table of Contents

1. [Quick Reference](#quick-reference)
2. [Migration Basics](#migration-basics)
3. [Creating Migrations](#creating-migrations)
4. [Running Migrations](#running-migrations)
5. [Rollback Procedures](#rollback-procedures)
6. [Best Practices](#best-practices)
7. [Troubleshooting](#troubleshooting)
8. [Production Deployment](#production-deployment)

---

## üöÄ Quick Reference

### **Common Commands**

```bash
# Navigate to backend directory
cd apps/backend

# Check current database version
alembic current

# Show migration history
alembic history --verbose

# Create new migration (autogenerate from models)
alembic revision --autogenerate -m "Add user preferences table"

# Create empty migration (manual)
alembic revision -m "Add custom indexes"

# Apply all pending migrations
alembic upgrade head

# Rollback last migration
alembic downgrade -1

# Rollback to specific revision
alembic downgrade <revision_id>

# Show SQL without executing (dry run)
alembic upgrade head --sql

# Check for differences between database and models
alembic check
```

---

## üìö Migration Basics

### **What is a Migration?**

A migration is a **versioned database schema change** that can be:
- **Applied** (upgrade): Move database forward to new schema
- **Reverted** (downgrade): Move database backward to previous schema

### **Why Use Migrations?**

‚úÖ **Version Control:** Track schema changes like code changes  
‚úÖ **Reproducible:** Apply same changes across dev/staging/production  
‚úÖ **Reversible:** Rollback if something goes wrong  
‚úÖ **Automated:** No manual SQL scripts  
‚úÖ **Safe:** Test migrations before production  

### **Migration Structure**

```
apps/backend/src/db/migrations/
‚îú‚îÄ‚îÄ alembic/                    # Main migrations (CRM, bookings)
‚îÇ   ‚îú‚îÄ‚îÄ env.py                 # Alembic environment config
‚îÇ   ‚îú‚îÄ‚îÄ script.py.mako         # Migration template
‚îÇ   ‚îî‚îÄ‚îÄ versions/              # Migration files
‚îÇ       ‚îú‚îÄ‚îÄ 001_create_crm_schemas.py
‚îÇ       ‚îú‚îÄ‚îÄ 002_create_read_projections.py
‚îÇ       ‚îî‚îÄ‚îÄ 004_add_station_multi_tenant_rbac.py
‚îî‚îÄ‚îÄ ai/                        # AI-specific migrations
    ‚îú‚îÄ‚îÄ env.py
    ‚îú‚îÄ‚îÄ script.py.mako
    ‚îî‚îÄ‚îÄ versions/
        ‚îî‚îÄ‚îÄ 56d701cf2472_initial_ai_router_schema.py
```

### **Migration File Anatomy**

```python
"""Add user preferences table

Revision ID: abc123def456
Revises: previous_revision
Create Date: 2025-01-15 10:30:00.123456
"""

from alembic import op
import sqlalchemy as sa

# Revision identifiers
revision = 'abc123def456'
down_revision = 'previous_revision'  # Previous migration
branch_labels = None
depends_on = None

def upgrade() -> None:
    """Apply changes to database"""
    op.create_table(
        'user_preferences',
        sa.Column('id', sa.Integer(), nullable=False),
        sa.Column('user_id', sa.Integer(), nullable=False),
        sa.Column('theme', sa.String(20), nullable=False),
        sa.PrimaryKeyConstraint('id'),
        sa.ForeignKeyConstraint(['user_id'], ['users.id'])
    )

def downgrade() -> None:
    """Revert changes to database"""
    op.drop_table('user_preferences')
```

---

## üõ†Ô∏è Creating Migrations

### **Step 1: Update Your Models**

First, modify SQLAlchemy models in `apps/backend/src/models/`:

```python
# apps/backend/src/models/user_models.py
from sqlalchemy import Column, Integer, String
from app.database import Base

class UserPreferences(Base):
    __tablename__ = "user_preferences"
    
    id = Column(Integer, primary_key=True)
    user_id = Column(Integer, ForeignKey("users.id"), nullable=False)
    theme = Column(String(20), nullable=False, default="light")
    language = Column(String(10), nullable=False, default="en")
```

### **Step 2: Generate Migration**

```bash
cd apps/backend

# Autogenerate migration from model changes
alembic revision --autogenerate -m "Add user preferences table"
```

**What Alembic Detects:**
- ‚úÖ New tables
- ‚úÖ New columns
- ‚úÖ Changed column types
- ‚úÖ New indexes
- ‚úÖ New foreign keys

**What Alembic DOESN'T Detect:**
- ‚ùå Table/column renames (sees as drop + add)
- ‚ùå Changes to `server_default` values
- ‚ùå Check constraints

### **Step 3: Review Generated Migration**

**‚ö†Ô∏è CRITICAL: Always review autogenerated migrations!**

```bash
# Open the newly created migration file
code apps/backend/src/db/migrations/alembic/versions/abc123_add_user_preferences.py
```

**Check for:**
1. ‚úÖ Column types are correct
2. ‚úÖ Nullable constraints match your intent
3. ‚úÖ Foreign keys reference correct tables
4. ‚úÖ Indexes are created where needed
5. ‚úÖ Downgrade function properly reverts changes

### **Step 4: Test Migration Locally**

```bash
# Apply migration
alembic upgrade head

# Check database
psql -d myhibachi_dev -c "\dt"  # List tables
psql -d myhibachi_dev -c "\d user_preferences"  # Describe table

# Test rollback
alembic downgrade -1

# Re-apply
alembic upgrade head
```

### **Step 5: Commit Migration**

```bash
git add apps/backend/src/db/migrations/alembic/versions/abc123_add_user_preferences.py
git commit -m "feat: Add user preferences table migration"
```

---

## ‚ñ∂Ô∏è Running Migrations

### **Development Environment**

```bash
# Apply all pending migrations
cd apps/backend
alembic upgrade head
```

### **Staging Environment**

```bash
# Check current version
alembic current

# Show what will be applied
alembic upgrade head --sql > migration_preview.sql
cat migration_preview.sql  # Review changes

# Apply migrations
alembic upgrade head
```

### **Production Environment**

**‚ö†Ô∏è ALWAYS follow pre-deployment checklist (see below)**

```bash
# 1. Backup database first!
./ops/backup_db.py --environment production

# 2. Run in maintenance window
# 3. Check current version
alembic current

# 4. Dry run (generate SQL without executing)
alembic upgrade head --sql > production_migration_$(date +%Y%m%d_%H%M%S).sql

# 5. Review SQL file
less production_migration_*.sql

# 6. Apply migrations
alembic upgrade head

# 7. Verify application still works
curl https://mhapi.mysticdatanode.net/health
```

---

## ‚è™ Rollback Procedures

### **Rollback Last Migration**

```bash
# Undo the most recent migration
alembic downgrade -1

# Verify rollback
alembic current
```

### **Rollback to Specific Version**

```bash
# Find revision ID
alembic history

# Rollback to specific revision
alembic downgrade abc123def456

# Or rollback 3 migrations
alembic downgrade -3
```

### **Rollback to Base (DESTRUCTIVE)**

```bash
# ‚ö†Ô∏è WARNING: This drops all tables!
alembic downgrade base
```

### **Emergency Production Rollback**

```bash
# 1. Stop application (prevent writes)
systemctl stop myhibachi-api

# 2. Rollback migration
cd /opt/myhibachi/apps/backend
alembic downgrade -1

# 3. Restart application
systemctl start myhibachi-api

# 4. Verify
systemctl status myhibachi-api
curl https://mhapi.mysticdatanode.net/health
```

---

## ‚úÖ Best Practices

### **1. Migration Naming**

```bash
# ‚úÖ GOOD - Descriptive names
alembic revision --autogenerate -m "Add user preferences table"
alembic revision --autogenerate -m "Add indexes to bookings table"
alembic revision --autogenerate -m "Change booking status enum values"

# ‚ùå BAD - Vague names
alembic revision --autogenerate -m "Update database"
alembic revision --autogenerate -m "Fix stuff"
alembic revision --autogenerate -m "Changes"
```

### **2. One Migration per Logical Change**

```bash
# ‚úÖ GOOD - Separate migrations
alembic revision -m "Add user preferences table"
alembic revision -m "Add email verification columns"

# ‚ùå BAD - Too many changes in one migration
alembic revision -m "Add preferences, fix indexes, update enums, add constraints"
```

### **3. Always Include Downgrade**

```python
# ‚úÖ GOOD - Reversible migration
def upgrade() -> None:
    op.create_table('user_preferences', ...)

def downgrade() -> None:
    op.drop_table('user_preferences')  # Can rollback

# ‚ùå BAD - Non-reversible migration
def upgrade() -> None:
    op.create_table('user_preferences', ...)

def downgrade() -> None:
    pass  # Can't rollback!
```

### **4. Handle Data Migrations Carefully**

```python
# ‚úÖ GOOD - Safe data migration
def upgrade() -> None:
    # 1. Add new column as nullable
    op.add_column('users', sa.Column('full_name', sa.String(255), nullable=True))
    
    # 2. Populate data
    op.execute("UPDATE users SET full_name = first_name || ' ' || last_name")
    
    # 3. Make column non-nullable
    op.alter_column('users', 'full_name', nullable=False)

def downgrade() -> None:
    op.drop_column('users', 'full_name')
```

### **5. Test Migrations Thoroughly**

```bash
# Test upgrade
alembic upgrade head

# Test downgrade
alembic downgrade -1

# Test re-upgrade
alembic upgrade head

# Verify data integrity
psql -d myhibachi_dev -c "SELECT COUNT(*) FROM users;"
```

### **6. Never Edit Applied Migrations**

```bash
# ‚ùå NEVER DO THIS
# If migration already applied to production, DON'T edit it!
# Create a new migration instead

# ‚úÖ DO THIS
alembic revision -m "Fix column type in user preferences"
```

### **7. Keep Migrations Fast**

```python
# ‚úÖ GOOD - Fast migration
def upgrade() -> None:
    op.add_column('users', sa.Column('theme', sa.String(20)))
    op.create_index('ix_users_theme', 'users', ['theme'])

# ‚ö†Ô∏è CAUTION - Slow migration (locks table)
def upgrade() -> None:
    # This locks the entire table during backfill
    op.add_column('users', sa.Column('score', sa.Integer(), nullable=False, server_default='0'))
    op.execute("UPDATE users SET score = calculate_score(id)")  # Slow!
```

**For large tables, use multi-step migrations:**

```python
# Migration 1: Add nullable column
def upgrade() -> None:
    op.add_column('users', sa.Column('score', sa.Integer(), nullable=True))

# Migration 2: Backfill data (can run during off-peak)
def upgrade() -> None:
    op.execute("UPDATE users SET score = 0 WHERE score IS NULL")

# Migration 3: Make non-nullable
def upgrade() -> None:
    op.alter_column('users', 'score', nullable=False)
```

---

## üêõ Troubleshooting

### **Problem: "Target database is not up to date"**

```bash
# Check current version
alembic current
# Output: abc123def456

# Check what's expected
alembic heads
# Output: xyz789ghi012 (head)

# Solution: Apply pending migrations
alembic upgrade head
```

### **Problem: "Can't locate revision identified by 'abc123'"**

**Cause:** Migration file missing from `versions/` directory

**Solution:**
```bash
# 1. Pull latest migrations from git
git pull origin main

# 2. Check versions directory
ls apps/backend/src/db/migrations/alembic/versions/

# 3. If migration truly doesn't exist, you may need to stamp
alembic stamp head  # ‚ö†Ô∏è Use with caution!
```

### **Problem: "Duplicate key value violates unique constraint"**

**Cause:** Migration tries to insert data that already exists

**Solution:**
```python
# Use ON CONFLICT in your migration
def upgrade() -> None:
    op.execute("""
        INSERT INTO settings (key, value)
        VALUES ('theme', 'light')
        ON CONFLICT (key) DO NOTHING
    """)
```

### **Problem: "Column already exists"**

**Cause:** Database out of sync with migrations

**Solution 1: Stamp database to correct version**
```bash
# Find current schema state
alembic current

# Stamp to correct version (if you know database is actually correct)
alembic stamp xyz789  # Use actual revision ID
```

**Solution 2: Reset database (DEVELOPMENT ONLY)**
```bash
# ‚ö†Ô∏è DESTRUCTIVE - Only for development!
dropdb myhibachi_dev
createdb myhibachi_dev
alembic upgrade head
```

### **Problem: Migration takes too long**

**Cause:** Large table with blocking operation

**Solutions:**
1. **Use concurrent index creation (PostgreSQL)**
   ```python
   def upgrade() -> None:
       op.create_index(
           'ix_bookings_created_at',
           'bookings',
           ['created_at'],
           postgresql_concurrently=True  # Non-blocking
       )
   ```

2. **Add column in multiple steps**
   - Migration 1: Add nullable column
   - Migration 2: Backfill data in batches
   - Migration 3: Make non-nullable

3. **Run migration during maintenance window**

---

## üöÄ Production Deployment Checklist

### **Pre-Deployment**

- [ ] **Backup database**
  ```bash
  ./ops/backup_db.py --environment production
  ```

- [ ] **Review migration SQL**
  ```bash
  alembic upgrade head --sql > migration_preview.sql
  ```

- [ ] **Check for breaking changes**
  - Dropped columns still used by running code?
  - Renamed columns?
  - Changed enum values?

- [ ] **Test in staging environment**
  ```bash
  # Staging should mirror production
  alembic upgrade head
  # Run tests
  pytest apps/backend/tests/
  ```

- [ ] **Estimate downtime**
  - Index creation time
  - Data backfill time
  - Total expected duration

- [ ] **Plan rollback procedure**
  - Can we rollback migration?
  - Does code support old schema?
  - Rollback command ready

### **During Deployment**

- [ ] **Put app in maintenance mode** (if needed)
  ```bash
  # Set maintenance flag
  touch /opt/myhibachi/maintenance
  ```

- [ ] **Apply migrations**
  ```bash
  cd /opt/myhibachi/apps/backend
  alembic upgrade head
  ```

- [ ] **Verify migration success**
  ```bash
  alembic current  # Check version
  psql -d myhibachi_prod -c "\dt"  # Verify tables
  ```

- [ ] **Deploy application code**
  ```bash
  git pull origin main
  systemctl restart myhibachi-api
  ```

- [ ] **Health check**
  ```bash
  curl https://mhapi.mysticdatanode.net/health
  curl https://mhapi.mysticdatanode.net/api/bookings  # Test endpoint
  ```

### **Post-Deployment**

- [ ] **Monitor logs**
  ```bash
  journalctl -u myhibachi-api -f
  ```

- [ ] **Monitor database performance**
  ```sql
  SELECT * FROM pg_stat_activity WHERE state = 'active';
  ```

- [ ] **Verify data integrity**
  ```sql
  SELECT COUNT(*) FROM bookings;
  SELECT COUNT(*) FROM users;
  ```

- [ ] **Remove maintenance mode**
  ```bash
  rm /opt/myhibachi/maintenance
  ```

- [ ] **Update documentation**
  - Record migration in changelog
  - Update schema documentation

---

## üìä Migration History

Current migrations in `apps/backend/src/db/migrations/alembic/versions/`:

| Revision | Description | Date | Status |
|----------|-------------|------|--------|
| 001 | Create CRM schemas | - | ‚úÖ Applied |
| 001 | Initial Stripe tables | - | ‚úÖ Applied |
| 002 | Create read projections | - | ‚úÖ Applied |
| 003 | Add lead newsletter schemas | - | ‚úÖ Applied |
| 003 | Add social media integration | - | ‚úÖ Applied |
| 004 | Add station multi-tenant RBAC | - | ‚úÖ Applied |
| 9fd62e8 | Merge migrations | - | ‚úÖ Applied |
| ea90695 | Update indexes and constraints | - | ‚úÖ Applied |

**AI Migrations** (separate branch):
| Revision | Description | Date | Status |
|----------|-------------|------|--------|
| 56d701c | Initial AI router schema | - | ‚úÖ Applied |
| cdf6709 | Update chat system with new models | - | ‚úÖ Applied |

---

## üìö Additional Resources

**Internal:**
- Database models: `apps/backend/src/models/`
- Alembic config: `apps/backend/alembic.ini`
- Environment setup: `apps/backend/src/db/migrations/alembic/env.py`

**External:**
- [Alembic Documentation](https://alembic.sqlalchemy.org/)
- [PostgreSQL ALTER TABLE](https://www.postgresql.org/docs/current/sql-altertable.html)
- [SQLAlchemy Column Types](https://docs.sqlalchemy.org/en/20/core/types.html)

**Common Alembic Operations:**
- [Alembic Operations Reference](https://alembic.sqlalchemy.org/en/latest/ops.html)

---

## üéØ Quick Command Reference

```bash
# Check status
alembic current              # Current version
alembic history              # All migrations
alembic heads                # Latest revision(s)

# Create migrations
alembic revision --autogenerate -m "description"  # Auto-detect changes
alembic revision -m "description"                 # Empty migration

# Apply migrations
alembic upgrade head         # Apply all pending
alembic upgrade +1           # Apply next migration
alembic upgrade <revision>   # Upgrade to specific version

# Rollback migrations
alembic downgrade -1         # Rollback last migration
alembic downgrade <revision> # Downgrade to specific version
alembic downgrade base       # Rollback all (DESTRUCTIVE)

# Other commands
alembic upgrade head --sql   # Preview SQL without executing
alembic check                # Check for differences
alembic stamp <revision>     # Mark database as being at specific version
```

---

**Maintained by:** Backend Team  
**Last Updated:** January 15, 2025  
**Questions?** Refer to Alembic documentation or contact the team.

