# =============================================================================
# My Hibachi - Backend Staging Deployment Workflow
# =============================================================================
# Triggers: Push to 'dev' branch (backend changes only)
# Target: VPS staging container (port 8002)
# 
# REQUIRED GITHUB SECRETS:
#   - VPS_HOST: VPS IP address (108.175.12.154)
#   - VPS_USER: SSH username (root)
#   - VPS_SSH_PRIVATE_KEY: SSH private key for VPS access
#   - VPS_STAGING_PATH: /var/www/vhosts/myhibachichef.com/mhapi.mysticdatanode.net/backend
#   - STAGING_API_URL: Staging API URL for health checks
#
# VPS DOCKER SETUP:
#   - Staging uses: docker-compose.staging.yml (staging-api on port 8002)
#   - Production uses: docker-compose.prod.yml (production-api on port 8000)
# =============================================================================

name: Deploy Backend to Staging

on:
  push:
    branches:
      - dev
    paths:
      - 'apps/backend/**'
      - 'requirements.txt'
      - 'docker-compose.staging.yml'
      - 'Dockerfile'
      - '.github/workflows/deploy-backend-staging.yml'

  workflow_dispatch:
    inputs:
      skip_tests:
        description: 'Skip E2E tests after deployment'
        required: false
        default: 'false'
        type: boolean

concurrency:
  group: staging-deploy
  cancel-in-progress: false

jobs:
  # ===========================================================================
  # JOB 1: Pre-deployment Validation
  # ===========================================================================
  validate:
    name: Pre-deployment Checks
    runs-on: ubuntu-latest
    outputs:
      should_deploy: ${{ steps.check.outputs.should_deploy }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Check for backend changes
        id: check
        run: |
          if git diff --name-only HEAD~1 HEAD | grep -qE '^(apps/backend/|requirements.txt|docker-compose.staging.yml|Dockerfile)'; then
            echo "should_deploy=true" >> $GITHUB_OUTPUT
            echo "âœ… Backend changes detected - will deploy"
          else
            echo "should_deploy=true" >> $GITHUB_OUTPUT
            echo "â„¹ï¸ Workflow file changed or manual trigger - will deploy"
          fi

  # ===========================================================================
  # JOB 2: Deploy to Staging VPS
  # ===========================================================================
  deploy:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    needs: validate
    if: needs.validate.outputs.should_deploy == 'true'
    environment: staging
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup SSH Key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.VPS_SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.VPS_HOST }} >> ~/.ssh/known_hosts 2>/dev/null || true

      - name: Deploy to Staging VPS
        run: |
          ssh -o StrictHostKeyChecking=no ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} << 'DEPLOY_SCRIPT'
          set -e
          
          echo "=========================================="
          echo "ðŸš€ Starting Staging Deployment"
          echo "=========================================="
          
          # Use the correct VPS path (hardcoded as backup if secret fails)
          DEPLOY_PATH="/var/www/vhosts/myhibachichef.com/mhapi.mysticdatanode.net/backend"
          cd "$DEPLOY_PATH"
          
          # Compose file for staging
          COMPOSE_FILE="docker-compose.staging.yml"
          SERVICE_NAME="staging-api"
          HEALTH_PORT="8002"
          
          # Store current commit for rollback
          PREVIOUS_COMMIT=$(git rev-parse HEAD 2>/dev/null || echo "none")
          echo "ðŸ“Œ Previous commit: $PREVIOUS_COMMIT"
          
          # Pull latest code
          echo "ðŸ“¥ Pulling latest code from dev branch..."
          git fetch origin dev
          git checkout dev
          git pull origin dev
          
          NEW_COMMIT=$(git rev-parse HEAD)
          echo "ðŸ“Œ New commit: $NEW_COMMIT"
          
          # Rebuild and restart staging container
          echo "ðŸ³ Rebuilding staging Docker container..."
          docker compose -f "$COMPOSE_FILE" build "$SERVICE_NAME"
          
          echo "ðŸ”„ Restarting staging container..."
          docker compose -f "$COMPOSE_FILE" up -d "$SERVICE_NAME"
          
          # Wait for container to be healthy
          echo "â³ Waiting for container health check..."
          sleep 15
          
          # Check container status
          if docker compose -f "$COMPOSE_FILE" ps "$SERVICE_NAME" | grep -q "Up"; then
            echo "âœ… Staging container is running"
          else
            echo "âŒ Staging container failed to start"
            echo "ðŸ“‹ Container logs:"
            docker compose -f "$COMPOSE_FILE" logs --tail=50 "$SERVICE_NAME"
            exit 1
          fi
          
          # Health check
          echo "ðŸ¥ Running health check..."
          for i in {1..6}; do
            if curl -sf "http://localhost:$HEALTH_PORT/health" > /dev/null 2>&1; then
              echo "âœ… Health check passed!"
              break
            fi
            if [ $i -eq 6 ]; then
              echo "âŒ Health check failed after 6 attempts"
              echo "ðŸ”„ Rolling back to previous commit..."
              git checkout "$PREVIOUS_COMMIT"
              docker compose -f "$COMPOSE_FILE" build "$SERVICE_NAME"
              docker compose -f "$COMPOSE_FILE" up -d "$SERVICE_NAME"
              exit 1
            fi
            echo "â³ Health check attempt $i/6 failed, retrying in 10s..."
            sleep 10
          done
          
          echo "=========================================="
          echo "âœ… Staging Deployment Complete!"
          echo "=========================================="
          DEPLOY_SCRIPT

      - name: Deployment Summary
        if: always()
        run: |
          echo "## Staging Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch:** dev" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Triggered by:** ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Container:** staging-api (port 8002)" >> $GITHUB_STEP_SUMMARY
          echo "- **Compose File:** docker-compose.staging.yml" >> $GITHUB_STEP_SUMMARY

  # ===========================================================================
  # JOB 3: Run E2E Tests (Optional)
  # ===========================================================================
  e2e-tests:
    name: E2E Tests
    runs-on: ubuntu-latest
    needs: deploy
    if: github.event.inputs.skip_tests != 'true'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright browsers
        run: npx playwright install --with-deps chromium

      - name: Wait for staging to stabilize
        run: sleep 30

      - name: Run E2E tests against staging
        env:
          STAGING_API_URL: ${{ secrets.STAGING_API_URL }}
        run: |
          npx playwright test --config=playwright.staging.config.ts --project=api-staging || true

      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: playwright-report-staging
          path: playwright-report-staging/
          retention-days: 7
