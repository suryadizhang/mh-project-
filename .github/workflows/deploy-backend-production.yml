# =============================================================================
# My Hibachi - Backend Production Deployment Workflow
# =============================================================================
# Triggers: Push to 'main' branch (backend changes only)
# Target: VPS production container (port 8000)
#
# REQUIRED GITHUB SECRETS:
#   - VPS_HOST: VPS IP address (108.175.12.154)
#   - VPS_USER: SSH username (root)
#   - VPS_SSH_PRIVATE_KEY: SSH private key for VPS access
#   - VPS_PRODUCTION_PATH: /var/www/vhosts/myhibachichef.com/mhapi.mysticdatanode.net/backend
#
# VPS DOCKER SETUP:
#   - Staging uses: docker-compose.staging.yml (staging-api on port 8002)
#   - Production uses: docker-compose.prod.yml (production-api on port 8000)
# =============================================================================

name: Deploy Backend to Production

on:
  push:
    branches:
      - main
    paths:
      - 'apps/backend/**'
      - 'requirements.txt'
      - 'docker-compose.prod.yml'
      - 'Dockerfile'
      - '.github/workflows/deploy-backend-production.yml'

  workflow_dispatch:
    inputs:
      skip_approval:
        description: 'Skip manual approval (emergency only)'
        required: false
        default: 'false'
        type: boolean

concurrency:
  group: production-deploy
  cancel-in-progress: false

jobs:
  # ===========================================================================
  # JOB 1: Pre-deployment Validation
  # ===========================================================================
  validate:
    name: Pre-deployment Checks
    runs-on: ubuntu-latest
    outputs:
      should_deploy: ${{ steps.check.outputs.should_deploy }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Check for backend changes
        id: check
        run: |
          if git diff --name-only HEAD~1 HEAD | grep -qE '^(apps/backend/|requirements.txt|docker-compose.prod.yml|Dockerfile)'; then
            echo "should_deploy=true" >> $GITHUB_OUTPUT
            echo "‚úÖ Backend changes detected - will deploy"
          else
            echo "should_deploy=true" >> $GITHUB_OUTPUT
            echo "‚ÑπÔ∏è Workflow file changed or manual trigger - will deploy"
          fi

  # ===========================================================================
  # JOB 2: Manual Approval Gate
  # ===========================================================================
  approval:
    name: Production Approval
    runs-on: ubuntu-latest
    needs: validate
    if: needs.validate.outputs.should_deploy == 'true' && github.event.inputs.skip_approval != 'true'
    environment: production

    steps:
      - name: Approval checkpoint
        run: |
          echo "‚úÖ Production deployment approved"
          echo "Proceeding with deployment to production..."

  # ===========================================================================
  # JOB 3: Deploy to Production VPS
  # ===========================================================================
  deploy:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: [validate, approval]
    if: always() && needs.validate.outputs.should_deploy == 'true' && (needs.approval.result == 'success' || github.event.inputs.skip_approval == 'true')

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup SSH Key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.VPS_SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.VPS_HOST }} >> ~/.ssh/known_hosts 2>/dev/null || true

      - name: Validate Database Schema
        run: |
          echo "üîç Checking SQLAlchemy model vs database schema sync..."

          # Copy schema comparison script to VPS
          scp -o StrictHostKeyChecking=no scripts/compare_schemas.py \
            ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }}:/tmp/compare_schemas.py

          # Run schema validation on production database
          ssh -o StrictHostKeyChecking=no ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} << 'SCHEMA_CHECK'
          set -e
          cd /var/www/vhosts/myhibachichef.com/mhapi.mysticdatanode.net/backend

          # Activate virtual environment if exists
          if [ -f "venv/bin/activate" ]; then
            source venv/bin/activate
          fi

          # Run schema comparison against production database
          echo "üìä Comparing SQLAlchemy models with production database..."
          python /tmp/compare_schemas.py --env production --ci 2>&1 || {
            echo "‚ö†Ô∏è Schema mismatch detected! Review the above output."
            echo "If critical columns are missing, run migrations before deployment."
            # Exit with error to block deployment if critical mismatches found
            exit 1
          }

          echo "‚úÖ Schema validation passed"
          rm -f /tmp/compare_schemas.py
          SCHEMA_CHECK

      - name: Deploy to Production VPS
        run: |
          ssh -o StrictHostKeyChecking=no ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} << 'DEPLOY_SCRIPT'
          set -e

          echo "=========================================="
          echo "üöÄ Starting Production Deployment"
          echo "=========================================="

          # Use the correct VPS path (hardcoded as backup if secret fails)
          DEPLOY_PATH="/var/www/vhosts/myhibachichef.com/mhapi.mysticdatanode.net/backend"
          cd "$DEPLOY_PATH"

          # Compose file for production
          COMPOSE_FILE="docker-compose.prod.yml"
          SERVICE_NAME="production-api"
          HEALTH_PORT="8000"

          # Store current commit for rollback
          PREVIOUS_COMMIT=$(git rev-parse HEAD 2>/dev/null || echo "none")
          echo "üìå Previous commit: $PREVIOUS_COMMIT"

          # Pull latest code (force reset to handle divergent branches)
          echo "üì• Pulling latest code from main branch..."
          git fetch origin main
          git checkout main
          git reset --hard origin/main

          NEW_COMMIT=$(git rev-parse HEAD)
          echo "üìå New commit: $NEW_COMMIT"

          # Rebuild and restart production container
          echo "üê≥ Rebuilding production Docker container..."
          docker compose -f "$COMPOSE_FILE" build "$SERVICE_NAME"

          echo "üîÑ Restarting production container..."
          docker compose -f "$COMPOSE_FILE" up -d "$SERVICE_NAME"

          # Wait for container to be healthy
          echo "‚è≥ Waiting for container health check..."
          sleep 15

          # Check container status
          if docker compose -f "$COMPOSE_FILE" ps "$SERVICE_NAME" | grep -q "Up"; then
            echo "‚úÖ Production container is running"
          else
            echo "‚ùå Production container failed to start"
            echo "üìã Container logs:"
            docker compose -f "$COMPOSE_FILE" logs --tail=50 "$SERVICE_NAME"
            exit 1
          fi

          # Health check with more retries for production
          echo "üè• Running health check..."
          for i in {1..10}; do
            if curl -sf "http://localhost:$HEALTH_PORT/health" > /dev/null 2>&1; then
              echo "‚úÖ Health check passed!"
              break
            fi
            if [ $i -eq 10 ]; then
              echo "‚ùå Health check failed after 10 attempts"
              echo "üîÑ Rolling back to previous commit..."
              git checkout "$PREVIOUS_COMMIT"
              docker compose -f "$COMPOSE_FILE" build "$SERVICE_NAME"
              docker compose -f "$COMPOSE_FILE" up -d "$SERVICE_NAME"
              exit 1
            fi
            echo "‚è≥ Health check attempt $i/10 failed, retrying in 10s..."
            sleep 10
          done

          echo "=========================================="
          echo "‚úÖ Production Deployment Complete!"
          echo "=========================================="
          DEPLOY_SCRIPT

      - name: Deployment Summary
        if: always()
        run: |
          echo "## Production Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch:** main" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Triggered by:** ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Container:** production-api (port 8000)" >> $GITHUB_STEP_SUMMARY
          echo "- **Compose File:** docker-compose.prod.yml" >> $GITHUB_STEP_SUMMARY

  # ===========================================================================
  # JOB 4: Post-deployment Verification
  # ===========================================================================
  verify:
    name: Verify Production
    runs-on: ubuntu-latest
    needs: deploy
    if: success()

    steps:
      - name: Verify production health
        run: |
          echo "üîç Verifying production deployment..."
          sleep 30

          # External health check via Cloudflare
          if curl -sf https://mhapi.mysticdatanode.net/health > /dev/null 2>&1; then
            echo "‚úÖ Production API is accessible via Cloudflare"
          else
            echo "‚ö†Ô∏è Production API may not be accessible externally yet"
            echo "This could be due to DNS propagation or Cloudflare caching"
          fi

      - name: Post-deployment Summary
        run: |
          echo "## Post-deployment Verification" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "‚úÖ Production deployment verified" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "1. Monitor application logs for errors" >> $GITHUB_STEP_SUMMARY
          echo "2. Check Cloudflare analytics for any issues" >> $GITHUB_STEP_SUMMARY
          echo "3. Run manual smoke tests if needed" >> $GITHUB_STEP_SUMMARY
